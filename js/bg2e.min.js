"use strict";var bg={};bg.version="1.2.8 - build: e2399f3",bg.utils={},Reflect.defineProperty=Reflect.defineProperty||Object.defineProperty,function(t){t.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t,e){window.setTimeout(t,1e3/60)}}(),bg.utils.initWebGLContext=function(t){var e={gl:null,supported:!1,experimental:!1};try{e.gl=t.getContext("webgl",{preserveDrawingBuffer:!0}),e.supported=null!=e.gl}catch(t){e.supported=!1}if(!e.supported)try{e.gl=t.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),e.supported=null!=e.gl,e.experimental=!0}catch(t){}return e&&(e.gl.uuid=Symbol(e.gl)),e},bg.utils.isBigEndian=function(){var t=new Uint32Array(1);new Uint8Array(t.buffer);return t[0]=255,255==t[3]},bg.utils.isLittleEndian=function(){var t=new Uint32Array(1);new Uint8Array(t.buffer);return t[0]=255,255==t[0]};var e=function(){function t(t){this.system={},this.browser={},t||(t=navigator.userAgent),this.parseOperatingSystem(t),this.parseBrowser(t)}return $traceurRuntime.createClass(t,{parseOperatingSystem:function(t){this.system.OSX=/Macintosh/.test(t),this.system.Windows=/Windows/.test(t),this.system.iPhone=/iPhone/.test(t),this.system.iPodTouch=/iPod/.test(t),this.system.iPad=/iPad/.test(t),this.system.iOS=this.system.iPhone||this.system.iPad||this.system.iPodTouch,this.system.Android=/Android/.test(t),this.system.Linux=!this.system.Android&&/Linux/.test(t),this.system.OSX?(this.system.OSName="OS X",this.parseOSXVersion(t)):this.system.Windows?(this.system.OSName="Windows",this.parseWindowsVersion(t)):this.system.Linux?(this.system.OSName="Linux",this.parseLinuxVersion(t)):this.system.iOS?(this.system.OSName="iOS",this.parseIOSVersion(t)):this.system.Android&&(this.system.OSName="Android",this.parseAndroidVersion(t))},parseBrowser:function(t){if(this.browser.Version={},this.browser.Safari=/Version\/([\d\.]+) Safari\//.test(t),this.browser.Safari&&(this.browser.Name="Safari",this.browser.Vendor="Apple",this.browser.Version.versionString=RegExp.$1),this.browser.Chrome=/Chrome\/([\d\.]+) Safari\//.test(t),this.browser.Chrome&&(this.browser.Name="Chrome",this.browser.Vendor="Google",this.browser.Version.versionString=RegExp.$1),this.browser.Opera=/Opera\/[\d\.]+/.test(t),this.browser.Opera){this.browser.Name="Opera",this.browser.Vendor="Opera Software";/Version\/([\d\.]+)/.test(t);this.browser.Version.versionString=RegExp.$1}if(this.browser.Firefox=/Gecko\/[\d\.]+ Firefox\/([\d\.]+)/.test(t),this.browser.Firefox&&(this.browser.Name="Firefox",this.browser.Vendor="Mozilla Foundation",this.browser.Version.versionString=RegExp.$1),this.browser.Edge=/Edge\/(.*)/.test(t),this.browser.Edge){var e=/Edge\/(.*)/.exec(t);this.browser.Name="Edge",this.browser.Chrome=!1,this.browser.Vendor="Microsoft",this.browser.Version.versionString=e[1]}if(this.browser.Explorer=/MSIE ([\d\.]+)/.test(t),this.browser.Explorer)this.browser.Name="Internet Explorer",this.browser.Vendor="Microsoft",this.browser.Version.versionString=RegExp.$1;else{var i=/\Mozilla\/5.0 \(([^)]+)\) like Gecko/,n=i.exec(t);if(n){i=/rv:(.*)/;var r=i.exec(n[1]);this.browser.Explorer=!0,this.browser.Name="Internet Explorer",this.browser.Vendor="Microsoft",this.browser.Version.versionString=r?r[1]:"unknown"}}this.system.iOS?(this.browser.IsMobileVersion=!0,this.browser.MobileSafari=/Version\/([\d\.]+) Mobile/.test(t),this.browser.MobileSafari&&(this.browser.Name="Mobile Safari",this.browser.Vendor="Apple",this.browser.Version.versionString=RegExp.$1),this.browser.Android=!1):this.system.Android?(this.browser.IsMobileVersion=!0,this.browser.Android=/Version\/([\d\.]+) Mobile/.test(t),this.browser.MobileSafari?(this.browser.Name="Android Browser",this.browser.Vendor="Google",this.browser.Version.versionString=RegExp.$1):(this.browser.Chrome=/Chrome\/([\d\.]+)/.test(t),this.browser.Name="Chrome",this.browser.Vendor="Google",this.browser.Version.versionString=RegExp.$1),this.browser.Safari=!1):this.browser.IsMobileVersion=!1,this.parseBrowserVersion(t)},parseBrowserVersion:function(t){/([\d]+)\.([\d]+)\.*([\d]*)/.test(this.browser.Version.versionString)&&(this.browser.Version.major=Number(RegExp.$1),this.browser.Version.minor=Number(RegExp.$2),this.browser.Version.revision=RegExp.$3?Number(RegExp.$3):0)},parseOSXVersion:function(t){var e=/Mac OS X (\d+_\d+_*\d*)/.test(t)?RegExp.$1:"";switch(this.system.Version={},""!=e?/(\d+)_(\d+)_*(\d*)/.test(e)&&(this.system.Version.major=Number(RegExp.$1),this.system.Version.minor=Number(RegExp.$2),this.system.Version.revision=RegExp.$3?Number(RegExp.$3):0):(e=/Mac OS X (\d+\.\d+\.*\d*)/.test(t)?RegExp.$1:"Unknown",/(\d+)\.(\d+)\.*(\d*)/.test(e)&&(this.system.Version.major=Number(RegExp.$1),this.system.Version.minor=Number(RegExp.$2),this.system.Version.revision=RegExp.$3?Number(RegExp.$3):0)),this.system.Version.major||(this.system.Version.major=0,this.system.Version.minor=0,this.system.Version.revision=0),this.system.Version.stringValue=this.system.Version.major+"."+this.system.Version.minor+"."+this.system.Version.revision,this.system.Version.minor){case 0:this.system.Version.name="Cheetah";break;case 1:this.system.Version.name="Puma";break;case 2:this.system.Version.name="Jaguar";break;case 3:this.system.Version.name="Panther";break;case 4:this.system.Version.name="Tiger";break;case 5:this.system.Version.name="Leopard";break;case 6:this.system.Version.name="Snow Leopard";break;case 7:this.system.Version.name="Lion";break;case 8:this.system.Version.name="Mountain Lion"}},parseWindowsVersion:function(t){if(this.system.Version={},/NT (\d+)\.(\d*)/.test(t)){this.system.Version.major=Number(RegExp.$1),this.system.Version.minor=Number(RegExp.$2),this.system.Version.revision=0,this.system.Version.stringValue="NT "+this.system.Version.major+"."+this.system.Version.minor;var e=this.system.Version.major,i=this.system.Version.minor;5==e?this.system.Version.name=0==i?"2000":"XP":6==e&&(0==i?this.system.Version.name="Vista":1==i?this.system.Version.name="7":2==i&&(this.system.Version.name="8"))}else this.system.Version.major=0,this.system.Version.minor=0,this.system.Version.name="Unknown",this.system.Version.stringValue="Unknown"},parseLinuxVersion:function(t){this.system.Version={},this.system.Version.major=0,this.system.Version.minor=0,this.system.Version.revision=0,this.system.Version.name="",this.system.Version.stringValue="Unknown distribution"},parseIOSVersion:function(t){this.system.Version={},/iPhone OS (\d+)_(\d+)_*(\d*)/i.test(t)?(this.system.Version.major=Number(RegExp.$1),this.system.Version.minor=Number(RegExp.$2),this.system.Version.revision=RegExp.$3?Number(RegExp.$3):0,this.system.Version.stringValue=this.system.Version.major+"."+this.system.Version.minor+"."+this.system.Version.revision,this.system.Version.name="iOS"):(this.system.Version.major=0,this.system.Version.minor=0,this.system.Version.name="Unknown",this.system.Version.stringValue="Unknown")},parseAndroidVersion:function(t){this.system.Version={},/Android (\d+)\.(\d+)\.*(\d*)/.test(t)?(this.system.Version.major=Number(RegExp.$1),this.system.Version.minor=Number(RegExp.$2),this.system.Version.revision=RegExp.$3?Number(RegExp.$3):0,this.system.Version.stringValue=this.system.Version.major+"."+this.system.Version.minor+"."+this.system.Version.revision):(this.system.Version.major=0,this.system.Version.minor=0,this.system.Version.revision=0),/Build\/([a-zA-Z]+)/.test(t)?this.system.Version.name=RegExp.$1:this.system.Version.name="Unknown version",this.system.Version.stringValue=this.system.Version.major+"."+this.system.Version.minor+"."+this.system.Version.revision},getInfoString:function(){return navigator.userAgent}},{})}();bg.utils.UserAgent=e,bg.utils.userAgent=new e;var i=function(){function t(){}return $traceurRuntime.createClass(t,{get sep(){return"/"},join:function(t,e){return t.lastIndexOf(this.sep)!=t.length-1?t+this.sep+e:t+e},extension:function(t){return t.split(".").pop()},fileName:function(t){return t.split(this.sep).pop()},removeFileName:function(t){var e=t.split(this.sep);return e.pop(),e.join(this.sep)}},{})}();bg.utils.Path=i,bg.utils.path=new i}(window),function(){var t=[],e=[],i=function(){function t(){}return $traceurRuntime.createClass(t,{getRequest:function(t,e,i,n){},loadImage:function(t,e,i){},loadVideo:function(t,e,i){}},{})}(),n=function(i){function n(){$traceurRuntime.superConstructor(n).apply(this,arguments)}return $traceurRuntime.createClass(n,{getRequest:function(t,e,i,n){var r=new XMLHttpRequest;return n||(n=function(t){console.log("Loading "+t.file+": "+t.loaded/t.total*100+" %")}),r.open("GET",t,!0),r.addEventListener("load",function(){200===r.status?e(r):i(new Error("Error receiving data: "+r.status+", url: "+t))},!1),r.addEventListener("error",function(){i(new Error("Cannot make AJAX request. Url: "+t))},!1),r.addEventListener("progress",function(e){n({file:t,loaded:e.loaded,total:e.total})},!1),r},loadImage:function(e,i,n){var r=new Image;t.push(r),r.crossOrigin="",r.addEventListener("load",function(e){var n=t.indexOf(e.target);-1!=n&&t.splice(n,1),i(e.target)}),r.addEventListener("error",function(t){n(new Error("Error loading image: "+e))}),r.addEventListener("abort",function(t){n(new Error("Image load aborted: "+e))}),r.src=e},loadVideo:function(t,i,n){var r=document.createElement("video");e.push(r),r.crossOrigin="",r.autoplay=!0,r.setAttribute("playsinline",null),r.addEventListener("canplay",function(t){var n=e.indexOf(t.target);-1!=n&&e.splice(n,1),i(event.target)}),r.addEventListener("error",function(e){n(new Error("Error loading video: "+t))}),r.addEventListener("abort",function(e){n(new Error("Error loading video: "+t))}),r.src=t}},{},i)}(i);bg.utils.ResourceProvider=i,bg.utils.HTTPResourceProvider=n;var r=new n,s=function(){function t(){}return $traceurRuntime.createClass(t,{},{SetResourceProvider:function(t){r=t},GetResourceProvider:function(){return r},GetExtension:function(t){var e=/\.([a-z0-9-_]*)$/i.exec(t);return e&&e[1].toLowerCase()||""},JoinUrl:function(t,e){return 0==t.length?e:0==e.length?t:/\/$/.test(t)?t+e:t+"/"+e},IsFormat:function(e,i){return null!=i.find(function(t){return t==this},t.GetExtension(e))},IsImage:function(e){return t.IsFormat(e,["jpg","jpeg","gif","png"])},IsBinary:function(e){var i=void 0!==arguments[1]?arguments[1]:["vwglb","bg2"];return t.IsFormat(e,i)},IsVideo:function(e){var i=void 0!==arguments[1]?arguments[1]:["mp4","m4v","ogg","ogv","m3u8","webm"];return t.IsFormat(e,i)},LoadMultiple:function(e,i){var n={},r=function(t){n[t.file]=t;var r=0,s=0;for(var a in n){var o=n[a];r+=o.total,s+=o.loaded}i?i({fileList:e,total:r,loaded:s}):console.log("Loading "+Object.keys(n).length+" files: "+s/r*100+"% completed")},s=[];e.forEach(function(e){s.push(t.Load(e,r))});var a=s.map(function(t){return new Promise(function(e){var i=new Array(2);t.then(function(t){i[0]=t}).catch(function(t){i[1]=t}).then(function(){e(i)})})});return Promise.all(a).then(function(t){var i={};return e.forEach(function(e,n){var r=t[n];i[e]=r[1]?null:r[0]}),i})},Load:function(e,i){var n=null;switch(!0){case e.constructor===Array:n=t.LoadMultiple;break;case t.IsImage(e):n=t.LoadImage;break;case t.IsBinary(e):n=t.LoadBinary;break;case t.IsVideo(e):n=t.LoadVideo;break;case"json"==t.GetExtension(e):n=t.LoadJson;break;default:n=t.LoadText}return n(e,i)},LoadText:function(t,e){return new Promise(function(i,n){r.getRequest(t,function(t){i(t.responseText)},function(t){n(t)},e).send()})},LoadVideo:function(t,e){return new Promise(function(e,i){r.loadVideo(t,function(t){e(t),bg.emitImageLoadEvent(t)},function(t){i(t)})})},LoadBinary:function(t,e){return new Promise(function(i,n){var s=r.getRequest(t,function(t){i(t.response)},function(t){n(t)},e);s.responseType="arraybuffer",s.send()})},LoadImage:function(t){return new Promise(function(e,i){r.loadImage(t,function(t){e(t),bg.emitImageLoadEvent(t)},function(t){i(t)})})},LoadJson:function(t){return new Promise(function(e,i){r.getRequest(t,function(t){try{e(JSON.parse(t.responseText))}catch(t){i(new Error("Error parsing JSON data"))}},function(t){i(t)}).send()})}})}();bg.utils.Resource=s,bg.utils.requireGlobal=function(t){var e=document.createElement("script");e.src=t,e.type="text/javascript",e.async=!1,document.getElementsByTagName("head")[0].appendChild(e)}}(),function(){var t=null,e=function(){function e(){}return $traceurRuntime.createClass(e,{get id(){return this._engineId},get texture(){return this._texture},get pipeline(){return this._pipeline},get polyList(){return this._polyList},get shader(){return this._shader},get colorBuffer(){return this._colorBuffer},get textureBuffer(){return this._textureBuffer},get shaderSource(){return this._shaderSource}},{Set:function(e){t=e},Get:function(){return t}})}();bg.Engine=e}(),function(){var t=function(){function t(){}return $traceurRuntime.createClass(t,{init:function(){},frame:function(t){},willDisplay:function(t,e){},display:function(t,e){},displayGizmo:function(t,e){},didDisplay:function(t,e){},reshape:function(t,e,i,n){},keyDown:function(t){},keyUp:function(t){},mouseUp:function(t){},mouseDown:function(t){},mouseMove:function(t){},mouseOut:function(t){},mouseDrag:function(t){},mouseWheel:function(t){},touchStart:function(t){},touchMove:function(t){},touchEnd:function(t){},postRedisplay:function(){var t=void 0!==arguments[0]?arguments[0]:1;bg.app.MainLoop.singleton.postRedisplay(t)},postReshape:function(){bg.app.MainLoop.singleton.postReshape()}},{})}();bg.LifeCycle=t}(),function(){!function(t){function e(t){for(var e="",i="",n=0,r=0,s=0,a=t.length;a>s;s++){var o=t.charCodeAt(s);128>o?r++:(i=2048>o?String.fromCharCode(o>>6|192,63&o|128):String.fromCharCode(o>>12|224,o>>6&63|128,63&o|128),r>n&&(e+=t.slice(n,r)),e+=i,n=r=s+1)}return r>n&&(e+=t.slice(n,a)),e}function i(t){var e,i;if(t+="",p=!1,d=_=t.length,_>63){for(n(t.substring(0,64)),a(l),p=!0,e=128;_>=e;e+=64)n(t.substring(e-64,e)),o(l);t=t.substring(e-64),_=t.length}for(h[0]=h[1]=h[2]=h[3]=h[4]=h[5]=h[6]=h[7]=h[8]=h[9]=h[10]=h[11]=h[12]=h[13]=h[14]=h[15]=0,e=0;_>e;e++)i=3&e,0===i?h[e>>2]=t.charCodeAt(e):h[e>>2]|=t.charCodeAt(e)<<g[i];return h[e>>2]|=f[3&e],e>55?(p?o(h):(a(h),p=!0),o([0,0,0,0,0,0,0,0,0,0,0,0,0,0,d<<3,0])):(h[14]=d<<3,void(p?o(h):a(h)))}function n(t){for(var e=16;e--;){var i=e<<2;l[e]=t.charCodeAt(i)+(t.charCodeAt(i+1)<<8)+(t.charCodeAt(i+2)<<16)+(t.charCodeAt(i+3)<<24)}}function r(t,n,r){i(n?t:e(t));var s=m[0];return u[1]=b[15&s],u[0]=b[15&(s>>=4)],u[3]=b[15&(s>>=4)],u[2]=b[15&(s>>=4)],u[5]=b[15&(s>>=4)],u[4]=b[15&(s>>=4)],u[7]=b[15&(s>>=4)],u[6]=b[15&(s>>=4)],s=m[1],u[9]=b[15&s],u[8]=b[15&(s>>=4)],u[11]=b[15&(s>>=4)],u[10]=b[15&(s>>=4)],u[13]=b[15&(s>>=4)],u[12]=b[15&(s>>=4)],u[15]=b[15&(s>>=4)],u[14]=b[15&(s>>=4)],s=m[2],u[17]=b[15&s],u[16]=b[15&(s>>=4)],u[19]=b[15&(s>>=4)],u[18]=b[15&(s>>=4)],u[21]=b[15&(s>>=4)],u[20]=b[15&(s>>=4)],u[23]=b[15&(s>>=4)],u[22]=b[15&(s>>=4)],s=m[3],u[25]=b[15&s],u[24]=b[15&(s>>=4)],u[27]=b[15&(s>>=4)],u[26]=b[15&(s>>=4)],u[29]=b[15&(s>>=4)],u[28]=b[15&(s>>=4)],u[31]=b[15&(s>>=4)],u[30]=b[15&(s>>=4)],r?u:u.join("")}function s(t,e,i,n,r,s,a){return((e+=t+n+a)<<r|e>>>s)+i<<0}function a(t){c(0,0,0,0,t),m[0]=v[0]+1732584193<<0,m[1]=v[1]-271733879<<0,m[2]=v[2]-1732584194<<0,m[3]=v[3]+271733878<<0}function o(t){c(m[0],m[1],m[2],m[3],t),m[0]=v[0]+m[0]<<0,m[1]=v[1]+m[1]<<0,m[2]=v[2]+m[2]<<0,m[3]=v[3]+m[3]<<0}function c(t,e,i,n,r){var a,o;p?(t=s((i^n)&e^n,t,e,r[0],7,25,-680876936),n=s((e^i)&t^i,n,t,r[1],12,20,-389564586),i=s((t^e)&n^e,i,n,r[2],17,15,606105819),e=s((n^t)&i^t,e,i,r[3],22,10,-1044525330)):(t=r[0]-680876937,t=(t<<7|t>>>25)-271733879<<0,n=r[1]-117830708+(2004318071&t^-1732584194),n=(n<<12|n>>>20)+t<<0,i=r[2]-1126478375+((-271733879^t)&n^-271733879),i=(i<<17|i>>>15)+n<<0,e=r[3]-1316259209+((n^t)&i^t),e=(e<<22|e>>>10)+i<<0),t=s((i^n)&e^n,t,e,r[4],7,25,-176418897),n=s((e^i)&t^i,n,t,r[5],12,20,1200080426),i=s((t^e)&n^e,i,n,r[6],17,15,-1473231341),e=s((n^t)&i^t,e,i,r[7],22,10,-45705983),t=s((i^n)&e^n,t,e,r[8],7,25,1770035416),n=s((e^i)&t^i,n,t,r[9],12,20,-1958414417),i=s((t^e)&n^e,i,n,r[10],17,15,-42063),e=s((n^t)&i^t,e,i,r[11],22,10,-1990404162),t=s((i^n)&e^n,t,e,r[12],7,25,1804603682),n=s((e^i)&t^i,n,t,r[13],12,20,-40341101),i=s((t^e)&n^e,i,n,r[14],17,15,-1502002290),e=s((n^t)&i^t,e,i,r[15],22,10,1236535329),t=s((e^i)&n^i,t,e,r[1],5,27,-165796510),n=s((t^e)&i^e,n,t,r[6],9,23,-1069501632),i=s((n^t)&e^t,i,n,r[11],14,18,643717713),e=s((i^n)&t^n,e,i,r[0],20,12,-373897302),t=s((e^i)&n^i,t,e,r[5],5,27,-701558691),n=s((t^e)&i^e,n,t,r[10],9,23,38016083),i=s((n^t)&e^t,i,n,r[15],14,18,-660478335),e=s((i^n)&t^n,e,i,r[4],20,12,-405537848),t=s((e^i)&n^i,t,e,r[9],5,27,568446438),n=s((t^e)&i^e,n,t,r[14],9,23,-1019803690),i=s((n^t)&e^t,i,n,r[3],14,18,-187363961),e=s((i^n)&t^n,e,i,r[8],20,12,1163531501),t=s((e^i)&n^i,t,e,r[13],5,27,-1444681467),n=s((t^e)&i^e,n,t,r[2],9,23,-51403784),i=s((n^t)&e^t,i,n,r[7],14,18,1735328473),e=s((i^n)&t^n,e,i,r[12],20,12,-1926607734),a=e^i,t=s(a^n,t,e,r[5],4,28,-378558),n=s(a^t,n,t,r[8],11,21,-2022574463),o=n^t,i=s(o^e,i,n,r[11],16,16,1839030562),e=s(o^i,e,i,r[14],23,9,-35309556),a=e^i,t=s(a^n,t,e,r[1],4,28,-1530992060),n=s(a^t,n,t,r[4],11,21,1272893353),o=n^t,i=s(o^e,i,n,r[7],16,16,-155497632),e=s(o^i,e,i,r[10],23,9,-1094730640),a=e^i,t=s(a^n,t,e,r[13],4,28,681279174),n=s(a^t,n,t,r[0],11,21,-358537222),o=n^t,i=s(o^e,i,n,r[3],16,16,-722521979),e=s(o^i,e,i,r[6],23,9,76029189),a=e^i,t=s(a^n,t,e,r[9],4,28,-640364487),n=s(a^t,n,t,r[12],11,21,-421815835),o=n^t,i=s(o^e,i,n,r[15],16,16,530742520),e=s(o^i,e,i,r[2],23,9,-995338651),t=s(i^(e|~n),t,e,r[0],6,26,-198630844),n=s(e^(t|~i),n,t,r[7],10,22,1126891415),i=s(t^(n|~e),i,n,r[14],15,17,-1416354905),e=s(n^(i|~t),e,i,r[5],21,11,-57434055),t=s(i^(e|~n),t,e,r[12],6,26,1700485571),n=s(e^(t|~i),n,t,r[3],10,22,-1894986606),i=s(t^(n|~e),i,n,r[10],15,17,-1051523),e=s(n^(i|~t),e,i,r[1],21,11,-2054922799),t=s(i^(e|~n),t,e,r[8],6,26,1873313359),n=s(e^(t|~i),n,t,r[15],10,22,-30611744),i=s(t^(n|~e),i,n,r[6],15,17,-1560198380),e=s(n^(i|~t),e,i,r[13],21,11,1309151649),t=s(i^(e|~n),t,e,r[4],6,26,-145523070),n=s(e^(t|~i),n,t,r[11],10,22,-1120210379),i=s(t^(n|~e),i,n,r[2],15,17,718787259),e=s(n^(i|~t),e,i,r[9],21,11,-343485551),v[0]=t,v[1]=e,v[2]=i,v[3]=n}var u=[],h=[],l=[],f=[],b="0123456789abcdef".split(""),g=[],m=[],p=!1,d=0,_=0,v=[];if(t.Int32Array)h=new Int32Array(16),l=new Int32Array(16),f=new Int32Array(4),g=new Int32Array(4),m=new Int32Array(4),v=new Int32Array(4);else{var x;for(x=0;16>x;x++)h[x]=l[x]=0;for(x=0;4>x;x++)f[x]=g[x]=m[x]=v[x]=0}f[0]=128,f[1]=32768,f[2]=8388608,f[3]=-2147483648,g[0]=0,g[1]=8,g[2]=16,g[3]=24,t.md5=t.md5||r}("undefined"==typeof global?window:global),bg.utils.md5=md5}(),function(){function t(){var t=(new Date).getTime();return"undefined"!=typeof performance&&"function"==typeof performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var i=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?i:3&i|8).toString(16)})}bg.utils.generateUUID=t}(),bg.app={},function(){var t=function(){function t(t){var e=this;if(this._domElem=t,this._domElem.style.MozUserSelect="none",this._domElem.style.WebkitUserSelect="none",this._domElem.setAttribute("onselectstart","return false"),this._multisample=1,!function(){return e._context=bg.utils.initWebGLContext(t),e._context.supported}())throw new Error("Sorry, your browser does not support WebGL.")}return $traceurRuntime.createClass(t,{get multisample(){return this._multisample},set multisample(t){this._multisample=t},get context(){return this._context},get domElement(){return this._domElem},get width(){return this._domElem.clientWidth},get height(){return this._domElem.clientHeight},screenshot:function(t,e,i){var n="",r={};e&&(i=i||e,n=this.domElement.style.cssText,r.width=this.domElement.width,r.height=this.domElement.height,this.domElement.style.cssText="top:auto;left:auto;bottom:auto;right:auto;width:"+e+"px;height:"+i+"px;",this.domElement.width=e,this.domElement.height=i,bg.app.MainLoop.singleton.windowController.reshape(e,i),bg.app.MainLoop.singleton.windowController.postRedisplay(),bg.app.MainLoop.singleton.windowController.display());var s=this.domElement.toDataURL(t);return e&&(this.domElement.style.cssText=n,this.domElement.width=r.width,this.domElement.height=r.height,bg.app.MainLoop.singleton.windowController.reshape(r.width,r.height),bg.app.MainLoop.singleton.windowController.postRedisplay(),bg.app.MainLoop.singleton.windowController.display()),s}},{})}();bg.app.Canvas=t;var e=function(){function t(t){this._context=t}return $traceurRuntime.createClass(t,{get context(){return this._context},set context(t){this._context=t}},{})}();bg.app.ContextObject=e}(),function(){bg.app.SpecialKey={BACKSPACE:"Backspace",TAB:"Tab",ENTER:"Enter",SHIFT:"Shift",SHIFT_LEFT:"ShiftLeft",SHIFT_RIGHT:"ShiftRight",CTRL:"Control",CTRL_LEFT:"ControlLeft",CTRL_LEFT:"ControlRight",ALT:"Alt",ALT_LEFT:"AltLeft",ALT_RIGHT:"AltRight",PAUSE:"Pause",CAPS_LOCK:"CapsLock",ESCAPE:"Escape",PAGE_UP:"PageUp",PAGEDOWN:"PageDown",END:"End",HOME:"Home",LEFT_ARROW:"ArrowLeft",UP_ARROW:"ArrowUp",RIGHT_ARROW:"ArrowRight",DOWN_ARROW:"ArrowDown",INSERT:"Insert",DELETE:"Delete"};var t=function(){function t(){this._executeDefault=!1}return $traceurRuntime.createClass(t,{get executeDefault(){return this._executeDefault},set executeDefault(t){this._executeDefault=t}},{})}();bg.app.EventBase=t;var e=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this),this.key=t,this.event=i}return $traceurRuntime.createClass(e,{isSpecialKey:function(){return e.IsSpecialKey(this.event)}},{IsSpecialKey:function(t){return null!=bg.app.SpecialKey[t.code]}},t)}(t);bg.app.KeyboardEvent=e,bg.app.MouseButton={LEFT:0,MIDDLE:1,RIGHT:2,NONE:-1};var i=function(t){function e(){var t=void 0!==arguments[0]?arguments[0]:bg.app.MouseButton.NONE,i=void 0!==arguments[1]?arguments[1]:-1,n=void 0!==arguments[2]?arguments[2]:-1,r=void 0!==arguments[3]?arguments[3]:0,s=void 0!==arguments[4]?arguments[4]:null;$traceurRuntime.superConstructor(e).call(this),this.button=t,this.x=i,this.y=n,this.delta=r,this.event=s}return $traceurRuntime.createClass(e,{},{},t)}(t);bg.app.MouseEvent=i;var n=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this),this.touches=t,this.event=i}return $traceurRuntime.createClass(e,{},{},t)}(t);bg.app.TouchEvent=n}(),function(){function t(){requestAnimFrame(t),n()}function e(){if(i(),window.addEventListener("resize",function(t){i()}),!p.canvas)throw new Error("Configuration error in MainLoop: no canvas defined");var t=p.canvas.domElement;t.addEventListener("mousedown",function(t){if(!r(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("mousemove",function(t){if(!s(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("mouseout",function(t){if(!a().executeDefault)return t.preventDefault(),!1}),t.addEventListener("mouseover",function(t){if(!o(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("mouseup",function(t){if(!c(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("touchstart",function(t){if(!l(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("touchmove",function(t){if(!f(t).executeDefault)return t.preventDefault(),!1}),t.addEventListener("touchend",function(t){if(!b(t).executeDefault)return t.preventDefault(),!1});var e=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";t.addEventListener(e,function(t){if(!u(t).executeDefault)return t.preventDefault(),!1}),window.addEventListener("keydown",function(t){g(t)}),window.addEventListener("keyup",function(t){m(t)}),t.oncontextmenu=function(t){return!1}}function i(){if(p.canvas&&p.windowController){var t=p.canvas.multisample;p.canvas.domElement.width=p.canvas.width*t,p.canvas.domElement.height=p.canvas.height*t,p.windowController.reshape(p.canvas.width*t,p.canvas.height*t)}}function n(){p.redisplay&&(-1==_&&(_=Date.now()),p.windowController.frame(Date.now()-_),p.windowController.display(),_=Date.now(),p.updateMode==bg.app.FrameUpdate.AUTO?p._redisplayFrames=1:p._redisplayFrames--)}function r(t){var e=p.canvas.domElement.getBoundingClientRect(),i=p.canvas.multisample;switch(d.pos.x=(t.clientX-e.left)*i,d.pos.y=(t.clientY-e.top)*i,t.button){case bg.app.MouseButton.LEFT:d.leftButton=!0;break;case bg.app.MouseButton.MIDDLE:d.middleButton=!0;break;case bg.app.MouseButton.RIGHT:d.rightButton=!0}var n=new bg.app.MouseEvent(t.button,d.pos.x,d.pos.y,0,t);return p.windowController.mouseDown(n),n}function s(t){var e=p.canvas.domElement.getBoundingClientRect(),i=p.canvas.multisample;d.pos.x=(t.clientX-e.left)*i,d.pos.y=(t.clientY-e.top)*i;var n=new bg.app.MouseEvent(bg.app.MouseButton.NONE,d.pos.x,d.pos.y,0,t);return p.windowController.mouseMove(n),d.anyButton&&p.windowController.mouseDrag(n),n}function a(){var t=new bg.app.MouseEvent(bg.app.MouseButton.NONE,d.pos.x,d.pos.y,0,{});return p.windowController.mouseOut(t),d.leftButton&&(d.leftButton=!1,t=new bg.app.MouseEvent(bg.app.MouseButton.LEFT,d.pos.x,d.pos.y,0,{}),p.windowController.mouseUp(t)),d.middleButton&&(d.middleButton=!1,t=new bg.app.MouseEvent(bg.app.MouseButton.MIDDLE,d.pos.x,d.pos.y,0,{}),p.windowController.mouseUp(t)),d.rightButton&&(t=new bg.app.MouseEvent(bg.app.MouseButton.RIGHT,d.pos.x,d.pos.y,0,{}),p.windowController.mouseUp(t),d.rightButton=!1),t}function o(t){return s(t)}function c(t){switch(t.button){case bg.app.MouseButton.LEFT:d.leftButton=!1;break;case bg.app.MouseButton.MIDDLE:d.middleButton=!1;break;case bg.app.MouseButton.RIGHT:d.rightButton=!1}var e=p.canvas.domElement.getBoundingClientRect(),i=p.canvas.multisample;d.pos.x=(t.clientX-e.left)*i,d.pos.y=(t.clientY-e.top)*i;var n=new bg.app.MouseEvent(t.button,d.pos.x,d.pos.y,0,t);return p.windowController.mouseUp(n),n}function u(t){var e=p.canvas.domElement.getBoundingClientRect(),i=p.canvas.multisample;d.pos.x=(t.clientX-e.left)*i,d.pos.y=(t.clientY-e.top)*i;var n=t.wheelDelta?-1*t.wheelDelta:10*t.detail,r=new bg.app.MouseEvent(bg.app.MouseButton.NONE,d.pos.x,d.pos.y,n,t);return p.windowController.mouseWheel(r),r}function h(t){for(var e=p.canvas.domElement.getBoundingClientRect(),i=[],n=0;n<t.touches.length;++n){var r=t.touches[n];i.push({identifier:r.identifier,x:r.clientX-e.left,y:r.clientY-e.top,force:r.force,rotationAngle:r.rotationAngle,radiusX:r.radiusX,radiusY:r.radiusY})}return new bg.app.TouchEvent(i,t)}function l(t){var e=h(t);return p.windowController.touchStart(e),e}function f(t){var e=h(t);return p.windowController.touchMove(e),e}function b(t){var e=h(t);return p.windowController.touchEnd(e),e}function g(t){var e=bg.app.KeyboardEvent.IsSpecialKey(t)?t.keyCode:t.code;p.windowController.keyDown(new bg.app.KeyboardEvent(e,t))}function m(t){var e=bg.app.KeyboardEvent.IsSpecialKey(t)?t.keyCode:t.code;p.windowController.keyUp(new bg.app.KeyboardEvent(e,t))}var p=null,d={leftButton:!1,middleButton:!1,rightButton:!1,pos:{x:-1,y:-1}};Object.defineProperty(d,"anyButton",{get:function(){return this.leftButton||this.middleButton||this.rightButton}});var _=-1,v=function(){function t(){}return $traceurRuntime.createClass(t,{},{LeftButton:function(){return d.leftButton},MiddleButton:function(){return d.middleButton},RightButton:function(){return d.rightButton},Position:function(){return d.pos}})}();bg.app.Mouse=v,bg.app.FrameUpdate={AUTO:0,MANUAL:1};var x=function(){function n(){var t=this;this._canvas=null,this._windowController=null,this._updateMode=bg.app.FrameUpdate.AUTO,this._redisplayFrames=1,bg.bindImageLoadEvent(function(){t.postRedisplay()})}return $traceurRuntime.createClass(n,{get canvas(){return this._canvas},set canvas(t){this._canvas=new bg.app.Canvas(t)},get windowController(){return this._windowController},get updateMode(){return this._updateMode},set updateMode(t){this._updateMode=t,this._updateMode==bg.app.FrameUpdate.AUTO&&(this._redisplayFrames=1)},get redisplay(){return this._redisplayFrames>0},get mouseButtonStatus(){return d},run:function(i){this._windowController=i,this.postRedisplay(),this.windowController.init(),e(),t()},postRedisplay:function(){var t=void 0!==arguments[0]?arguments[0]:1;this._redisplayFrames=t},postReshape:function(){i()}},{})}();bg.app.MainLoop={},Object.defineProperty(bg.app.MainLoop,"singleton",{get:function(){return p||(p=new x),p}})}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{postRedisplay:function(){var t=void 0!==arguments[0]?arguments[0]:1;bg.app.MainLoop.singleton.postRedisplay(t)},postReshape:function(){bg.app.MainLoop.singleton.postReshape()},get canvas(){return bg.app.MainLoop.singleton.canvas},get context(){return bg.app.MainLoop.singleton.canvas.context},get gl(){return bg.app.MainLoop.singleton.canvas.context.gl}},{},t)}(bg.LifeCycle);bg.app.WindowController=t}(),bg.base={},bg.s_log=[],bg.log=function(t){console.log&&console.log(t),bg.s_log.push(t)},bg.flushLog=function(){console.log&&bg.s_log.forEach(function(t){console.log(t)}),bg.s_log=[]},bg.emitImageLoadEvent=function(t){var e=new CustomEvent("bg2e:image-load",{image:t});document.dispatchEvent(e)},bg.bindImageLoadEvent=function(t){document.addEventListener("bg2e:image-load",t)},bg.Axis={NONE:0,X:1,Y:2,Z:3},Object.defineProperty(bg,"isElectronApp",{get:function(){return"undefined"!=typeof module&&module.exports&&!0}}),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._shader=null,this._inputVars=[]}return $traceurRuntime.createClass(e,{get inputVars(){return this._inputVars},get shader(){return this._shader},setupShaderSource:function(t){var e=this;this._shader=new bg.base.Shader(this.context),this._inputVars=[];var i=[],n=[];t.forEach(function(t){t.params.forEach(function(t){t&&("buffer"==t.role?(e._inputVars[t.target]=t.name,i.push(t.name)):"value"==t.role&&n.push(t.name))}),e._shader.addShaderSource(t.type,t.toString())}),this._shader.link(),this._shader.status?this._shader.initVars(i,n):(bg.log(this._shader.compileError),this._shader.compileErrorSource&&(bg.log("Shader source:"),bg.log(this._shader.compileErrorSource)),bg.log(this._shader.linkError))},beginDraw:function(){},setupVars:function(){},setActive:function(){this.shader.setActive(),this.beginDraw()},clearActive:function(){this.shader.clearActive()},bindPolyList:function(t){var e=this.shader;this.inputVars.vertex&&e.setInputBuffer(this.inputVars.vertex,t.vertexBuffer,3),this.inputVars.normal&&e.setInputBuffer(this.inputVars.normal,t.normalBuffer,3),this.inputVars.tex0&&e.setInputBuffer(this.inputVars.tex0,t.texCoord0Buffer,2),this.inputVars.tex1&&e.setInputBuffer(this.inputVars.tex1,t.texCoord1Buffer,2),this.inputVars.tex2&&e.setInputBuffer(this.inputVars.tex2,t.texCoord2Buffer,2),this.inputVars.color&&e.setInputBuffer(this.inputVars.color,t.colorBuffer,4),this.inputVars.tangent&&e.setInputBuffer(this.inputVars.tangent,t.tangentBuffer,3),this.setupVars()},unbind:function(){var t=this.shader;this.inputVars.vertex&&t.disableInputBuffer(this.inputVars.vertex),this.inputVars.normal&&t.disableInputBuffer(this.inputVars.normal),this.inputVars.tex0&&t.disableInputBuffer(this.inputVars.tex0),this.inputVars.tex1&&t.disableInputBuffer(this.inputVars.tex1),this.inputVars.tex2&&t.disableInputBuffer(this.inputVars.tex2),this.inputVars.color&&t.disableInputBuffer(this.inputVars.color),this.inputVars.tangent&&t.disableInputBuffer(this.inputVars.tangent)}},{},t)}(bg.app.ContextObject);bg.base.Effect=e;var i=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t),this._frame=new bg.base.PolyList(t),this._frame.vertex=[1,1,0,-1,1,0,-1,-1,0,1,-1,0],this._frame.texCoord0=[1,1,0,1,0,0,1,0],this._frame.index=[0,1,2,2,3,0],this._frame.build(),this.rebuildShaders()}return $traceurRuntime.createClass(i,{rebuildShaders:function(){
this.setupShaderSource([this.vertexShaderSource,this.fragmentShaderSource])},get vertexShaderSource(){return this._vertexShaderSource||(this._vertexShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),this._vertexShaderSource.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,{name:"fsTexCoord",dataType:"vec2",role:"out"}]),"webgl1"==bg.Engine.Get().id&&this._vertexShaderSource.setMainBody("\n\t\t\t\t\tgl_Position = vec4(inVertex,1.0);\n\t\t\t\t\tfsTexCoord = inTex0;")),this._vertexShaderSource},get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter({name:"fsTexCoord",dataType:"vec2",role:"in"}),"webgl1"==bg.Engine.Get().id&&this._fragmentShaderSource.setMainBody("\n\t\t\t\t\tgl_FragColor = vec4(1.0,0.0,0.0,1.0);")),this._fragmentShaderSource},drawSurface:function(t){this.setActive(),this._surface=t,this.bindPolyList(this._frame),this._frame.draw(),this.unbind(),this.clearActive()}},{},e)}(e);bg.base.TextureEffect=i}(),function(){function t(t,e){var i=void 0!==arguments[2]?arguments[2]:null,n=void 0!==arguments[3]?arguments[3]:null;return new Promise(function(r,a){bg.utils.Resource.Load(e,i).then(function(i){return s.LoadData(t,e,i,n)}).then(function(t,e){r(t,e)}).catch(function(t){a(t)})})}function e(t,e){var n=void 0!==arguments[2]?arguments[2]:null,r=void 0!==arguments[3]?arguments[3]:null;return new Promise(function(s,a){bg.utils.Resource.LoadMultiple(e,n).then(function(e){var n=[];for(var s in e){var a=e[s];n.push(i(t,s,a,r))}return Promise.all(n)}).then(function(t){var i={};e.forEach(function(e,n){i[e]=t[n]}),s(i)}).catch(function(t){a(t)})})}function i(t,e,i){var n=void 0!==arguments[3]?arguments[3]:null;return new Promise(function(s,a){var o=null;if(r.some(function(t){if(t.acceptType(e,i))return o=t,!0}),!o)return a(new Error("No suitable plugin found for load "+e));n||(n={}),s(o.load(t,e,i,n))})}var n=function(){function t(){}return $traceurRuntime.createClass(t,{acceptType:function(t,e){return!1},load:function(t,e,i){return new Promise(function(t,e){e(new Error("Not implemented"))})}},{})}();bg.base.LoaderPlugin=n;var r=[],s=function(){function n(){}return $traceurRuntime.createClass(n,{},{RegisterPlugin:function(t){r.push(t)},Load:function(i,n){var r=void 0!==arguments[2]?arguments[2]:null,s=void 0!==arguments[3]?arguments[3]:null;return Array.isArray(n)?e(i,n,r,s):t(i,n,r,s)},LoadData:function(t,e,n){return i(t,e,n,void 0!==arguments[3]?arguments[3]:null)}})}();bg.base.Loader=s}(),function(){if(!bg.isElectronApp)return!1;var t=function(){function t(){}return $traceurRuntime.createClass(t,{acceptType:function(t,e){return!1},write:function(t,e){}},{})}();bg.base.WriterPlugin=t;var e=[],i=function(){function t(){}return $traceurRuntime.createClass(t,{},{RegisterPlugin:function(t){e.push(t)},Write:function(t,i){return new Promise(function(n,r){var s=null;e.some(function(e){if(e.acceptType(t,i))return s=e,!0}),s?n(s.write(t,i)):r(new Error("No suitable plugin found for write "+t))})},PrepareDirectory:function(e){var i=t.ToSystemPath(e),n=require("fs"),r=require("path"),s=r.sep,a=r.isAbsolute(i)?s:"";i.split(s).reduce(function(t,e){var i=r.resolve(t,e);return n.existsSync(i)||n.mkdirSync(i),i},a)},StandarizePath:function(t){return t.replace(/\\/g,"/")},ToSystemPath:function(t){var e=require("path"),i=e.sep;return t.replace(/\\/g,i).replace(/\//g,i)},CopyFile:function(e,i){return new Promise(function(n,r){var s=require("fs"),a=require("path"),o=!1;if(e=t.StandarizePath(a.resolve(e)),i=t.StandarizePath(a.resolve(i)),e==i)n();else{var c=function(t){o||(t?r(t):n(),o=!0)},u=s.createReadStream(e);u.on("error",function(t){c(t)});var h=s.createWriteStream(i);h.on("error",function(t){c(t)}),h.on("close",function(t){c()}),u.pipe(h)}})}})}();bg.base.Writer=i}(),function(){function t(t,e){if(t){var i=bg.base.Writer.StandarizePath(e.path).split("/");i.pop();var n=t.fileName.split("/").pop();i.push(n),i=i.join("/");var r={src:t.fileName,dst:i};return r.src!=r.dst&&e.copyFiles.push(r),n}return""}function e(e){var i=[];return e.node.drawable.forEach(function(n,r){i.push({name:n.name,class:"GenericMaterial",diffuseR:r.diffuse.r,diffuseG:r.diffuse.g,diffuseB:r.diffuse.b,diffuseA:r.diffuse.a,specularR:r.specular.r,specularG:r.specular.g,specularB:r.specular.b,specularA:r.specular.a,shininess:r.shininess,refractionAmount:r.refractionAmount,reflectionAmount:r.reflectionAmount,lightEmission:r.lightEmission,textureOffsetX:r.textureOffset.x,textureOffsetY:r.textureOffset.y,textureScaleX:r.textureScale.x,textureScaleY:r.textureScale.y,lightmapOffsetX:r.lightmapOffset.x,lightmapOffsetY:r.lightmapOffset.y,lightmapScaleX:r.lightmapScale.x,lightmapScaleY:r.lightmapScale.y,normalMapOffsetX:r.normalMapOffset.x,normalMapOffsetY:r.normalMapOffset.y,normalMapScaleX:r.normalMapScale.x,normalMapScaleY:r.normalMapScale.y,castShadows:r.castShadows,receiveShadows:r.receiveShadows,alphaCutoff:r.alphaCutoff,shininessMaskChannel:r.shininessMaskChannel,invertShininessMask:r.shininessMaskInvert,lightEmissionMaskChannel:r.lightEmissionMaskChannel,invertLightEmissionMask:r.lightEmissionMaskInvert,displacementFactor:0,displacementUV:0,tessDistanceFarthest:40,tessDistanceFar:30,tessDistanceNear:15,tessDistanceNearest:8,tessFarthestLevel:1,tessFarLevel:1,tessNearLevel:1,tessNearestLevel:1,reflectionMaskChannel:r.reflectionMaskChannel,invertReflectionMask:r.reflectionMaskInvert,roughness:r.roughness,roughnessMaskChannel:r.roughnessMaskChannel,invertRoughnessMask:r.roughnessMaskInvert,cullFace:r.cullFace,unlit:r.unlit,texture:t(r.texture,e),lightmap:t(r.lightmap,e),normalMap:t(r.normalMap,e),shininessMask:t(r.shininessMask,e),lightEmissionMask:t(r.lightEmissionMask,e),displacementMap:"",reflectionMask:t(r.reflectionMask,e),roughnessMask:t(r.roughnessMask,e),visible:n.visible,groupName:r.groupName})}),JSON.stringify(i)}function i(t){var e={},i=t.node.component("bg.scene.InputChainJoint"),n=t.node.component("bg.scene.OutputChainJoint");return i&&(e.input={type:"LinkJoint",offset:[i.joint.offset.x,i.joint.offset.y,i.joint.offset.z],pitch:i.joint.pitch,roll:i.joint.roll,yaw:i.joint.yaw}),n&&(e.output=[{type:"LinkJoint",offset:[n.joint.offset.x,n.joint.offset.y,n.joint.offset.z],pitch:n.joint.pitch,roll:n.joint.roll,yaw:n.joint.yaw}]),JSON.stringify(e)}function n(t){var e=[],i=0;t.node.drawable.forEach(function(t,n){var r=t.name;if(!r||-1!=e.indexOf(r)){do{r="polyList_"+i,++i}while(-1!=e.indexOf(r));t.name=r}e.push(r)})}function r(t){var r=new Buffer(4);[0,1,2,0].forEach(function(t,e){return r.writeInt8(t,e)}),t.stream.write(r),t.writeBlock("hedr"),n(t);var s=t.node.drawable,a=0;s.forEach(function(){return a++}),t.writeUInt(a),t.writeBlock("mtrl"),t.writeString(e(t)),t.writeBlock("join"),t.writeString(i(t))}function s(t,e,i,n){t.writeBlock("plst"),t.writeBlock("pnam"),t.writeString(e.name),t.writeBlock("mnam"),t.writeString(e.name),t.writeBuffer("varr",e.vertex),t.writeBuffer("narr",e.normal),t.writeBuffer("t0ar",e.texCoord0),t.writeBuffer("t1ar",e.texCoord1),t.writeBuffer("indx",e.index)}function a(t){r(t),t.node.drawable.forEach(function(e,i,n){s(t,e,i,n)}),t.writeBlock("endf"),t.stream.end()}if(!bg.isElectronApp)return!1;var o=require("fs"),c=(require("path"),function(){function t(t,e){this._path=t,this._node=e,this._copyFiles=[],this._stream=o.createWriteStream(t)}return $traceurRuntime.createClass(t,{get path(){return this._path},get node(){return this._node},get copyFiles(){return this._copyFiles},get stream(){return this._stream},writeUInt:function(t){var e=new Buffer(4);e.writeUInt32BE(t,0),this.stream.write(e)},writeBlock:function(t){this.stream.write(Buffer.from(t,"utf-8"))},writeString:function(t){this.writeUInt(t.length),this.stream.write(Buffer.from(t,"utf-8"))},writeBuffer:function(t,e){this.writeBlock(t),this.writeUInt(e.length);var i=new Buffer(4*e.length);"indx"==t?e.forEach(function(t,e){return i.writeUInt32BE(t,4*e)}):e.forEach(function(t,e){return i.writeFloatBE(t,4*e)}),this.stream.write(i)},writeTextures:function(){var t=[];return this.copyFiles.forEach(function(e){t.push(new Promise(function(t){function i(t){n.destroy(),r.end(),reject(t)}var n=o.createReadStream(e.src);n.on("error",i);var r=o.createWriteStream(e.dst);r.on("error",i),r.on("finish",t),n.pipe(r)}))}),Promise.all(t)}},{})}()),u=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){var i=t.split(".").pop();return/bg2/i.test(i)||/vwglb/i.test(i)},write:function(t,e){return new Promise(function(i,n){(!e||!e instanceof bg.scene.Node||!e.drawable)&&n(new Error("Invalid data format. Expecting scene node."));var r=new c(t,e);try{a(r),r.writeTextures().then(function(){return i()}).catch(function(t){return n(t)})}catch(t){n(t)}})}},{},t)}(bg.base.WriterPlugin);bg.base.Bg2WriterPlugin=u}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){return"bg2mat"==bg.utils.Resource.GetExtension(t)},load:function(t,e,i){return new Promise(function(n,r){if(i)try{"string"==typeof i&&(i=JSON.parse(i));var s=[],a=e.substring(0,e.lastIndexOf("/")+1);i.forEach(function(e){s.push(bg.base.Material.FromMaterialDefinition(t,e,a))}),Promise.all(s).then(function(t){n(t)})}catch(t){r(t)}else r(new Error("Error loading material. Data is null."))})}},{},t)}(bg.base.LoaderPlugin);bg.base.Bg2matLoaderPlugin=t}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e);var n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT);n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,{name:"fsTexCoord",dataType:"vec2",role:"out"}]),r.addParameter([t().inputs.material.texture,{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&(n.setMainBody("\n\t\t\t\tgl_Position = vec4(inVertex,1.0);\n\t\t\t\tfsTexCoord = inTex0;"),r.setMainBody("gl_FragColor = texture2D(inTexture,fsTexCoord);")),this.setupShaderSource([n,r])}return $traceurRuntime.createClass(i,{setupVars:function(){var t=null;this._surface instanceof bg.base.Texture?t=this._surface:this._surface instanceof bg.base.RenderSurface&&(t=this._surface.getTexture(0)),t&&this.shader.setTexture("inTexture",t,bg.base.TextureUnit.TEXTURE_0)}},{},e)}(bg.base.TextureEffect);bg.base.DrawTextureEffect=e}(),function(){function t(){return bg.base.ShaderLibrary.Get()}function e(){return n||(n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.normal,t().inputs.buffers.tangent,t().inputs.buffers.tex0,t().inputs.buffers.tex1]),n.addParameter(t().inputs.matrix.all),n.addParameter([{name:"inLightProjectionMatrix",dataType:"mat4",role:"value"},{name:"inLightViewMatrix",dataType:"mat4",role:"value"}]),n.addParameter([{name:"fsPosition",dataType:"vec3",role:"out"},{name:"fsTex0Coord",dataType:"vec2",role:"out"},{name:"fsTex1Coord",dataType:"vec2",role:"out"},{name:"fsNormal",dataType:"vec3",role:"out"},{name:"fsTangent",dataType:"vec3",role:"out"},{name:"fsBitangent",dataType:"vec3",role:"out"},{name:"fsSurfaceToView",dataType:"vec3",role:"out"},{name:"fsVertexPosFromLight",dataType:"vec4",role:"out"}]),"webgl1"==bg.Engine.Get().id&&n.setMainBody("\n\t\t\t\t\tmat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.0, 0.5, 0.0, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.0, 0.0, 0.5, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.5, 0.5, 0.5, 1.0);\n\t\t\t\t\t\n\t\t\t\t\tvec4 viewPos = inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t\tgl_Position = inProjectionMatrix * viewPos;\n\t\t\t\t\t\n\t\t\t\t\tfsNormal = normalize((inNormalMatrix * vec4(inNormal,1.0)).xyz);\n\t\t\t\t\tfsTangent = normalize((inNormalMatrix * vec4(inTangent,1.0)).xyz);\n\t\t\t\t\tfsBitangent = cross(fsNormal,fsTangent);\n\t\t\t\t\t\n\t\t\t\t\tfsVertexPosFromLight = ScaleMatrix * inLightProjectionMatrix * inLightViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t\t\n\t\t\t\t\tfsTex0Coord = inTex0;\n\t\t\t\t\tfsTex1Coord = inTex1;\n\t\t\t\t\tfsPosition = viewPos.xyz;")),n}function i(){return r||(r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),r.addParameter(t().inputs.material.all),r.addParameter(t().inputs.lightingForward.all),r.addParameter(t().inputs.shadows.all),r.addParameter(t().inputs.colorCorrection.all),r.addParameter([{name:"fsPosition",dataType:"vec3",role:"in"},{name:"fsTex0Coord",dataType:"vec2",role:"in"},{name:"fsTex1Coord",dataType:"vec2",role:"in"},{name:"fsNormal",dataType:"vec3",role:"in"},{name:"fsTangent",dataType:"vec3",role:"in"},{name:"fsBitangent",dataType:"vec3",role:"in"},{name:"fsSurfaceToView",dataType:"vec3",role:"in"},{name:"fsVertexPosFromLight",dataType:"vec4",role:"in"},{name:"inCubeMap",dataType:"samplerCube",role:"value"},{name:"inLightEmissionFactor",dataType:"float",role:"value"}]),r.addFunction(t().functions.materials.all),r.addFunction(t().functions.colorCorrection.all),r.addFunction(t().functions.utils.unpack),r.addFunction(t().functions.utils.random),r.addFunction(t().functions.lighting.all),r.addFunction(t().functions.blur.blurCube),"webgl1"==bg.Engine.Get().id&&r.setMainBody("\n\t\t\t\t\tvec4 diffuseColor = samplerColor(inTexture,fsTex0Coord,inTextureOffset,inTextureScale);\n\t\t\t\t\tif (inUnlit && diffuseColor.a>=inAlphaCutoff) {\n\t\t\t\t\t\tgl_FragColor = diffuseColor;\n\t\t\t\t\t}\n\t\t\t\t\telse if (diffuseColor.a>=inAlphaCutoff) {\n\t\t\t\t\t\tvec4 lightmapColor = samplerColor(inLightMap,fsTex1Coord,inLightMapOffset,inLightMapScale);\n\t\t\t\t\t\tvec3 normalMap = samplerNormal(inNormalMap,fsTex0Coord,inNormalMapOffset,inNormalMapScale);\n\t\t\t\t\t\tnormalMap = combineNormalWithMap(fsNormal,fsTangent,fsBitangent,normalMap);\n\t\t\t\t\t\tvec4 shadowColor = vec4(1.0);\n\t\t\t\t\t\tif (inReceiveShadows) {\n\t\t\t\t\t\t\tshadowColor = getShadowColor(fsVertexPosFromLight,inShadowMap,inShadowMapSize,inShadowType,inShadowStrength,inShadowBias,inShadowColor);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvec4 specular = specularColor(inSpecularColor,inShininessMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinShininessMaskChannel,inShininessMaskInvert);\n\t\t\t\t\t\tfloat lightEmission = applyTextureMask(inLightEmission,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinLightEmissionMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinLightEmissionMaskChannel,inLightEmissionMaskInvert);\n\t\t\t\t\t\tdiffuseColor = diffuseColor * inDiffuseColor * lightmapColor;\n\t\t\t\t\t\t\n\t\t\t\t\t\tvec4 light = vec4(0.0,0.0,0.0,1.0);\n\t\t\t\t\t\tfor (int i=0; i<"+bg.base.MAX_FORWARD_LIGHTS+"; ++i) {\n\t\t\t\t\t\t\tif (i>=inNumLights) break;\n\t\t\t\t\t\t\tlight.rgb += getLight(\n\t\t\t\t\t\t\t\tinLightType[i],\n\t\t\t\t\t\t\t\tinLightAmbient[i], inLightDiffuse[i], inLightSpecular[i],inShininess,\n\t\t\t\t\t\t\t\tinLightPosition[i],inLightDirection[i],\n\t\t\t\t\t\t\t\tinLightAttenuation[i].x,inLightAttenuation[i].y,inLightAttenuation[i].z,\n\t\t\t\t\t\t\t\tinSpotCutoff[i],inSpotExponent[i],inLightCutoffDistance[i],\n\t\t\t\t\t\t\t\tfsPosition,normalMap,\n\t\t\t\t\t\t\t\tdiffuseColor,specular,shadowColor\n\t\t\t\t\t\t\t).rgb;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tvec3 cameraPos = vec3(0.0);\n\t\t\t\t\t\tvec3 cameraVector = fsPosition - cameraPos;\n\t\t\t\t\t\tvec3 lookup = reflect(cameraVector,normalMap);\n\t\t\t\t\t\tfloat dist = distance(fsPosition,cameraPos);\n\t\t\t\t\t\tfloat maxRough = 50.0;\n\t\t\t\t\t\tfloat rough = max(inRoughness * 10.0,1.0);\n\t\t\t\t\t\trough = max(rough*dist,rough);\n\t\t\t\t\t\tfloat blur = min(rough,maxRough);\n\t\t\t\t\t\tvec3 cubemapColor = blurCube(inCubeMap,lookup,int(blur),vec2(10),dist).rgb;\n\n\t\t\t\t\t\tfloat reflectionAmount = applyTextureMask(inReflection,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tinReflectionMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tinReflectionMaskChannel,inReflectionMaskInvert);\n\n\t\t\t\t\t\tlight.rgb = clamp(light.rgb + (lightEmission * diffuseColor.rgb * 10.0), vec3(0.0), vec3(1.0));\n\t\t\t\t\t\tvec3 finalColor = light.rgb * (1.0 - reflectionAmount);\n\t\t\t\t\t\tfinalColor += cubemapColor * reflectionAmount;\n\t\t\t\t\t\tvec4 result = colorCorrection(vec4(finalColor,1.0),inHue,inSaturation,inLightness,inBrightness,inContrast);\n\t\t\t\t\t\tresult.a = diffuseColor.a;\n\t\t\t\t\t\tgl_FragColor = result;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}")),r}var n=null,r=null,s=function(){function t(){this._hue=1,this._saturation=1,this._lightness=1,this._brightness=.5,this._contrast=.5}return $traceurRuntime.createClass(t,{set hue(t){this._hue=t},get hue(){return this._hue},set saturation(t){this._saturation=t},get saturation(){return this._saturation},set lightness(t){this._lightness=t},get lightness(){return this._lightness},set brightness(t){this._brightness=t},get brightness(){return this._brightness},set contrast(t){this._contrast=t},get contrast(){return this._contrast},apply:function(t){var e=void 0!==arguments[1]?arguments[1]:{hue:"inHue",saturation:"inSaturation",lightness:"inLightness",brightness:"inBrightness",contrast:"inContrast"};t.setValueFloat(e.hue,this._hue),t.setValueFloat(e.saturation,this._saturation),t.setValueFloat(e.lightness,this._lightness),t.setValueFloat(e.brightness,this._brightness),t.setValueFloat(e.contrast,this._contrast)}},{})}();bg.base.ColorCorrectionSettings=s;var a=function(t){function n(t){$traceurRuntime.superConstructor(n).call(this,t),this._material=null,this._light=null,this._lightTransform=bg.Matrix4.Identity(),this._lightArray=new bg.base.LightArray,this._shadowMap=null;var r=[e(),i()];this.setupShaderSource(r),this._colorCorrection=new bg.base.ColorCorrectionSettings}return $traceurRuntime.createClass(n,{get material(){return this._material},set material(t){this._material=t},get light(){return this._light},set light(t){this._light=t,this._lightArray.reset()},get lightTransform(){return this._lightTransform},set lightTransform(t){this._lightTransform=t,this._lightArray.reset()},get lightArray(){return this._lightArray},set shadowMap(t){this._shadowMap=t},get shadowMap(){return this._shadowMap},get colorCorrection(){return this._colorCorrection},set colorCorrection(t){this._colorCorrection=t},beginDraw:function(){if(this._light&&(this.lightArray.reset(),this.lightArray.push(this.light,this.lightTransform)),this.lightArray.numLights){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.lightArray.updatePositionAndDirection(e);var i=this.shadowMap?this.shadowMap.viewMatrix:this.lightArray.shadowLightTransform;this.shader.setMatrix4("inLightProjectionMatrix",this.shadowMap?this.shadowMap.projection:this.lightArray.shadowLight.projection);var n=this.shadowMap?this.shadowMap.shadowColor:bg.Color.Transparent(),r=bg.base.TextureCache.BlackTexture(this.context);this.shader.setMatrix4("inLightViewMatrix",i),this.shader.setValueInt("inShadowType",this._shadowMap?this._shadowMap.shadowType:0),this.shader.setTexture("inShadowMap",this._shadowMap?this._shadowMap.texture:r,bg.base.TextureUnit.TEXTURE_5),this.shader.setVector2("inShadowMapSize",this._shadowMap?this._shadowMap.size:new bg.Vector2(32,32)),this.shader.setValueFloat("inShadowStrength",this.lightArray.shadowLight.shadowStrength),this.shader.setVector4("inShadowColor",n),this.shader.setValueFloat("inShadowBias",this.lightArray.shadowLight.shadowBias),this.shader.setValueInt("inCastShadows",this.lightArray.shadowLight.castShadows),this.shader.setVector4Ptr("inLightAmbient",this.lightArray.ambient),this.shader.setVector4Ptr("inLightDiffuse",this.lightArray.diffuse),this.shader.setVector4Ptr("inLightSpecular",this.lightArray.specular),this.shader.setValueIntPtr("inLightType",this.lightArray.type),this.shader.setVector3Ptr("inLightAttenuation",this.lightArray.attenuation),this.shader.setValueFloatPtr("inLightCutoffDistance",this.lightArray.cutoffDistance);this.shader.setValueFloat("inLightEmissionFactor",10),this.shader.setTexture("inCubeMap",bg.scene.Cubemap.Current(this.context),bg.base.TextureUnit.TEXTURE_6),this.shader.setVector3Ptr("inLightDirection",this.lightArray.direction),this.shader.setVector3Ptr("inLightPosition",this.lightArray.position),this.shader.setValueFloatPtr("inSpotCutoff",this.lightArray.spotCutoff),this.shader.setValueFloatPtr("inSpotExponent",this.lightArray.spotExponent),this.shader.setValueInt("inNumLights",this.lightArray.numLights)}else{var s=bg.Color.Black();this.shader.setVector4Ptr("inLightAmbient",s.toArray()),this.shader.setVector4Ptr("inLightDiffuse",s.toArray()),this.shader.setVector4Ptr("inLightSpecular",s.toArray()),this.shader.setVector3Ptr("inLightDirection",new bg.Vector3(0,0,0).toArray()),this.shader.setValueInt("inNumLights",0)}this.colorCorrection.apply(this.shader)},setupVars:function(){if(this.material){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst),this.shader.setMatrix4("inNormalMatrix",t.normalMatrix),this.shader.setMatrix4("inViewMatrixInv",t.viewMatrixInvert);var i=bg.base.TextureCache.WhiteTexture(this.context),n=bg.base.TextureCache.BlackTexture(this.context),r=bg.base.TextureCache.NormalTexture(this.context),s=this.material.texture||i,a=this.material.lightmap||i,o=this.material.normalMap||r,c=this.material.shininessMask||n,u=this.material.lightEmissionMask||i;this.shader.setVector4("inDiffuseColor",this.material.diffuse),this.shader.setVector4("inSpecularColor",this.material.specular),this.shader.setValueFloat("inShininess",this.material.shininess),this.shader.setTexture("inShininessMask",c,bg.base.TextureUnit.TEXTURE_3),this.shader.setVector4("inShininessMaskChannel",this.material.shininessMaskChannelVector),this.shader.setValueInt("inShininessMaskInvert",this.material.shininessMaskInvert),this.shader.setValueFloat("inLightEmission",this.material.lightEmission),this.shader.setTexture("inLightEmissionMask",u,bg.base.TextureUnit.TEXTURE_4),this.shader.setVector4("inLightEmissionMaskChannel",this.material.lightEmissionMaskChannelVector),this.shader.setValueInt("inLightEmissionMaskInvert",this.material.lightEmissionMaskInvert),this.shader.setTexture("inTexture",s,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTextureOffset",this.material.textureOffset),this.shader.setVector2("inTextureScale",this.material.textureScale),this.shader.setTexture("inLightMap",a,bg.base.TextureUnit.TEXTURE_1),this.shader.setVector2("inLightMapOffset",this.material.lightmapOffset),this.shader.setVector2("inLightMapScale",this.material.lightmapScale),this.shader.setTexture("inNormalMap",o,bg.base.TextureUnit.TEXTURE_2),this.shader.setVector2("inNormalMapScale",this.material.normalMapScale),this.shader.setVector2("inNormalMapOffset",this.material.normalMapOffset),this.shader.setValueInt("inReceiveShadows",this.material.receiveShadows);var h=this.material.reflectionMask||i;this.shader.setValueFloat("inReflection",this.material.reflectionAmount),this.shader.setTexture("inReflectionMask",h,bg.base.TextureUnit.TEXTURE_7),this.shader.setVector4("inReflectionMaskChannel",this.material.reflectionMaskChannelVector),this.shader.setValueInt("inReflectionMaskInvert",this.material.reflectionMaskInvert);var l=this.material.roughnessMask||i;this.shader.setValueFloat("inRoughness",this.material.roughness),this.shader.setTexture("inRoughnessMask",l,bg.base.TextureUnit.TEXTURE_8),this.shader.setVector4("inRoughnessMaskChannel",this.material.roughnessMaskChannelVector),this.shader.setValueInt("inRoughnessMaskInvert",this.material.roughnessMaskInvert),this.shader.setValueInt("inSelectMode",!1),this.shader.setValueInt("inUnlit",this.material.unlit)}}},{},t)}(bg.base.Effect);bg.base.ForwardEffect=a,bg.base.MAX_FORWARD_LIGHTS=4}(),function(){bg.base.LightType={DIRECTIONAL:4,SPOT:1,POINT:5,DISABLED:10};var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._enabled=!0,this._type=bg.base.LightType.DIRECTIONAL,this._direction=new bg.Vector3(0,0,-1),this._ambient=new bg.Color(.2,.2,.2,1),this._diffuse=new bg.Color(.9,.9,.9,1),this._specular=bg.Color.White(),this._attenuation=new bg.Vector3(1,.5,.1),this._spotCutoff=20,this._spotExponent=30,this._shadowStrength=.7,this._cutoffDistance=-1,this._castShadows=!0,this._shadowBias=2e-5,this._projection=bg.Matrix4.Ortho(-10,10,-10,10,.5,300)}return $traceurRuntime.createClass(e,{clone:function(t){var e=new bg.base.Light(t||this.context);return e.assign(this),e},assign:function(t){this.enabled=t.enabled,this.type=t.type,this.direction.assign(t.direction),this.ambient.assign(t.ambient),this.diffuse.assign(t.diffuse),this.specular.assign(t.specular),this.attenuation.assign(t.attenuation),this.spotCutoff=t.spotCutoff,this.spotExponent=t.spotExponent,this.shadowStrength=t.shadowStrength,this.cutoffDistance=t.cutoffDistance,this.castShadows=t.castShadows,this.shadowBias=t.shadowBias},get enabled(){return this._enabled},set enabled(t){this._enabled=t},get type(){return this._type},set type(t){this._type=t},get direction(){return this._direction},set direction(t){this._direction=t},get ambient(){return this._ambient},set ambient(t){this._ambient=t},get diffuse(){return this._diffuse},set diffuse(t){this._diffuse=t},get specular(){return this._specular},set specular(t){this._specular=t},get attenuationVector(){return this._attenuation},get constantAttenuation(){return this._attenuation.x},get linearAttenuation(){return this._attenuation.y},get quadraticAttenuation(){return this._attenuation.z},set attenuationVector(t){this._attenuation=t},set constantAttenuation(t){this._attenuation.x=t},set linearAttenuation(t){this._attenuation.y=t},set quadraticAttenuation(t){this._attenuation.z=t},get cutoffDistance(){return this._cutoffDistance},set cutoffDistance(t){this._cutoffDistance=t},get spotCutoff(){return this._spotCutoff},set spotCutoff(t){this._spotCutoff=t},get spotExponent(){return this._spotExponent},set spotExponent(t){this._spotExponent=t},get shadowStrength(){return this._shadowStrength},set shadowStrength(t){this._shadowStrength=t},get castShadows(){return this._castShadows},set castShadows(t){this._castShadows=t},get shadowBias(){return this._shadowBias},set shadowBias(t){this._shadowBias=t},get projection(){return this._projection},set projection(t){this._projection=t},deserialize:function(t){switch(t.lightType){case"kTypeDirectional":this._type=bg.base.LightType.DIRECTIONAL;break;case"kTypeSpot":this._type=bg.base.LightType.SPOT,this._shadowBias=t.shadowBias;break;case"kTypePoint":this._type=bg.base.LightType.POINT}this._ambient=new bg.Color(t.ambient),this._diffuse=new bg.Color(t.diffuse),this._specular=new bg.Color(t.specular),this._attenuation=new bg.Vector3(t.constantAtt,t.linearAtt,t.expAtt),this._spotCutoff=t.spotCutoff||20,this._spotExponent=t.spotExponent||30,this._shadowStrength=t.shadowStrength,this._cutoffDistance=t.cutoffDistance,this._projection=new bg.Matrix4(t.projection),this._castShadows=t.castShadows},serialize:function(t){var e=[];e[bg.base.LightType.DIRECTIONAL]="kTypeDirectional",e[bg.base.LightType.SPOT]="kTypeSpot",e[bg.base.LightType.POINT]="kTypePoint",t.lightType=e[this._type],t.ambient=this._ambient.toArray(),t.diffuse=this._diffuse.toArray(),t.specular=this._specular.toArray(),t.intensity=1,t.constantAtt=this._attenuation.x,t.linearAtt=this._attenuation.y,t.expAtt=this._attenuation.z,t.spotCutoff=this._spotCutoff||20,t.spotExponent=this._spotExponent||30,t.shadowStrength=this._shadowStrength,t.cutoffDistance=this._cutoffDistance,t.projection=this._projection.toArray(),t.castShadows=this._castShadows,t.shadowBias=this._shadowBias||.0029}},{},t)}(bg.app.ContextObject);bg.base.Light=t;var e=function(){function t(){this.reset()}return $traceurRuntime.createClass(t,{get type(){return this._type},get ambient(){return this._ambient},get diffuse(){return this._diffuse},get specular(){return this._specular},get position(){return this._position},get direction(){return this._direction},get rawDirection(){return this._rawDirection},get attenuation(){return this._attenuation},get spotCutoff(){return this._spotCutoff},get spotExponent(){return this._spotExponent},get shadowStrength(){return this._shadowStrength},get cutoffDistance(){return this._cutoffDistance},get numLights(){return this._numLights},get lightTransform(){return this._lightTransform},get shadowLight(){return this._shadowLight||{shadowStrength:0,shadowColor:bg.Color.Black(),shadowBias:0,castShadows:!1,projection:bg.Matrix4.Identity()}},get shadowLightTransform(){return this._shadowLightTransform||bg.Matrix4.Identity()},get shadowLightIndex(){return this._shadowLightIndex},reset:function(){this._type=[],this._ambient=[],this._diffuse=[],this._specular=[],this._position=[],this._direction=[],this._rawDirection=[],this._attenuation=[],this._spotCutoff=[],this._spotExponent=[],this._shadowStrength=[],this._cutoffDistance=[],this._numLights=0,this._lightTransform=[],this._shadowLightTransform=null,this._shadowLightIndex=-1,this._shadowLight=null},push:function(t,e){var i,n,r;return this._numLights!=bg.base.MAX_FORWARD_LIGHTS&&(-1==this._shadowLightIndex&&t.type!=bg.base.LightType.POINT&&t.castShadows&&(this._shadowLightTransform=e,this._shadowLight=t,this._shadowLightIndex=this._numLights),this._type.push(t.type),(i=this._ambient).push.apply(i,$traceurRuntime.spread(t.ambient.toArray())),(n=this._diffuse).push.apply(n,$traceurRuntime.spread(t.diffuse.toArray())),(r=this._specular).push.apply(r,$traceurRuntime.spread(t.specular.toArray())),this._rawDirection.push(t.direction),this._attenuation.push(t.constantAttenuation),this._attenuation.push(t.linearAttenuation),this._attenuation.push(t.quadraticAttenuation),this._spotCutoff.push(t.spotCutoff),this._spotExponent.push(t.spotExponent),this._shadowStrength.push(t.shadowStrength),this._cutoffDistance.push(t.cutoffDistance),this._numLights++,this._lightTransform.push(e),!0)},updatePositionAndDirection:function(t){var e,i;this._direction=[],this._position=[];for(var n=0;n<this._numLights;++n){var r=new bg.Matrix4(t),s=r.mult(this._lightTransform[n]).rotation.multVector(this._rawDirection[n]).xyz;r=new bg.Matrix4(t);var a=r.mult(this._lightTransform[n]).position;(e=this._direction).push.apply(e,$traceurRuntime.spread(s.toArray())),(i=this._position).push.apply(i,$traceurRuntime.spread(a.toArray()))}}},{})}();bg.base.LightArray=e}(),function(){function t(t,e,i){var n=null;return e&&((n=bg.base.TextureCache.Get(t).find(i))||(bg.log("Texture "+i+" not found. Loading texture"),n=new bg.base.Texture(t),n.create(),n.bind(),n.minFilter=bg.base.TextureLoaderPlugin.GetMinFilter(),n.magFilter=bg.base.TextureLoaderPlugin.GetMagFilter(),n.setImage(e),n.fileName=i,bg.base.TextureCache.Get(t).register(i,n))),n}function e(t){return/^(f|ht)tps?:\/\//i.test(t)}function i(t,i,n){var r=null;return i&&(e(i)||("/"!=n.slice(-1)&&(n+="/"),i=""+n+i),(r=bg.base.TextureCache.Get(t).find(i))||(r=new bg.base.Texture(t),r.create(),r.fileName=i,bg.base.TextureCache.Get(t).register(i,r),function(t,e){bg.utils.Resource.Load(t).then(function(i){e.bind(),r.minFilter=bg.base.TextureLoaderPlugin.GetMinFilter(),r.magFilter=bg.base.TextureLoaderPlugin.GetMinFilter(),e.fileName=t,e.setImage(i)})}(i,r))),r}function n(t){return t?t.fileName:""}function r(t){return new bg.Vector4(0==t?1:0,1==t?1:0,2==t?1:0,3==t?1:0)}function s(t){if(!t)return null;switch(t.length){case 2:return new bg.Vector2(t[0],t[1]);case 3:return new bg.Vector3(t[0],t[1],t[2]);case 4:return new bg.Vector4(t[0],t[1],t[2],t[3])}return null}function a(t,e,i,n,r){return new Promise(function(s){if(i)if(/data\:image\/[a-z]+\;base64\,/.test(i)){var a=bg.utils.md5(i)
;c[a]?n[r]=c[a]:(n[r]=bg.base.Texture.FromBase64Image(t,i),c[a]=n[r]),s(n[r])}else{var o=e+i;bg.base.Loader.Load(t,o).then(function(t){n[r]=t,s(t)})}else s()})}bg.base.MaterialFlag={DIFFUSE:1,SPECULAR:2,SHININESS:4,LIGHT_EMISSION:8,REFRACTION_AMOUNT:16,REFLECTION_AMOUNT:32,TEXTURE:64,LIGHT_MAP:128,NORMAL_MAP:256,TEXTURE_OFFSET:512,TEXTURE_SCALE:1024,LIGHT_MAP_OFFSET:2048,LIGHT_MAP_SCALE:4096,NORMAL_MAP_OFFSET:8192,NORMAL_MAP_SCALE:16384,CAST_SHADOWS:32768,RECEIVE_SHADOWS:65536,ALPHA_CUTOFF:1<<17,SHININESS_MASK:1<<18,SHININESS_MASK_CHANNEL:1<<19,SHININESS_MASK_INVERT:1<<20,LIGHT_EMISSION_MASK:1<<21,LIGHT_EMISSION_MASK_CHANNEL:1<<22,LIGHT_EMISSION_MASK_INVERT:1<<23,REFLECTION_MASK:1<<24,REFLECTION_MASK_CHANNEL:1<<25,REFLECTION_MASK_INVERT:1<<26,CULL_FACE:1<<27,ROUGHNESS:1<<28,UNLIT:1<<29};var o=function(){function t(t){this._modifierFlags=0,this._diffuse=bg.Color.White(),this._specular=bg.Color.White(),this._shininess=0,this._lightEmission=0,this._refractionAmount=0,this._reflectionAmount=0,this._texture=null,this._lightmap=null,this._normalMap=null,this._textureOffset=new bg.Vector2,this._textureScale=new bg.Vector2(1),this._lightmapOffset=new bg.Vector2,this._lightmapScale=new bg.Vector2(1),this._normalMapOffset=new bg.Vector2,this._normalMapScale=new bg.Vector2(1),this._castShadows=!0,this._receiveShadows=!0,this._alphaCutoff=.5,this._shininessMask=null,this._shininessMaskChannel=0,this._shininessMaskInvert=!1,this._lightEmissionMask=null,this._lightEmissionMaskChannel=0,this._lightEmissionMaskInvert=!1,this._reflectionMask=null,this._reflectionMaskChannel=0,this._reflectionMaskInvert=!1,this._cullFace=!0,this._roughness=!0,this._roughnessMask=null,this._roughnessMaskChannel=0,this._roughnessMaskInvert=!1,this._unlit=!1,t&&(void 0!==t.diffuseR&&void 0!==t.diffuseG&&void 0!==t.diffuseB&&(this.diffuse=new bg.Color(t.diffuseR,t.diffuseG,t.diffuseB,t.diffuseA?t.diffuseA:1)),void 0!==t.specularR&&void 0!==t.specularG&&void 0!==t.specularB&&(this.specular=new bg.Color(t.specularR,t.specularG,t.specularB,t.specularA?t.specularA:1)),void 0!==t.shininess&&(this.shininess=t.shininess),void 0!==t.lightEmission&&(this.lightEmission=t.lightEmission),void 0!==t.refractionAmount&&(this.refractionAmount=t.refractionAmount),void 0!==t.reflectionAmount&&(this.reflectionAmount=t.reflectionAmount),void 0!==t.texture&&(this.texture=t.texture),void 0!==t.lightmap&&(this.lightmap=t.lightmap),void 0!==t.normalMap&&(this.normalMap=t.normalMap),void 0!==t.textureOffsetX&&void 0!==t.textureOffsetY&&(this.textureOffset=new bg.Vector2(t.textureOffsetX,t.textureOffsetY)),void 0!==t.textureScaleX&&void 0!==t.textureScaleY&&(this.textureScale=new bg.Vector2(t.textureScaleX,t.textureScaleY)),void 0!==t.lightmapOffsetX&&void 0!==t.lightmapOffsetY&&(this.lightmapOffset=new bg.Vector2(t.lightmapOffsetX,t.lightmapOffsetY)),void 0!==t.lightmapScaleX&&void 0!==t.lightmapScaleY&&(this.lightmapScale=new bg.Vector2(t.lightmapScaleX,t.lightmapScaleY)),void 0!==t.normalMapScaleX&&void 0!==t.normalMapScaleY&&(this.normalMapScale=new bg.Vector2(t.normalMapScaleX,t.normalMapScaleY)),void 0!==t.normalMapOffsetX&&void 0!==t.normalMapOffsetY&&(this.normalMapOffset=new bg.Vector2(t.normalMapOffsetX,t.normalMapOffsetY)),void 0!==t.castShadows&&(this.castShadows=t.castShadows),void 0!==t.receiveShadows&&(this.receiveShadows=t.receiveShadows),void 0!==t.alphaCutoff&&(this.alphaCutoff=t.alphaCutoff),void 0!==t.shininessMask&&(this.shininessMask=t.shininessMask),void 0!==t.shininessMaskChannel&&(this.shininessMaskChannel=t.shininessMaskChannel),void 0!==t.invertShininessMask&&(this.shininessMaskInvert=t.invertShininessMask),void 0!==t.lightEmissionMask&&(this.lightEmissionMask=t.lightEmissionMask),void 0!==t.lightEmissionMaskChannel&&(this.lightEmissionMaskChannel=t.lightEmissionMaskChannel),void 0!==t.invertLightEmissionMask&&(this.lightEmissionMaskInvert=t.invertLightEmissionMask),void 0!==t.reflectionMask&&(this.reflectionMask=t.reflectionMask),void 0!==t.reflectionMaskChannel&&(this.reflectionMaskChannel=t.reflectionMaskChannel),void 0!==t.invertReflectionMask&&(this.reflectionMaskInvert=t.reflectionMaskInvert),void 0!==t.roughness&&(this.roughness=t.roughness),void 0!==t.roughnessMask&&(this.roughnessMask=t.roughnessMask),void 0!==t.roughnessMaskChannel&&(this.roughnessMaskChannel=t.roughnessMaskChannel),void 0!==t.invertRoughnessMask&&(this.roughnessMaskInvert=t.roughnessMaskInvert),void 0!==t.unlit&&(this.unlit=t.unlit))}return $traceurRuntime.createClass(t,{get modifierFlags(){return this._modifierFlags},set modifierFlags(t){this._modifierFlags=t},setEnabled:function(t){this._modifierFlags=this._modifierFlags|t},isEnabled:function(t){return 0!=(this._modifierFlags&t)},get diffuse(){return this._diffuse},get specular(){return this._specular},get shininess(){return this._shininess},get lightEmission(){return this._lightEmission},get refractionAmount(){return this._refractionAmount},get reflectionAmount(){return this._reflectionAmount},get texture(){return this._texture},get lightmap(){return this._lightmap},get normalMap(){return this._normalMap},get textureOffset(){return this._textureOffset},get textureScale(){return this._textureScale},get lightmapOffset(){return this._lightmapOffset},get lightmapScale(){return this._lightmapScale},get normalMapOffset(){return this._normalMapOffset},get normalMapScale(){return this._normalMapScale},get castShadows(){return this._castShadows},get receiveShadows(){return this._receiveShadows},get alphaCutoff(){return this._alphaCutoff},get shininessMask(){return this._shininessMask},get shininessMaskChannel(){return this._shininessMaskChannel},get shininessMaskInvert(){return this._shininessMaskInvert},get lightEmissionMask(){return this._lightEmissionMask},get lightEmissionMaskChannel(){return this._lightEmissionMaskChannel},get lightEmissionMaskInvert(){return this._lightEmissionMaskInvert},get reflectionMask(){return this._reflectionMask},get reflectionMaskChannel(){return this._reflectionMaskChannel},get reflectionMaskInvert(){return this._reflectionMaskInvert},get cullFace(){return this._cullFace},get roughness(){return this._roughness},get roughnessMask(){return this._roughnessMask},get roughnessMaskChannel(){return this._roughnessMaskChannel},get roughnessMaskInvert(){return this._roughnessMaskInvert},get unlit(){return this._unlit},set diffuse(t){this._diffuse=t,this.setEnabled(bg.base.MaterialFlag.DIFFUSE)},set specular(t){this._specular=t,this.setEnabled(bg.base.MaterialFlag.SPECULAR)},set shininess(t){isNaN(t)||(this._shininess=t,this.setEnabled(bg.base.MaterialFlag.SHININESS))},set lightEmission(t){isNaN(t)||(this._lightEmission=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_EMISSION))},set refractionAmount(t){isNaN(t)||(this._refractionAmount=t,this.setEnabled(bg.base.MaterialFlag.REFRACTION_AMOUNT))},set reflectionAmount(t){isNaN(t)||(this._reflectionAmount=t,this.setEnabled(bg.base.MaterialFlag.REFLECTION_AMOUNT))},set texture(t){this._texture=t,this.setEnabled(bg.base.MaterialFlag.TEXTURE)},set lightmap(t){this._lightmap=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_MAP)},set normalMap(t){this._normalMap=t,this.setEnabled(bg.base.MaterialFlag.NORMAL_MAP)},set textureOffset(t){this._textureOffset=t,this.setEnabled(bg.base.MaterialFlag.TEXTURE_OFFSET)},set textureScale(t){this._textureScale=t,this.setEnabled(bg.base.MaterialFlag.TEXTURE_SCALE)},set lightmapOffset(t){this._lightmapOffset=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_MAP_OFFSET)},set lightmapScale(t){this._lightmapScale=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_MAP_SCALE)},set normalMapOffset(t){this._normalMapOffset=t,this.setEnabled(bg.base.MaterialFlag.NORMAL_MAP_OFFSET)},set normalMapScale(t){this._normalMapScale=t,this.setEnabled(bg.base.MaterialFlag.NORMAL_MAP_SCALE)},set castShadows(t){this._castShadows=t,this.setEnabled(bg.base.MaterialFlag.CAST_SHADOWS)},set receiveShadows(t){this._receiveShadows=t,this.setEnabled(bg.base.MaterialFlag.RECEIVE_SHADOWS)},set alphaCutoff(t){isNaN(t)||(this._alphaCutoff=t,this.setEnabled(bg.base.MaterialFlag.ALPHA_CUTOFF))},set shininessMask(t){this._shininessMask=t,this.setEnabled(bg.base.MaterialFlag.SHININESS_MASK)},set shininessMaskChannel(t){this._shininessMaskChannel=t,this.setEnabled(bg.base.MaterialFlag.SHININESS_MASK_CHANNEL)},set shininessMaskInvert(t){this._shininessMaskInvert=t,this.setEnabled(bg.base.MaterialFlag.SHININESS_MASK_INVERT)},set lightEmissionMask(t){this._lightEmissionMask=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK)},set lightEmissionMaskChannel(t){this._lightEmissionMaskChannel=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_CHANNEL)},set lightEmissionMaskInvert(t){this._lightEmissionMaskInvert=t,this.setEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_INVERT)},set reflectionMask(t){this._reflectionMask=t,this.setEnabled(bg.base.MaterialFlag.REFLECTION_MASK)},set reflectionMaskChannel(t){this._reflectionMaskChannel=t,this.setEnabled(bg.base.MaterialFlag.REFLECTION_MASK_CHANNEL)},set reflectionMaskInvert(t){this._reflectionMaskInvert=t,this.setEnabled(bg.base.MaterialFlag.REFLECTION_MASK_INVERT)},set cullFace(t){this._cullFace=t,this.setEnabled(bg.base.MaterialFlag.CULL_FACE)},set roughness(t){this._roughness=t,this.setEnabled(bg.base.MaterialFlag.ROUGHNESS)},set roughnessMask(t){this._roughnessMask=t,this.setEnabled(bg.base.MaterialFlag.ROUGHNESS)},set roughnessMaskChannel(t){this._roughnessMaskChannel=t,this.setEnabled(bg.base.MaterialFlag.ROUGHNESS)},set roughnessMaskInvert(t){this._roughnessMaskInvert=t,this.setEnabled(bg.base.MaterialFlag.ROUGHNESS)},set unlit(t){this._unlit=t,this.setEnabled(bg.base.MaterialFlag.UNLIT)},clone:function(){var e=new t;return e.assign(this),e},assign:function(t){this._modifierFlags=t._modifierFlags,this._diffuse=t._diffuse,this._specular=t._specular,this._shininess=t._shininess,this._lightEmission=t._lightEmission,this._refractionAmount=t._refractionAmount,this._reflectionAmount=t._reflectionAmount,this._texture=t._texture,this._lightmap=t._lightmap,this._normalMap=t._normalMap,this._textureOffset=t._textureOffset,this._textureScale=t._textureScale,this._lightmapOffset=t._lightmapOffset,this._lightmapScale=t._lightmapScale,this._normalMapOffset=t._normalMapOffset,this._normalMapScale=t._normalMapScale,this._castShadows=t._castShadows,this._receiveShadows=t._receiveShadows,this._alphaCutoff=t._alphaCutoff,this._shininessMask=t._shininessMask,this._shininessMaskChannel=t._shininessMaskChannel,this._shininessMaskInvert=t._shininessMaskInvert,this._lightEmissionMask=t._lightEmissionMask,this._lightEmissionMaskChannel=t._lightEmissionMaskChannel,this._lightEmissionMaskInvert=t._lightEmissionMaskInvert,this._reflectionMask=t._reflectionMask,this._reflectionMaskChannel=t._reflectionMaskChannel,this._reflectionMaskInvert=t._reflectionMaskInvert,this._cullFace=t._cullFace,this._roughness=t._roughness,this._roughnessMask=t._roughnessMask,this._roughnessMaskChannel=t._roughnessMaskChannel,this._roughnessMaskInvert=t._roughnessMaskInvert,this._unlit=t._unlit}},{})}();bg.base.MaterialModifier=o;var c={},u=function(){function e(){this._diffuse=bg.Color.White(),this._specular=bg.Color.White(),this._shininess=0,this._lightEmission=0,this._refractionAmount=0,this._reflectionAmount=0,this._texture=null,this._lightmap=null,this._normalMap=null,this._textureOffset=new bg.Vector2,this._textureScale=new bg.Vector2(1),this._lightmapOffset=new bg.Vector2,this._lightmapScale=new bg.Vector2(1),this._normalMapOffset=new bg.Vector2,this._normalMapScale=new bg.Vector2(1),this._castShadows=!0,this._receiveShadows=!0,this._alphaCutoff=.5,this._shininessMask=null,this._shininessMaskChannel=0,this._shininessMaskInvert=!1,this._lightEmissionMask=null,this._lightEmissionMaskChannel=0,this._lightEmissionMaskInvert=!1,this._reflectionMask=null,this._reflectionMaskChannel=0,this._reflectionMaskInvert=!1,this._cullFace=!0,this._roughness=0,this._roughnessMask=null,this._roughnessMaskChannel=0,this._roughnessMaskInvert=!1,this._unlit=!1,this._selectMode=!1}return $traceurRuntime.createClass(e,{clone:function(){var t=new e;return t.assign(this),t},assign:function(t){this._diffuse=new bg.Color(t.diffuse),this._specular=new bg.Color(t.specular),this._shininess=t.shininess,this._lightEmission=t.lightEmission,this._refractionAmount=t.refractionAmount,this._reflectionAmount=t.reflectionAmount,this._texture=t.texture,this._lightmap=t.lightmap,this._normalMap=t.normalMap,this._textureOffset=new bg.Vector2(t.textureOffset),this._textureScale=new bg.Vector2(t.textureScale),this._lightmapOffset=new bg.Vector2(t.ligthmapOffset),this._lightmapScale=new bg.Vector2(t.lightmapScale),this._normalMapOffset=new bg.Vector2(t.normalMapOffset),this._normalMapScale=new bg.Vector2(t.normalMapScale),this._castShadows=t.castShadows,this._receiveShadows=t.receiveShadows,this._alphaCutoff=t.alphaCutoff,this._shininessMask=t.shininessMask,this._shininessMaskChannel=t.shininessMaskChannel,this._shininessMaskInvert=t.shininessMaskInvert,this._lightEmissionMask=t.lightEmissionMask,this._lightEmissionMaskChannel=t.lightEmissionMaskChannel,this._lightEmissionMaskInvert=t.lightEmissionMaskInvert,this._reflectionMask=t.reflectionMask,this._reflectionMaskChannel=t.reflectionMaskChannel,this._reflectionMaskInvert=t.reflectionMaskInvert,this._cullFace=t.cullFace,this._roughness=t.roughness,this._roughnessMask=t.roughnessMask,this._roughnessMaskChannel=t.roughnessMaskChannel,this._roughnessMaskInvert=t.roughnessMaskInvert,this._unlit=t.unlit},get isTransparent(){return this._diffuse.a<1},get diffuse(){return this._diffuse},get specular(){return this._specular},get shininess(){return this._shininess},get lightEmission(){return this._lightEmission},get refractionAmount(){return this._refractionAmount},get reflectionAmount(){return this._reflectionAmount},get texture(){return this._texture},get lightmap(){return this._lightmap},get normalMap(){return this._normalMap},get textureOffset(){return this._textureOffset},get textureScale(){return this._textureScale},get lightmapOffset(){return this._lightmapOffset},get lightmapScale(){return this._lightmapScale},get normalMapOffset(){return this._normalMapOffset},get normalMapScale(){return this._normalMapScale},get castShadows(){return this._castShadows},get receiveShadows(){return this._receiveShadows},get alphaCutoff(){return this._alphaCutoff},get shininessMask(){return this._shininessMask},get shininessMaskChannel(){return this._shininessMaskChannel},get shininessMaskInvert(){return this._shininessMaskInvert},get lightEmissionMask(){return this._lightEmissionMask},get lightEmissionMaskChannel(){return this._lightEmissionMaskChannel},get lightEmissionMaskInvert(){return this._lightEmissionMaskInvert},get reflectionMask(){return this._reflectionMask},get reflectionMaskChannel(){return this._reflectionMaskChannel},get reflectionMaskInvert(){return this._reflectionMaskInvert},get cullFace(){return this._cullFace},get roughness(){return this._roughness},get roughnessMask(){return this._roughnessMask},get roughnessMaskChannel(){return this._roughnessMaskChannel},get roughnessMaskInvert(){return this._roughnessMaskInvert},get unlit(){return this._unlit},set diffuse(t){this._diffuse=t},set specular(t){this._specular=t},set shininess(t){isNaN(t)||(this._shininess=t)},set lightEmission(t){isNaN(t)||(this._lightEmission=t)},set refractionAmount(t){this._refractionAmount=t},set reflectionAmount(t){this._reflectionAmount=t},set texture(t){this._texture=t},set lightmap(t){this._lightmap=t},set normalMap(t){this._normalMap=t},set textureOffset(t){this._textureOffset=t},set textureScale(t){this._textureScale=t},set lightmapOffset(t){this._lightmapOffset=t},set lightmapScale(t){this._lightmapScale=t},set normalMapOffset(t){this._normalMapOffset=t},set normalMapScale(t){this._normalMapScale=t},set castShadows(t){this._castShadows=t},set receiveShadows(t){this._receiveShadows=t},set alphaCutoff(t){isNaN(t)||(this._alphaCutoff=t)},set shininessMask(t){this._shininessMask=t},set shininessMaskChannel(t){this._shininessMaskChannel=t},set shininessMaskInvert(t){this._shininessMaskInvert=t},set lightEmissionMask(t){this._lightEmissionMask=t},set lightEmissionMaskChannel(t){this._lightEmissionMaskChannel=t},set lightEmissionMaskInvert(t){this._lightEmissionMaskInvert=t},set reflectionMask(t){this._reflectionMask=t},set reflectionMaskChannel(t){this._reflectionMaskChannel=t},set reflectionMaskInvert(t){this._reflectionMaskInvert=t},set cullFace(t){this._cullFace=t},set roughness(t){this._roughness=t},set roughnessMask(t){this._roughnessMask=t},set roughnessMaskChannel(t){this._roughnessMaskChannel=t},set roughnessMaskInvert(t){this._roughnessMaskInvert=t},get unlit(){return this._unlit},set unlit(t){this._unlit=t},get selectMode(){return this._selectMode},set selectMode(t){this._selectMode=t},get lightEmissionMaskChannelVector(){return r(this.lightEmissionMaskChannel)},get shininessMaskChannelVector(){return r(this.shininessMaskChannel)},get reflectionMaskChannelVector(){return r(this.reflectionMaskChannel)},get roughnessMaskChannelVector(){return r(this.roughnessMaskChannel)},copyMaterialSettings:function(t,e){e&bg.base.MaterialFlag.DIFFUSE&&(t.diffuse=this.diffuse),e&bg.base.MaterialFlag.SPECULAR&&(t.specular=this.specular),e&bg.base.MaterialFlag.SHININESS&&(t.shininess=this.shininess),e&bg.base.MaterialFlag.LIGHT_EMISSION&&(t.lightEmission=this.lightEmission),e&bg.base.MaterialFlag.REFRACTION_AMOUNT&&(t.refractionAmount=this.refractionAmount),e&bg.base.MaterialFlag.REFLECTION_AMOUNT&&(t.reflectionAmount=this.reflectionAmount),e&bg.base.MaterialFlag.TEXTURE&&(t.texture=this.texture),e&bg.base.MaterialFlag.LIGHT_MAP&&(t.lightmap=this.lightmap),e&bg.base.MaterialFlag.NORMAL_MAP&&(t.normalMap=this.normalMap),e&bg.base.MaterialFlag.TEXTURE_OFFSET&&(t.textureOffset=this.textureOffset),e&bg.base.MaterialFlag.TEXTURE_SCALE&&(t.textureScale=this.textureScale),e&bg.base.MaterialFlag.LIGHT_MAP_OFFSET&&(t.lightmapOffset=this.lightmapOffset),e&bg.base.MaterialFlag.LIGHT_MAP_SCALE&&(t.lightmapScale=this.lightmapScale),e&bg.base.MaterialFlag.NORMAL_MAP_OFFSET&&(t.normalMapOffset=this.normalMapOffset),e&bg.base.MaterialFlag.NORMAL_MAP_SCALE&&(t.normalMapScale=this.normalMapScale),e&bg.base.MaterialFlag.CAST_SHADOWS&&(t.castShadows=this.castShadows),e&bg.base.MaterialFlag.RECEIVE_SHADOWS&&(t.receiveShadows=this.receiveShadows),e&bg.base.MaterialFlag.ALPHA_CUTOFF&&(t.alphaCutoff=this.alphaCutoff),e&bg.base.MaterialFlag.SHININESS_MASK&&(t.shininessMask=this.shininessMask),e&bg.base.MaterialFlag.SHININESS_MASK_CHANNEL&&(t.shininessMaskChannel=this.shininessMaskChannel),e&bg.base.MaterialFlag.SHININESS_MASK_INVERT&&(t.shininessMaskInvert=this.shininessMaskInvert),e&bg.base.MaterialFlag.LIGHT_EMISSION_MASK&&(t.lightEmissionMask=this.lightEmissionMask),e&bg.base.MaterialFlag.LIGHT_EMISSION_MASK_CHANNEL&&(t.lightEmissionMaskChannel=this.lightEmissionMaskChannel),e&bg.base.MaterialFlag.LIGHT_EMISSION_MASK_INVERT&&(t.lightEmissionMaskInvert=this.lightEmissionMaskInvert),e&bg.base.MaterialFlag.REFLECTION_MASK&&(t.reflectionMask=this.reflectionMask),e&bg.base.MaterialFlag.REFLECTION_MASK_CHANNEL&&(t.reflectionMaskChannel=this.reflectionMaskChannel),e&bg.base.MaterialFlag.REFLECTION_MASK_INVERT&&(t.reflectionMaskInvert=this.reflectionMaskInvert),e&bg.base.MaterialFlag.CULL_FACE&&(t.cullFace=this.cullFace),e&bg.base.MaterialFlag.ROUGHNESS&&(t.reflectionAmount=this.reflectionAmount,t.reflectionMask=this.reflectionMask,t.reflectionMaskChannel=this.reflectionMaskChannel,t.reflectionMaskInvert=this.reflectionMaskInvert),e&bg.base.MaterialFlag.UNLIT&&(t.unlit=this.unlit)},applyModifier:function(t,e,n){e.isEnabled(bg.base.MaterialFlag.DIFFUSE)&&(this.diffuse=e.diffuse),e.isEnabled(bg.base.MaterialFlag.SPECULAR)&&(this.specular=e.specular),e.isEnabled(bg.base.MaterialFlag.SHININESS)&&(this.shininess=e.shininess),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION)&&(this.lightEmission=e.lightEmission),e.isEnabled(bg.base.MaterialFlag.REFRACTION_AMOUNT)&&(this.refractionAmount=e.refractionAmount),e.isEnabled(bg.base.MaterialFlag.REFLECTION_AMOUNT)&&(this.reflectionAmount=e.reflectionAmount),e.isEnabled(bg.base.MaterialFlag.TEXTURE)&&(this.texture=i(t,e.texture,n)),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP)&&(this.lightmap=i(t,e.lightmap,n)),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP)&&(this.normalMap=i(t,e.normalMap,n)),e.isEnabled(bg.base.MaterialFlag.TEXTURE_OFFSET)&&(this.textureOffset=e.textureOffset),e.isEnabled(bg.base.MaterialFlag.TEXTURE_SCALE)&&(this.textureScale=e.textureScale),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP_OFFSET)&&(this.lightmapOffset=e.lightmapOffset),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP_SCALE)&&(this.lightmapScale=e.lightmapScale),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP_OFFSET)&&(this.normalMapOffset=e.normalMapOffset),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP_SCALE)&&(this.normalMapScale=e.normalMapScale),e.isEnabled(bg.base.MaterialFlag.CAST_SHADOWS)&&(this.castShadows=e.castShadows),e.isEnabled(bg.base.MaterialFlag.RECEIVE_SHADOWS)&&(this.receiveShadows=e.receiveShadows),e.isEnabled(bg.base.MaterialFlag.ALPHA_CUTOFF)&&(this.alphaCutoff=e.alphaCutoff),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK)&&(this.shininessMask=i(t,e.shininessMask,n)),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK_CHANNEL)&&(this.shininessMaskChannel=e.shininessMaskChannel),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK_INVERT)&&(this.shininessMaskInvert=e.shininessMaskInvert),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK)&&(this.lightEmissionMask=i(t,e.lightEmissionMask,n)),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_CHANNEL)&&(this.lightEmissionMaskChannel=e.lightEmissionMaskChannel),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_INVERT)&&(this.lightEmissionMaskInvert=e.lightEmissionMaskInvert),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK)&&(this.reflectionMask=i(t,e.reflectionMask,n)),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK_CHANNEL)&&(this.reflectionMaskChannel=e.reflectionMaskChannel),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK_INVERT)&&(this.reflectionMaskInvert=e.reflectionMaskInvert),e.isEnabled(bg.base.MaterialFlag.CULL_FACE)&&(this.cullFace=e.cullFace),e.isEnabled(bg.base.MaterialFlag.ROUGHNESS)&&(this.roughness=e.roughness,this.roughnessMask=i(t,e.roughnessMask,n),this.roughnessMaskChannel=e.roughnessMaskChannel,this.roughnessMaskInvert=e.roughnessMaskInvert),e.isEnabled(bg.base.MaterialFlag.UNLIT)&&(this.unlit=e.unlit)},getModifierWithMask:function(t){var e=new o;e.isEnabled(bg.base.MaterialFlag.DIFFUSE)&&(e.diffuse=this.diffuse),e.isEnabled(bg.base.MaterialFlag.SPECULAR)&&(e.specular=this.specular),e.isEnabled(bg.base.MaterialFlag.SHININESS)&&(e.shininess=this.shininess),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION)&&(e.lightEmission=this.lightEmission),e.isEnabled(bg.base.MaterialFlag.REFRACTION_AMOUNT)&&(e.refractionAmount=this.refractionAmount),e.isEnabled(bg.base.MaterialFlag.REFLECTION_AMOUNT)&&(e.reflectionAmount=this.reflectionAmount),e.isEnabled(bg.base.MaterialFlag.TEXTURE)&&(e.texture=n(this.texture)),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP)&&(e.lightmap=n(this.lightmap)),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP)&&(e.normalMap=n(this.normalMap)),e.isEnabled(bg.base.MaterialFlag.TEXTURE_OFFSET)&&(e.textureOffset=this.textureOffset),e.isEnabled(bg.base.MaterialFlag.TEXTURE_SCALE)&&(e.textureScale=this.textureScale),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP_OFFSET)&&(e.lightmapOffset=this.lightmapOffset),e.isEnabled(bg.base.MaterialFlag.LIGHT_MAP_SCALE)&&(e.lightmapScale=this.lightmapScale),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP_OFFSET)&&(e.normalMapOffset=this.normalMapOffset),e.isEnabled(bg.base.MaterialFlag.NORMAL_MAP_SCALE)&&(e.normalMapScale=this.normalMapScale),e.isEnabled(bg.base.MaterialFlag.CAST_SHADOWS)&&(e.castShadows=this.castShadows),e.isEnabled(bg.base.MaterialFlag.RECEIVE_SHADOWS)&&(e.receiveShadows=this.receiveShadows),e.isEnabled(bg.base.MaterialFlag.ALPHA_CUTOFF)&&(e.alphaCutoff=this.alphaCutoff),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK)&&(e.shininessMask=n(this.shininessMask)),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK_CHANNEL)&&(e.shininessMaskChannel=this.shininessMaskChannel),e.isEnabled(bg.base.MaterialFlag.SHININESS_MASK_INVERT)&&(e.shininessMaskInvert=this.shininessMaskInvert),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK)&&(e.lightEmissionMask=n(this.lightEmissionMask)),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_CHANNEL)&&(e.lightEmissionMaskChannel=this.lightEmissionMaskChannel),e.isEnabled(bg.base.MaterialFlag.LIGHT_EMISSION_MASK_INVERT)&&(e.lightEmissionMaskInver=this.lightEmissionMaskInver),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK)&&(e.reflectionMask=n(this.reflectionMask)),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK_CHANNEL)&&(e.reflectionMaskChannel=this.reflectionMaskChannel),e.isEnabled(bg.base.MaterialFlag.REFLECTION_MASK_INVERT)&&(e.reflectionMaskInvert=this.reflectionMaskInvert),e.isEnabled(bg.base.MaterialFlag.CULL_FACE)&&(e.cullFace=this.cullFace),e.isEnabled(bg.base.MaterialFlag.ROUGHNESS)&&(e.roughness=this.roughness,e.roughnessMask=n(this.roughnessMask),e.roughnessMaskChannel=this.roughnessMaskChannel,e.roughnessMaskInvert=this.roughnessMaskInvert),e.isEnabled(bg.base.MaterialFlag.UNLIT)&&(e.unlit=this.unlit),e.setFlags(t)}},{FromMaterialDefinition:function(t,i){var n=void 0!==arguments[2]?arguments[2]:"";return new Promise(function(r,o){var c=new e;c.diffuse=s(i.diffuse)||bg.Color.White(),c.specular=s(i.specular)||bg.Color.White(),c.shininess=i.shininess||0,c.shininessMaskChannel=i.shininessMaskChannel||0,c.shininessMaskInvert=i.shininessMaskInvert||!1,c.lightEmission=i.lightEmission||0,c.lightEmissionMaskChannel=i.lightEmissionMaskChannel||0,c.lightEmissionMaskInvert=i.lightEmissionMaskInvert||!1,c.refractionAmount=i.refractionAmount||0,c.reflectionAmount=i.reflectionAmount||0,c.reflectionMaskChannel=i.reflectionMaskChannel||0,c.reflectionMaskInvert=i.reflectionMaskInvert||!1,c.textureOffset=s(i.textureOffset)||new bg.Vector2(0,0),c.textureScale=s(i.textureScale)||new bg.Vector2(1,1),c.normalMapOffset=s(i.normalMapOffset)||new bg.Vector2(0,0),c.normalMapScale=s(i.normalMapScale)||new bg.Vector2(1,1),c.cullFace=void 0===i.cullFace||i.cullFace,c.castShadows=void 0===i.castShadows||i.castShadows,c.receiveShadows=void 0===i.receiveShadows||i.receiveShadows,c.alphaCutoff=void 0===i.alphaCutoff?.5:i.alphaCutoff,c.name=i.name,c.description=i.description,c.roughness=i.roughness||0,c.roughnessMaskChannel=i.roughnessMaskChannel||0,c.roughnessMaskInvert=i.roughnessMaskInvert||!1,c.unlit=i.unlit||!1;var u=[];u.push(a(t,n,i.shininessMask,c,"shininessMask")),u.push(a(t,n,i.lightEmissionMask,c,"lightEmissionMask")),u.push(a(t,n,i.reflectionMask,c,"reflectionMask")),u.push(a(t,n,i.texture,c,"texture")),u.push(a(t,n,i.normalMap,c,"normalMap")),u.push(a(t,n,i.roughnessMask,c,"roughnessMask")),Promise.all(u).then(function(){r(c)})})},GetMaterialWithJson:function(i,n,r){function s(t,e){return e?t?t+e:e:null}var a=new e;return void 0===n.cullFace&&(n.cullFace=!0),a.diffuse.set(n.diffuseR,n.diffuseG,n.diffuseB,n.diffuseA),a.specular.set(n.specularR,n.specularG,n.specularB,n.specularA),a.shininess=n.shininess,a.lightEmission=n.lightEmission,a.refractionAmount=n.refractionAmount,a.reflectionAmount=n.reflectionAmount,a.textureOffset.set(n.textureOffsetX,n.textureOffsetY),a.textureScale.set(n.textureScaleX,n.textureScaleY),a.lightmapOffset.set(n.lightmapOffsetX,n.lightmapOffsetY),a.lightmapScale.set(n.lightmapScaleX,n.lightmapScaleY),a.normalMapOffset.set(n.normalMapOffsetX,n.normalMapOffsetY),a.normalMapScale.set(n.normalMapScaleX,n.normalMapScaleY),a.alphaCutoff=n.alphaCutoff,a.castShadows=n.castShadows,a.receiveShadows=n.receiveShadows,a.shininessMaskChannel=n.shininessMaskChannel,a.shininessMaskInvert=n.invertShininessMask,a.lightEmissionMaskChannel=n.lightEmissionMaskChannel,a.lightEmissionMaskInvert=n.invertLightEmissionMask,a.reflectionMaskChannel=n.reflectionMaskChannel,a.reflectionMaskInvert=n.invertReflectionMask,a.roughness=n.roughness,a.roughnessMaskChannel=n.roughnessMaskChannel,a.roughnessMaskInvert=n.invertRoughnessMask,a.cullFace=n.cullFace,a.unlit=n.unlit,r&&"/"!=r[r.length-1]&&(r+="/"),n.texture=s(r,n.texture),n.lightmap=s(r,n.lightmap),n.normalMap=s(r,n.normalMap),n.shininessMask=s(r,n.shininessMask),n.lightEmissionMask=s(r,n.lightEmissionMask),n.reflectionMask=s(r,n.reflectionMask),n.roughnessMask=s(r,n.roughnessMask),new Promise(function(e,r){var s=[];n.texture&&s.push(n.texture),n.lightmap&&-1==s.indexOf(n.lightmap)&&s.push(n.lightmap),n.normalMap&&-1==s.indexOf(n.normalMap)&&s.push(n.normalMap),n.shininessMask&&-1==s.indexOf(n.shininessMask)&&s.push(n.shininessMask),n.lightEmissionMask&&-1==s.indexOf(n.lightEmissionMask)&&s.push(n.lightEmissionMask),n.reflectionMask&&-1==s.indexOf(n.reflectionMask)&&s.push(n.reflectionMask),n.roughnessMask&&-1==s.indexOf(n.roughnessMask)&&s.push(n.roughnessMask),bg.utils.Resource.Load(s).then(function(r){a.texture=t(i,r[n.texture],n.texture),a.lightmap=t(i,r[n.lightmap],n.lightmap),a.normalMap=t(i,r[n.normalMap],n.normalMap),a.shininessMask=t(i,r[n.shininessMask],n.shininessMask),a.lightEmissionMask=t(i,r[n.lightEmissionMask],n.lightEmissionMask),a.reflectionMask=t(i,r[n.reflectionMask],n.reflectionMask),a.roughnessMask=t(i,r[n.roughnessMask],n.roughnessMask),e(a)})})}})}();bg.base.Material=u}(),function(){var t=function(){function t(){this._matrix=bg.Matrix4.Identity(),this._stack=[],this._changed=!0}return $traceurRuntime.createClass(t,{get changed(){return this._changed},set changed(t){this._changed=t},push:function(){this._stack.push(new bg.Matrix4(this._matrix))},set:function(t){return this._matrix.assign(t),this._changed=!0,this},mult:function(t){return this._matrix.mult(t),this._changed=!0,this},identity:function(){return this._matrix.identity(),this._changed=!0,this},translate:function(t,e,i){return this._matrix.translate(t,e,i),this._changed=!0,this},rotate:function(t,e,i,n){return this._matrix.rotate(t,e,i,n),this._changed=!0,this},scale:function(t,e,i){return this._matrix.scale(t,e,i),this._changed=!0,this},setScale:function(t,e,i){return this._matrix.setScale(t,e,i),this._changed=!0,this},perspective:function(t,e,i,n){return this._matrix.identity().perspective(t,e,i,n),this._changed=!0,this},frustum:function(t,e,i,n,r,s){return this._matrix.identity().frustum(t,e,i,n,r,s),this._changed=!0,this},ortho:function(t,e,i,n,r,s){return this._matrix.identity().ortho(t,e,i,n,r,s),this._changed=!0,this},invert:function(){return this._matrix.invert(),this._changed=!0,this},get matrix(){return this._changed=!0,this._matrix},get matrixConst(){return this._matrix},pop:function(){return this._stack.length&&(this._matrix.assign(this._stack.pop()),this._changed=!0),this._matrix}},{})}();bg.base.MatrixStack=t;var e=null,i=function(){function i(){this._modelMatrixStack=new t,this._viewMatrixStack=new t,this._projectionMatrixStack=new t,this._modelViewMatrix=bg.Matrix4.Identity(),this._normalMatrix=bg.Matrix4.Identity(),this._cameraDistanceScale=null}return $traceurRuntime.createClass(i,{get modelMatrixStack(){return this._modelMatrixStack},get viewMatrixStack(){return this._viewMatrixStack},get projectionMatrixStack(){return this._projectionMatrixStack},get modelViewMatrix(){return(!this._modelViewMatrix||this._modelMatrixStack.changed||this._viewMatrixStack.changed)&&(this._modelViewMatrix=new bg.Matrix4(this._viewMatrixStack._matrix),this._modelViewMatrix.mult(this._modelMatrixStack._matrix),this._modelMatrixStack.changed=!1,this._viewMatrixStack.changed=!1),this._modelViewMatrix},get normalMatrix(){return(!this._normalMatrix||this._modelMatrixStack.changed||this._viewMatrixStack.changed)&&(this._normalMatrix=new bg.Matrix4(this.modelViewMatrix),this._normalMatrix.invert(),this._normalMatrix.traspose(),this._modelMatrixStack.changed=!1),this._normalMatrix},get viewMatrixInvert(){
return this._viewMatrixInvert&&!this._viewMatrixStack.changed||(this._viewMatrixInvert=new bg.Matrix4(this.viewMatrixStack.matrixConst),this._viewMatrixInvert.invert()),this._viewMatrixInvert},get cameraDistanceScale(){return this._cameraDistanceScale=this._viewMatrixStack.matrix.position.magnitude()}},{Current:function(){return e||(e=new i),e},SetCurrent:function(t){return e=t}})}();bg.base.MatrixState=i}(),function(){function t(t){t._effect&&t._effect.setActive(),t.renderSurface.setActive(),bg.Engine.Get().pipeline.setViewport(t.context,t._viewport),bg.Engine.Get().pipeline.setDepthTestEnabled(t.context,t._depthTest),bg.Engine.Get().pipeline.setCullFace(t.context,t._cullFace),bg.Engine.Get().pipeline.setBlendEnabled(t.context,t._blend),bg.Engine.Get().pipeline.setBlendMode(t.context,t._blendMode)}bg.base.ClearBuffers={COLOR:null,DEPTH:null,COLOR_DEPTH:null},bg.base.BlendMode={NORMAL:1,MULTIPLY:2,ADD:3,SUBTRACT:4,ALPHA_ADD:5,ALPHA_SUBTRACT:6},bg.base.OpacityLayer={TRANSPARENT:1,OPAQUE:2,GIZMOS:4,SELECTION:8,GIZMOS_SELECTION:16,ALL:15,NONE:0};var e=function(){function t(t){this.initFlags(t),bg.base.ClearBuffers.COLOR_DEPTH=bg.base.ClearBuffers.COLOR|bg.base.ClearBuffers.DEPTH}return $traceurRuntime.createClass(t,{initFlags:function(t){},setViewport:function(t,e){},clearBuffers:function(t,e,i){},setDepthTestEnabled:function(t,e){},setBlendEnabled:function(t,e){},setBlendMode:function(t,e){},setCullFace:function(t,e){}},{})}();bg.base.PipelineImpl=e;var i=null,n=function(e){function n(t){$traceurRuntime.superConstructor(n).call(this,t),this._opacityLayer=bg.base.OpacityLayer.ALL,this._viewport=new bg.Viewport(0,0,200,200),this._clearColor=bg.Color.Black(),this._effect=null,this._textureEffect=null,this._depthTest=!0,this._cullFace=!0,this._renderSurface=null,this._blend=!1,this._blendMode=bg.base.BlendMode.NORMAL,this._buffersToClear=bg.base.ClearBuffers.COLOR_DEPTH}return $traceurRuntime.createClass(n,{get isCurrent(){return i==this},set opacityLayer(t){this._opacityLayer=t},get opacityLayer(){return this._opacityLayer},shouldDraw:function(t){return t&&(t.isTransparent&&0!=(this._opacityLayer&bg.base.OpacityLayer.TRANSPARENT)||!t.isTransparent&&0!=(this._opacityLayer&bg.base.OpacityLayer.OPAQUE))},get effect(){return this._effect},set effect(t){this._effect=t,this._effect&&this.isCurrent&&this._effect.setActive()},get textureEffect(){return this._textureEffect||(this._textureEffect=new bg.base.DrawTextureEffect(this.context)),this._textureEffect},set textureEffect(t){this._textureEffect=t},set buffersToClear(t){this._buffersToClear=t},get buffersToClear(){return this._buffersToClear},get renderSurface(){return this._renderSurface||(this._renderSurface=new bg.base.ColorSurface(this.context),this._renderSurface.setActive()),this._renderSurface},set renderSurface(t){this._renderSurface=t,this.isCurrent&&this._renderSurface.setActive()},draw:function(t){if(this._effect&&t&&this.isCurrent){var e=this.cullFace;this._effect.bindPolyList(t),this._effect.material&&(this.cullFace=this._effect.material.cullFace),t.draw(),this._effect.unbind(),this.cullFace=e}},drawTexture:function(t){var e=this.depthTest;this.depthTest=!1,this.textureEffect.drawSurface(t),this.depthTest=e},get blend(){return this._blend},set blend(t){this._blend=t,this.isCurrent&&bg.Engine.Get().pipeline.setBlendEnabled(this.context,this._blend)},get blendMode(){return this._blendMode},set blendMode(t){this._blendMode=t,this.isCurrent&&bg.Engine.Get().pipeline.setBlendMode(this.context,this._blendMode)},get viewport(){return this._viewport},set viewport(t){this._viewport=t,this.renderSurface.resizeOnViewportChanged&&(this.renderSurface.size=new bg.Vector2(t.width,t.height)),this.isCurrent&&bg.Engine.Get().pipeline.setViewport(this.context,this._viewport)},clearBuffers:function(t){this.isCurrent&&(t=void 0!==t?t:this._buffersToClear,bg.Engine.Get().pipeline.clearBuffers(this.context,this._clearColor,t))},get clearColor(){return this._clearColor},set clearColor(t){this._clearColor=t},get depthTest(){return this._depthTest},set depthTest(t){this._depthTest=t,this.isCurrent&&bg.Engine.Get().pipeline.setDepthTestEnabled(this.context,this._depthTest)},get cullFace(){return this._cullFace},set cullFace(t){this._cullFace=t,this.isCurrent&&bg.Engine.Get().pipeline.setCullFace(this.context,this._cullFace)}},{SetCurrent:function(e){(i=e)&&t(i)},Current:function(){return i}},e)}(bg.app.ContextObject);bg.base.Pipeline=n}(),function(){function t(t){if(t.texCoord0&&t.vertex){t._tangent=[];var e=[],i={};if(t.index.length%3==0)for(var n=0;n<t.index.length-2;n+=3){var r=3*t.index[n],s=3*t.index[n+1],a=3*t.index[n+2],o=2*t.index[n],c=2*t.index[n+1],u=2*t.index[n+2],h=new bg.Vector3(t.vertex[r],t.vertex[r+1],t.vertex[r+2]),l=new bg.Vector3(t.vertex[s],t.vertex[s+1],t.vertex[s+2]),f=new bg.Vector3(t.vertex[a],t.vertex[a+1],t.vertex[a+2]),b=new bg.Vector2(t.texCoord0[o],t.texCoord0[o+1]),g=new bg.Vector2(t.texCoord0[c],t.texCoord0[c+1]),m=new bg.Vector2(t.texCoord0[u],t.texCoord0[u+1]),p=new bg.Vector3(l).sub(h),d=new bg.Vector3(f).sub(h),_=g.x-b.x,v=g.y-b.y,x=m.x-b.x,T=m.y-b.y,M=1/(_*T-x*v),S=new bg.Vector3(M*(T*p.x-v*d.x),M*(T*p.y-v*d.y),M*(T*p.z-v*d.z));S.normalize(),void 0===i[r]&&(e.push(S.x),e.push(S.y),e.push(S.z),i[r]=S),void 0===i[s]&&(e.push(S.x),e.push(S.y),e.push(S.z),i[s]=S),void 0===i[a]&&(e.push(S.x),e.push(S.y),e.push(S.z),i[a]=S)}else for(var E=0;E<t.vertex.length;E+=3)t._tangent.push(0,0,1);return e}}bg.base.BufferType={VERTEX:1,NORMAL:2,TEX_COORD_0:4,TEX_COORD_1:8,TEX_COORD_2:16,COLOR:32,TANGENT:64,INDEX:128};var e=function(){function t(t){this.initFlags(t)}return $traceurRuntime.createClass(t,{initFlags:function(t){},create:function(t){},build:function(t,e,i,n,r,s,a,o,c,u){return!1},draw:function(t,e,i,n){},destroy:function(t,e){},update:function(t,e,i,n){}},{})}();bg.base.PolyListImpl=e,bg.base.DrawMode={TRIANGLES:null,TRIANGLE_FAN:null,TRIANGLE_STRIP:null,LINES:null,LINE_STRIP:null};var i=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t),this._plist=null,this._drawMode=bg.base.DrawMode.TRIANGLES,this._name="",this._groupName="",this._visible=!0,this._vertex=[],this._normal=[],this._texCoord0=[],this._texCoord1=[],this._texCoord2=[],this._color=[],this._tangent=[],this._index=[]}return $traceurRuntime.createClass(i,{clone:function(){var t=new i(this.context),e=function(t,e){t.forEach(function(t){e.push(t)})};return t.name=this.name+" clone",t.groupName=this.groupName,t.visible=this.visible,t.drawMode=this.drawMode,e(this.vertex,t.vertex),e(this.normal,t.normal),e(this.texCoord0,t.texCoord0),e(this.texCoord1,t.texCoord1),e(this.texCoord2,t.texCoord02),e(this.color,t.color),e(this.index,t.index),t.build(),t},get name(){return this._name},set name(t){this._name=t},get groupName(){return this._groupName},set groupName(t){this._groupName=t},get visible(){return this._visible},set visible(t){this._visible=t},get drawMode(){return this._drawMode},set drawMode(t){this._drawMode=t},set vertex(t){this._vertex=t},set normal(t){this._normal=t},set texCoord0(t){this._texCoord0=t},set texCoord1(t){this._texCoord1=t},set texCoord2(t){this._texCoord2=t},set color(t){this._color=t},set index(t){this._index=t},get vertex(){return this._vertex},get normal(){return this._normal},get texCoord0(){return this._texCoord0},get texCoord1(){return this._texCoord1},get texCoord2(){return this._texCoord2},get color(){return this._color},get tangent(){return this._tangent},get index(){return this._index},get vertexBuffer(){return this._plist.vertexBuffer},get normalBuffer(){return this._plist.normalBuffer},get texCoord0Buffer(){return this._plist.tex0Buffer},get texCoord1Buffer(){return this._plist.tex1Buffer},get texCoord2Buffer(){return this._plist.tex2Buffer},get colorBuffer(){return this._plist.colorBuffer},get tangentBuffer(){return this._plist.tangentBuffer},get indexBuffer(){return this._plist.indexBuffer},updateBuffer:function(t,e){var i=!1;switch(t){case bg.base.BufferType.VERTEX:i=this.vertex.length==e.length;break;case bg.base.BufferType.NORMAL:i=this.normal.length==e.length;break;case bg.base.BufferType.TEX_COORD_0:i=this.texCoord0.length==e.length;break;case bg.base.BufferType.TEX_COORD_1:i=this.texCoord1.length==e.length;break;case bg.base.BufferType.TEX_COORD_2:i=this.texCoord2.length==e.length;break;case bg.base.BufferType.COLOR:i=this.color.length==e.length;break;case bg.base.BufferType.TANGENT:i=this.tangent.length==e.length;break;case bg.base.BufferType.INDEX:i=this.index.length==e.length}if(!i)throw new Error("Error updating buffer: The new buffer have different size as the old one.");bg.Engine.Get().polyList.update(this.context,this._plist,t,e)},build:function(){if(0==this.color.length)for(var e=0;e<this.vertex.length;e+=3)this.color.push(1),this.color.push(1),this.color.push(1),this.color.push(1);var i=bg.Engine.Get().polyList;return this._plist&&(i.destroy(this.context,this._plist),this._tangent=[]),this._tangent=t(this),this._plist=i.create(this.context),i.build(this.context,this._plist,this._vertex,this._normal,this._texCoord0,this._texCoord1,this._texCoord2,this._color,this._tangent,this._index)},draw:function(){bg.Engine.Get().polyList.draw(this.context,this._plist,this.drawMode,this.index.length)},destroy:function(){this._plist&&bg.Engine.Get().polyList.destroy(this.context,this._plist),this._plist=null,this._name="",this._vertex=[],this._normal=[],this._texCoord0=[],this._texCoord1=[],this._texCoord2=[],this._color=[],this._tangent=[],this._index=[]},applyTransform:function(t){var e=new bg.Matrix4(t),i=new bg.Matrix4(t.getMatrix3());if(this.normal.length>0&&this.normal.length!=this.vertex.length)throw new Error("Unexpected number of normal coordinates found in polyList");for(var n=0;n<this.vertex.length-2;n+=3){var r=new bg.Vector4(this.vertex[n],this.vertex[n+1],this.vertex[n+2],1);if(r=e.multVector(r),this.vertex[n]=r.x,this.vertex[n+1]=r.y,this.vertex[n+2]=r.z,this.normal.length){var s=new bg.Vector4(this.normal[n],this.normal[n+1],this.normal[n+2],1);s=i.multVector(s),this.normal[n]=s.x,this.normal[n+1]=s.y,this.normal[n+2]=s.z}}this.build()}},{},e)}(bg.app.ContextObject);bg.base.PolyList=i}(),function(){function t(){return bg.base.ShaderLibrary.Get()}function e(){return n||(n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),n.addParameter([t().inputs.buffers.vertex]),n.addParameter(t().inputs.matrix.all),"webgl1"==bg.Engine.Get().id&&n.setMainBody("\n\t\t\t\t\tgl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t")),n}function i(){return r||(r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),"webgl1"==bg.Engine.Get().id&&r.setMainBody("\n\t\t\t\t\tgl_FragColor = vec4(1.0,0.0,0.0,1.0);\n\t\t\t\t")),r}var n=null,r=null,s=function(t){function n(t){$traceurRuntime.superConstructor(n).call(this,t);var r=[e(),i()];this.setupShaderSource(r)}return $traceurRuntime.createClass(n,{beginDraw:function(){},setupVars:function(){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst)}},{},t)}(bg.base.Effect);bg.base.RedEffect=s}(),function(){var t=function(){function t(t){this.initFlags(t)}return $traceurRuntime.createClass(t,{initFlags:function(t){},create:function(t,e){},setActive:function(t,e){},readBuffer:function(t,e,i){},resize:function(t,e,i){},destroy:function(t,e){},supportType:function(t){},supportFormat:function(t){},maxColorAttachments:function(){}},{})}();bg.base.RenderSurfaceBufferImpl=t;var e=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._size=new bg.Vector2(256),this._renderSurface=null,this._resizeOnViewportChanged=!0}return $traceurRuntime.createClass(e,{get size(){return this._size},set size(t){this._size.x==t.x&&this._size.y==t.y||(this._size=t,this.surfaceImpl.resize(this.context,this._renderSurface,t))},get surfaceImpl(){return null},get resizeOnViewportChanged(){return this._resizeOnViewportChanged},set resizeOnViewportChanged(t){this._resizeOnViewportChanged=t},create:function(t){t||(t=e.DefaultAttachments()),this._renderSurface=this.surfaceImpl.create(this.context,t)},setActive:function(){this.surfaceImpl.setActive(this.context,this._renderSurface)},readBuffer:function(t){return this.surfaceImpl.readBuffer(this.context,this._renderSurface,t,this.size)},destroy:function(){this.surfaceImpl.destroy(this.context,this._renderSurface),this._renderSurface=null}},{DefaultAttachments:function(){return[{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]},SupportFormat:function(t){return bg.Engine.Get().colorBuffer.supportFormat(t)},SupportType:function(t){return bg.Engine.Get().colorBuffer.supportType(t)},MaxColorAttachments:function(){return bg.Engine.Get().textureBuffer.maxColorAttachments}},t)}(bg.app.ContextObject);bg.base.RenderSurface=e,bg.base.RenderSurfaceType={RGBA:null,DEPTH:null},bg.base.RenderSurfaceFormat={UNSIGNED_BYTE:null,UNSIGNED_SHORT:null,FLOAT:null,RENDERBUFFER:null};var i=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{get surfaceImpl(){return bg.Engine.Get().colorBuffer}},{MaxColorAttachments:function(){return bg.Engine.Get().colorBuffer.maxColorAttachments}},t)}(e);bg.base.ColorSurface=i;var n=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{get surfaceImpl(){return bg.Engine.Get().textureBuffer},getTexture:function(){var t=void 0!==arguments[0]?arguments[0]:0;return this._renderSurface.attachments[t]&&this._renderSurface.attachments[t].texture}},{MaxColorAttachments:function(){return bg.Engine.Get().textureBuffer.maxColorAttachments}},t)}(e);bg.base.TextureSurface=n}(),function(){if(!bg.isElectronApp)return!1;var t=require("fs"),e=require("path"),i=function(){function i(){}return $traceurRuntime.createClass(i,{save:function(i,n){var r=this;return i=bg.base.Writer.StandarizePath(i),new Promise(function(s,a){r._url={},r._url.path=i.split("/"),r._url.fileName=r._url.path.pop(),r._url.path=r._url.path.join("/"),r._sceneData={fileType:"vwgl::scene",version:{major:2,minor:0,rev:0},scene:[]},r._promises=[],bg.base.Writer.PrepareDirectory(r._url.path);var o={};r._sceneData.scene.push(o),r.buildSceneNode(n,o),t.writeFileSync(e.join(r._url.path,r._url.fileName),JSON.stringify(r._sceneData,"","\t"),"utf-8"),Promise.all(r._promises).then(function(){return s()}).catch(function(t){return a(t)})})},buildSceneNode:function(t,e){var i=this;e.type="Node",e.name=t.name,e.enabled=t.enabled,e.children=[],e.components=[],t.forEachComponent(function(t){if(t.shouldSerialize){var n={};t.serialize(n,i._promises,i._url),e.components.push(n)}}),t.children.forEach(function(t){var n={};i.buildSceneNode(t,n),e.children.push(n)})}},{})}(),n=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){return/vitscnj/i.test(t.split(".").pop("."))&&e instanceof bg.scene.Node},write:function(t,e){return(new i).save(t,e)}},{},t)}(bg.base.WriterPlugin);bg.base.SceneWriterPlugin=n}(),function(){function t(t){Reflect.defineProperty(t,"all",{get:function(){if(!this._all){this._all=[];for(var e in t)"object"==$traceurRuntime.typeof(t[e])&&t[e].name&&this._all.push(t[e])}return this._all}})}var e=null,i=function(){function i(){var e=bg[bg.Engine.Get().id].shaderLibrary;for(var i in e)this[i]=e[i];t(this.inputs.matrix),Object.defineProperty(this.inputs.matrix,"modelViewProjection",{get:function(){return[this.model,this.view,this.projection]}}),t(this.inputs.material),t(this.inputs.lighting),t(this.inputs.lightingForward),t(this.inputs.shadows),t(this.inputs.colorCorrection),t(this.functions.materials),t(this.functions.colorCorrection),t(this.functions.lighting),t(this.functions.utils)}return $traceurRuntime.createClass(i,{},{Get:function(){return e||(e=new i),e}})}();bg.base.ShaderLibrary=i;var n=function(){function t(){}return $traceurRuntime.createClass(t,{header:function(t){return""},parameter:function(t,e){return e.name},func:function(t,e){return e.name}},{})}();bg.base.ShaderSourceImpl=n;var r=function(){function t(t){this._type=t,this._params=[],this._functions=[],this._requiredExtensions=[],this._header=""}return $traceurRuntime.createClass(t,{get type(){return this._type},get params(){return this._params},get header(){return this._header},get functions(){return this._functions},addParameter:function(t){t instanceof Array?this._params=$traceurRuntime.spread(this._params,t):this._params.push(t),this._params.push(null)},addFunction:function(t){t instanceof Array?this._functions=$traceurRuntime.spread(this._functions,t):this._functions.push(t)},setMainBody:function(t){this.addFunction({returnType:"void",name:"main",params:{},body:t})},appendHeader:function(t){this._header+=t+"\n"},toString:function(){var t=this,e=bg.Engine.Get().shaderSource,i=e.header(this.type)+"\n"+this._header+"\n\n";return this.params.forEach(function(n){i+=e.parameter(t.type,n)+"\n"}),this.functions.forEach(function(n){i+="\n"+e.func(t.type,n)+"\n"}),i}},{FormatSource:function(t){var e="",i=t.replace(/^\n*/,"").replace(/\n*$/,"").split("\n"),n=100;return i.forEach(function(t){var e=/(\t*)/.exec(t)[0].length;n>e&&(n=e)}),i.forEach(function(t){var i=/(\t*)/.exec(t)[0].length,r=i-n;e+=t.slice(i-r,t.length)+"\n"}),e.replace(/^\n*/,"").replace(/\n*$/,"")}})}();bg.base.ShaderSource=r}(),function(){function t(t){var e="";return t.split("\n").forEach(function(t,i){++i,e+=(i<10?"00":i<100?"0":"")+i+" | "+t+"\n"}),e}var e=function(){function t(t){this.initFlags(t)}return $traceurRuntime.createClass(t,{initFlags:function(t){},setActive:function(t,e){},create:function(t){},addShaderSource:function(t,e,i,n){},link:function(t,e){},initVars:function(t,e,i,n){},setInputBuffer:function(t,e,i,n,r){},setValueInt:function(t,e,i,n){},setValueIntPtr:function(t,e,i,n){},setValueFloat:function(t,e,i,n){},setValueFloatPtr:function(t,e,i,n){},setValueVector2:function(t,e,i,n){},setValueVector3:function(t,e,i,n){},setValueVector4:function(t,e,i,n){},setValueVector2v:function(t,e,i,n){},setValueVector3v:function(t,e,i,n){},setValueVector4v:function(t,e,i,n){},setValueMatrix3:function(t,e,i,n,r){},setValueMatrix4:function(t,e,i,n,r){},setTexture:function(t,e,i,n,r){}},{})}();bg.base.ShaderImpl=e,bg.base.ShaderType={VERTEX:null,FRAGMENT:null};var i=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t),this._shader=bg.Engine.Get().shader.create(t),this._linked=!1,this._compileError=null,this._linkError=null}return $traceurRuntime.createClass(i,{get shader(){return this._shader},get compileError(){return this._compileError},get compileErrorSource(){return this._compileErrorSource},get linkError(){return this._linkError},get status(){return null==this._compileError&&null==this._linkError},addShaderSource:function(e,i){return this._linked?this._compileError="Tying to attach a shader to a linked program":this._compileError||(this._compileError=bg.Engine.Get().shader.addShaderSource(this.context,this._shader,e,i),this._compileError&&(this._compileErrorSource=t(i))),null==this._compileError},link:function(){return this._linkError=null,this._linked?this._linkError="Shader already linked":(this._linkError=bg.Engine.Get().shader.link(this.context,this._shader),this._linked=null==this._linkError),this._linked},setActive:function(){bg.Engine.Get().shader.setActive(this.context,this._shader)},clearActive:function(){i.ClearActive(this.context)},initVars:function(t,e){bg.Engine.Get().shader.initVars(this.context,this._shader,t,e)},setInputBuffer:function(t,e,i){bg.Engine.Get().shader.setInputBuffer(this.context,this._shader,t,e,i)},disableInputBuffer:function(t){bg.Engine.Get().shader.disableInputBuffer(this.context,this._shader,t)},setValueInt:function(t,e){bg.Engine.Get().shader.setValueInt(this.context,this._shader,t,e)},setValueIntPtr:function(t,e){bg.Engine.Get().shader.setValueIntPtr(this.context,this._shader,t,e)},setValueFloat:function(t,e){bg.Engine.Get().shader.setValueFloat(this.context,this._shader,t,e)},setValueFloatPtr:function(t,e){bg.Engine.Get().shader.setValueFloatPtr(this.context,this._shader,t,e)},setVector2:function(t,e){bg.Engine.Get().shader.setValueVector2(this.context,this._shader,t,e)},setVector3:function(t,e){bg.Engine.Get().shader.setValueVector3(this.context,this._shader,t,e)},setVector4:function(t,e){bg.Engine.Get().shader.setValueVector4(this.context,this._shader,t,e)},setVector2Ptr:function(t,e){bg.Engine.Get().shader.setValueVector2v(this.context,this._shader,t,e)},setVector3Ptr:function(t,e){bg.Engine.Get().shader.setValueVector3v(this.context,this._shader,t,e)},setVector4Ptr:function(t,e){bg.Engine.Get().shader.setValueVector4v(this.context,this._shader,t,e)},setMatrix3:function(t,e){var i=void 0!==arguments[2]&&arguments[2];bg.Engine.Get().shader.setValueMatrix3(this.context,this._shader,t,i,e)},setMatrix4:function(t,e){var i=void 0!==arguments[2]&&arguments[2];bg.Engine.Get().shader.setValueMatrix4(this.context,this._shader,t,i,e)},setTexture:function(t,e,i){bg.Engine.Get().shader.setTexture(this.context,this._shader,t,e,i)}},{ClearActive:function(t){bg.Engine.Get().shader.setActive(t,null)}},e)}(bg.app.ContextObject);bg.base.Shader=i}(),function(){function t(){return bg.base.ShaderLibrary.Get()}function e(){return n||(n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,null,t().inputs.matrix.model,t().inputs.matrix.view,t().inputs.matrix.projection,null,{name:"fsTexCoord",dataType:"vec2",role:"out"}]),"webgl1"==bg.Engine.Get().id&&n.setMainBody("\n\t\t\t\tgl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\tfsTexCoord = inTex0;\n\t\t\t\t")),n}function i(){return r||(r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),r.addParameter([t().inputs.material.castShadows,t().inputs.material.texture,t().inputs.material.textureOffset,t().inputs.material.textureScale,t().inputs.material.alphaCutoff,null,{name:"fsTexCoord",dataType:"vec2",role:"in"}]),r.addFunction(t().functions.utils.pack),r.addFunction(t().functions.materials.samplerColor),"webgl1"==bg.Engine.Get().id&&r.setMainBody("\n\t\t\t\t\n\t\t\t\tfloat alpha = samplerColor(inTexture,fsTexCoord,inTextureOffset,inTextureScale).a;\n\t\t\t\tif (inCastShadows && alpha>inAlphaCutoff) {\n\t\t\t\t\tgl_FragColor = pack(gl_FragCoord.z);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tdiscard;\n\t\t\t\t}")),r}var n=null,r=null,s=function(t){function n(t){$traceurRuntime.superConstructor(n).call(this,t),this._material=null,this._light=null,this._lightTransform=null,this.setupShaderSource([e(),i()])}return $traceurRuntime.createClass(n,{get material(){return this._material},set material(t){this._material=t},get light(){return this._light},set light(t){this._light=t},get lightTransform(){return this._lightTransform},set lightTransform(t){this._lightTransform=t},setupVars:function(){if(this.material&&this.light&&this.lightTransform){var t=bg.base.MatrixState.Current();this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",this.lightTransform),this.shader.setMatrix4("inProjectionMatrix",this.light.projection),this.shader.setValueInt("inCastShadows",this.material.castShadows);var e=this.material.texture||bg.base.TextureCache.WhiteTexture(this.context);this.shader.setTexture("inTexture",e,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTextureOffset",this.material.textureOffset),this.shader.setVector2("inTextureScale",this.material.textureScale),this.shader.setValueFloat("inAlphaCutoff",this.material.alphaCutoff)}}},{},t)}(bg.base.Effect);bg.base.ShadowMapEffect=s,bg.base.ShadowType={HARD:0,SOFT:1,STRATIFIED:2};var a=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._pipeline=new bg.base.Pipeline(t),this._pipeline.renderSurface=new bg.base.TextureSurface(t),this._pipeline.renderSurface.create(),this._pipeline.effect=new bg.base.ShadowMapEffect(t),this._matrixState=new bg.base.MatrixState,this._drawVisitor=new bg.scene.DrawVisitor(this._pipeline,this._matrixState),this._shadowMapSize=new bg.Vector2(2048),this._pipeline.viewport=new bg.Viewport(0,0,this._shadowMapSize.width,this._shadowMapSize.height),this._shadowType=bg.base.ShadowType.SOFT,this._projection=bg.Matrix4.Ortho(-15,15,-15,15,1,50),this._viewMatrix=bg.Matrix4.Identity(),this._shadowColor=bg.Color.Black()}return $traceurRuntime.createClass(e,{get size(){return this._shadowMapSize},set size(t){this._shadowMapSize=t,this._pipeline.viewport=new bg.Viewport(0,0,t.width,t.height)},get shadowType(){return this._shadowType},set shadowType(t){this._shadowType=t},get shadowColor(){return this._shadowColor},set shadowColor(t){this._shadowColor=t},get viewMatrix(){return this._viewMatrix},get projection(){return this._projection},get texture(){return this._pipeline.renderSurface.getTexture(0)},update:function(t,e,i,n){var r=bg.base.MatrixState.Current();if(bg.base.MatrixState.SetCurrent(this._matrixState),this._pipeline.effect.light=i,this._viewMatrix=new bg.Matrix4(n),i.type==bg.base.LightType.DIRECTIONAL){var s=this._viewMatrix.rotation,a=e.transform.matrix.position,o=new bg.Matrix4(e.transform.matrix),c=a.add(o.forwardVector.scale(-e.focus));this._viewMatrix.identity().translate(c).mult(s).translate(0,0,10).invert(),i.projection=bg.Matrix4.Ortho(-e.focus,e.focus,-e.focus,e.focus,1,300*e.focus)}else if(i.type==bg.base.LightType.SPOT){var u=i.spotCutoff;i.projection=bg.Matrix4.Perspective(2*u,1,.1,200),i.shadowBias=2e-4,this._viewMatrix.invert()}this._projection=i.projection,this._pipeline.effect.lightTransform=this._viewMatrix,bg.base.Pipeline.SetCurrent(this._pipeline),this._pipeline.clearBuffers(bg.base.ClearBuffers.COLOR_DEPTH),t.accept(this._drawVisitor),bg.base.MatrixState.SetCurrent(r)}},{},t)}(bg.app.ContextObject);bg.base.ShadowMap=a}(),function(){var t={},e=8,i=function(){function i(t){this._context=t,this._textures={}}return $traceurRuntime.createClass(i,{find:function(t){return this._textures[t]},register:function(t,e){e instanceof bg.base.Texture&&(this._textures[t]=e)},unregister:function(t){this._textures[t]&&delete this._textures[t]},clear:function(){this._textures={}}},{SetColorTextureSize:function(t){e=t},GetColorTextureSize:function(){return e},WhiteCubemap:function(t){var e=i.Get(t),n=e.find("static-white-cubemap-texture");return n||(n=bg.base.Texture.WhiteCubemap(t),e.register("static-white-cubemap-texture",n)),n},WhiteTexture:function(t){var n=i.Get(t),r=n.find("static-white-color-texture");return r||(r=bg.base.Texture.WhiteTexture(t,new bg.Vector2(e)),n.register("static-white-color-texture",r)),r},BlackTexture:function(t){var n=i.Get(t),r=n.find("static-black-color-texture");return r||(r=bg.base.Texture.BlackTexture(t,new bg.Vector2(e)),n.register("static-black-color-texture",r)),r},NormalTexture:function(t){var n=i.Get(t),r=n.find("static-normal-color-texture");return r||(r=bg.base.Texture.NormalTexture(t,new bg.Vector2(e)),n.register("static-normal-color-texture",r)),r},RandomTexture:function(t){var e=i.Get(t),n=e.find("static-random-color-texture");return n||(n=bg.base.Texture.RandomTexture(t,new bg.Vector2(64)),e.register("static-random-color-texture",n)),n},Get:function(e){return t[e.uuid]||(t[e.uuid]=new i(e)),t[e.uuid]}})}();bg.base.TextureCache=i;var n=null,r=null,s=null,a=null,o=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){return bg.utils.Resource.IsImage(t)},load:function(t,i,n,r){return new Promise(function(s,a){if(n){var o=bg.base.TextureCache.Get(t).find(i);o||(bg.log("Texture "+i+" not found. Loading texture"),o=new bg.base.Texture(t),o.create(),o.bind(),o.wrapX=r.wrapX||e.GetWrapX(),o.wrapY=r.wrapY||e.GetWrapY(),o.minFilter=r.minFilter||e.GetMinFilter(),o.magFilter=r.magFilter||e.GetMagFilter(),o.setImage(n),o.fileName=i,bg.base.TextureCache.Get(t).register(i,o)),s(o)}else a(new Error("Error loading texture image data"))})}},{GetWrapX:function(){return n||bg.base.TextureWrap.REPEAT},GetWrapY:function(){return r||bg.base.TextureWrap.REPEAT},GetMinFilter:function(){return s||bg.base.TextureFilter.LINEAR_MIPMAP_NEAREST},GetMagFilter:function(){return a||bg.base.TextureFilter.LINEAR},SetMinFilter:function(t){s=t},SetMagFilter:function(t){a=t},SetWrapX:function(t){n=t},SetWrapY:function(t){r=t}},t)}(bg.base.LoaderPlugin);bg.base.TextureLoaderPlugin=o;var c=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){return bg.utils.Resource.IsVideo(t)},load:function(t,e,i){return new Promise(function(n,r){if(i){var s=new bg.base.Texture(t);s.create(),s.bind(),s.setVideo(i),s.fileName=e,n(s)}else r(new Error("Error loading video texture data"))})}},{},t)}(bg.base.LoaderPlugin);bg.base.VideoTextureLoaderPlugin=c}(),function(){bg.base.TextureUnit={TEXTURE_0:0,TEXTURE_1:1,TEXTURE_2:2,TEXTURE_3:3,TEXTURE_4:4,TEXTURE_5:5,TEXTURE_6:6,TEXTURE_7:7,TEXTURE_8:8,TEXTURE_9:9,TEXTURE_10:10,TEXTURE_11:11,TEXTURE_12:12,TEXTURE_13:13,TEXTURE_14:14,TEXTURE_15:15,TEXTURE_16:16,TEXTURE_17:17,TEXTURE_18:18,TEXTURE_19:19,TEXTURE_20:20,TEXTURE_21:21,TEXTURE_22:22,TEXTURE_23:23,TEXTURE_24:24,TEXTURE_25:25,TEXTURE_26:26,TEXTURE_27:27,TEXTURE_28:28,TEXTURE_29:29,TEXTURE_30:30},bg.base.TextureWrap={REPEAT:null,CLAMP:null,MIRRORED_REPEAT:null},bg.base.TextureFilter={NEAREST_MIPMAP_NEAREST:null,LINEAR_MIPMAP_NEAREST:null,NEAREST_MIPMAP_LINEAR:null,LINEAR_MIPMAP_LINEAR:null,NEAREST:null,LINEAR:null},bg.base.TextureTarget={TEXTURE_2D:null,CUBE_MAP:null,POSITIVE_X_FACE:null,NEGATIVE_X_FACE:null,POSITIVE_Y_FACE:null,NEGATIVE_Y_FACE:null,POSITIVE_Z_FACE:null,NEGATIVE_Z_FACE:null};var t=function(){function t(t){this.initFlags(t)}return $traceurRuntime.createClass(t,{initFlags:function(t){console.log("TextureImpl: initFlags() method not implemented")},create:function(t){return console.log("TextureImpl: create() method not implemented"),null},setActive:function(t,e){console.log("TextureImpl: setActive() method not implemented")},bind:function(t,e,i){console.log("TextureImpl: bind() method not implemented")},unbind:function(t,e){console.log("TextureImpl: unbind() method not implemented")},setTextureWrapX:function(t,e,i,n){console.log("TextureImpl: setTextureWrapX() method not implemented")},setTextureWrapY:function(t,e,i,n){console.log("TextureImpl: setTextureWrapY() method not implemented")},setImage:function(t,e,i,n,r,s,a){console.log("TextureImpl: setImage() method not implemented")},setImageRaw:function(t,e,i,n,r,s,a,o){console.log("TextureImpl: setImageRaw() method not implemented")},setTextureFilter:function(t,e,i,n){console.log("TextureImpl: setTextureFilter() method not implemented")},setCubemapImage:function(t,e,i){console.log("TextureImpl: setCubemapImage() method not implemented")},setCubemapRaw:function(t,e,i,n,r){console.log("TextureImpl: setCubemapRaw() method not implemented")},setVideo:function(t,e,i,n,r){console.log("TextureImpl: setVideo() method not implemented")},updateVideoData:function(t,e,i,n){console.log("TextureImpl: updateVideoData() method not implemented")},destroy:function(t,e){console.log("TextureImpl: destroy() method not implemented")}},{})}();bg.base.TextureImpl=t,bg.base.TextureDataType={NONE:0,IMAGE:1,IMAGE_DATA:2,CUBEMAP:3,CUBEMAP_DATA:4,VIDEO:5};var e=[],i=function(t){function i(t){$traceurRuntime.superConstructor(i).call(this,t),this._texture=null,this._fileName="",this._size=new bg.Vector2(0),this._target=bg.base.TextureTarget.TEXTURE_2D,this._minFilter=bg.base.TextureFilter.LINEAR,
this._magFilter=bg.base.TextureFilter.LINEAR,this._wrapX=bg.base.TextureWrap.REPEAT,this._wrapY=bg.base.TextureWrap.REPEAT,this._video=null}return $traceurRuntime.createClass(i,{get texture(){return this._texture},get target(){return this._target},set target(t){this._target=t},get fileName(){return this._fileName},set fileName(t){this._fileName=t},set minFilter(t){this._minFilter=t},set magFilter(t){this._magFilter=t},get minFilter(){return this._minFilter},get magFilter(){return this._magFilter},set wrapX(t){this._wrapX=t},set wrapY(t){this._wrapY=t},get wrapX(){return this._wrapX},get wrapY(){return this._wrapY},get size(){return this._size},get image(){return this._image},get imageData(){return this._imageData},get cubeMapImages(){return this._cubeMapImages},get cubeMapData(){return this._cubeMapData},get video(){return this._video},get dataType(){return this._image?bg.base.TextureDataType.IMAGE:this._imageData?bg.base.TextureDataType.IMAGE_DATA:this._cubeMapImages?bg.base.TextureDataType.CUBEMAP:this._cubeMapData?bg.base.TextureDataType.CUBEMAP_DATA:this._video?bg.base.TextureDataType.VIDEO:bg.base.TextureDataType.NONE},create:function(){null!==this._texture&&this.destroy(),this._texture=bg.Engine.Get().texture.create(this.context)},setActive:function(t){bg.Engine.Get().texture.setActive(this.context,t)},bind:function(){bg.Engine.Get().texture.bind(this.context,this._target,this._texture)},unbind:function(){i.Unbind(this.context,this._target)},setImage:function(t,e){void 0===e&&(e=!0),this._size.width=t.width,this._size.height=t.height,bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapX),bg.Engine.Get().texture.setTextureWrapY(this.context,this._target,this._texture,this._wrapY),bg.Engine.Get().texture.setImage(this.context,this._target,this._minFilter,this._magFilter,this._texture,t,e),this._image=t,this._imageData=null,this._cubeMapImages=null,this._cubeMapData=null,this._video=null},setImageRaw:function(t,e,i,n,r){n||(n=this.context.RGBA),r||(r=this.context.UNSIGNED_BYTE),this._size.width=t,this._size.height=e,bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapX),bg.Engine.Get().texture.setTextureWrapY(this.context,this._target,this._texture,this._wrapY),bg.Engine.Get().texture.setImageRaw(this.context,this._target,this._minFilter,this._magFilter,this._texture,t,e,i,n,r),this._image=null,this._imageData=i,this._cubeMapImages=null,this._cubeMapData=null,this._video=null},setCubemap:function(t,e,i,n,r,s){bg.Engine.Get().texture.bind(this.context,this._target,this._texture),bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapX),bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapY),bg.Engine.Get().texture.setTextureFilter(this.context,this._target,this._minFilter,this._magFilter),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.POSITIVE_X_FACE,t),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.NEGATIVE_X_FACE,e),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.POSITIVE_Y_FACE,i),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.NEGATIVE_Y_FACE,n),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.POSITIVE_Z_FACE,r),bg.Engine.Get().texture.setCubemapImage(this.context,bg.base.TextureTarget.NEGATIVE_Z_FACE,s),this._image=null,this._imageData=null,this._cubeMapImages={posX:t,negX:e,posY:i,negY:n,posZ:r,negZ:s},this._cubeMapData=null,this._video=null},setCubemapRaw:function(t,e,i,n,r,s,a,o){bg.Engine.Get().texture.bind(this.context,this._target,this._texture),bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapX),bg.Engine.Get().texture.setTextureWrapX(this.context,this._target,this._texture,this._wrapY),bg.Engine.Get().texture.setTextureFilter(this.context,this._target,this._minFilter,this._magFilter),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.POSITIVE_X_FACE,i,t,e),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.NEGATIVE_X_FACE,n,t,e),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.POSITIVE_Y_FACE,r,t,e),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.NEGATIVE_Y_FACE,s,t,e),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.POSITIVE_Z_FACE,a,t,e),bg.Engine.Get().texture.setCubemapRaw(this.context,bg.base.TextureTarget.NEGATIVE_Z_FACE,o,t,e),this._image=null,this._imageData=null,this._cubeMapImages=null,this._cubeMapData={width:t,height:e,posX:i,negX:n,posY:r,negY:s,posZ:a,negZ:o},this._video=null},setVideo:function(t,e){void 0===e&&(e=!0),this._size.width=t.videoWidth,this._size.height=t.videoHeight,bg.Engine.Get().texture.setVideo(this.context,this._target,this._texture,t,e),this._video=t,this._image=null,this._imageData=null,this._cubeMapImages=null,this._cubeMapData=null},destroy:function(){bg.Engine.Get().texture.destroy(this.context,this._texture),this._texture=null,this._minFilter=null,this._magFilter=null,this._fileName=""},valid:function(){return null!==this._texture},update:function(){bg.Engine.Get().texture.updateVideoData(this.context,this._target,this._texture,this._video)}},{FromBase64Image:function(t,i){var n=new bg.base.Texture(t);return n.img=new Image,e.push(n),n.onload=function(t,i){n.create(),n.bind(),n.minFilter=bg.base.TextureLoaderPlugin.GetMinFilter(),n.magFilter=bg.base.TextureLoaderPlugin.GetMagFilter(),n.setImage(n.img),n.unbind();var r=e.indexOf(n);-1!=r&&e.splice(r,1),bg.emitImageLoadEvent()},n.img.src=i,n},ColorTexture:function(t,e,i){var n=new bg.base.Texture(t);n.create(),n.bind();for(var r=i.width*i.height*4,s=[],a=0;a<r;a+=4)s[a]=255*e.r,s[a+1]=255*e.g,s[a+2]=255*e.b,s[a+3]=255*e.a;return s=new Uint8Array(s),n.minFilter=bg.base.TextureFilter.NEAREST,n.magFilter=bg.base.TextureFilter.NEAREST,n.setImageRaw(i.width,i.height,s),n.unbind(),n},WhiteTexture:function(t,e){return i.ColorTexture(t,bg.Color.White(),e)},WhiteCubemap:function(t){return i.ColorCubemap(t,bg.Color.White())},BlackCubemap:function(t){return i.ColorCubemap(t,bg.Color.Black())},ColorCubemap:function(t,e){var i=new bg.base.Texture(t);i.target=bg.base.TextureTarget.CUBE_MAP,i.create(),i.bind();for(var n=[],r=0;r<4096;r+=4)n[r]=255*e.r,n[r+1]=255*e.g,n[r+2]=255*e.b,n[r+3]=255*e.a;return n=new Uint8Array(n),i.setCubemapRaw(32,32,n,n,n,n,n,n),i.unbind(),i},NormalTexture:function(t,e){return i.ColorTexture(t,new bg.Color(.5,.5,1,1),e)},BlackTexture:function(t,e){return i.ColorTexture(t,bg.Color.Black(),e)},RandomTexture:function(t,e){var i=new bg.base.Texture(t);i.create(),i.bind();for(var n=e.width*e.height*4,r=[],s=0;s<n;s+=4){var a=new bg.Vector3(2*bg.Math.random()-1,2*bg.Math.random()-1,0);a.normalize(),r[s]=255*a.x,r[s+1]=255*a.y,r[s+2]=255*a.z,r[s+3]=1}return r=new Uint8Array(r),i.minFilter=bg.base.TextureFilter.NEAREST,i.magFilter=bg.base.TextureFilter.NEAREST,i.setImageRaw(e.width,e.height,r),i.unbind(),i},SetActive:function(t,e){bg.Engine.Get().texture.setActive(t,e)},Unbind:function(t,e){e||(e=bg.base.TextureTarget.TEXTURE_2D),bg.Engine.Get().texture.unbind(t,e)}},t)}(bg.app.ContextObject);bg.base.Texture=i}(),function(){bg.Math={seed:1,PI:3.141592653589793,DEG_TO_RAD:.01745329251994,RAD_TO_DEG:57.29577951308233,PI_2:1.5707963267948966,PI_4:.785398163397448,PI_8:.392699081698724,TWO_PI:6.283185307179586,EPSILON:1e-7,Array:Float32Array,FLOAT_MAX:3.402823e38,checkZero:function(t){return t>-this.EPSILON&&t<this.EPSILON?0:t},equals:function(t,e){return Math.abs(t-e)<this.EPSILON},degreesToRadians:function(t){return Math.fround(this.checkZero(t*this.DEG_TO_RAD))},radiansToDegrees:function(t){return Math.fround(this.checkZero(t*this.RAD_TO_DEG))},sin:function(t){return Math.fround(this.checkZero(Math.sin(t)))},cos:function(t){return Math.fround(this.checkZero(Math.cos(t)))},tan:function(t){return Math.fround(this.checkZero(Math.tan(t)))},cotan:function(t){return Math.fround(this.checkZero(1/this.tan(t)))},atan:function(t){return Math.fround(this.checkZero(Math.atan(t)))},atan2:function(t,e){return Math.fround(this.checkZero(Math.atan2f(t,e)))},random:function(){return Math.random()},seededRandom:function(){return this.seed=(9301*this.seed+49297)%233280,0+this.seed/233280*1},max:function(t,e){return Math.fround(Math.max(t,e))},min:function(t,e){return Math.fround(Math.min(t,e))},abs:function(t){return Math.fround(Math.abs(t))},sqrt:function(t){return Math.fround(Math.sqrt(t))},lerp:function(t,e,i){return Math.fround((1-i)*t+i*e)},square:function(t){return Math.fround(t*t)}};var t=function(){function t(t){this._target=t}return $traceurRuntime.createClass(t,{get target(){return this._target},set target(t){this._target=t},apply:function(){console.log("WARNING: MatrixStrategy::apply() not overloaded by the child class.")}},{})}();bg.MatrixStrategy=t}(),function(){var t=function(){function t(){var t=void 0!==arguments[0]?arguments[0]:1,e=void 0!==arguments[1]?arguments[1]:0,i=void 0!==arguments[2]?arguments[2]:0,n=void 0!==arguments[3]?arguments[3]:0,r=void 0!==arguments[4]?arguments[4]:1,s=void 0!==arguments[5]?arguments[5]:0,a=void 0!==arguments[6]?arguments[6]:0,o=void 0!==arguments[7]?arguments[7]:0,c=void 0!==arguments[8]?arguments[8]:1;this._m=new bg.Math.Array(9),Array.isArray($traceurRuntime.typeof(t))?(this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[0],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8]):"number"==typeof t?(this._m[0]=t,this._m[1]=e,this._m[2]=i,this._m[3]=n,this._m[4]=r,this._m[5]=s,this._m[6]=a,this._m[7]=o,this._m[8]=c):this.assign(t)}return $traceurRuntime.createClass(t,{get m(){return this._m},toArray:function(){return[this._m[0],this._m[1],this._m[2],this._m[3],this._m[4],this._m[5],this._m[6],this._m[7],this._m[8]]},get m00(){return this._m[0]},get m01(){return this._m[1]},get m02(){return this._m[2]},get m10(){return this._m[3]},get m11(){return this._m[4]},get m12(){return this._m[5]},get m20(){return this._m[6]},get m21(){return this._m[7]},get m22(){return this._m[8]},set m00(t){this._m[0]=t},set m01(t){this._m[1]=t},set m02(t){this._m[2]=t},set m10(t){this._m[3]=t},set m11(t){this._m[4]=t},set m12(t){this._m[5]=t},set m20(t){this._m[6]=t},set m21(t){this._m[7]=t},set m22(t){this._m[8]=t},zero:function(){return this._m[0]=this._m[1]=this._m[2]=this._m[3]=this._m[4]=this._m[5]=this._m[6]=this._m[7]=this._m[8]=0,this},identity:function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=1,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=1,this},isZero:function(){return 0==this._m[0]&&0==this._m[1]&&0==this._m[2]&&0==this._m[3]&&0==this._m[4]&&0==this._m[5]&&0==this._m[6]&&0==this._m[7]&&0==this._m[8]},isIdentity:function(){return 1==this._m[0]&&0==this._m[1]&&0==this._m[2]&&0==this._m[3]&&1==this._m[4]&&0==this._m[5]&&0==this._m[6]&&0==this._m[7]&&1==this._m[8]},row:function(t){return new bg.Vector3(this._m[3*t],this._m[3*t+1],this._m[3*t+2])},setRow:function(t,e){return this._m[3*t]=e._v[0],this._m[3*t+1]=e._v[1],this._m[3*t+2]=e._v[2],this},setScale:function(t,e,i){var n=new bg.Vector3(this._m[0],this._m[3],this._m[6]).normalize().scale(t),r=new bg.Vector3(this._m[1],this._m[4],this._m[7]).normalize().scale(e),s=new bg.Vector3(this._m[2],this._m[5],this._m[8]).normalize().scale(i);return this._m[0]=n.x,this._m[3]=n.y,this._m[6]=n.z,this._m[1]=r.x,this._m[4]=r.y,this._m[7]=r.z,this._m[2]=s.x,this._m[5]=s.y,this._m[8]=s.z,this},getScale:function(){return new bg.Vector3(new bg.Vector3(this._m[0],this._m[3],this._m[6]).module,new bg.Vector3(this._m[1],this._m[4],this._m[7]).module,new bg.Vector3(this._m[2],this._m[5],this._m[8]).module)},get length(){return this._m.length},traspose:function(){var t=new bg.Vector3(this._m[0],this._m[3],this._m[6]),e=new bg.Vector3(this._m[1],this._m[4],this._m[7]),i=new bg.Vector3(this._m[2],this._m[5],this._m[8]);return this.setRow(0,t),this.setRow(1,e),this.setRow(2,i),this},elemAtIndex:function(t){return this._m[t]},assign:function(t){return 9==t.length?(this._m[0]=t._m[0],this._m[1]=t._m[1],this._m[2]=t._m[2],this._m[3]=t._m[3],this._m[4]=t._m[4],this._m[5]=t._m[5],this._m[6]=t._m[6],this._m[7]=t._m[7],this._m[8]=t._m[8]):16==t.length&&(this._m[0]=t._m[0],this._m[1]=t._m[1],this._m[2]=t._m[2],this._m[3]=t._m[4],this._m[4]=t._m[5],this._m[5]=t._m[6],this._m[6]=t._m[8],this._m[7]=t._m[9],this._m[8]=t._m[10]),this},equals:function(t){return this._m[0]==t._m[0]&&this._m[1]==t._m[1]&&this._m[2]==t._m[2]&&this._m[3]==t._m[3]&&this._m[4]==t._m[4]&&this._m[5]==t._m[5]&&this._m[6]==t._m[6]&&this._m[7]==t._m[7]&&this._m[8]==t._m[8]},notEquals:function(t){return this._m[0]!=t._m[0]||this._m[1]!=t._m[1]||this._m[2]!=t._m[2]&&this._m[3]!=t._m[3]||this._m[4]!=t._m[4]||this._m[5]!=t._m[5]&&this._m[6]!=t._m[6]||this._m[7]!=t._m[7]||this._m[8]!=t._m[8]},mult:function(t){if("number"==typeof t)this._m[0]*=t,this._m[1]*=t,this._m[2]*=t,this._m[3]*=t,this._m[4]*=t,this._m[5]*=t,this._m[6]*=t,this._m[7]*=t,this._m[8]*=t;else{var e=this._m,i=t._m,n=new bg.Math.Array(9);n[0]=i[0]*e[0]+i[1]*e[1]+i[2]*e[2],n[1]=i[0]*e[1]+i[1]*e[4]+i[2]*e[7],n[2]=i[0]*e[2]+i[1]*e[5]+i[2]*e[8],n[3]=i[3]*e[0]+i[4]*e[3]+i[5]*e[6],n[4]=i[3]*e[1]+i[4]*e[4]+i[5]*e[7],n[5]=i[3]*e[2]+i[4]*e[5]+i[5]*e[8],n[6]=i[6]*e[0]+i[7]*e[3]+i[8]*e[6],n[7]=i[6]*e[1]+i[7]*e[4]+i[8]*e[7],n[8]=i[6]*e[2]+i[7]*e[5]+i[8]*e[8],this._m=n}return this},multVector:function(t){"object"==$traceurRuntime.typeof(t)&&t._v&&t._v.length>=2&&(t=t._v);var e=t[0],i=t[1];return new bg.Vector3(this._m[0]*e+this._m[3]*i+1*this._m[6],this._m[1]*e+this._m[4]*i+1*this._m[7],this._m[2]*e+this._m[5]*i+1*this._m[8])},isNan:function(){return!(Math.isNaN(_m[0])||Math.isNaN(_m[1])||Math.isNaN(_m[2])||Math.isNaN(_m[3])||Math.isNaN(_m[4])||Math.isNaN(_m[5])||Math.isNaN(_m[6])||Math.isNaN(_m[7])||Math.isNaN(_m[8]))},toString:function(){return"["+this._m[0]+", "+this._m[1]+", "+this._m[2]+"]\n ["+this._m[3]+", "+this._m[4]+", "+this._m[5]+"]\n ["+this._m[6]+", "+this._m[7]+", "+this._m[8]+"]"}},{Identity:function(){return new bg.Matrix3(1,0,0,0,1,0,0,0,1)}})}();bg.Matrix3=t;var e=function(){function t(){var t=void 0!==arguments[0]?arguments[0]:0,e=void 0!==arguments[1]?arguments[1]:0,i=void 0!==arguments[2]?arguments[2]:0,n=void 0!==arguments[3]?arguments[3]:0,r=void 0!==arguments[4]?arguments[4]:0,s=void 0!==arguments[5]?arguments[5]:0,a=void 0!==arguments[6]?arguments[6]:0,o=void 0!==arguments[7]?arguments[7]:0,c=void 0!==arguments[8]?arguments[8]:0,u=void 0!==arguments[9]?arguments[9]:0,h=void 0!==arguments[10]?arguments[10]:0,l=void 0!==arguments[11]?arguments[11]:0,f=void 0!==arguments[12]?arguments[12]:0,b=void 0!==arguments[13]?arguments[13]:0,g=void 0!==arguments[14]?arguments[14]:0,m=void 0!==arguments[15]?arguments[15]:0;this._m=new bg.Math.Array(16),Array.isArray(t)?(this._m[0]=t[0],this._m[1]=t[1],this._m[2]=t[2],this._m[3]=t[3],this._m[4]=t[4],this._m[5]=t[5],this._m[6]=t[6],this._m[7]=t[7],this._m[8]=t[8],this._m[9]=t[9],this._m[10]=t[10],this._m[11]=t[11],this._m[12]=t[12],this._m[13]=t[13],this._m[14]=t[14],this._m[15]=t[15]):"number"==typeof t?(this._m[0]=t,this._m[1]=e,this._m[2]=i,this._m[3]=n,this._m[4]=r,this._m[5]=s,this._m[6]=a,this._m[7]=o,this._m[8]=c,this._m[9]=u,this._m[10]=h,this._m[11]=l,this._m[12]=f,this._m[13]=b,this._m[14]=g,this._m[15]=m):this.assign(t)}return $traceurRuntime.createClass(t,{get m(){return this._m},toArray:function(){return[this._m[0],this._m[1],this._m[2],this._m[3],this._m[4],this._m[5],this._m[6],this._m[7],this._m[8],this._m[9],this._m[10],this._m[11],this._m[12],this._m[13],this._m[14],this._m[15]]},get m00(){return this._m[0]},get m01(){return this._m[1]},get m02(){return this._m[2]},get m03(){return this._m[3]},get m10(){return this._m[4]},get m11(){return this._m[5]},get m12(){return this._m[6]},get m13(){return this._m[7]},get m20(){return this._m[8]},get m21(){return this._m[9]},get m22(){return this._m[10]},get m23(){return this._m[11]},get m30(){return this._m[12]},get m31(){return this._m[13]},get m32(){return this._m[14]},get m33(){return this._m[15]},set m00(t){this._m[0]=t},set m01(t){this._m[1]=t},set m02(t){this._m[2]=t},set m03(t){this._m[3]=t},set m10(t){this._m[4]=t},set m11(t){this._m[5]=t},set m12(t){this._m[6]=t},set m13(t){this._m[7]=t},set m20(t){this._m[8]=t},set m21(t){this._m[9]=t},set m22(t){this._m[10]=t},set m23(t){this._m[11]=t},set m30(t){this._m[12]=t},set m31(t){this._m[13]=t},set m32(t){this._m[14]=t},set m33(t){this._m[15]=t},zero:function(){return this._m[0]=0,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=0,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=0,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=0,this},identity:function(){return this._m[0]=1,this._m[1]=0,this._m[2]=0,this._m[3]=0,this._m[4]=0,this._m[5]=1,this._m[6]=0,this._m[7]=0,this._m[8]=0,this._m[9]=0,this._m[10]=1,this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1,this},isZero:function(){return 0==this._m[0]&&0==this._m[1]&&0==this._m[2]&&0==this._m[3]&&0==this._m[4]&&0==this._m[5]&&0==this._m[6]&&0==this._m[7]&&0==this._m[8]&&0==this._m[9]&&0==this._m[10]&&0==this._m[11]&&0==this._m[12]&&0==this._m[13]&&0==this._m[14]&&0==this._m[15]},isIdentity:function(){return 1==this._m[0]&&0==this._m[1]&&0==this._m[2]&&0==this._m[3]&&0==this._m[4]&&1==this._m[5]&&0==this._m[6]&&0==this._m[7]&&0==this._m[8]&&0==this._m[9]&&1==this._m[10]&&0==this._m[11]&&0==this._m[12]&&0==this._m[13]&&0==this._m[14]&&1==this._m[15]},row:function(t){return new bg.Vector4(this._m[4*t],this._m[4*t+1],this._m[4*t+2],this._m[4*t+3])},setRow:function(t,e){return this._m[4*t]=e._v[0],this._m[4*t+1]=e._v[1],this._m[4*t+2]=e._v[2],this._m[4*t+3]=e._v[3],this},setScale:function(t,e,i){var n=new bg.Vector3(this._m[0],this._m[4],this._m[8]).normalize().scale(t),r=new bg.Vector3(this._m[1],this._m[5],this._m[9]).normalize().scale(e),s=new bg.Vector3(this._m[2],this._m[6],this._m[10]).normalize().scale(i);return this._m[0]=n.x,this._m[4]=n.y,this._m[8]=n.z,this._m[1]=r.x,this._m[5]=r.y,this._m[9]=r.z,this._m[2]=s.x,this._m[6]=s.y,this._m[10]=s.z,this},getScale:function(){return new bg.Vector3(new bg.Vector3(this._m[0],this._m[4],this._m[8]).module,new bg.Vector3(this._m[1],this._m[5],this._m[9]).module,new bg.Vector3(this._m[2],this._m[6],this._m[10]).module)},setPosition:function(t,e,i){return"number"==typeof t?(this._m[12]=t,this._m[13]=e,this._m[14]=i):(this._m[12]=t.x,this._m[13]=t.y,this._m[14]=t.z),this},get rotation(){var t=this.getScale();return new bg.Matrix4(this._m[0]/t.x,this._m[1]/t.y,this._m[2]/t.z,0,this._m[4]/t.x,this._m[5]/t.y,this._m[6]/t.z,0,this._m[8]/t.x,this._m[9]/t.y,this._m[10]/t.z,0,0,0,0,1)},get position(){return new bg.Vector3(this._m[12],this._m[13],this._m[14])},get length(){return this._m.length},getMatrix3:function(){return new bg.Matrix3(this._m[0],this._m[1],this._m[2],this._m[4],this._m[5],this._m[6],this._m[8],this._m[9],this._m[10])},perspective:function(t,e,i,n){return this.assign(bg.Matrix4.Perspective(t,e,i,n)),this},frustum:function(t,e,i,n,r,s){return this.assign(bg.Matrix4.Frustum(t,e,i,n,r,s)),this},ortho:function(t,e,i,n,r,s){return this.assign(bg.Matrix4.Ortho(t,e,i,n,r,s)),this},lookAt:function(t,e,i){return this.assign(bg.Matrix4.LookAt(t,e,i)),this},translate:function(t,e,i){return this.mult(bg.Matrix4.Translation(t,e,i)),this},rotate:function(t,e,i,n){return this.mult(bg.Matrix4.Rotation(t,e,i,n)),this},scale:function(t,e,i){return this.mult(bg.Matrix4.Scale(t,e,i)),this},elemAtIndex:function(t){return this._m[t]},assign:function(t){return 9==t.length?(this._m[0]=t._m[0],this._m[1]=t._m[1],this._m[2]=t._m[2],this._m[3]=0,this._m[4]=t._m[3],this._m[5]=t._m[4],this._m[6]=t._m[5],this._m[7]=0,this._m[8]=t._m[6],this._m[9]=t._m[7],this._m[10]=t._m[8],this._m[11]=0,this._m[12]=0,this._m[13]=0,this._m[14]=0,this._m[15]=1):16==t.length&&(this._m[0]=t._m[0],this._m[1]=t._m[1],this._m[2]=t._m[2],this._m[3]=t._m[3],this._m[4]=t._m[4],this._m[5]=t._m[5],this._m[6]=t._m[6],this._m[7]=t._m[7],this._m[8]=t._m[8],this._m[9]=t._m[9],this._m[10]=t._m[10],this._m[11]=t._m[11],this._m[12]=t._m[12],this._m[13]=t._m[13],this._m[14]=t._m[14],this._m[15]=t._m[15]),this},equals:function(t){return this._m[0]==t._m[0]&&this._m[1]==t._m[1]&&this._m[2]==t._m[2]&&this._m[3]==t._m[3]&&this._m[4]==t._m[4]&&this._m[5]==t._m[5]&&this._m[6]==t._m[6]&&this._m[7]==t._m[7]&&this._m[8]==t._m[8]&&this._m[9]==t._m[9]&&this._m[10]==t._m[10]&&this._m[11]==t._m[11]&&this._m[12]==t._m[12]&&this._m[13]==t._m[13]&&this._m[14]==t._m[14]&&this._m[15]==t._m[15]},notEquals:function(t){return this._m[0]!=t._m[0]||this._m[1]!=t._m[1]||this._m[2]!=t._m[2]||this._m[3]!=t._m[3]||this._m[4]!=t._m[4]||this._m[5]!=t._m[5]||this._m[6]!=t._m[6]||this._m[7]!=t._m[7]||this._m[8]!=t._m[8]||this._m[9]!=t._m[9]||this._m[10]!=t._m[10]||this._m[11]!=t._m[11]||this._m[12]!=t._m[12]||this._m[13]!=t._m[13]||this._m[14]!=t._m[14]||this._m[15]!=t._m[15]},mult:function(t){if("number"==typeof t)return this._m[0]*=t,this._m[1]*=t,this._m[2]*=t,this._m[3]*=t,this._m[4]*=t,this._m[5]*=t,this._m[6]*=t,this._m[7]*=t,this._m[8]*=t,this._m[9]*=t,this._m[10]*=t,this._m[11]*=t,this._m[12]*=t,this._m[13]*=t,this._m[14]*=t,this._m[15]*=t,this;var e=this._m,i=t._m,n=new bg.Math.Array(16);return n[0]=i[0]*e[0]+i[1]*e[4]+i[2]*e[8]+i[3]*e[12],n[1]=i[0]*e[1]+i[1]*e[5]+i[2]*e[9]+i[3]*e[13],n[2]=i[0]*e[2]+i[1]*e[6]+i[2]*e[10]+i[3]*e[14],n[3]=i[0]*e[3]+i[1]*e[7]+i[2]*e[11]+i[3]*e[15],n[4]=i[4]*e[0]+i[5]*e[4]+i[6]*e[8]+i[7]*e[12],n[5]=i[4]*e[1]+i[5]*e[5]+i[6]*e[9]+i[7]*e[13],n[6]=i[4]*e[2]+i[5]*e[6]+i[6]*e[10]+i[7]*e[14],n[7]=i[4]*e[3]+i[5]*e[7]+i[6]*e[11]+i[7]*e[15],n[8]=i[8]*e[0]+i[9]*e[4]+i[10]*e[8]+i[11]*e[12],n[9]=i[8]*e[1]+i[9]*e[5]+i[10]*e[9]+i[11]*e[13],n[10]=i[8]*e[2]+i[9]*e[6]+i[10]*e[10]+i[11]*e[14],n[11]=i[8]*e[3]+i[9]*e[7]+i[10]*e[11]+i[11]*e[15],n[12]=i[12]*e[0]+i[13]*e[4]+i[14]*e[8]+i[15]*e[12],n[13]=i[12]*e[1]+i[13]*e[5]+i[14]*e[9]+i[15]*e[13],n[14]=i[12]*e[2]+i[13]*e[6]+i[14]*e[10]+i[15]*e[14],n[15]=i[12]*e[3]+i[13]*e[7]+i[14]*e[11]+i[15]*e[15],this._m=n,this},multVector:function(t){"object"==$traceurRuntime.typeof(t)&&t._v&&t._v.length>=3&&(t=t._v);var e=t[0],i=t[1],n=t[2];return new bg.Vector4(this._m[0]*e+this._m[4]*i+this._m[8]*n+1*this._m[12],this._m[1]*e+this._m[5]*i+this._m[9]*n+1*this._m[13],this._m[2]*e+this._m[6]*i+this._m[10]*n+1*this._m[14],this._m[3]*e+this._m[7]*i+this._m[11]*n+1*this._m[15])},invert:function(){var t=this._m[0],e=this._m[1],i=this._m[2],n=this._m[3],r=this._m[4],s=this._m[5],a=this._m[6],o=this._m[7],c=this._m[8],u=this._m[9],h=this._m[10],l=this._m[11],f=this._m[12],b=this._m[13],g=this._m[14],m=this._m[15],p=t*s-e*r,d=t*a-i*r,_=t*o-n*r,v=e*a-i*s,x=e*o-n*s,T=i*o-n*a,M=c*b-u*f,S=c*g-h*f,E=c*m-l*f,w=u*g-h*b,y=u*m-l*b,j=h*m-l*g,C=p*j-d*y+_*w+v*E-x*S+T*M;return C?(C=1/C,this._m[0]=(s*j-a*y+o*w)*C,this._m[1]=(i*y-e*j-n*w)*C,this._m[2]=(b*T-g*x+m*v)*C,this._m[3]=(h*x-u*T-l*v)*C,this._m[4]=(a*E-r*j-o*S)*C,this._m[5]=(t*j-i*E+n*S)*C,this._m[6]=(g*_-f*T-m*d)*C,this._m[7]=(c*T-h*_+l*d)*C,this._m[8]=(r*y-s*E+o*M)*C,this._m[9]=(e*E-t*y-n*M)*C,this._m[10]=(f*x-b*_+m*p)*C,this._m[11]=(u*_-c*x-l*p)*C,this._m[12]=(s*S-r*w-a*M)*C,this._m[13]=(t*w-e*S+i*M)*C,this._m[14]=(b*d-f*v-g*p)*C,this._m[15]=(c*v-u*d+h*p)*C,this):(this.zero(),this)},traspose:function(){var t=new bg.Vector4(this._m[0],this._m[4],this._m[8],this._m[12]),e=new bg.Vector4(this._m[1],this._m[5],this._m[9],this._m[13]),i=new bg.Vector4(this._m[2],this._m[6],this._m[10],this._m[14]),n=new bg.Vector4(this._m[3],this._m[7],this._m[11],this._m[15]);return this.setRow(0,t),this.setRow(1,e),this.setRow(2,i),this.setRow(3,n),this},transformDirection:function(t){var e=new bg.Vector3(t),i=new bg.Matrix4(this);return i.setRow(3,new bg.Vector4(0,0,0,1)),e.assign(i.multVector(e).xyz),e.normalize(),e},get forwardVector(){return this.transformDirection(new bg.Vector3(0,0,1))},get rightVector(){return this.transformDirection(new bg.Vector3(1,0,0))},get upVector(){return this.transformDirection(new bg.Vector3(0,1,0))},get backwardVector(){return this.transformDirection(new bg.Vector3(0,0,-1))},get leftVector(){return this.transformDirection(new bg.Vector3(-1,0,0))},get downVector(){return this.transformDirection(new bg.Vector3(0,-1,0))},isNan:function(){return Number.isNaN(this._m[0])||Number.isNaN(this._m[1])||Number.isNaN(this._m[2])||Number.isNaN(this._m[3])||Number.isNaN(this._m[4])||Number.isNaN(this._m[5])||Number.isNaN(this._m[6])||Number.isNaN(this._m[7])||Number.isNaN(this._m[8])||Number.isNaN(this._m[9])||Number.isNaN(this._m[10])||Number.isNaN(this._m[11])||Number.isNaN(this._m[12])||Number.isNaN(this._m[13])||Number.isNaN(this._m[14])||Number.isNaN(this._m[15])},getOrthoValues:function(){return[(1+get23())/get22(),-(1-get23())/get22(),(1-get13())/get11(),-(1+get13())/get11(),-(1+get03())/get00(),(1-get03())/get00()]},getPerspectiveValues:function(){return[get23()/(get22()-1),get23()/(get22()+1),near*(get12()-1)/get11(),near*(get12()+1)/get11(),near*(get02()-1)/get00(),near*(get02()+1)/get00()]},toString:function(){return"["+this._m[0]+", "+this._m[1]+", "+this._m[2]+", "+this._m[3]+"]\n ["+this._m[4]+", "+this._m[5]+", "+this._m[6]+", "+this._m[7]+"]\n ["+this._m[8]+", "+this._m[9]+", "+this._m[10]+", "+this._m[11]+"]\n ["+this._m[12]+", "+this._m[13]+", "+this._m[14]+", "+this._m[15]+"]"}},{Unproject:function(t,e,i,n,r,s){var a=new bg.Matrix4(r);a.mult(n),a.invert();var o=new bg.Vector4((t-s.y)/s.width*2-1,(e-s.x)/s.height*2-1,2*i-1,1),c=new bg.Vector4(a.multVector(o));return 0==c.z?c.set(0):c.set(c.x/c.w,c.y/c.w,c.z/c.w,c.w/c.w),c},Identity:function(){return new bg.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},Perspective:function(t,e,i,n){var r=bg.Math.tan(t*bg.Math.PI/360)*i,s=r*e;return bg.Matrix4.Frustum(-s,s,-r,r,i,n)},Frustum:function(t,e,i,n,r,s){var a=new bg.Matrix4,o=e-t,c=n-i,u=s-r;return a.setRow(0,new bg.Vector4(2*r/o,0,0,0)),a.setRow(1,new bg.Vector4(0,2*r/c,0,0)),a.setRow(2,new bg.Vector4((e+t)/o,(n+i)/c,-(s+r)/u,-1)),a.setRow(3,new bg.Vector4(0,0,-s*r*2/u,0)),a},Ortho:function(t,e,i,n,r,s){var a=new bg.Matrix4,o=e-t,c=n-i,u=s-r;return a._m[0]=2/o,a._m[1]=0,a._m[2]=0,a._m[3]=0,a._m[4]=0,a._m[5]=2/c,a._m[6]=0,a._m[7]=0,a._m[8]=0,a._m[9]=0,a._m[10]=-2/u,a._m[11]=0,a._m[12]=-(t+e)/o,a._m[13]=-(n+i)/c,a._m[14]=-(s+r)/u,a._m[15]=1,a},LookAt:function(t,e,i){var n=new bg.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),r=new bg.Vector3(e);r.sub(t);var s=new bg.Vector3(i);r.normalize();var a=new bg.Vector3(r);return a.cross(s),s.assign(a),s.cross(r),n.set00(a.x),n.set10(a.y),n.set20(a.z),n.set01(s.x),n.set11(s.y),n.set21(s.z),n.set02(-r.x),n.set12(-r.y),n.set22(-r.z),n.setRow(3,new vwgl.Vector4(-t.x,-t.y,-t.z,1)),n},Translation:function(t,e,i){return"object"==$traceurRuntime.typeof(t)&&t._v&&t._v.length>=3&&(e=t._v[1],i=t._v[2],t=t._v[0]),new bg.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,t,e,i,1)},Rotation:function(t,e,i,n){var r=new bg.Vector3(e,i,n);r.normalize();var s=(new bg.Matrix4(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),bg.Math.cos(t)),a=1-s,o=bg.Math.sin(t);return new bg.Matrix4(r.x*r.x*a+s,r.x*r.y*a+r.z*o,r.x*r.z*a-r.y*o,0,r.y*r.x*a-r.z*o,r.y*r.y*a+s,r.y*r.z*a+r.x*o,0,r.z*r.x*a+r.y*o,r.z*r.y*a-r.x*o,r.z*r.z*a+s,0,0,0,0,1)},Scale:function(t,e,i){return"object"==$traceurRuntime.typeof(t)&&t._v&&t._v.length>=3&&(t=t._v[0],e=t._v[1],i=t._v[2]),new bg.Matrix4(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1)}})}();bg.Matrix4=e}(),function(){var t=function(){function t(t){this._v=t}return $traceurRuntime.createClass(t,{get v(){return this._v},get length(){return this._v.length},get x(){return this._v[0]},set x(t){this._v[0]=t},get y(){return this._v[1]},set y(t){this._v[1]=t},get module(){return this.magnitude()},toArray:function(){for(var t=[],e=0;e<this.v.length;++e)t.push(this.v[e]);return t}},{MinComponents:function(t,e){var i=Math.min(t.length,e.length),n=null;switch(i){case 2:n=new bg.Vector2;break;case 3:n=new bg.Vector3;break;case 4:n=new bg.Vector4}for(var r=0;r<i;++r)n._v[r]=t._v[r]<e._v[r]?t._v[r]:e._v[r];return n},MaxComponents:function(t,e){var i=Math.min(t.length,e.length),n=null;switch(i){case 2:n=new bg.Vector2;break;case 3:n=new bg.Vector3;break;case 4:n=new bg.Vector4}for(var r=0;r<i;++r)n._v[r]=t._v[r]>e._v[r]?t._v[r]:e._v[r];return n}})}();bg.VectorBase=t,bg.Vector=t;var e=function(t){function e(){var t=void 0!==arguments[0]?arguments[0]:0,i=arguments[1];$traceurRuntime.superConstructor(e).call(this,new bg.Math.Array(2)),t instanceof e?(this._v[0]=t._v[0],this._v[1]=t._v[1]):Array.isArray(t)&&t.length>=2?(this._v[0]=t[0],this._v[1]=t[1]):(void 0===i&&(i=t),this._v[0]=t,this._v[1]=i)}return $traceurRuntime.createClass(e,{distance:function(t){return new bg.Vector2(this._v[0]-t._v[0],this._v[1]-t._v[1]).magnitude()},normalize:function(){var t=this.magnitude();return this._v[0]=this._v[0]/t,this._v[1]=this._v[1]/t,this},add:function(t){return this._v[0]+=t._v[0],this._v[1]+=t._v[1],this},sub:function(t){return this._v[0]-=t._v[0],this._v[1]-=t._v[1],this},dot:function(t){return this._v[0]*t._v[0]+this._v[1]*t._v[1]},scale:function(t){return this._v[0]*=t,this._v[1]*=t,this},magnitude:function(){return Math.sqrt(this._v[0]*this._v[0]+this._v[1]*this._v[1])},elemAtIndex:function(t){return this._v[t]},equals:function(t){return this._v[0]==t._v[0]&&this._v[1]==t._v[1]},notEquals:function(t){return this._v[0]!=t._v[0]||this._v[1]!=t._v[1]},assign:function(t){this._v[0]=t._v[0],this._v[1]=t._v[1]},set:function(t,e){void 0===e&&(e=t),this._v[0]=t,this._v[1]=e},get width(){return this._v[0]},get height(){return this._v[1]},set width(t){this._v[0]=t},set height(t){this._v[1]=t},get aspectRatio(){return this._v[0]/this._v[1]},isNan:function(){return isNaN(this._v[0])||isNaN(this._v[1])},toString:function(){return"["+this._v+"]"}},{Add:function(t,i){return new e(t.x+i.x,t.y+i.y)},Sub:function(t,i){return new e(t.x-i.x,t.y-i.y)}},t)}(t);bg.Vector2=e;var i=function(t){function i(){var t=void 0!==arguments[0]?arguments[0]:0,n=void 0!==arguments[1]?arguments[1]:0,r=void 0!==arguments[2]?arguments[2]:0;$traceurRuntime.superConstructor(i).call(this,new bg.Math.Array(3)),t instanceof e?(this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=n):t instanceof i?(this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=t._v[2]):Array.isArray(t)&&t.length>=3?(this._v[0]=t[0],this._v[1]=t[1],this._v[2]=t[2]):(void 0===n&&(n=t),void 0===r&&(r=n),this._v[0]=t,this._v[1]=n,this._v[2]=r)}return $traceurRuntime.createClass(i,{get z(){return this._v[2]},set z(t){this._v[2]=t},magnitude:function(){return Math.sqrt(this._v[0]*this._v[0]+this._v[1]*this._v[1]+this._v[2]*this._v[2])},normalize:function(){var t=this.magnitude();return this._v[0]=this._v[0]/t,this._v[1]=this._v[1]/t,this._v[2]=this._v[2]/t,this},distance:function(t){return new bg.Vector3(this._v[0]-t._v[0],this._v[1]-t._v[1],this._v[2]-t._v[2]).magnitude()},add:function(t){return this._v[0]+=t._v[0],this._v[1]+=t._v[1],this._v[2]+=t._v[2],this},sub:function(t){return this._v[0]-=t._v[0],this._v[1]-=t._v[1],this._v[2]-=t._v[2],this},dot:function(t){return this._v[0]*t._v[0]+this._v[1]*t._v[1]+this._v[2]*t._v[2]},scale:function(t){return this._v[0]*=t,this._v[1]*=t,this._v[2]*=t,this},cross:function(t){var e=this._v[1]*t._v[2]-this._v[2]*t._v[1],i=this._v[2]*t._v[0]-this._v[0]*t._v[2],n=this._v[0]*t._v[1]-this._v[1]*t._v[0];return this._v[0]=e,this._v[1]=i,this._v[2]=n,this},elemAtIndex:function(t){return this._v[t]},equals:function(t){return this._v[0]==t._v[0]&&this._v[1]==t._v[1]&&this._v[2]==t._v[2]},notEquals:function(t){return this._v[0]!=t._v[0]||this._v[1]!=t._v[1]||this._v[2]!=t._v[2]},assign:function(t){this._v[0]=t._v[0],this._v[1]=t._v[1],t._v.length>=3&&(this._v[2]=t._v[2])},set:function(t,e,i){this._v[0]=t,this._v[1]=void 0===e?t:e,this._v[2]=void 0===e?t:void 0===i?e:i},get width(){return this._v[0]},get height(){return this._v[1]},get depth(){return this._v[2]},set width(t){
this._v[0]=t},set height(t){this._v[1]=t},set depth(t){this._v[2]=t},get xy(){return new bg.Vector2(this._v[0],this._v[1])},get yz(){return new bg.Vector2(this._v[1],this._v[2])},get xz(){return new bg.Vector2(this._v[0],this._v[2])},isNan:function(){return isNaN(this._v[0])||isNaN(this._v[1])||isNaN(this._v[2])},toString:function(){return"["+this._v+"]"}},{Add:function(t,e){return new i(t.x+e.x,t.y+e.y,t.z+e.z)},Sub:function(t,e){return new i(t.x-e.x,t.y-e.y,t.z-e.z)}},t)}(t);bg.Vector3=i;var n=function(t){function n(){var t=void 0!==arguments[0]?arguments[0]:0,r=void 0!==arguments[1]?arguments[1]:0,s=void 0!==arguments[2]?arguments[2]:0,a=void 0!==arguments[3]?arguments[3]:0;$traceurRuntime.superConstructor(n).call(this,new bg.Math.Array(4)),t instanceof e?(this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=r,this._v[3]=s):t instanceof i?(this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=t._v[2],this._v[3]=r):t instanceof n?(this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=t._v[2],this._v[3]=t._v[3]):Array.isArray(t)&&t.length>=4?(this._v[0]=t[0],this._v[1]=t[1],this._v[2]=t[2],this._v[3]=t[3]):(void 0===r&&(r=t),void 0===s&&(s=r),void 0===a&&(a=s),this._v[0]=t,this._v[1]=r,this._v[2]=s,this._v[3]=a)}return $traceurRuntime.createClass(n,{get z(){return this._v[2]},set z(t){this._v[2]=t},get w(){return this._v[3]},set w(t){this._v[3]=t},magnitude:function(){return Math.sqrt(this._v[0]*this._v[0]+this._v[1]*this._v[1]+this._v[2]*this._v[2]+this._v[3]*this._v[3])},normalize:function(){var t=this.magnitude();return this._v[0]=this._v[0]/t,this._v[1]=this._v[1]/t,this._v[2]=this._v[2]/t,this._v[3]=this._v[3]/t,this},distance:function(t){return new bg.Vector4(this._v[0]-t._v[0],this._v[1]-t._v[1],this._v[2]-t._v[2],this._v[3]-t._v[3]).magnitude()},add:function(t){return this._v[0]+=t._v[0],this._v[1]+=t._v[1],this._v[2]+=t._v[2],this._v[3]+=t._v[3],this},sub:function(t){return this._v[0]-=t._v[0],this._v[1]-=t._v[1],this._v[2]-=t._v[2],this._v[3]-=t._v[3],this},dot:function(t){return this._v[0]*t._v[0]+this._v[1]*t._v[1]+this._v[2]*t._v[2]+this._v[3]*t._v[3]},scale:function(t){return this._v[0]*=t,this._v[1]*=t,this._v[2]*=t,this._v[3]*=t,this},elemAtIndex:function(t){return this._v[t]},equals:function(t){return this._v[0]==t._v[0]&&this._v[1]==t._v[1]&&this._v[2]==t._v[2]&&this._v[3]==t._v[3]},notEquals:function(t){return this._v[0]!=t._v[0]||this._v[1]!=t._v[1]||this._v[2]!=t._v[2]||this._v[3]!=t._v[3]},assign:function(t){this._v[0]=t._v[0],this._v[1]=t._v[1],t._v.length>=3&&(this._v[2]=t._v[2]),4==t._v.length&&(this._v[3]=t._v[3])},set:function(t,e,i,n){this._v[0]=t,this._v[1]=void 0===e?t:e,this._v[2]=void 0===e?t:void 0===i?e:i,this._v[3]=void 0===e?t:void 0===i?e:void 0===n?i:n},get r(){return this._v[0]},get g(){return this._v[1]},get b(){return this._v[2]},get a(){return this._v[3]},set r(t){this._v[0]=t},set g(t){this._v[1]=t},set b(t){this._v[2]=t},set a(t){this._v[3]=t},get xy(){return new bg.Vector2(this._v[0],this._v[1])},get yz(){return new bg.Vector2(this._v[1],this._v[2])},get xz(){return new bg.Vector2(this._v[0],this._v[2])},get xyz(){return new bg.Vector3(this._v[0],this._v[1],this._v[2])},get width(){return this._v[2]},get height(){return this._v[3]},set width(t){this._v[2]=t},set height(t){this._v[3]=t},get aspectRatio(){return 0!=this._v[3]?this._v[2]/this._v[3]:1},isNan:function(){return isNaN(this._v[0])||isNaN(this._v[1])||isNaN(this._v[2])||isNaN(this._v[3])},toString:function(){return"["+this._v+"]"}},{Add:function(t,e){return new n(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)},Sub:function(t,e){return new n(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)},Yellow:function(){return new bg.Vector4(1,1,0,1)},Orange:function(){return new bg.Vector4(1,.5,0,1)},Red:function(){return new bg.Vector4(1,0,0,1)},Violet:function(){return new bg.Vector4(.5,0,1,1)},Blue:function(){return new bg.Vector4(0,0,1,1)},Green:function(){return new bg.Vector4(0,1,0,1)},White:function(){return new bg.Vector4(1,1,1,1)},LightGray:function(){return new bg.Vector4(.8,.8,.8,1)},Gray:function(){return new bg.Vector4(.5,.5,.5,1)},DarkGray:function(){return new bg.Vector4(.2,.2,.2,1)},Black:function(){return new bg.Vector4(0,0,0,1)},Brown:function(){return new bg.Vector4(.4,.2,0,1)},Transparent:function(){return new bg.Vector4(0,0,0,0)}},t)}(t);bg.Vector4=n,bg.Size2D=e,bg.Size3D=i,bg.Position2D=e,bg.Viewport=n,bg.Color=n;var r=function(t){function e(){var t=void 0!==arguments[0]?arguments[0]:0,i=void 0!==arguments[1]?arguments[1]:0,n=void 0!==arguments[2]?arguments[2]:0,r=void 0!==arguments[3]?arguments[3]:0,s=void 0!==arguments[4]?arguments[4]:0,a=void 0!==arguments[5]?arguments[5]:0;$traceurRuntime.superConstructor(e).call(this,new bg.Math.Array(6)),this._v[0]=t,this._v[1]=i,this._v[2]=n,this._v[3]=r,this._v[4]=s,this._v[5]=a}return $traceurRuntime.createClass(e,{elemAtIndex:function(t){return this._v[t]},equals:function(t){return this._v[0]==t._v[0]&&this._v[1]==t._v[1]&&this._v[2]==t._v[2]&&this._v[3]==t._v[3]&&this._v[4]==t._v[4]&&this._v[5]==t._v[5]},notEquals:function(t){return this._v[0]!=t._v[0]||this._v[1]!=t._v[1]||this._v[2]!=t._v[2]||this._v[3]!=t._v[3]||this._v[4]!=t._v[4]||this._v[5]!=t._v[5]},assign:function(t){this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=t._v[2],this._v[3]=t._v[3],this._v[4]=t._v[4],this._v[5]=t._v[5]},set:function(t,e,i,n,r,s){this._v[0]=t,this._v[1]=void 0===e?t:e,this._v[2]=void 0===e?t:i,this._v[3]=void 0===e?t:n,this._v[4]=void 0===e?t:r,this._v[5]=void 0===e?t:s},get left(){return this._v[0]},get right(){return this._v[1]},get bottom(){return this._v[2]},get top(){return this._v[3]},get back(){return this._v[4]},get front(){return this._v[5]},set left(t){this._v[0]=t},set right(t){this._v[1]=t},set bottom(t){this._v[2]=t},set top(t){this._v[3]=t},set back(t){this._v[4]=t},set front(t){this._v[5]=t},get width(){return Math.abs(this._v[1]-this._v[0])},get height(){return Math.abs(this._v[3]-this._v[2])},get depth(){return Math.abs(this._v[5]-this._v[4])},isNan:function(){return isNaN(this._v[0])||isNaN(this._v[1])||isNaN(this._v[2])||isNaN(this._v[3])||isNaN(this._v[4])||isNaN(this._v[5])},toString:function(){return"["+this._v+"]"},isInBounds:function(t){return t.x>=this._v[0]&&t.x<=this._v[1]&&t.y>=this._v[2]&&t.y<=this._v[3]&&t.z>=this._v[4]&&t.z<=this._v[5]}},{},t)}(t);bg.Bounds=r;var s=function(t){function e(t,i,n,r){$traceurRuntime.superConstructor(e).call(this),void 0===t?this.zero():void 0===i?t._v&&t._v.lenght>=4?this.clone(t):t._m&&9==t._m.length?this.initWithMatrix3(t):t._m&&16==t._m.length?this.initWithMatrix4(t):this.zero():void 0!==t&&void 0!==i&&void 0!==n&&void 0!==r?this.initWithValues(t,i,n,r):this.zero()}return $traceurRuntime.createClass(e,{initWithValues:function(t,e,i,n){return this._v[0]=e*bg.Math.sin(t/2),this._v[1]=i*bg.Math.sin(t/2),this._v[2]=n*bg.Math.sin(t/2),this._v[3]=bg.Math.cos(t/2),this},clone:function(t){this._v[0]=t._v[0],this._v[1]=t._v[1],this._v[2]=t._v[2],this._v[3]=t._v[3]},initWithMatrix3:function(t){var e=bg.Math.sqrt(1+t._m[0]+t._m[4]+t._m[8])/2,i=4*e;this._v[0]=(t._m[7]-t._m[5])/e,this._v[1]=(t._m[2]-t._m[6])/i,this._v[2]=(t._m[3]-t._m[1])/i,this._v[3]=e},initWithMatrix4:function(t){var e=bg.Math.sqrt(1+t._m[0]+t._m[5]+t._m[10])/2,i=4*e;this._v[0]=(t._m[9]-t._m[6])/e,this._v[1]=(t._m[2]-t._m[8])/i,this._v[2]=(t._m[4]-t._m[1])/i,this._v[3]=e},getMatrix4:function(){var t=bg.Matrix4.Identity(),e=this._v;return t.setRow(0,new bg.Vector4(1-2*e[1]*e[1]-2*e[2]*e[2],2*e[0]*e[1]-2*e[2]*e[3],2*e[0]*e[2]+2*e[1]*e[3],0)),t.setRow(1,new bg.Vector4(2*e[0]*e[1]+2*e[2]*e[3],1-2*e[0]*e[0]-2*e[2]*e[2],2*e[1]*e[2]-2*e[0]*e[3],0)),t.setRow(2,new bg.Vector4(2*e[0]*e[2]-2*e[1]*e[3],2*e[1]*e[2]+2*e[0]*e[3],1-2*e[0]*e[0]-2*e[1]*e[1],0)),t},getMatrix3:function(){var t=bg.Matrix3.Identity(),e=this._v;return t.setRow(0,new bg.Vector3(1-2*e[1]*e[1]-2*e[2]*e[2],2*e[0]*e[1]-2*e[2]*e[3],2*e[0]*e[2]+2*e[1]*e[3])),t.setRow(1,new bg.Vector3(2*e[0]*e[1]+2*e[2]*e[3],1-2*e[0]*e[0]-2*e[2]*e[2],2*e[1]*e[2]-2*e[0]*e[3])),t.setRow(2,new bg.Vector3(2*e[0]*e[2]-2*e[1]*e[3],2*e[1]*e[2]+2*e[0]*e[3],1-2*e[0]*e[0]-2*e[1]*e[1])),t}},{MakeWithMatrix:function(t){return new e(t)}},t)}(n);bg.Quaternion=s}(),bg.physics={},function(){bg.physics.IntersectionType={NONE:0,POINT:1,LLINE:2};var t=function(){function t(){this._type=null,this._p0=null,this._p1=null}return $traceurRuntime.createClass(t,{get type(){return this._type},get point(){return this._p0},get endPoint(){return this._p1},intersects:function(){return!1}},{RayToPlane:function(t,e){return new bg.physics.RayToPlaneIntersection(t,e)}})}();bg.physics.Intersection=t;var e=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this),this._ray=null,this._p0=null,this._type=bg.physics.IntersectionType.POINT;var n=new bg.Vector3(i.origin),r=new bg.Vector3(i.normal),s=new bg.Vector3(t.start),a=new bg.Vector3(t.vector),o=n.sub(s).dot(r),c=a.dot(r);if(0!=c){var u=o/c;u>t.magnitude||(this._ray=bg.physics.Ray.RayWithVector(t.vector,t.start,u),this._p0=this._ray.end)}}return $traceurRuntime.createClass(e,{get ray(){return this._ray},intersects:function(){return null!=this._ray&&null!=this._p0}},{},t)}(bg.physics.Intersection);bg.physics.RayToPlaneIntersection=e}(),function(){var t=function(){function t(){this._transform=bg.Matrix4.Identity()}return $traceurRuntime.createClass(t,{get transform(){return this._transform},set transform(t){this._transform=t},applyTransform:function(t){},calculateTransform:function(){}},{Factory:function(t){switch(t.type){case"LinkJoint":return e.Factory(t)}return null}})}();bg.physics.Joint=t,bg.physics.LinkTransformOrder={TRANSLATE_ROTATE:1,ROTATE_TRANSLATE:0};var e=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this._offset=new bg.Vector3,this._eulerRotation=new bg.Vector3,this._transformOrder=bg.physics.LinkTransformOrder.TRANSLATE_ROTATE}return $traceurRuntime.createClass(e,{applyTransform:function(t){t.mult(this.transform)},assign:function(t){this.yaw=t.yaw,this.pitch=t.pitch,this.roll=t.roll,this.offset.assign(t.offset),this.transformOrder=t.transformOrder},get offset(){return this._offset},set offset(t){this._offset=t,this.calculateTransform()},get eulerRotation(){return this._eulerRotation},set eulerRotation(t){this._eulerRotation=t,this.calculateTransform()},get yaw(){return this._eulerRotation.x},get pitch(){return this._eulerRotation.y},get roll(){return this._eulerRotation.z},set yaw(t){this._eulerRotation.x=t,this.calculateTransform()},set pitch(t){this._eulerRotation.y=t,this.calculateTransform()},set roll(t){this._eulerRotation.z=t,this.calculateTransform()},get transformOrder(){return this._transformOrder},set transformOrder(t){this._transformOrder=t,this.calculateTransform()},multTransform:function(t){var e=this.offset;switch(this.transformOrder){case bg.physics.LinkTransformOrder.TRANSLATE_ROTATE:t.translate(e.x,e.y,e.z),this.multRotation(t);break;case bg.physics.LinkTransformOrder.TRANSLATE_ROTATE:this.multRotation(t),t.translate(e.x,e.y,e.z)}},multRotation:function(t){t.rotate(this.eulerRotation.z,0,0,1).rotate(this.eulerRotation.y,0,1,0).rotate(this.eulerRotation.x,1,0,0)},calculateTransform:function(){this.transform.identity(),this.multTransform(this.transform)},serialize:function(t){t.type="LinkJoint",t.offset=[this.offset.x,this.offset.y,this.offset.z],t.yaw=this.yaw,t.pitch=this.pitch,t.roll=this.roll,t.order=this.order}},{Factory:function(t){var i=new e;return i.offset=new bg.Vector3(t.offset[0]||0,t.offset[1]||0,t.offset[2]||0),i.yaw=t.yaw||0,i.pitch=t.pitch||0,i.roll=t.roll||0,i.order=t.order||1,i}},t)}(t);bg.physics.LinkJoint=e}(),function(){var t=function(){function t(t,e,i){if(t=t instanceof bg.Vector3&&t,e=e instanceof bg.Vector3&&e,i=i instanceof bg.Vector3&&i,t&&!e)this._normal=new bg.Vector3(t),this._origin=new bg.Vector3(0);else if(t&&e&&!i)this._normal=new bg.Vector3(t),this._origin=new bg.Vector3(e);else if(t&&e&&i){var n=new bg.Vector3(t);n.sub(e);var r=new bg.Vector3(i);r.sub(t),this._origin=new bg.Vector3(p1),this._normal=new bg.Vector3(n),this._normal.cross(r).normalize()}else this._origin=new bg.Vector3(0),this._normal=new bg.Vector3(0,1,0)}return $traceurRuntime.createClass(t,{get normal(){return this._normal},set normal(t){this._normal.assign(t)},get origin(){return this._origin},set origin(t){this._origin.assign(t)},toString:function(){return"P0: "+this._origin.toString()+", normal:"+this._normal.toString()},valid:function(){return!this._origin.isNan()&&!this._normal.isNan()},assign:function(t){return this._origin.assign(t._origin),this._normal.assign(t._normal),this},equals:function(t){return this._origin.equals(t._origin)&&this._normal.equals(t._normal)}},{})}();bg.physics.Plane=t}(),function(){function t(t){t._vector=new bg.Vector3(t._end),t._vector.sub(t._start),t._magnitude=t._vector.magnitude(),t._vector.normalize()}var e=function(){function e(e,i){this._start=e||new bg.Vector3,this._end=i||new bg.Vector3(1),t(this)}return $traceurRuntime.createClass(e,{setWithPoints:function(e,i){return this._start.assign(e),this._end.assign(i),t(),this},setWithVector:function(e,i,n){this._start.assign(i),this._end.assign(i);var r=new bg.Vector3(e);return r.normalize().scale(n),this._end.add(r),t(this),this},setWithScreenPoint:function(e,i,n,r){var s=bg.Matrix4.Unproject(e.x,e.y,0,n,i,r),a=bg.Matrix4.Unproject(e.x,e.y,1,n,i,r);return this._start=s.xyz,this._end=a.xyz,t(this),this},assign:function(t){this._start.assign(t.start),this._end.assign(t.end),this._vector.assign(t.vector),this._magnitude.assign(t.magnitude)},get start(){return this._start},set start(e){this._start.assign(e),t(this)},get end(){return this._end},set end(t){this._end.assign(t)},get vector(){return this._vector},get magnitude(){return this._magnitude},toString:function(){return"start: "+this.start.toString()+", end: "+this.end.toString()}},{RayWithPoints:function(t,i){return new e(t,i)},RayWithVector:function(t,i,n){var r=new e;return r.setWithVector(t,i,n),r},RayWithScreenPoint:function(t,i,n,r){var s=new e;return s.setWithScreenPoint(t,i,n,r),s}})}();bg.physics.Ray=e}(),bg.scene={},function(){var t={},e=function(e){function i(){$traceurRuntime.superConstructor(i).call(this),this._node=null,this._drawGizmo=!0}return $traceurRuntime.createClass(i,{clone:function(){return bg.log("WARNING: Component with typeid "+this.typeId+" does not implmement the clone() method."),null},get node(){return this._node},get typeId(){return this._typeId},get draw3DGizmo(){return this._drawGizmo},set draw3DGizmo(t){this._drawGizmo=t},removedFromNode:function(t){},addedToNode:function(t){},get shouldSerialize(){return!0},deserialize:function(t,e,i){return Promise.resolve(this)},serialize:function(t,e,i){t.type=this.typeId.split(".").pop()},component:function(t){return this._node&&this._node.component(t)},get camera(){return this.component("bg.scene.Camera")},get chain(){return this.component("bg.scene.Chain")},get drawable(){return this.component("bg.scene.Drawable")},get inputChainJoint(){return this.component("bg.scene.InputChainJoint")},get outputChainJoint(){return this.component("bg.scene.OutputChainJoint")},get light(){return this.component("bg.scene.Light")},get transform(){return this.component("bg.scene.Transform")}},{Factory:function(e,i,n,r){var s=t[i.type];if(s){var a=new s;return n.addComponent(a),a.deserialize(e,i,r)}return Promise.resolve()}},e)}(bg.LifeCycle);bg.scene.Component=e,bg.scene.registerComponent=function(e,i,n){var r=/function (.+)\(/.exec(i.toString());r||(r=/class ([a-zA-Z0-9_]+) /.exec(i.toString()));var s=r&&r.length>1?r[1]:"";e[s]=i,i.prototype._typeId=n||s,t[s]=i}}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._context=t}return $traceurRuntime.createClass(e,{get context(){return this._context},set context(t){this._context=t}},{},t)}(bg.LifeCycle),e=function(t){function e(t){var i=void 0!==arguments[1]?arguments[1]:"";$traceurRuntime.superConstructor(e).call(this,t),this._name=i,this._enabled=!0,this._components={}}return $traceurRuntime.createClass(e,{cloneComponents:function(){var t=new bg.scene.Node(this.context,this.name?"copy of "+this.name:"");return t.enabled=this.enabled,this.forEachComponent(function(e){t.addComponent(e.clone())}),t},get name(){return this._name},set name(t){this._name=t},get enabled(){return this._enabled},set enabled(t){this._enabled=t},addComponent:function(t){t._node&&t._node.removeComponent(t),t._node=this,this._components[t.typeId]=t,t.addedToNode(this)},removeComponent:function(t){var e="",i=null;return"string"==typeof t?(e=t,i=this.component(t)):t instanceof bg.scene.Component&&(i=t,e=t.typeId),this._components[e]==i&&null!=i&&(delete this._components[e],i.removedFromNode(this),!0)},component:function(t){return this._components[t]},get camera(){return this.component("bg.scene.Camera")},get chain(){return this.component("bg.scene.Chain")},get drawable(){return this.component("bg.scene.Drawable")},get inputJoint(){return this.component("bg.scene.InputJoint")},get outputJoint(){return this.component("bg.scene.OutputJoint")},get light(){return this.component("bg.scene.Light")},get transform(){return this.component("bg.scene.Transform")},forEachComponent:function(t){var e=Object.keys(this._components),i=!0,n=!1,r=void 0;try{for(var s=void 0,a=e[Symbol.iterator]();!(i=(s=a.next()).done);i=!0){var o=s.value;t(this._components[o],o,this._components)}}catch(t){n=!0,r=t}finally{try{i||null==a.return||a.return()}finally{if(n)throw r}}},someComponent:function(t){var e=Object.keys(this._components),i=!0,n=!1,r=void 0;try{for(var s=void 0,a=e[Symbol.iterator]();!(i=(s=a.next()).done);i=!0){var o=s.value;if(t(this._components[o],o,this._components))return!0}}catch(t){n=!0,r=t}finally{try{i||null==a.return||a.return()}finally{if(n)throw r}}return!1},everyComponent:function(t){var e=Object.keys(this._components),i=!0,n=!1,r=void 0;try{for(var s=void 0,a=e[Symbol.iterator]();!(i=(s=a.next()).done);i=!0){var o=s.value;if(!t(this._components[o],o,this._components))return!1}}catch(t){n=!0,r=t}finally{try{i||null==a.return||a.return()}finally{if(n)throw r}}return!0},destroy:function(){var t=this;this.forEachComponent(function(e){e.removedFromNode(t)}),this._components={}},init:function(){this.forEachComponent(function(t){t.init()})},frame:function(t){this.forEachComponent(function(e){e._initialized_||(e.init(),e._initialized_=!0),e.frame(t)})},willDisplay:function(t,e){this.forEachComponent(function(i){i.willDisplay(t,e)})},display:function(t,e){this.forEachComponent(function(i){i.display(t,e)})},displayGizmo:function(t,e){this.forEachComponent(function(i){i.draw3DGizmo&&i.displayGizmo(t,e)})},didDisplay:function(t,e){this.forEachComponent(function(i){i.didDisplay(t,e)})},reshape:function(t,e,i,n){this.forEachComponent(function(t){t.reshape(i,n)})},keyDown:function(t){this.forEachComponent(function(e){e.keyDown(t)})},keyUp:function(t){this.forEachComponent(function(e){e.keyUp(t)})},mouseUp:function(t){this.forEachComponent(function(e){e.mouseUp(t)})},mouseDown:function(t){this.forEachComponent(function(e){e.mouseDown(t)})},mouseMove:function(t){this.forEachComponent(function(e){e.mouseMove(t)})},mouseOut:function(t){this.forEachComponent(function(e){e.mouseOut(t)})},mouseDrag:function(t){this.forEachComponent(function(e){e.mouseDrag(t)})},mouseWheel:function(t){this.forEachComponent(function(e){e.mouseWheel(t)})},touchStart:function(t){this.forEachComponent(function(e){e.touchStart(t)})},touchMove:function(t){this.forEachComponent(function(e){e.touchMove(t)})},touchEnd:function(t){this.forEachComponent(function(e){e.touchEnd(t)})}},{},t)}(t);bg.scene.SceneObject=e}(),function(){function t(e,i){return!(!e||!i)&&(e._parent==i||t(e._parent,i))}function e(t){var i=[],n=[];t.forEachComponent(function(t){return i.push(t)}),t.children.forEach(function(t){return n.push(t)}),i.forEach(function(e){return t.removeComponent(e)}),n.forEach(function(i){t.removeChild(i),e(i)})}var i=function(i){function n(t){var e=void 0!==arguments[1]?arguments[1]:"";$traceurRuntime.superConstructor(n).call(this,t,e),this._children=[],this._parent=null}return $traceurRuntime.createClass(n,{addChild:function(t){t&&!this.isAncientOf(t)&&t!=this&&(t.parent&&t.parent.removeChild(t),this._children.push(t),t._parent=this)},removeChild:function(t){var e=this._children.indexOf(t);e>=0&&this._children.splice(e,1)},get children(){return this._children},get parent(){return this._parent},get sceneRoot(){return this._parent?this._parent.sceneRoot():this},haveChild:function(t){return-1!=this._children.indexOf(t)},isAncientOf:function(e){t(this,e)},accept:function(t){t.ignoreDisabled&&!this.enabled||(t.visit(this),this._children.forEach(function(e){e.accept(t)}),t.didVisit(this))},acceptReverse:function(t){t.ignoreDisabled&&!this.enabled||(this._parent&&this._parent.acceptReverse(t),t.visit(this))},destroy:function(){$traceurRuntime.superGet(this,n.prototype,"destroy").call(this),this._children.forEach(function(t){t.destroy()}),this._children=[]}},{CleanupNode:function(t){e(t)}},i)}(bg.scene.SceneObject);bg.scene.Node=i;var n=function(){function t(){this._ignoreDisabled=!0}return $traceurRuntime.createClass(t,{get ignoreDisabled(){return this._ignoreDisabled},set ignoreDisabled(t){this._ignoreDisabled=t},visit:function(t){},didVisit:function(t){}},{})}();bg.scene.NodeVisitor=n}(),function(){function t(t,e,i){for(var n=new bg.base.PolyList(t),r=[],s=[],a=[],o=0,c=0;c<e.length;c+=3)r.push(0),r.push(0),r.push(1),s.push(0),s.push(0),a.push(o++);return n.vertex=e,n.normal=r,n.texCoord0=s,n.color=i,n.index=a,n.drawMode=bg.base.DrawMode.LINES,n.build(),n}function e(){if(!this._gizmo){var e=this.projectionStrategy?this.projectionStrategy.fov:bg.Math.PI_4;e*=.5;var i=this.focus,n=bg.app.MainLoop.singleton.canvas.width/bg.app.MainLoop.singleton.canvas.height,r=bg.Math.sin(e)*i,s=bg.Math.sin(e)*i/n,a=[0,0,0,r,s,-i,0,0,0,-r,s,-i,0,0,0,r,-s,-i,0,0,0,-r,-s,-i,r,s,-i,-r,s,-i,-r,s,-i,-r,-s,-i,-r,-s,-i,r,-s,-i,r,-s,-i,r,s,-i],o=[1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1];this._gizmo=t(this.node.context,a,o)}return this._gizmo}function i(t){t.camera&&(t.camera.isMain=!1),t.children.forEach(function(t){return i(t)})}var n=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._near=.1,this._far=100,this._viewport=new bg.Viewport(0,0,512,512)}return $traceurRuntime.createClass(e,{clone:function(){console.log("WARNING: ProjectionStrategy::clone() method not implemented by child class.")},get near(){return this._near},set near(t){this._near=t},get far(){return this._far},set far(t){this._far=t},get viewport(){return this._viewport},set viewport(t){this._viewport=t},get fov(){return 0},serialize:function(t){t.near=this.near,t.far=this.far}},{Factory:function(t){var e=null;return t&&("PerspectiveProjectionMethod"==t.type?e=new r:"OpticalProjectionMethod"==t.type&&(e=new s),e&&e.deserialize(t)),e}},t)}(bg.MatrixStrategy);bg.scene.ProjectionStrategy=n;var r=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._fov=60}return $traceurRuntime.createClass(e,{clone:function(){var t=new e;return t.near=this.near,t.far=this.far,t.viewport=this.viewport,t.fov=this.fov,t},get fov(){return this._fov},set fov(t){this._fov=t},apply:function(){this.target&&this.target.perspective(this.fov,this.viewport.aspectRatio,this.near,this.far)},deserialize:function(t){this.near=t.near,this.far=t.far,this.fov=t.fov},serialize:function(t){t.type="PerspectiveProjectionMethod",t.fov=this.fov,$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t)}},{},t)}(n);bg.scene.PerspectiveProjectionStrategy=r;var s=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._focalLength=50,this._frameSize=35}return $traceurRuntime.createClass(e,{clone:function(){var t=new e;return t.near=this.near,t.far=this.far,t.viewport=this.viewport,t.focalLength=this.focalLength,t.frameSize=this.frameSize,t},get focalLength(){return this._focalLength},set focalLength(t){this._focalLength=t},get frameSize(){return this._frameSize},set frameSize(t){this._frameSize=t},get fov(){return 2*bg.Math.atan(this.frameSize/(this.focalLength/2))},apply:function(){if(this.target){var t=this.fov;t=bg.Math.radiansToDegrees(t),this.target.perspective(t,this.viewport.aspectRatio,this.near,this.far)}},deserialize:function(t){this.frameSize=t.frameSize,this.focalLength=t.focalLength,this.near=t.near,this.far=t.far},serialize:function(t){t.type="OpticalProjectionMethod",t.frameSize=this.frameSize,t.focalLength=this.focalLength,$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t)}},{},t)}(n);bg.scene.OpticalProjectionStrategy=s;var a=function(t){function r(){$traceurRuntime.superConstructor(r).call(this),this._projection=bg.Matrix4.Perspective(60,1,.1,100),this._viewport=new bg.Viewport(0,0,512,512),this._visitor=new bg.scene.TransformVisitor,this._rebuildTransform=!0,this._clearBuffers=bg.base.ClearBuffers.COLOR_DEPTH,this._focus=5,this._projectionStrategy=null,this._isMain=!1}return $traceurRuntime.createClass(r,{clone:function(){var t=new bg.scene.Camera;return t._projection=new bg.Matrix4(this._projection),t._viewport=new bg.Matrix4(this._viewport),t._projectionStrategy=this._projectionStrategy?this._projectionStrategy.clone():null,t},get projection(){return this._projection},set projection(t){this._projectionStrategy||(this._projection=t)},get viewport(){return this._viewport},set viewport(t){this._viewport=t,this._projectionStrategy&&(this._projectionStrategy.viewport=t,this._projectionStrategy.apply())},get focus(){return this._focus},set focus(t){this._focus=t,this.recalculateGizmo()},get isMain(){return this._isMain},set isMain(t){this._isMain=t},get projectionStrategy(){return this._projectionStrategy},set projectionStrategy(t){this._projectionStrategy=t,this._projectionStrategy&&(this._projectionStrategy.target=this._projection),this.recalculateGizmo()},get clearBuffers(){return this._clearBuffers},set clearBuffers(t){this._clearBuffers=t},get modelMatrix(){return this._rebuildTransform&&this.node&&(this._visitor.matrix.identity(),this.node.acceptReverse(this._visitor),this._rebuildTransform=!1),this._visitor.matrix},get viewMatrix(){return this._viewMatrix&&!this._rebuildTransform||(this._viewMatrix=new bg.Matrix4(this.modelMatrix),this._viewMatrix.invert()),this._viewMatrix},recalculateGizmo:function(){this._gizmo&&(this._gizmo.destroy(),this._gizmo=null)},frame:function(t){this._rebuildTransform=!0},displayGizmo:function(t,i){if(!this.isMain){var n=e.apply(this);n&&t.draw(n)}},serialize:function(t,e,i){if($traceurRuntime.superGet(this,r.prototype,"serialize").call(this,t,e,i),t.isMain=this.isMain,this.projectionStrategy){var n={};t.projectionMethod=n,this.projectionStrategy.serialize(n)}},deserialize:function(t,e,i){e.isMain=e.isMain||!1,this.projectionStrategy=n.Factory(e.projectionMethod||{})}},{SetAsMainCamera:function(t,e){if(i(e),t instanceof r)t.isMain=!0;else{if(!(t instanceof bg.scene.Node&&t.camera))throw new Error("Error setting main camera: invalid camera node.");t.camera.isMain=!0}}},t)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,a,"bg.scene.Camera")}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).call(this)}return $traceurRuntime.createClass(e,{clone:function(){return new bg.scene.Chain},willDisplay:function(t,e){if(this.node){var i=bg.Matrix4.Identity();this.node.children.forEach(function(t){var e=t.component("bg.scene.Transform"),n=t.component("bg.scene.InputChainJoint"),r=t.component("bg.scene.OutputChainJoint");n?n.joint.applyTransform(i):i.identity(),e&&e.matrix.assign(i),r&&r.joint.applyTransform(i)})}}},{},t)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,t,"bg.scene.Chain");var e=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this._joint=new bg.physics.LinkJoint}return $traceurRuntime.createClass(e,{get joint(){return this._joint},set joint(t){this._joint=t},deserialize:function(t,e,i){e.joint&&(this.joint=bg.physics.Joint.Factory(e.joint))}},{},t)}(bg.scene.Component);bg.scene.ChainJoint=e;var i=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this),t?this.joint=t:this.joint.transformOrder=bg.physics.LinkTransformOrder.ROTATE_TRANSLATE}return $traceurRuntime.createClass(e,{clone:function(){var t=new bg.scene.InputChainJoint;return t.joint.assign(this.joint),t},serialize:function(t,i,n){$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t,i,n),t.joint={},this.joint.serialize(t.joint)}},{},t)}(e);bg.scene.registerComponent(bg.scene,i,"bg.scene.InputChainJoint");var n=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this),t?this.joint=t:this.joint.transformOrder=bg.physics.LinkTransformOrder.TRANSLATE_ROTATE}return $traceurRuntime.createClass(e,{clone:function(){var t=new bg.scene.OutputChainJoint;return t.joint.assign(this.joint),t},serialize:function(t,i,n){$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t,i,n),t.joint={},this.joint.serialize(t.joint)}},{},t)}(e);bg.scene.registerComponent(bg.scene,n,"bg.scene.OutputChainJoint")}(),function(){function t(t,e,i){var n=require("path"),r=bg.base.Writer.StandarizePath(this.getImageUrl(e)),s=r.split("/").pop(),a=bg.base.Writer.StandarizePath(n.join(i,s));switch(e){case bg.scene.CubemapImage.POSITIVE_X:t.positiveX=s;break;case bg.scene.CubemapImage.NEGATIVE_X:t.negativeX=s;break;case bg.scene.CubemapImage.POSITIVE_Y:t.positiveY=s;break;case bg.scene.CubemapImage.NEGATIVE_Y:t.negativeY=s;break;case bg.scene.CubemapImage.POSITIVE_Z:t.positiveZ=s;break;case bg.scene.CubemapImage.NEGATIVE_Z:t.negativeZ=s}return bg.base.Writer.CopyFile(r,a)}bg.scene.CubemapImage={POSITIVE_X:0,NEGATIVE_X:1,POSITIVE_Y:2,NEGATIVE_Y:3,POSITIVE_Z:4,NEGATIVE_Z:5};var e=null,i=function(i){function n(){$traceurRuntime.superConstructor(n).call(this),this._images=[null,null,null,null,null,null],this._texture=null}return $traceurRuntime.createClass(n,{setImageUrl:function(t,e){this._images[t]=e},getImageUrl:function(t){return this._images[t]},get texture(){return this._texture},loadCubemap:function(t){var i=this;return t=t||this.node&&this.node.context,new Promise(function(n,r){bg.utils.Resource.LoadMultiple(i._images).then(function(r){i._texture=new bg.base.Texture(t),i._texture.target=bg.base.TextureTarget.CUBE_MAP,i._texture.create(),i._texture.bind(),i._texture.setCubemap(r[i.getImageUrl(bg.scene.CubemapImage.POSITIVE_X)],r[i.getImageUrl(bg.scene.CubemapImage.NEGATIVE_X)],r[i.getImageUrl(bg.scene.CubemapImage.POSITIVE_Y)],r[i.getImageUrl(bg.scene.CubemapImage.NEGATIVE_Y)],r[i.getImageUrl(bg.scene.CubemapImage.POSITIVE_Z)],r[i.getImageUrl(bg.scene.CubemapImage.NEGATIVE_Z)]),e=i._texture,bg.emitImageLoadEvent(r[i.getImageUrl(bg.scene.CubemapImage.POSITIVE_X)]),n(i)}).catch(function(t){r(t)})})},clone:function(){var t=new n;for(var e in this._images)t._images[e]=this._images[e];return t._texture=this._texture,t},deserialize:function(t,e,i){return this.setImageUrl(bg.scene.CubemapImage.POSITIVE_X,bg.utils.Resource.JoinUrl(i,e.positiveX)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_X,bg.utils.Resource.JoinUrl(i,e.negativeX)),this.setImageUrl(bg.scene.CubemapImage.POSITIVE_Y,bg.utils.Resource.JoinUrl(i,e.positiveY)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_Y,bg.utils.Resource.JoinUrl(i,e.negativeY)),this.setImageUrl(bg.scene.CubemapImage.POSITIVE_Z,bg.utils.Resource.JoinUrl(i,e.positiveZ)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_Z,bg.utils.Resource.JoinUrl(i,e.negativeZ)),this.loadCubemap(t)},serialize:function(e,i,r){$traceurRuntime.superGet(this,n.prototype,"serialize").call(this,e,i,r),bg.isElectronApp&&(i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_X,r.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_X,r.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_Y,r.path])),
i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_Y,r.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_Z,r.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_Z,r.path])))}},{Current:function(t){return e||(e=bg.base.TextureCache.WhiteCubemap(t)),e}},i)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,i,"bg.scene.Cubemap")}(),function(){var t=function(t){function e(){var t=void 0!==arguments[0]?arguments[0]:"";$traceurRuntime.superConstructor(e).call(this),this._name=t,this._items=[]}return $traceurRuntime.createClass(e,{get name(){return this._name},set name(t){this._name=t},clone:function(t){var e=new bg.scene.Drawable;return e.name=t||"copy of "+this.name,this.forEach(function(t,i,n){e.addPolyList(t.clone(),i.clone(),n?new bg.Matrix4(n):null)}),e},instance:function(t){var e=new bg.scene.Drawable;return e.name=t||"copy of "+this.name,this.forEach(function(t,i,n){e.addPolyList(t,i.clone(),n?new bg.Matrix4(n):null)}),e},addPolyList:function(t,e){var i=void 0!==arguments[2]?arguments[2]:null;return!(!t||-1!=this.indexOf(t))&&(e=e||new bg.base.Material,this._items.push({polyList:t,material:e,transform:i}),!0)},applyMaterialDefinition:function(t,e){var i=[];return this.forEach(function(n,r){var s=t[n.name];s&&i.push(new Promise(function(t,i){var a=new bg.base.MaterialModifier(s);r.applyModifier(n.context,a,e),t()}))}),Promise.all(i)},removePolyList:function(t){var e=-1;this._items.some(function(i,n){t==i.polyList&&(e=n)}),e>=0&&this._items.splice(e,1)},indexOf:function(t){var e=-1;return this._items.some(function(t,i){if(t.polyList==t)return e=i,!0}),e},replacePolyList:function(t,e){return t>=0&&t<this._items.length&&(this._items[t].polyList=e,!0)},replaceMaterial:function(t,e){return t>=0&&t<this._items.length&&(this._items[t].material=e,!0)},replaceTransform:function(t,e){return t>=0&&t<this._items.length&&(this._items[t].transform=e,!0)},getPolyList:function(t){return t>=0&&t<this._items.length&&this._items[t].polyList},getMaterial:function(t){return t>=0&&t<this._items.length&&this._items[t].material},getTransform:function(t){return t>=0&&t<this._items.length&&this._items[t].transform},forEach:function(t){var e=!0,i=!1,n=void 0;try{for(var r=void 0,s=this._items[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){var a=r.value;t(a.polyList,a.material,a.transform)}}catch(t){i=!0,n=t}finally{try{e||null==s.return||s.return()}finally{if(i)throw n}}},some:function(t){var e=!0,i=!1,n=void 0;try{for(var r=void 0,s=this._items[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){var a=r.value;if(t(a.polyList,a.material,a.transform))return!0}}catch(t){i=!0,n=t}finally{try{e||null==s.return||s.return()}finally{if(i)throw n}}return!1},every:function(t){var e=!0,i=!1,n=void 0;try{for(var r=void 0,s=this._items[Symbol.iterator]();!(e=(r=s.next()).done);e=!0){var a=r.value;if(!t(a.polyList,a.material,a.transform))return!1}}catch(t){i=!0,n=t}finally{try{e||null==s.return||s.return()}finally{if(i)throw n}}return!0},display:function(t,e){if(!t.effect)throw new Error("Could not draw component: invalid effect found.");this.node.enabled&&this.forEach(function(i,n,r){if(i.visible){var s=t.effect.material;r&&(e.modelMatrixStack.push(),e.modelMatrixStack.mult(r)),t.shouldDraw(n)&&(t.effect.material=n,t.draw(i)),r&&e.modelMatrixStack.pop(),t.effect.material=s}})},setGroupVisible:function(t){var e=void 0===arguments[1]||arguments[1];this.forEach(function(i){i.groupName==t&&(i.visible=e)})},hideGroup:function(t){this.setGroupVisible(t,!1)},showGroup:function(t){this.setGroupVisible(t,!0)},setVisibleByName:function(t){var e=void 0===arguments[1]||arguments[1];this.some(function(i){if(i.name==t)return i.visible=e,!0})},showByName:function(t){this.setVisibleByName(t,!0)},hideByName:function(t){this.setVisibleByName(t,!1)},deserialize:function(t,e,i){var n=this;return new Promise(function(r,s){var a=bg.utils.Resource.JoinUrl(i,e.name+".vwglb");bg.base.Loader.Load(t,a).then(function(t){var i=t.component("bg.scene.Drawable");n._name=e.name,n._items=i._items,r(n)})})},serialize:function(t,i,n){var r=this;if(bg.isElectronApp){$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t,i,n),this.name||(this.name=bg.utils.generateUUID()),t.name=this.name;var s=require("path"),a=s.join(n.path,t.name+".vwglb");i.push(new Promise(function(t,e){bg.base.Writer.Write(a,r.node).then(function(){return t()}).catch(function(t){return e(t)})}))}}},{InstanceNode:function(t){var i=new bg.scene.Node(t.context,t.name?"copy of "+t.name:"");return i.enabled=t.enabled,t.forEachComponent(function(t){var n=null;n=t instanceof e?t.instance():t.clone(),i.addComponent(n)}),i}},t)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,t,"bg.scene.Drawable")}(),function(){function t(t){o.push(t)}function e(t){var e=o.indexOf(t);-1!=e&&o.splice(e,1)}function i(t,e,i){for(var n=new bg.base.PolyList(t),r=[],s=[],a=[],o=0,c=0;c<e.length;c+=3)r.push(0),r.push(0),r.push(1),s.push(0),s.push(0),a.push(o++);return n.vertex=e,n.normal=r,n.texCoord0=s,n.color=i,n.index=a,n.drawMode=bg.base.DrawMode.LINES,n.build(),n}function n(t){if(!this._directionalGizmo){var e=this.node.context,n=[0,0,0,0,0,-1,0,0,-1,0,.1,-.9,0,0,-1,0,-.1,-.9],r=[1,1,1,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1];this._directionalGizmo=i(e,n,r)}return this._directionalGizmo}function r(){var t=this.node.context,e=bg.Math.degreesToRadians(this.light.spotCutoff/2),n=5*bg.Math.sin(e),r=5*bg.Math.cos(e),s=bg.Math.cos(bg.Math.PI_8)*n,a=bg.Math.cos(bg.Math.PI_4)*n,o=bg.Math.cos(bg.Math.PI_4+bg.Math.PI_8)*n,c=bg.Math.sin(bg.Math.PI_8)*n,u=bg.Math.sin(bg.Math.PI_4)*n,h=bg.Math.sin(bg.Math.PI_4+bg.Math.PI_8)*n,l=[0,0,0,0,n,-r,0,0,0,0,-n,-r,0,0,0,n,0,-r,0,0,0,-n,0,-r,0,n,-r,o,h,-r,o,h,-r,a,u,-r,a,u,-r,s,c,-r,s,c,-r,n,0,-r,n,0,-r,s,-c,-r,s,-c,-r,a,-u,-r,a,-u,-r,o,-h,-r,o,-h,-r,0,-n,-r,0,-n,-r,-o,-h,-r,-o,-h,-r,-a,-u,-r,-a,-u,-r,-s,-c,-r,-s,-c,-r,-n,0,-r,-n,0,-r,-s,c,-r,-s,c,-r,-a,u,-r,-a,u,-r,-o,h,-r,-o,h,-r,0,n,-r],f=[1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1,1,1,0,1];return this._spotGizmo?(this._spotGizmo.updateBuffer(bg.base.BufferType.VERTEX,l),this._spotGizmo.updateBuffer(bg.base.BufferType.COLOR,f)):this._spotGizmo=i(t,l,f),this._spotGizmo}function s(){if(!this._pointGizmo){var t=this.node.context,e=.5,n=bg.Math.sin(bg.Math.PI_4)*e,r=[0,0,0,0,e,0,0,0,0,0,-e,0,0,0,0,-e,0,0,0,0,0,e,0,0,0,0,0,n,n,0,0,0,0,n,-n,0,0,0,0,-n,n,0,0,0,0,-n,-n,0,0,0,0,0,0,e,0,0,0,0,0,-e,0,0,0,0,n,n,0,0,0,0,-n,n,0,0,0,0,-n,-n,0,0,0,0,n,-n,0,0,0,n,0,n,0,0,0,-n,0,n,0,0,0,-n,0,-n,0,0,0,n,0,-n],s=[1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1];this._pointGizmo=i(t,r,s)}return this._pointGizmo}function a(){switch(this._light&&this._light.type){case bg.base.LightType.DIRECTIONAL:return n.apply(this);case bg.base.LightType.SPOT:return r.apply(this);case bg.base.LightType.POINT:return s.apply(this)}return null}var o=[],c=function(i){function n(){var t=void 0!==arguments[0]?arguments[0]:null;$traceurRuntime.superConstructor(n).call(this),this._light=t,this._visitor=new bg.scene.TransformVisitor,this._rebuildTransform=!0}return $traceurRuntime.createClass(n,{clone:function(){var t=new bg.scene.Light;return t.light=this.light.clone(),t},get light(){return this._light},set light(t){this._light=t},get transform(){return this._rebuildTransform&&this.node&&(this._visitor.matrix.identity(),this.node.acceptReverse(this._visitor),this._rebuildTransform=!1),this._visitor.matrix},frame:function(t){this._rebuildTransform=!0,this.transform},displayGizmo:function(t,e){var i=a.apply(this);i&&t.draw(i)},removedFromNode:function(t){e(this)},addedToNode:function(e){t(this)},deserialize:function(t,e,i){var n=this;return new Promise(function(i,r){n._light=new bg.base.Light(t),n._light.deserialize(e),i(n)})},serialize:function(t,e,i){$traceurRuntime.superGet(this,n.prototype,"serialize").call(this,t,e,i),this.light.serialize(t)}},{GetActiveLights:function(){return o}},i)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,c,"bg.scene.Light")}(),function(){function t(t){var e=/newmtl\s+(.*)/.exec(t);e&&(this._jsonData[e[1]]=JSON.parse(JSON.stringify(m)),this._currentMat=this._jsonData[e[1]])}function e(t){var e=/Ns\s+([\d\.]+)/.exec(t);e&&(this._currentMat.shininess=Number(e[1]))}function i(t){return[Number(t[1]),Number(t[2]),Number(t[3]),t[4]?Number(t[4]):1]}function n(t){var e=/Kd\s+([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)\s*([\d\.]*)/.exec(t);if(e){var n=i(e);this._currentMat.diffuseR=n[0],this._currentMat.diffuseG=n[1],this._currentMat.diffuseB=n[2],this._currentMat.diffuseA=n[3]}else if(e=/Ks\s+([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)\s*([\d\.]*)/.exec(t)){var r=i(e);this._currentMat.specularR=r[0],this._currentMat.specularG=r[1],this._currentMat.specularB=r[2],this._currentMat.specularA=r[3]}}function r(t){var e=/map_Kd\s+(.*)/.exec(t);if(e){var i=e[1];i=i.replace(/\\/g,"/");var n=i.lastIndexOf("/");n>=0&&(i=i.substring(n+1)),this._currentMat.texture=i}}function s(t){var e=/mtllib\s+(.*)/.exec(t);e&&(this._mtlLib=e[1])}function a(t){var e=/g\s+(.*)/.exec(t);e&&(this._currentPlist.name=e[1])}function o(t){var e=/usemtl\s+(.*)/.exec(t);e&&(this._currentPlist._matName=e[1],""==this._currentPlist.name&&(this._currentPlist.name=e[1]))}function c(t){/s\s+(.*)/.exec(t)}function u(t){this._currentPlist.vertex.push(t.vertex[0],t.vertex[1],t.vertex[2]),t.normal&&this._currentPlist.normal.push(t.normal[0],t.normal[1],t.normal[2]),t.tex&&this._currentPlist.texCoord0.push(t.tex[0],t.tex[1]),this._currentPlist.index.push(this._currentPlist.index.length)}function h(t){var e=0,i=t.length;if(!(i<3))for(;e<i;){var n=e,r=e+1,s=e+2;s==i?s=0:r==i&&(r=0,s=2);var a=t[n],o=t[r],c=t[s];u.apply(this,[a]),u.apply(this,[o]),u.apply(this,[c]),e+=3}}function l(t){this._addPlist=!0;var e=/f\s+(.*)/.exec(t);if(e){var i=e[1],n=/([\d\-]+)\/([\d\-]*)\/([\d\-]*)/g;if(-1==i.indexOf("/"));for(var r=[];e=n.exec(i);){var s=Number(e[1]),a=e[3]?Number(e[3]):null,o=e[2]?Number(e[2]):null;s=s<0?this._vertexArray.length+s:s-1,a=a<0?this._normalArray.length+a:null===a?null:a-1,o=o<0?this._texCoordArray.length+o:null===o?null:o-1;var c=this._vertexArray[s],u=null!==a?this._normalArray[a]:null,l=null!==o?this._texCoordArray[o]:null;r.push({vertex:c,normal:u,tex:l})}h.apply(this,[r])}}function f(t){var e=/s\s+(.*)/.exec(t);e&&""==this._currentPlist.name&&(this._currentPlist.name=e[1])}function b(){this._addPlist&&(this._currentPlist&&(this._currentPlist.build(),this._plistArray.push(this._currentPlist)),this._currentPlist=new bg.base.PolyList(this.context),this._addPlist=!1)}function g(t){return new p(t).jsonData}var m={diffuseR:1,diffuseG:1,diffuseB:1,diffuseA:1,specularR:1,specularG:1,specularB:1,specularA:1,shininess:0,lightEmission:0,refractionAmount:0,reflectionAmount:0,textureOffsetX:0,textureOffsetY:0,textureScaleX:1,textureScaleY:1,lightmapOffsetX:0,lightmapOffsetY:0,lightmapScaleX:1,lightmapScaleY:1,normalMapOffsetX:0,normalMapOffsetY:0,normalMapScaleX:1,normalMapScaleY:1,alphaCutoff:.5,castShadows:!0,receiveShadows:!0,shininessMaskChannel:0,shininessMaskInvert:!1,lightEmissionMaskChannel:0,lightEmissionMaskInvert:!1,reflectionMaskChannel:0,reflectionMaskInvert:!1,cullFace:!0,texture:"",lightmap:"",normalMap:"",shininessMask:"",lightEmissionMask:"",reflectionMask:""},p=function(){function i(i){var s=this;this._jsonData={},this._currentMat=JSON.parse(JSON.stringify(m)),i.split("\n").forEach(function(i){if(i=i.trim(),i.length>1&&"#"!=i[0])switch(i[0]){case"n":t.apply(s,[i]);break;case"N":e.apply(s,[i]);break;case"m":r.apply(s,[i]);break;case"d":case"T":break;case"K":n.apply(s,[i])}})}return $traceurRuntime.createClass(i,{get jsonData(){return this._jsonData}},{})}(),d=function(){function t(t,e){this.context=t,this.url=e,this._plistArray=[],this._vertexArray=[],this._normalArray=[],this._texCoordArray=[],this._mtlLib="",this._addPlist=!0}return $traceurRuntime.createClass(t,{loadDrawable:function(t){var e=this;return new Promise(function(i,n){function r(t,e){var i=this;t.forEach(function(t){var n=new bg.base.Material,r=e[t._matName];if(r){var s=i.url.substring(0,i.url.lastIndexOf("/")+1);bg.base.Material.GetMaterialWithJson(i.context,r,s).then(function(e){u.addPolyList(t,e)})}else u.addPolyList(t,n)})}var u=new bg.scene.Drawable(e.url);if(t.split("\n").forEach(function(t){if(t=t.trim(),t.length>1&&"#"!=t[0])switch(t[0]){case"v":var i=/v\s+([\d\.\-]+)\s+([\d\.\-]+)\s+([\d\.\-]+)/.exec(t);i?e._vertexArray.push([Number(i[1]),Number(i[2]),Number(i[3])]):(i=/vn\s+([\d\.\-]+)\s+([\d\.\-]+)\s+([\d\.\-]+)/.exec(t))?e._normalArray.push([Number(i[1]),Number(i[2]),Number(i[3])]):(i=/vt\s+([\d\.\-]+)\s+([\d\.\-]+)/.exec(t))&&e._texCoordArray.push([Number(i[1]),Number(i[2])]);break;case"m":b.apply(e),s.apply(e,[t]);break;case"g":b.apply(e),a.apply(e,[t]);break;case"u":b.apply(e),o.apply(e,[t]);break;case"s":c.apply(e,[t]);break;case"f":l.apply(e,[t]);break;case"o":b.apply(e),f.apply(e,[t])}}),e._currentPlist&&e._addPlist&&(e._currentPlist.build(),e._plistArray.push(e._currentPlist)),e._mtlLib){var h=e.url.substring(0,e.url.lastIndexOf("/"));h.length>0&&"/"!=h&&(h+="/"),bg.utils.Resource.Load(h+e._mtlLib).then(function(t){r.apply(e,[e._plistArray,g(t)]),i(u)}).catch(function(){bg.log("Warning: no such material library file for obj model "+e.url),r.apply(e,[e._plistArray,{}]),i(u)})}else r.apply(e,[e._plistArray]),i(u)})}},{})}(),_=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){return"obj"==bg.utils.Resource.GetExtension(t)},load:function(t,e,i){return new Promise(function(n,r){if(i)try{var s=new d(t,e),a=null,o=e.split("/");o.pop(),o=o.join("/")+"/";var c=e.split(".");c.pop(),c.push("bg2mat"),c=c.join("."),s.loadDrawable(i).then(function(e){var i=new bg.scene.Node(t,e.name);return i.addComponent(e),a=i,bg.utils.Resource.LoadJson(c)}).then(function(e){var i=[];try{a.component("bg.scene.Drawable").forEach(function(n,r){var s=null;if(e.some(function(t){if(t.name==n.name)return s=t,!0}),s){var a=bg.base.Material.FromMaterialDefinition(t,s,o);i.push(a),a.then(function(t){r.assign(t)})}})}catch(t){}return Promise.all(i)}).then(function(){n(a)}).catch(function(){n(a)})}catch(t){r(t)}else r(new Error("Error loading drawable. Data is null."))})}},{},t)}(bg.base.LoaderPlugin);bg.base.OBJLoaderPlugin=_}(),function(){function t(t,e,i,n){var r=new bg.base.PolyList(t),s=e/2,a=i/2,o=n/2;return r.vertex=[s,-a,-o,-s,-a,-o,-s,a,-o,s,a,-o,s,-a,o,s,-a,-o,s,a,-o,s,a,o,-s,-a,o,s,-a,o,s,a,o,-s,a,o,-s,-a,-o,-s,-a,o,-s,a,o,-s,a,-o,-s,a,o,s,a,o,s,a,-o,-s,a,-o,s,-a,o,-s,-a,o,-s,-a,-o,s,-a,-o],r.normal=[0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],r.texCoord0=[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],r.texCoord1=[0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1],r.index=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20],r.build(),r}function e(t,e,i){var n=void 0!==arguments[3]?arguments[3]:"y",r=e/2,s=i/2,a=new bg.base.PolyList(t);switch(n.toLowerCase()){case"x":a.vertex=[0,-r,-s,0,r,-s,0,r,s,0,r,s,0,-r,s,0,-r,-s];break;case"y":a.vertex=[-r,0,-s,r,0,-s,r,0,s,r,0,s,-r,0,s,-r,0,-s];break;case"z":a.vertex=[-r,-s,0,r,-s,0,r,s,0,r,s,0,-r,s,0,-r,-s,0]}return a.normal=[0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0],a.texCoord0=[0,0,1,0,1,1,1,1,0,1,0,0],a.texCoord1=[0,0,1,0,1,1,1,1,0,1,0,0],a.index=[2,1,0,5,4,3],a.build(),a}function i(t,e,i,n){var r=new bg.base.PolyList(t);++i;var s,a,o=1/(n-1),c=1/(i-1),u=[],h=[],l=[],f=[];for(s=0;s<n;s++)for(a=0;a<i;a++){var b=bg.Math.sin(-bg.Math.PI_2+bg.Math.PI*s*o),g=bg.Math.cos(2*bg.Math.PI*a*c)*bg.Math.sin(bg.Math.PI*s*o),m=bg.Math.sin(2*bg.Math.PI*a*c)*bg.Math.sin(bg.Math.PI*s*o);l.push(a*c),l.push(s*o),h.push(g,b,m),u.push(g*e,b*e,m*e)}for(s=0;s<n-1;s++)for(a=0;a<i-1;a++){var p=s*i+a,d=s*i+(a+1),_=(s+1)*i+(a+1),v=(s+1)*i+a;f.push(p),f.push(v),f.push(_),f.push(_),f.push(d),f.push(p)}return r.vertex=u,r.normal=h,r.texCoord0=l,r.texCoord1=l,r.index=f,r.build(),r}function n(t,e){var i=new bg.scene.Drawable(e);return i.addPolyList(t),i}var r=function(){function r(){}return $traceurRuntime.createClass(r,{},{CubePolyList:function(e){var i=void 0!==arguments[1]?arguments[1]:1,n=arguments[2],r=arguments[3];return n=n||i,r=r||i,t(e,i,n,r)},PlanePolyList:function(t){var i=void 0!==arguments[1]?arguments[1]:1,n=arguments[2],r=void 0!==arguments[3]?arguments[3]:"y";return n=n||i,e(t,i,n,r)},SpherePolyList:function(t){var e=void 0!==arguments[1]?arguments[1]:1,n=void 0!==arguments[2]?arguments[2]:20,r=arguments[3];return r=r||n,i(t,e,n,r)},Cube:function(e){var i=void 0!==arguments[1]?arguments[1]:1,r=arguments[2],s=arguments[3];return r=r||i,s=s||i,n(t(e,i,r,s),"Cube")},Plane:function(t){var i=void 0!==arguments[1]?arguments[1]:1,r=arguments[2],s=void 0!==arguments[3]?arguments[3]:"y";return r=r||i,n(e(t,i,r,s),"Plane")},Sphere:function(t){var e=void 0!==arguments[1]?arguments[1]:1,r=void 0!==arguments[2]?arguments[2]:20,s=arguments[3];return s=s||r,n(i(t,e,r,s),"Sphere")}})}();bg.scene.PrimitiveFactory=r}(),function(){var t=function(){function t(t,e){this.url=t.substring(0,t.lastIndexOf("/")),this.jsonData=e}return $traceurRuntime.createClass(t,{loadNode:function(t,e,i,n){var r=this,s=new bg.scene.Node(t,e.name);s.enabled=e.enabled,i.addChild(s),e.components.forEach(function(e){n.push(bg.scene.Component.Factory(t,e,s,r.url))}),e.children.forEach(function(e){r.loadNode(t,e,s,n)})},loadScene:function(t){var e=this,i=[],n=new bg.scene.Node(t,"scene-root");return this.jsonData.scene.forEach(function(r){e.loadNode(t,r,n,i)}),new Promise(function(e,r){Promise.all(i).then(function(){var i=new bg.scene.FindComponentVisitor("bg.scene.Camera");n.accept(i);var r=null,s=null;if(i.result.some(function(t){if(s||(s=t),t.camera.isMain)return r=t,!0}),!(r=r||s)){r=new bg.scene.Node(t,"Camera"),r.addComponent(new bg.scene.Camera);var a=bg.Matrix4.Rotation(.52,-1,0,0);a.translate(0,0,5),r.addComponent(new bg.scene.Transform(a)),n.addChild(r)}bg.scene.Camera.SetAsMainCamera(r,n),e({sceneRoot:n,cameraNode:r})})})}},{})}(),e=function(e){function i(){$traceurRuntime.superConstructor(i).apply(this,arguments)}return $traceurRuntime.createClass(i,{acceptType:function(t,e){return"vitscnj"==bg.utils.Resource.GetExtension(t)},load:function(e,i,n){return new Promise(function(r,s){if(n)try{"string"==typeof n&&(n=n.replace(/,[\s\r\n]*\]/g,"]"),n=n.replace(/,[\s\r\n]*\}/g,"}"),n=JSON.parse(n));new t(i,n).loadScene(e).then(function(t){r(t)})}catch(t){s(t)}else s(new Error("Error loading scene. Data is null"))})}},{},e)}(bg.base.LoaderPlugin);bg.base.SceneLoaderPlugin=e}(),function(){function t(t,e,i){var n=require("path"),r=bg.base.Writer.StandarizePath(this.getImageUrl(e)),s=r.split("/").pop(),a=bg.base.Writer.StandarizePath(n.join(i,s));switch(e){case bg.scene.CubemapImage.POSITIVE_X:t.positiveX=s;break;case bg.scene.CubemapImage.NEGATIVE_X:t.negativeX=s;break;case bg.scene.CubemapImage.POSITIVE_Y:t.positiveY=s;break;case bg.scene.CubemapImage.NEGATIVE_Y:t.negativeY=s;break;case bg.scene.CubemapImage.POSITIVE_Z:t.positiveZ=s;break;case bg.scene.CubemapImage.NEGATIVE_Z:t.negativeZ=s}return bg.base.Writer.CopyFile(r,a)}var e=[.5,-.5,-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5],i=[.5,-.5,.5,.5,-.5,-.5,.5,.5,-.5,.5,.5,.5],n=[-.5,-.5,.5,.5,-.5,.5,.5,.5,.5,-.5,.5,.5],r=[-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5],s=[-.5,.5,.5,.5,.5,.5,.5,.5,-.5,-.5,.5,-.5],a=[.5,-.5,.5,-.5,-.5,.5,-.5,-.5,-.5,.5,-.5,-.5],o=[0,0,1,0,0,1,0,0,1,0,0,1],c=[-1,0,0,-1,0,0,-1,0,0,-1,0,0],u=[0,0,-1,0,0,-1,0,0,-1,0,0,-1],h=[1,0,0,1,0,0,1,0,0,1,0,0],l=[0,-1,0,0,-1,0,0,-1,0,0,-1,0],f=[0,1,0,0,1,0,0,1,0,0,1,0],b=[1,0,0,0,0,1,1,1],g=[1,0,0,0,0,1,1,1],m=[1,0,0,0,0,1,1,1],p=[1,0,0,0,0,1,1,1],d=[1,0,0,0,0,1,1,1],_=[1,0,0,0,0,1,1,1],v=[2,1,0,0,3,2],x=function(x){function T(){$traceurRuntime.superConstructor(T).call(this),this._images=[null,null,null,null,null,null],this._textures=[],this._plist=[],this._material=null}return $traceurRuntime.createClass(T,{setImageUrl:function(t,e){this._images[t]=e},getImageUrl:function(t){return this._images[t]},getTexture:function(t){return this._textures[t]},loadSkybox:function(){var t=void 0!==arguments[0]?arguments[0]:null,x=void 0!==arguments[1]?arguments[1]:null,T=this;t=t||this.node&&this.node.context;var M=new bg.base.PolyList(t),S=new bg.base.PolyList(t),E=new bg.base.PolyList(t),w=new bg.base.PolyList(t),y=new bg.base.PolyList(t),j=new bg.base.PolyList(t);return M.vertex=e,M.normal=o,M.texCoord0=b,M.texCoord1=b,M.index=v,M.build(),S.vertex=i,S.normal=c,S.texCoord0=g,S.texCoord1=g,S.index=v,S.build(),E.vertex=n,E.normal=u,E.texCoord0=m,E.texCoord1=m,E.index=v,E.build(),w.vertex=r,w.normal=h,w.texCoord0=p,w.texCoord1=p,w.index=v,w.build(),y.vertex=s,y.normal=l,y.texCoord0=d,y.texCoord1=d,y.index=v,y.build(),j.vertex=a,j.normal=f,j.texCoord0=_,j.texCoord1=_,j.index=v,j.build(),this._plist=[w,S,y,j,E,M],this._material=new bg.base.Material,this._material.receiveShadows=!1,this._material.castShadows=!1,this._material.unlit=!0,new Promise(function(e,i){bg.base.Loader.Load(t,T._images,x,{wrapX:bg.base.TextureWrap.MIRRORED_REPEAT,wrapY:bg.base.TextureWrap.MIRRORED_REPEAT}).then(function(t){T._textures=[t[T.getImageUrl(bg.scene.CubemapImage.POSITIVE_X)],t[T.getImageUrl(bg.scene.CubemapImage.NEGATIVE_X)],t[T.getImageUrl(bg.scene.CubemapImage.POSITIVE_Y)],t[T.getImageUrl(bg.scene.CubemapImage.NEGATIVE_Y)],t[T.getImageUrl(bg.scene.CubemapImage.POSITIVE_Z)],t[T.getImageUrl(bg.scene.CubemapImage.NEGATIVE_Z)]],T._textures.forEach(function(t){t.wrapX=bg.base.TextureWrap.CLAMP,t.wrapY=bg.base.TextureWrap.CLAMP}),bg.emitImageLoadEvent(t[T.getImageUrl(bg.scene.CubemapImage.POSITIVE_X)]),e()}).catch(function(t){i(t)})})},display:function(t,e){var i=this;if(!t.effect)throw new Error("Could not draw skybox: invalid effect");if(this.node.enabled&&6==this._textures.length){var n=t.effect.material;t.effect.material=this._material,e.viewMatrixStack.push(),e.modelMatrixStack.push(),e.viewMatrixStack.matrix.setPosition(0,0,0);var r=e.projectionMatrixStack.matrix,s=-r.m22,a=-r.m32,o=2*a/(2*s-2),c=bg.Math.sin(bg.Math.PI_4)*o-1;e.modelMatrixStack.scale(c,c,c),t.shouldDraw(this._material)&&this._plist.forEach(function(e,n){i._material.texture=i._textures[n],t.draw(e)}),e.modelMatrixStack.pop(),e.viewMatrixStack.pop(),t.effect.material=n}},removedFromNode:function(){this._plist.forEach(function(t){t.destroy()})},deserialize:function(t,e,i){return this.setImageUrl(bg.scene.CubemapImage.POSITIVE_X,bg.utils.Resource.JoinUrl(i,e.positiveX)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_X,bg.utils.Resource.JoinUrl(i,e.negativeX)),this.setImageUrl(bg.scene.CubemapImage.POSITIVE_Y,bg.utils.Resource.JoinUrl(i,e.positiveY)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_Y,bg.utils.Resource.JoinUrl(i,e.negativeY)),this.setImageUrl(bg.scene.CubemapImage.POSITIVE_Z,bg.utils.Resource.JoinUrl(i,e.positiveZ)),this.setImageUrl(bg.scene.CubemapImage.NEGATIVE_Z,bg.utils.Resource.JoinUrl(i,e.negativeZ)),this.loadSkybox(t)},serialize:function(e,i,n){$traceurRuntime.superGet(this,T.prototype,"serialize").call(this,e,i,n),bg.isElectronApp&&(i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_X,n.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_X,n.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_Y,n.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_Y,n.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.POSITIVE_Z,n.path])),i.push(t.apply(this,[e,bg.scene.CubemapImage.NEGATIVE_Z,n.path])))}},{},x)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,x,"bg.scene.Skybox")}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this),this._matrix=t||bg.Matrix4.Identity(),this._globalMatrixValid=!1,this._transformVisitor=new bg.scene.TransformVisitor}return $traceurRuntime.createClass(e,{clone:function(){var t=new bg.scene.Transform;return t.matrix=new bg.Matrix4(this.matrix),t},get matrix(){return this._matrix},set matrix(t){this._matrix=t},get globalMatrix(){return this._globalMatrixValid||(this._transformVisitor.clear(),this.node.acceptReverse(this._transformVisitor),this._globalMatrix=this._transformVisitor.matrix),this._globalMatrix},deserialize:function(t,e,i){var n=this;return new Promise(function(t,i){if(e.transformStrategy){var r=e.transformStrategy;if("TRSTransformStrategy"==r.type){switch(n._matrix.identity().translate(r.translate[0],r.translate[1],r.translate[2]),r.rotationOrder){case"kOrderXYZ":n._matrix.rotate(r.rotateX,1,0,0).rotate(r.rotateY,0,1,0).rotate(r.rotateZ,0,0,1);break;case"kOrderXZY":n._matrix.rotate(r.rotateX,1,0,0).rotate(r.rotateZ,0,0,1).rotate(r.rotateY,0,1,0);break;case"kOrderYXZ":n._matrix.rotate(r.rotateY,0,1,0).rotate(r.rotateX,1,0,0).rotate(r.rotateZ,0,0,1);break;case"kOrderYZX":n._matrix.rotate(r.rotateY,0,1,0).rotate(r.rotateZ,0,0,1).rotate(r.rotateX,1,0,0);break;case"kOrderZYX":n._matrix.rotate(r.rotateZ,0,0,1).rotate(r.rotateY,0,1,0).rotate(r.rotateX,1,0,0);break;case"kOrderZXY":n._matrix.rotate(r.rotateZ,0,0,1).rotate(r.rotateX,1,0,0).rotate(r.rotateY,0,1,0)}n._matrix.scale(r.scale[0],r.scale[1],r.scale[2])}}else e.transformMatrix&&(n._matrix=new bg.Matrix4(e.transformMatrix));t(n)})},serialize:function(t,i,n){$traceurRuntime.superGet(this,e.prototype,"serialize").call(this,t,i,n),t.transformMatrix=this._matrix.toArray()},willDisplay:function(t,e){this.node&&this.node.enabled&&(e.modelMatrixStack.push(),e.modelMatrixStack.mult(this.matrix))},didDisplay:function(t,e){this.node&&this.node.enabled&&e.modelMatrixStack.pop(),this._globalMatrixValid=!1}},{},t)}(bg.scene.Component);bg.scene.registerComponent(bg.scene,t,"bg.scene.Transform")}(),function(){var t=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this),this._pipeline=t||bg.base.Pipeline.Current(),this._matrixState=i||bg.base.MatrixState.Current()}return $traceurRuntime.createClass(e,{get pipeline(){return this._pipeline},get matrixState(){return this._matrixState},visit:function(t){t.willDisplay(this.pipeline,this.matrixState),t.display(this.pipeline,this.matrixState)},didVisit:function(t){t.didDisplay(this.pipeline,this.matrixState)}},{},t)}(bg.scene.NodeVisitor);bg.scene.DrawVisitor=t;var e=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this._delta=0}return $traceurRuntime.createClass(e,{get delta(){return this._delta},set delta(t){this._delta=t},visit:function(t){t.frame(this.delta)}},{},t)}(bg.scene.NodeVisitor);bg.scene.FrameVisitor=e;var i=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this._matrix=bg.Matrix4.Identity()}return $traceurRuntime.createClass(e,{get matrix(){return this._matrix},clear:function(){this._matrix=bg.Matrix4.Identity()},visit:function(t){var e=t.component("bg.scene.Transform");e&&this._matrix.mult(e.matrix)}},{},t)}(bg.scene.NodeVisitor);bg.scene.TransformVisitor=i;var n=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{visit:function(t){this._operation&&t[this._operation](this._event)},keyDown:function(t,e){this._operation="keyDown",this._event=e,t.accept(this)},keyUp:function(t,e){this._operation="keyUp",this._event=e,t.accept(this)},mouseUp:function(t,e){this._operation="mouseUp",this._event=e,t.accept(this)},mouseDown:function(t,e){this._operation="mouseDown",this._event=e,t.accept(this)},mouseMove:function(t,e){this._operation="mouseMove",this._event=e,t.accept(this)},mouseOut:function(t,e){this._operation="mouseOut",this._event=e,t.accept(this)},mouseDrag:function(t,e){this._operation="mouseDrag",this._event=e,t.accept(this)},mouseWheel:function(t,e){this._operation="mouseWheel",this._event=e,t.accept(this)},touchStart:function(t,e){this._operation="touchStart",this._event=e,t.accept(this)},touchMove:function(t,e){this._operation="touchMove",this._event=e,t.accept(this)},touchEnd:function(t,e){this._operation="touchEnd",this._event=e,t.accept(this)}},{},t)}(bg.scene.NodeVisitor);bg.scene.InputVisitor=n;var r=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this.clear()}return $traceurRuntime.createClass(e,{get min(){return this._min},get max(){return this._max},get size(){return this._size},clear:function(){this._min=new bg.Vector3(bg.Math.FLOAT_MAX,bg.Math.FLOAT_MAX,bg.Math.FLOAT_MAX),this._max=new bg.Vector3(-bg.Math.FLOAT_MAX,-bg.Math.FLOAT_MAX,-bg.Math.FLOAT_MAX),this._size=new bg.Vector3(0,0,0)},visit:function(t){var e=bg.Matrix4.Identity();if(t.component("bg.scene.Transform")&&(e=t.component("bg.scene.Transform").globalMatrix),t.component("bg.scene.Drawable")){var i=new bg.tools.BoundingBox(t.component("bg.scene.Drawable"),new bg.Matrix4(e));this._min=bg.Vector.MinComponents(this._min,i.min),this._max=bg.Vector.MaxComponents(this._max,i.max),this._size=bg.Vector3.Sub(this._max,this._min)}}},{},t)}(bg.scene.NodeVisitor);bg.scene.BoundingBoxVisitor=r;var s=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this),this.componentId=t,this.clear()}return $traceurRuntime.createClass(e,{get result(){return this._result},clear:function(){this._result=[]},visit:function(t){t.component(this.componentId)&&this._result.push(t)}},{},t)}(bg.scene.NodeVisitor);bg.scene.FindComponentVisitor=s}(),function(){function t(t,e){var i=new Uint8Array(t,e,4);return i=String.fromCharCode(i[0])+String.fromCharCode(i[1])+String.fromCharCode(i[2])+String.fromCharCode(i[3])}function e(t,e){return new DataView(t,e,4).getInt32(0)}function i(t,e){return new DataView(t,e,4).getFloat32(0)}function n(t,e){for(var i={offset:0,data:[]},n=new DataView(t,e,64),r=0;r<16;++r)i.data[r]=n.getFloat32(4*r,!1);return i.offset+=64,i}function r(t,i){var n={offset:0,data:""},r=e(t,i);n.offset+=4;for(var s=new Uint8Array(t,i+4,r),a=0;a<r;++a)n.data+=String.fromCharCode(s[a]);return n.offset+=r,n}function s(t,i){var n={offset:0,data:[]},r=e(t,i);n.offset+=4;for(var s=new DataView(t,i+4,4*r),a=0;a<r;++a)n.data[a]=s.getFloat32(4*a,!1);return n.offset+=4*r,n}function a(t,i){var n={offset:0,data:[]},r=e(t,i);n.offset+=4;for(var s=new DataView(t,i+4,4*r),a=0;a<r;++a)n.data[a]=s.getInt32(4*a,!1);return n.offset+=4*r,n}function o(t,e,i){var n=new bg.physics[i.type];n.offset=new(Function.prototype.bind.apply(bg.Vector3,$traceurRuntime.spread([null],i.offset))),n.roll=i.roll,n.pitch=i.pitch,n.yaw=i.yaw;var r=new bg.scene[e](n);t.addComponent(r)}var c=function(){function c(t,e){this._context=t}return $traceurRuntime.createClass(c,{loadDrawable:function(t,e){this._jointData=null;var i=this.parseData(t);return this.createDrawable(i,e)},parseData:function(o){var c=[],u=null,h=0,l=new Uint8Array(o,0,8);h=8;var f=String.fromCharCode(l[4])+String.fromCharCode(l[5])+String.fromCharCode(l[6])+String.fromCharCode(l[7]);if(1==l[0])throw"Could not open the model file. This file has been saved as computer (little endian) format, try again saving it in network (big endian) format";if("hedr"!=f)throw"File format error. Expecting header";var b={maj:l[1],min:l[2],rev:l[3]};bg.log("vwglb file version: "+b.maj+"."+b.min+"."+b.rev+", big endian");e(o,h);h+=4;var g=t(o,h);if(h+=4,"mtrl"!=g)throw"File format error. Expecting materials definition";var m=r(o,h);if(h+=m.offset,u=JSON.parse(m.data),"proj"==t(o,h)){h+=4,h+=r(o,h).offset,i(o,h),h+=4;var p=n(o,h);h+=p.offset;var d=(p.data,n(o,h));h+=d.offset,d.data}
if("join"==t(o,h)){h+=4;var _=r(o,h);h+=_.offset;var v=_.data;try{this._jointData=JSON.parse(v)}catch(t){throw new Error("VWGLB file format reader: Error parsing joint data")}}var x=t(o,h);if("plst"!=x)throw"File format error. Expecting poly list";var T=!1;h+=4;for(var M,S,E,w,y,j,C,O;!T;){x=t(o,h),h+=4;var R=null,A=null;switch(x){case"pnam":R=r(o,h),h+=R.offset,M=R.data;break;case"mnam":R=r(o,h),h+=R.offset,S=R.data;break;case"varr":var I=s(o,h);h+=I.offset,E=I.data;break;case"narr":var V=s(o,h);h+=V.offset,w=V.data;break;case"t0ar":A=s(o,h),h+=A.offset,y=A.data;break;case"t1ar":A=s(o,h),h+=A.offset,j=A.data;break;case"t2ar":A=s(o,h),h+=A.offset,C=A.data;break;case"indx":var L=a(o,h);h+=L.offset,O=L.data;break;case"plst":case"endf":var P={name:M,matName:S,vertices:E,normal:w,texcoord0:y,texcoord1:j,texcoord2:C,indices:O};c.push(P),M="",S="",E=null,w=null,y=null,j=null,C=null,O=null;break;default:throw"File format exception. Unexpected poly list member found"}T="endf"==x}var N={version:b,polyList:c,materials:{}};return u.forEach(function(t){N.materials[t.name]=t}),N},createDrawable:function(t,e){var i=this,n=new bg.scene.Drawable(this.context);n._version=t.version;var r=[];return t.polyList.forEach(function(s){var a=t.materials[s.matName],o=new bg.base.PolyList(i._context);o.name=s.name,o.vertex=s.vertices||o.vertex,o.normal=s.normal||o.normal,o.texCoord0=s.texcoord0||o.texCoord0,o.texCoord1=s.texcoord1||o.texCoord1,o.texCoord2=s.texcoord2||o.texCoord2,o.index=s.indices||o.index,o.groupName=a.groupName,o.visible=a.visible,o.build(),r.push(bg.base.Material.GetMaterialWithJson(i._context,a,e).then(function(t){n.addPolyList(o,t)}))}),Promise.all(r).then(function(){return n})},addComponents:function(t){if(this._jointData){var e=null,i=null;this._jointData.input&&(e=this._jointData.input),this._jointData.output&&this._jointData.output.length&&(i=this._jointData.output[0]),e&&o(t,"InputChainJoint",e),i&&o(t,"OutputChainJoint",i)}}},{})}(),u=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{acceptType:function(t,e){var i=bg.utils.Resource.GetExtension(t);return"vwglb"==i||"bg2"==i},load:function(t,e,i){return new Promise(function(n,r){if(i)try{var s=new c(t,i),a=e.substr(0,e.lastIndexOf("/"));s.loadDrawable(i,a).then(function(e){var i=new bg.scene.Node(t,e.name);i.addComponent(e),s.addComponents(i),n(i)})}catch(t){r(t)}else r(new Error("Error loading drawable. Data is null"))})}},{},t)}(bg.base.LoaderPlugin),h=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{load:function(t,i,n){var r=$traceurRuntime.superGet(this,e.prototype,"load").call(this,t,i,n);return new Promise(function(e,n){r.then(function(n){var r=i.split("/");r.pop(),r=r.join("/")+"/";var s=i.split(".");s.pop(),s.push("bg2mat"),s=s.join("."),bg.utils.Resource.LoadJson(s).then(function(e){var i=[];try{n.component("bg.scene.Drawable").forEach(function(n,s){var a=null;if(e.some(function(t){if(t.name==n.name)return a=t,!0}),a){var o=bg.base.Material.FromMaterialDefinition(t,a,r);i.push(o),o.then(function(t){s.assign(t)})}})}catch(t){}return Promise.all(i)}).then(function(){e(n)}).catch(function(){e(n)})}).catch(function(t){n(t)})})}},{},t)}(u);bg.base.VWGLBLoaderPlugin=u,bg.base.Bg2LoaderPlugin=h}(),bg.manipulation={},function(){var t=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this,t,i),this._sprite=bg.scene.PrimitiveFactory.PlanePolyList(t.context,1,1,"z"),this._gizmoScale=1,this._gizmoIcons=[],this._show3dGizmos=!0}return $traceurRuntime.createClass(e,{get gizmoScale(){return this._gizmoScale},set gizmoScale(t){this._gizmoScale=t},get show3dGizmos(){return this._show3dGizmos},set show3dGizmos(t){this._show3dGizmos=t},clearGizmoIcons:function(){this._gizmoIcons=[]},addGizmoIcon:function(t,e){var i=void 0===arguments[2]||arguments[2];this._gizmoIcons.push({type:t,icon:e,visible:i})},setGizmoIconVisibility:function(t,e){this._gizmoIcons.some(function(i){i.type==t&&(i.visible=e)})},get gizmoIcons(){return this._gizmoIcons},getGizmoIcon:function(t){var e=null;return this._gizmoIcons.some(function(i){if(t.component(i.type)&&i.visible)return e=i.icon,!0}),e},visit:function(t){$traceurRuntime.superGet(this,e.prototype,"visit").call(this,t);var i=this.getGizmoIcon(t),n=this.pipeline.effect.gizmoOpacity,r=this.pipeline.effect.color;this.pipeline.effect.color=bg.Color.White();var s=this.pipeline.depthTest;if(this.pipeline.depthTest=!1,i){this.pipeline.effect.texture=i,this.pipeline.effect.gizmoOpacity=1,this.matrixState.viewMatrixStack.push(),this.matrixState.modelMatrixStack.push(),this.matrixState.viewMatrixStack.mult(this.matrixState.modelMatrixStack.matrix),this.matrixState.modelMatrixStack.identity(),this.matrixState.viewMatrixStack.matrix.setRow(0,new bg.Vector4(1,0,0,0)),this.matrixState.viewMatrixStack.matrix.setRow(1,new bg.Vector4(0,1,0,0)),this.matrixState.viewMatrixStack.matrix.setRow(2,new bg.Vector4(0,0,1,0));var a=.05*this.matrixState.cameraDistanceScale*this._gizmoScale;this.matrixState.viewMatrixStack.rotate(bg.Math.PI,0,1,0),this.matrixState.viewMatrixStack.scale(a,a,a),this.pipeline.draw(this._sprite),this.matrixState.viewMatrixStack.pop(),this.matrixState.modelMatrixStack.pop(),this.pipeline.effect.gizmoOpacity=n,this.pipeline.effect.texture=null}this._show3dGizmos&&t.displayGizmo(this.pipeline,this.matrixState),this.pipeline.effect.color=r,this.pipeline.depthTest=s}},{},t)}(bg.scene.DrawVisitor);bg.manipulation=bg.manipulation||{},bg.manipulation.DrawGizmoVisitor=t}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._gizmoOpacity=.9}return $traceurRuntime.createClass(e,{get pipeline(){return this._pipeline||(this._pipeline=new bg.base.Pipeline(this.context),this._pipeline.blendMode=bg.base.BlendMode.NORMAL,this._pipeline.effect=new bg.manipulation.GizmoEffect(this.context)),this._pipeline},get matrixState(){return this._matrixState||(this._matrixState=new bg.base.MatrixState),this._matrixState},get drawVisitor(){return this._drawVisitor||(this._drawVisitor=new bg.manipulation.DrawGizmoVisitor(this.pipeline,this.matrixState)),this._drawVisitor},get gizmoOpacity(){return this._gizmoOpacity},set gizmoOpacity(t){this._gizmoOpacity=t},get show3dGizmos(){return this.drawVisitor.show3dGizmos},set show3dGizmos(t){this.drawVisitor.show3dGizmos=t},get working(){return this._working},addGizmoIcon:function(t,e){this.drawVisitor.addGizmoIcon(t,e)},get gizmoIconScale(){return this.drawVisitor.gizmoScale},set gizmoIconScale(t){this.drawVisitor.gizmoScale=t},setGizmoIconVisibility:function(t,e){this.drawVisitor.setGizmoIconVisibility(t,e)},hideGizmoIcon:function(t){this.drawVisitor.setGizmoIconVisibility(t,!1)},showGizmoIcon:function(t){this.drawVisitor.setGizmoIconVisibility(t,!0)},get gizmoIcons(){return this.drawVisitor.gizmoIcons},loadGizmoIcons:function(t){var e=void 0!==arguments[1]?arguments[1]:"",i=arguments[2],n=this;return new Promise(function(r,s){var a=[],o=[];t.forEach(function(t){var i={type:t.type,iconTexture:null};i.path=bg.utils.path.join(e,t.icon),a.push(i.path),o.push(i)}),bg.base.Loader.Load(n.context,a,i).then(function(t){o.forEach(function(e){e.iconTexture=t[e.path],n.addGizmoIcon(e.type,e.iconTexture)}),r(o)}).catch(function(t){s(t)})})},clearGizmoIcons:function(){this.drawVisitor.clearGizmoIcons()},startAction:function(t,e){if(this._working=!0,this._startPoint=e,this._currentGizmoData=t,this._currentGizmoData&&this._currentGizmoData.node){var i=this._currentGizmoData.node.component("bg.manipulation.Gizmo");i&&i.beginDrag(this._currentGizmoData.action,e)}},move:function(t,e){if(this._currentGizmoData&&this._currentGizmoData.node){var i=this._currentGizmoData.node.component("bg.manipulation.Gizmo");i&&(t.y=e.viewport.height-t.y,i.drag(this._currentGizmoData.action,this._startPoint,t,e)),this._startPoint=t}},endAction:function(){if(this._currentGizmoData&&this._currentGizmoData.node){var t=this._currentGizmoData.node.component("bg.manipulation.Gizmo");t&&t.endDrag(this._currentGizmoData.action)}this._working=!1,this._startPoint=null,this._currentGizmoData=null},drawGizmos:function(t,e){var i=void 0===arguments[2]||arguments[2],n=bg.base.Pipeline.Current(),r=bg.base.MatrixState.Current();bg.base.Pipeline.SetCurrent(this.pipeline),bg.base.MatrixState.SetCurrent(this.matrixState),this.pipeline.viewport=e.viewport,this.pipeline.effect.matrixState=this.matrixState,i&&this.pipeline.clearBuffers(bg.base.ClearBuffers.DEPTH),this.matrixState.projectionMatrixStack.set(e.projection),this.matrixState.viewMatrixStack.set(e.viewMatrix);var s=this.pipeline.opacityLayer;this.pipeline.opacityLayer=bg.base.OpacityLayer.NONE,this.pipeline.blend=!0,this.pipeline.effect.gizmoOpacity=this.gizmoOpacity,t.accept(this.drawVisitor),this.pipeline.blend=!1,this.pipeline.opacityLayer=s,n&&bg.base.Pipeline.SetCurrent(n),r&&bg.base.MatrixState.SetCurrent(r)}},{},t)}(bg.app.ContextObject);bg.manipulation.GizmoManager=t}(),function(){function t(){o[bg.webgl1.EngineId]={vertex:"\n\t\t\tattribute vec3 inVertex;\n\t\t\tattribute vec2 inTexCoord;\n\t\t\tattribute vec4 inVertexColor;\n\t\t\t\n\t\t\tuniform mat4 inModelMatrix;\n\t\t\tuniform mat4 inViewMatrix;\n\t\t\tuniform mat4 inProjectionMatrix;\n\t\t\t\n\t\t\tvarying vec2 fsTexCoord;\n\t\t\tvarying vec4 fsColor;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tfsTexCoord = inTexCoord;\n\t\t\t\tfsColor = inVertexColor;\n\t\t\t\tgl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t}\n\t\t\t",fragment:"\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tuniform vec4 inColor;\n\t\t\tuniform sampler2D inTexture;\n\t\t\tuniform float inOpacity;\n\t\t\t\n\t\t\tvarying vec2 fsTexCoord;\n\t\t\tvarying vec4 fsColor;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tvec4 tex = texture2D(inTexture,fsTexCoord);\n\t\t\t\tgl_FragColor = vec4(fsColor.rgb * tex.rgb * inColor.rgb,inOpacity * tex.a);\n\t\t\t}\n\t\t\t"}}function e(t){return/rotate.*fine/i.test(t.name)?bg.manipulation.GizmoAction.ROTATE_FINE:/rotate.*x/i.test(t.name)?bg.manipulation.GizmoAction.ROTATE_X:/rotate.*y/i.test(t.name)?bg.manipulation.GizmoAction.ROTATE_Y:/rotate.*z/i.test(t.name)?bg.manipulation.GizmoAction.ROTATE_Z:/rotate/i.test(t.name)?bg.manipulation.GizmoAction.ROTATE:/translate.*x/i.test(t.name)?bg.manipulation.GizmoAction.TRANSLATE_X:/translate.*y/i.test(t.name)?bg.manipulation.GizmoAction.TRANSLATE_Y:/translate.*z/i.test(t.name)?bg.manipulation.GizmoAction.TRANSLATE_Z:/translate/i.test(t.name)?bg.manipulation.GizmoAction.TRANSLATE:/scale.*x/i.test(t.name)?bg.manipulation.GizmoAction.SCALE_X:/scale.*y/i.test(t.name)?bg.manipulation.GizmoAction.SCALE_Y:/scale.*z/i.test(t.name)?bg.manipulation.GizmoAction.SCALE_Z:/scale/i.test(t.name)?bg.manipulation.GizmoAction.SCALE:void 0}function i(t,i,n){return new Promise(function(r,s){if(!i)return void r([]);bg.base.Loader.Load(t,i).then(function(t){var i=t.component("bg.scene.Drawable"),s=[];i&&i.forEach(function(t,i){s.push({id:bg.manipulation.Selectable.GetIdentifier(),type:bg.manipulation.SelectableType.GIZMO,plist:t,material:i,action:e(t),node:n})}),r(s)}).catch(function(t){s(t)})})}function n(t,e,i,n,r){r||(r=0);var s=new bg.Vector3(i);s.sub(n).normalize();var a=new bg.Vector3(e);a.sub(n).normalize();var o=s.dot(a),c=Math.acos(o);if(c>=r||0==r){0!=r&&(c=c>=2*r?2*r:r);t.dot(s.cross(a))<0&&(c*=-1);var u=new bg.Quaternion(c,t.x,t.y,t.z);if(u.normalize(),!isNaN(u.x))return u}return new bg.Quaternion(0,0,1,0)}function r(t,e){var i=new bg.Matrix4(t.transform.matrix),n=i.rotation,r=i.position;switch(t._lastPickPoint||(t._lastPickPoint=e.ray.end,t._translateOffset=new bg.Vector3(r),t._translateOffset.sub(e.ray.end)),Math.abs(t.plane)){case bg.Axis.X:i=bg.Matrix4.Translation(r.x,e.point.y+t._translateOffset.y,e.point.z+t._translateOffset.z);break;case bg.Axis.Y:i=bg.Matrix4.Translation(e.point.x+t._translateOffset.x,r.y,e.point.z+t._translateOffset.z);break;case bg.Axis.Z:i=bg.Matrix4.Translation(e.point.x+t._translateOffset.x,e.point.y+t._translateOffset.y,r.z)}return i.mult(n),t._lastPickPoint=e.point,i}function s(t,e,i){var r=new bg.Matrix4(t.transform.matrix),s=r.rotation,a=r.position;if(t._lastPickPoint||(t._lastPickPoint=e.ray.end,t._translateOffset=new bg.Vector3(a),t._translateOffset.sub(e.ray.end)),i){var o=new bg.Matrix4(s);s=n(t.planeAxis,t._lastPickPoint,e.point,a),0==s.x&&0==s.y&&0==s.z&&1==s.w||(r=bg.Matrix4.Translation(a).mult(s.getMatrix4()).mult(o),t._lastPickPoint=e.point)}else{var c=new bg.Matrix4(s);s=n(t.planeAxis,t._lastPickPoint,e.point,a,bg.Math.degreesToRadians(22.5)),0==s.x&&0==s.y&&0==s.z&&1==s.w||(r=bg.Matrix4.Translation(a).mult(s.getMatrix4()).mult(c),t._lastPickPoint=e.point)}return r}function a(t,e){var i=e.viewMatrixStack.matrix.forwardVector,n=e.viewMatrixStack.matrix.upVector,r=new bg.Vector3(1,0,0),s=new bg.Vector3(0,1,0),a=new bg.Vector3(0,0,1),o=new bg.Vector3(-1,0,0),c=new bg.Vector3(0,-1,0),u=new bg.Vector3(0,0,-1);if(Math.acos(n.dot(s))>.9)t.plane=bg.Axis.Y;else{var h=[Math.acos(i.dot(r)),Math.acos(i.dot(s)),Math.acos(i.dot(a)),Math.acos(i.dot(o)),Math.acos(i.dot(c)),Math.acos(i.dot(u))],l=h[0],f=0;switch(h.reduce(function(t,e,i){e<l&&(f=i,l=e)}),f){case 0:t.plane=-bg.Axis.X;break;case 1:t.plane=bg.Axis.Y;break;case 2:t.plane=bg.Axis.Z;break;case 3:t.plane=bg.Axis.X;break;case 4:t.plane=-bg.Axis.Y;break;case 5:t.plane=-bg.Axis.Z}}}var o={},c=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e),t(),this._gizmoOpacity=1,this._color=bg.Color.White()}return $traceurRuntime.createClass(i,{get inputVars(){return{vertex:"inVertex",color:"inVertexColor",tex0:"inTexCoord"}},set matrixState(t){this._matrixState=t},get matrixState(){return this._matrixState},set texture(t){this._texture=t},get texture(){return this._texture},set color(t){this._color=t},get color(){return this._color},set gizmoOpacity(t){this._gizmoOpacity=t},get gizmoOpacity(){return this._gizmoOpacity},get shader(){return this._shader||(this._shader=new bg.base.Shader(this.context),this._shader.addShaderSource(bg.base.ShaderType.VERTEX,o[bg.webgl1.EngineId].vertex),this._shader.addShaderSource(bg.base.ShaderType.FRAGMENT,o[bg.webgl1.EngineId].fragment),this._shader.link(),this._shader.status?this._shader.initVars(["inVertex","inVertexColor","inTexCoord"],["inModelMatrix","inViewMatrix","inProjectionMatrix","inColor","inTexture","inOpacity"]):(console.log(this._shader.compileError),console.log(this._shader.linkError))),this._shader},setupVars:function(){var t=bg.base.TextureCache.WhiteTexture(this.context);this.shader.setMatrix4("inModelMatrix",this.matrixState.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",new bg.Matrix4(this.matrixState.viewMatrixStack.matrixConst)),this.shader.setMatrix4("inProjectionMatrix",this.matrixState.projectionMatrixStack.matrixConst),this.shader.setVector4("inColor",this.color),this.shader.setTexture("inTexture",this.texture?this.texture:t,bg.base.TextureUnit.TEXTURE_0),this.shader.setValueFloat("inOpacity",this.gizmoOpacity)}},{},e)}(bg.base.Effect);bg.manipulation.GizmoEffect=c,bg.manipulation.GizmoAction={TRANSLATE:1,ROTATE:2,ROTATE_FINE:3,SCALE:4,TRANSLATE_X:5,TRANSLATE_Y:6,TRANSLATE_Z:7,ROTATE_X:8,ROTATE_Y:9,ROTATE_Z:10,SCALE_X:11,SCALE_Y:12,SCALE_Z:13,NONE:99};var u={},h=function(){function t(t){this._context=t,this._gizmos={}}return $traceurRuntime.createClass(t,{find:function(t){return this._gizmos[t]},register:function(t,e){this._gizmos[t]=e},unregister:function(t){this._gizmos[t]&&delete this._gizmos[t]},clear:function(){this._gizmos={}}},{Get:function(e){return u[e.uuid]||(u[e.uuid]=new t(e)),u[e.uuid]}})}();bg.manipulation.GizmoCache=h;var l=function(t){function e(t){var i=void 0===arguments[1]||arguments[1];$traceurRuntime.superConstructor(e).call(this),this._gizmoPath=t,this._offset=new bg.Vector3(0),this._visible=i,this._gizmoTransform=bg.Matrix4.Identity(),this._gizmoP=bg.Matrix4.Identity(),this._scale=5,this._minSize=.5}return $traceurRuntime.createClass(e,{clone:function(){var t=new e(this._gizmoPath);return t.offset.assign(this._offset),t.visible=this._visible,t},get offset(){return this._offset},set offset(t){this._offset=t},get visible(){return this._visible},set visible(t){this._visible=t},get gizmoTransform(){return this._gizmoTransform},beginDrag:function(t,e){},drag:function(t,e,i,n){},endDrag:function(t){},findId:function(t){var e=null;return this._gizmoItems&&this._gizmoItems.some(function(i){if(i.id.r==t.r&&i.id.g==t.g&&i.id.b==t.b&&i.id.a==t.a)return e=i,!0}),e},init:function(){var t=this;this._error||(this._gizmoItems=[],i(this.node.context,this._gizmoPath,this.node).then(function(e){t._gizmoItems=e}).catch(function(e){throw t._error=!0,e}))},frame:function(t){},display:function(t,e){if(this._gizmoItems&&this.visible){e.modelMatrixStack.push();var i=new bg.Matrix4(e.viewMatrixStack.matrix);i.mult(e.modelMatrixStack.matrix);var n=i.position.magnitude()/this._scale;if(e.modelMatrixStack.matrix.setScale(n,n,n),t.effect instanceof bg.manipulation.ColorPickEffect&&(t.opacityLayer&bg.base.OpacityLayer.GIZMOS||t.opacityLayer&bg.base.OpacityLayer.GIZMOS_SELECTION)){var r=t.depthTest;t.opacityLayer&bg.base.OpacityLayer.GIZMOS_SELECTION?t.depthTest=!0:t.depthTest=!1,this._gizmoItems.forEach(function(e){t.effect.pickId=new bg.Color(e.id.a/255,e.id.b/255,e.id.g/255,e.id.r/255),t.draw(e.plist)}),t.depthTest=r}else t.effect instanceof bg.manipulation.GizmoEffect&&this._gizmoItems.forEach(function(e){t.effect.texture=e.material.texture,t.effect.color=e.material.diffuse,t.draw(e.plist)});e.modelMatrixStack.pop()}}},{},t)}(bg.scene.Component),f=function(t){function e(t){var i=void 0===arguments[1]||arguments[1];$traceurRuntime.superConstructor(e).call(this,t,i),this._plane=bg.Axis.Y,this._autoPlaneMode=!0}return $traceurRuntime.createClass(e,{get plane(){return this._plane},set plane(t){this._plane=t},get autoPlaneMode(){return this._autoPlaneMode},set autoPlaneMode(t){this._autoPlaneMode=t},get planeAxis(){switch(Math.abs(this.plane)){case bg.Axis.X:return new bg.Vector3(1,0,0);case bg.Axis.Y:return new bg.Vector3(0,1,0);case bg.Axis.Z:return new bg.Vector3(0,0,1)}},get gizmoTransform(){var t=bg.Matrix4.Identity();switch(this.plane){case bg.Axis.X:return bg.Matrix4.Rotation(bg.Math.degreesToRadians(90),0,0,-1);case bg.Axis.Y:break;case bg.Axis.Z:return bg.Matrix4.Rotation(bg.Math.degreesToRadians(90),1,0,0);case-bg.Axis.X:return bg.Matrix4.Rotation(bg.Math.degreesToRadians(90),0,0,1);case-bg.Axis.Y:return bg.Matrix4.Rotation(bg.Math.degreesToRadians(180),0,-1,0);case-bg.Axis.Z:return bg.Matrix4.Rotation(bg.Math.degreesToRadians(90),-1,0,0)}return t},clone:function(){var t=new e(this._gizmoPath);return t.offset.assign(this._offset),t.visible=this._visible,t},init:function(){$traceurRuntime.superGet(this,e.prototype,"init").call(this),this._gizmoP=bg.Matrix4.Translation(this.transform.matrix.position)},display:function(t,e){if(this._gizmoItems&&this.visible&&(this.autoPlaneMode&&a(this,e),this._gizmoItems&&this.visible)){var i=new bg.Matrix4(e.viewMatrixStack.matrix);i.mult(e.modelMatrixStack.matrix);var n=i.position.magnitude()/this._scale;n=n<this._minSize?this._minSize:n;var r=this.gizmoTransform;if(r.setScale(n,n,n),e.modelMatrixStack.push(),e.modelMatrixStack.mult(r),t.effect instanceof bg.manipulation.ColorPickEffect&&(t.opacityLayer&bg.base.OpacityLayer.GIZMOS||t.opacityLayer&bg.base.OpacityLayer.GIZMOS_SELECTION)){var s=t.depthTest;t.opacityLayer&bg.base.OpacityLayer.GIZMOS_SELECTION?t.depthTest=!0:t.depthTest=!1,this._gizmoItems.forEach(function(e){t.effect.pickId=new bg.Color(e.id.a/255,e.id.b/255,e.id.g/255,e.id.r/255),t.draw(e.plist)}),t.depthTest=s}else t.effect instanceof bg.manipulation.GizmoEffect&&this._gizmoItems.forEach(function(e){t.effect.texture=e.material.texture,t.effect.color=e.material.diffuse,t.draw(e.plist)});e.modelMatrixStack.pop()}},beginDrag:function(t,e){this._lastPickPoint=null},drag:function(t,e,i,n){if(this.transform){var a=new bg.physics.Plane(this.planeAxis),o=bg.physics.Ray.RayWithScreenPoint(i,n.projection,n.viewMatrix,n.viewport),c=bg.physics.Intersection.RayToPlane(o,a);if(c.intersects()){var u=new bg.Matrix4(this.transform.matrix);switch(this._gizmoP=bg.Matrix4.Translation(this.transform.matrix.position),t){case bg.manipulation.GizmoAction.TRANSLATE:u=r(this,c);break;case bg.manipulation.GizmoAction.ROTATE:u=s(this,c,!1);break;case bg.manipulation.GizmoAction.ROTATE_FINE:u=s(this,c,!0)}this.transform.matrix=u}}},endDrag:function(t){this._lastPickPoint=null}},{},t)}(l),b=function(t){function e(t){var i=void 0===arguments[1]||arguments[1];$traceurRuntime.superConstructor(e).call(this,t,i),this._translateSpeed=.005,this._rotateSpeed=.005,this._scaleSpeed=.001,this._gizmoTransform=bg.Matrix4.Identity()}return $traceurRuntime.createClass(e,{get gizmoTransform(){return this._gizmoTransform},get translateSpeed(){return this._translateSpeed},set translateSpeed(t){this._translateSpeed=t},get rotateSpeed(){return this._rotateSpeed},set rotateSpeed(t){this._rotateSpeed=t},get scaleSpeed(){return this._scaleSpeed},set scaleSpeed(t){this._scaleSpeed=t},clone:function(){var t=new f(this._gizmoPath);return t.offset.assign(this._offset),t.visible=this._visible,t},init:function(){$traceurRuntime.superGet(this,e.prototype,"init").call(this),this._gizmoP=bg.Matrix4.Translation(this.transform.matrix.position),this._gizmoTransform=this.transform.matrix.rotation},display:function(t,i){this._gizmoItems&&this.visible&&$traceurRuntime.superGet(this,e.prototype,"display").call(this,t,i)},beginDrag:function(t,e){this._lastPickPoint=null},drag:function(t,e,i,n){if(this.transform){this._lastPickPoint||(this._lastPickPoint=i);var r=new bg.Matrix4(this.transform.matrix);this._gizmoP=bg.Matrix4.Translation(this.transform.matrix.position);var s=new bg.Vector2(this._lastPickPoint);s.sub(i);var a=bg.base.MatrixState.Current(),o=new bg.Matrix4(a.viewMatrixStack.matrix);o.mult(a.modelMatrixStack.matrix);var c=o.position.magnitude()/this._scale;c=c<this._minSize?this._minSize:c;var u=r.getScale(),h=1-(s.x+s.y)*this.scaleSpeed;switch(t){case bg.manipulation.GizmoAction.SCALE:r.scale(h,h,h);break;case bg.manipulation.GizmoAction.TRANSLATE_X:r.translate(-(s.x+s.y)*this.translateSpeed*c/u.x,0,0);break;case bg.manipulation.GizmoAction.TRANSLATE_Y:r.translate(0,-(s.x+s.y)*this.translateSpeed*c/u.y,0);break;case bg.manipulation.GizmoAction.TRANSLATE_Z:r.translate(0,0,-(s.x+s.y)*this.translateSpeed*c/u.z);break;case bg.manipulation.GizmoAction.ROTATE_X:r.rotate((s.x+s.y)*this.rotateSpeed,1,0,0),this._gizmoP.rotate((s.x+s.y)*this.rotateSpeed,1,0,0);break;case bg.manipulation.GizmoAction.ROTATE_Y:r.rotate((s.x+s.y)*this.rotateSpeed,0,1,0),this._gizmoP.rotate((s.x+s.y)*this.rotateSpeed,0,1,0);break;case bg.manipulation.GizmoAction.ROTATE_Z:r.rotate((s.x+s.y)*this.rotateSpeed,0,0,1),this._gizmoP.rotate((s.x+s.y)*this.rotateSpeed,0,0,1);break;case bg.manipulation.GizmoAction.SCALE_X:r.scale(h,1,1);break;case bg.manipulation.GizmoAction.SCALE_Y:r.scale(1,h,1);break;case bg.manipulation.GizmoAction.SCALE_Z:r.scale(1,1,h)}this.transform.matrix=r,this._lastPickPoint=i}},endDrag:function(t){this._lastPickPoint=null}},{},t)}(l);bg.manipulation.GizmoMode={SELECT:0,TRANSLATE:1,ROTATE:2,SCALE:3,TRANSFORM:4};var g=function(t){function e(t,i,n,r){$traceurRuntime.superConstructor(e).call(this,t),this.mode=bg.manipulation.GizmoMode.TRANSFORM,this._transformPath=t,this._translatePath=i,this._rotatePath=n,this._scalePath=r,this._gizmoPath=t}return $traceurRuntime.createClass(e,{get visible(){return this._mode!=bg.manipulation.GizmoMode.SELECT&&this._visible},set visible(t){this._visible=t},get mode(){return this._mode},set mode(t){var e=this;switch(this._mode=t,this._gizmoItems=[],t){case bg.manipulation.GizmoMode.SELECT:this._gizmoPath="";break;case bg.manipulation.GizmoMode.TRANSLATE:this._gizmoPath=this._translatePath;break;case bg.manipulation.GizmoMode.ROTATE:this._gizmoPath=this._rotatePath;break;case bg.manipulation.GizmoMode.SCALE:this._gizmoPath=this._scalePath;break;case bg.manipulation.GizmoMode.TRANSFORM:this._gizmoPath=this._transformPath}this._gizmoPath&&i(this.node.context,this._gizmoPath,this.node).then(function(t){e._gizmoItems=t,bg.emitImageLoadEvent()}).catch(function(t){throw e._error=!0,t})}},{},t)}(b);bg.scene.registerComponent(bg.manipulation,l,"bg.manipulation.Gizmo"),bg.scene.registerComponent(bg.manipulation,f,"bg.manipulation.Gizmo"),bg.scene.registerComponent(bg.manipulation,b,"bg.manipulation.Gizmo"),bg.scene.registerComponent(bg.manipulation,g,"bg.manipulation.Gizmo")}(),function(){function t(){e[bg.webgl1.EngineId]={vertex:"\n\t\t\tattribute vec3 inVertex;\n\t\t\t\n\t\t\tuniform mat4 inModelMatrix;\n\t\t\tuniform mat4 inViewMatrix;\n\t\t\tuniform mat4 inProjectionMatrix;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tgl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t}\n\t\t\t",fragment:"\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tuniform vec4 inColorId;\n\t\t\t\n\t\t\tvoid main() {\n\t\t\t\tgl_FragColor = inColorId;\n\t\t\t}\n\t\t\t"}}var e={},i=function(i){function n(e){$traceurRuntime.superConstructor(n).call(this,e),t()}return $traceurRuntime.createClass(n,{get inputVars(){return{vertex:"inVertex"}},set matrixState(t){this._matrixState=t},get matrixState(){return this._matrixState},set pickId(t){this._pickId=t},get pickId(){return this._pickId||bg.Color.Transparent()},get shader(){return this._shader||(this._shader=new bg.base.Shader(this.context),this._shader.addShaderSource(bg.base.ShaderType.VERTEX,e[bg.webgl1.EngineId].vertex),this._shader.addShaderSource(bg.base.ShaderType.FRAGMENT,e[bg.webgl1.EngineId].fragment),this._shader.link(),this._shader.status?this._shader.initVars(["inVertex"],["inModelMatrix","inViewMatrix","inProjectionMatrix","inColorId"]):(console.log(this._shader.compileError),console.log(this._shader.linkError))),this._shader},setupVars:function(){this.shader.setMatrix4("inModelMatrix",this.matrixState.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",new bg.Matrix4(this.matrixState.viewMatrixStack.matrixConst)),this.shader.setMatrix4("inProjectionMatrix",this.matrixState.projectionMatrixStack.matrixConst),this.shader.setVector4("inColorId",this.pickId)}},{},i)}(bg.base.Effect);bg.manipulation.ColorPickEffect=i;var n=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this),this._target=t}return $traceurRuntime.createClass(e,{get target(){return this._target},set target(t){this._target=t,this._result=null},get result(){return this._result},visit:function(t){var e=t.component("bg.manipulation.Selectable"),i=t.component("bg.manipulation.Gizmo");i&&!i.visible&&(i=null),this._result=this._result||e&&e.findId(this.target)||i&&i.findId(this.target)}},{},t)}(bg.scene.NodeVisitor);bg.manipulation.FindPickIdVisitor=n;var r=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t)}return $traceurRuntime.createClass(e,{get pipeline(){return this._pipeline||(this._pipeline=new bg.base.Pipeline(this.context),this._pipeline.effect=new i(this.context),this._renderSurface=new bg.base.TextureSurface(this.context),this._renderSurface.create(),this._pipeline.renderSurface=this._renderSurface,this._pipeline.clearColor=new bg.Color(0,0,0,0)),this._pipeline},get matrixState(){return this._matrixState||(this._matrixState=new bg.base.MatrixState),this._matrixState},get drawVisitor(){return this._drawVisitor||(this._drawVisitor=new bg.scene.DrawVisitor(this.pipeline,this.matrixState)),this._drawVisitor},pick:function(t,e,i){var r=bg.base.Pipeline.Current(),s=bg.base.MatrixState.Current();bg.base.Pipeline.SetCurrent(this.pipeline),bg.base.MatrixState.SetCurrent(this.matrixState),this.pipeline.viewport=e.viewport,this.pipeline.effect.matrixState=this.matrixState,this.pipeline.clearBuffers(bg.base.ClearBuffers.COLOR|bg.base.ClearBuffers.DEPTH),this.matrixState.projectionMatrixStack.set(e.projection),this.matrixState.viewMatrixStack.set(e.viewMatrix);var a=this.pipeline.opacityLayer;this.pipeline.opacityLayer=bg.base.OpacityLayer.SELECTION,t.accept(this.drawVisitor),this.pipeline.opacityLayer=bg.base.OpacityLayer.GIZMOS_SELECTION,this.pipeline.clearBuffers(bg.base.ClearBuffers.DEPTH),t.accept(this.drawVisitor),this.pipeline.opacityLayer=a;var o=this.pipeline.renderSurface.readBuffer(new bg.Viewport(i.x,i.y,1,1)),c={r:o[3],g:o[2],b:o[1],a:o[0]},u=new n(c);return t.accept(u),r&&bg.base.Pipeline.SetCurrent(r),s&&bg.base.MatrixState.SetCurrent(s),u.result}},{},t)}(bg.app.ContextObject);bg.manipulation.MousePicker=r}(),function(){function t(){255==a?(a=0,e()):++a}function e(){255==o?(o=0,i()):++o}function i(){255==c?(c=0,n()):++c}function n(){255==u?(u=0,bg.log("WARNING: Maximum number of picker identifier reached.")):++u}function r(){return t(),{r:a,g:o,b:o,a:u}}function s(){return l||(l=bg.scene.PrimitiveFactory.SpherePolyList(this.node.context,.5)),l}var a=0,o=0,c=0,u=0,h=!1;bg.manipulation.SelectableType={PLIST:1,GIZMO:2,GIZMO_ICON:3};var l=null,f=["bg.scene.Camera","bg.scene.Light","bg.scene.Transform"],b=function(t){function e(){$traceurRuntime.superConstructor(e).call(this),this._initialized=!1,this._selectablePlist=[]}return $traceurRuntime.createClass(e,{clone:function(){return new e},buildIdentifier:function(){this._initialized=!1,this._selectablePlist=[]},findId:function(t){var e=null;return this._selectablePlist.some(function(i){if(i.id.r==t.r&&i.id.g==t.g&&i.id.b==t.b&&i.id.a==t.a)return e=i,!0}),e},frame:function(t){var e=this;if(!this._initialized&&this.drawable)this.drawable.forEach(function(t,i){var n=r();e._selectablePlist.push({id:n,type:bg.manipulation.SelectableType.PLIST,plist:t,material:i,drawable:e.drawable,node:e.node})}),this._initialized=!0;else if(!this._initialized){var i=r();this._selectablePlist.push({id:i,type:bg.manipulation.SelectableType.GIZMO_ICON,plist:null,material:null,drawable:null,node:this.node}),this._initialized=!0}},display:function(t,e){var i=this;if(t.effect instanceof bg.manipulation.ColorPickEffect&&t.opacityLayer&bg.base.OpacityLayer.SELECTION){var n=f.some(function(t){return null!=i.node.component(t)});this._selectablePlist.forEach(function(r){var a=new bg.Color(r.id.a/255,r.id.b/255,r.id.g/255,r.id.r/255);if(r.plist&&r.plist.visible)t.effect.pickId=a,t.draw(r.plist);else if(!r.plist&&n){var o=.1*e.cameraDistanceScale;t.effect.pickId=a,e.modelMatrixStack.push(),e.modelMatrixStack.scale(o,o,o),t.draw(s.apply(i)),e.modelMatrixStack.pop()}})}}},{SetSelectableIcons:function(t){f=t},AddSelectableIcon:function(t){-1==f.indexOf(t)&&f.push(t)},RemoveSelectableIcon:function(t){var e=f.indexOf(t);e>=0&&f.splice(e,1)},SetSelectMode:function(t){h=t},GetIdentifier:function(){return r()}},t)}(bg.scene.Component);bg.scene.registerComponent(bg.manipulation,b,"bg.manipulation.Selectable")}(),function(){function t(){return bg.base.ShaderLibrary.Get()}function e(){return s||(s=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),s.addParameter(t().inputs.buffers.vertex),s.addParameter(t().inputs.matrix.all),"webgl1"==bg.Engine.Get().id&&s.setMainBody("\n                    gl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n                ")),s}function i(){return a||(a=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),a.addParameter([{name:"inColor",dataType:"vec4",role:"value"},{name:"inSelectMode",dataType:"int",role:"value"}]),"webgl1"==bg.Engine.Get().id&&a.setMainBody("\n                    if (inSelectMode==0) {\n                        discard;\n                    }\n                    else {\n                        gl_FragColor = inColor;\n                    }\n                ")),a}function n(){var t=new bg.base.Pipeline(this.context),e=new bg.base.TextureSurface(this.context);t.effect=new bg.manipulation.PlainColorEffect(this.context);var i=[{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE
},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}];return e.create(i),t.renderSurface=e,t}var r=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e);var n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT);n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,{name:"fsTexCoord",dataType:"vec2",role:"out"}]),r.addParameter([t().inputs.material.texture,{name:"inTexSize",dataType:"vec2",role:"value"},{name:"inConvMatrix",dataType:"float",role:"value",vec:9},{name:"inBorderColor",dataType:"vec4",role:"value"},{name:"inBorderWidth",dataType:"float",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&(n.setMainBody("\n                gl_Position = vec4(inVertex,1.0);\n                fsTexCoord = inTex0;\n                "),r.addFunction(t().functions.utils.applyConvolution),r.setMainBody("\n                vec4 selectionColor = applyConvolution(inTexture,fsTexCoord,inTexSize,inConvMatrix,inBorderWidth);\n                if (selectionColor.r!=0.0 && selectionColor.g!=0.0 && selectionColor.b!=0.0) {\n                    gl_FragColor = inBorderColor;\n                }\n                else {\n                    discard;\n                }\n                ")),this.setupShaderSource([n,r]),this._highlightColor=bg.Color.White(),this._borderWidth=2}return $traceurRuntime.createClass(i,{get highlightColor(){return this._highlightColor},set highlightColor(t){this._highlightColor=t},get borderWidth(){return this._borderWidth},set borderWidth(t){this._borderWidth=t},setupVars:function(){var t=null;this._surface instanceof bg.base.Texture?t=this._surface:this._surface instanceof bg.base.RenderSurface&&(t=this._surface.getTexture(0)),t&&(this.shader.setTexture("inTexture",t,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTexSize",t.size));var e=[0,1,0,1,-4,1,0,1,0];this.shader.setValueFloatPtr("inConvMatrix",e),this.shader.setVector4("inBorderColor",this._highlightColor),this.shader.setValueFloat("inBorderWidth",this._borderWidth)}},{},e)}(bg.base.TextureEffect);bg.manipulation.BorderDetectionEffect=r;var s=null,a=null,o=function(t){function n(t){$traceurRuntime.superConstructor(n).call(this,t);var r=[e(),i()];this.setupShaderSource(r)}return $traceurRuntime.createClass(n,{beginDraw:function(){bg.Math.seed=1},setupVars:function(){this._baseColor=new bg.Color(bg.Math.seededRandom(),bg.Math.seededRandom(),bg.Math.seededRandom(),1);var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst),this.shader.setVector4("inColor",this._baseColor),this.shader.setValueInt("inSelectMode",this.material.selectMode)}},{},t)}(bg.base.Effect);bg.manipulation.PlainColorEffect=o;var c=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._offscreenPipeline=n.apply(this),this._pipeline=new bg.base.Pipeline(this.context),this._pipeline.textureEffect=new bg.manipulation.BorderDetectionEffect(this.context),this._matrixState=new bg.base.MatrixState,this._drawVisitor=new bg.scene.DrawVisitor(this._offscreenPipeline,this._matrixState)}return $traceurRuntime.createClass(e,{get highlightColor(){return this._pipeline.textureEffect.highlightColor},set highlightColor(t){this._pipeline.textureEffect.highlightColor=t},get borderWidth(){return this._pipeline.textureEffect.borderWidth},set borderWidth(t){this._pipeline.textureEffect.borderWidth=t},drawSelection:function(t,e){var i=bg.base.Pipeline.Current(),n=bg.base.MatrixState.Current();this._offscreenPipeline.viewport=e.viewport,this._pipeline.viewport=e.viewport,bg.base.Pipeline.SetCurrent(this._offscreenPipeline),bg.base.MatrixState.SetCurrent(this._matrixState),this._offscreenPipeline.clearBuffers(bg.base.ClearBuffers.COLOR|bg.base.ClearBuffers.DEPTH),this._matrixState.projectionMatrixStack.set(e.projection),this._matrixState.viewMatrixStack.set(e.viewMatrix),this._matrixState.modelMatrixStack.identity(),t.accept(this._drawVisitor);var r=this._offscreenPipeline.renderSurface.getTexture(0);bg.base.Pipeline.SetCurrent(this._pipeline),this._pipeline.drawTexture(r),i&&bg.base.Pipeline.SetCurrent(i),n&&bg.base.MatrixState.SetCurrent(n)}},{},t)}(bg.app.ContextObject);bg.manipulation.SelectionHighlight=c}(),function(){function t(t){var e=bg.app.Mouse.LeftButton(),i=bg.app.Mouse.MiddleButton(),r=bg.app.Mouse.RightButton();switch(!0){case e==t._rotateButtons.left&&i==t._rotateButtons.middle&&r==t._rotateButtons.right:return n.ROTATE;case e==t._panButtons.left&&i==t._panButtons.middle&&r==t._panButtons.right:return n.PAN;case e==t._zoomButtons.left&&i==t._zoomButtons.middle&&r==t._zoomButtons.right:return n.ZOOM}}function e(t,e,i){for(var n=new bg.base.PolyList(t),r=[],s=[],a=[],o=0,c=0;c<e.length;c+=3)r.push(0),r.push(0),r.push(1),s.push(0),s.push(0),a.push(o++);return n.vertex=e,n.normal=r,n.texCoord0=s,n.color=i,n.index=a,n.drawMode=bg.base.DrawMode.LINES,n.build(),n}function i(){for(var t=this.minX,i=this.maxX,n=this.minY,r=this.maxY,s=this.minZ,a=this.maxZ,o=[t,n,s,i,n,s,i,n,s,i,r,s,i,r,s,t,r,s,t,r,s,t,n,s,t,n,a,i,n,a,i,n,a,i,r,a,i,r,a,t,r,a,t,r,a,t,n,a,t,n,s,t,n,a,i,n,s,i,n,a,i,r,s,i,r,a,t,r,s,t,r,a],c=[],u=0;u<o.length;u+=3)c.push(this._limitGizmoColor.r),c.push(this._limitGizmoColor.g),c.push(this._limitGizmoColor.b),c.push(this._limitGizmoColor.a);return this._plist?(this._plist.updateBuffer(bg.base.BufferType.VERTEX,o),this._plist.updateBuffer(bg.base.BufferType.COLOR,c)):this._plist=e(this.node.context,o,c),this._plist}var n={ROTATE:0,PAN:1,ZOOM:2},r=function(e){function r(){$traceurRuntime.superConstructor(r).call(this),this._rotateButtons={left:!0,middle:!1,right:!1},this._panButtons={left:!1,middle:!1,right:!0},this._zoomButtons={left:!1,middle:!0,right:!1},this._rotation=new bg.Vector2,this._distance=5,this._center=new bg.Vector3,this._rotationSpeed=.2,this._forward=0,this._left=0,this._wheelSpeed=1,this._minFocus=2,this._minPitch=.1,this._maxPitch=85,this._minDistance=.4,this._maxDistance=24,this._maxX=15,this._minX=-15,this._minY=.1,this._maxY=2,this._maxZ=15,this._minZ=-15,this._displacementSpeed=.1,this._enabled=!0,this._keys={},this._showLimitGizmo=!0,this._limitGizmoColor=bg.Color.Green()}return $traceurRuntime.createClass(r,{setRotateButtons:function(t,e,i){this._rotateButtons={left:t,middle:e,right:i}},setPanButtons:function(t,e,i){this._panButtons={left:t,middle:e,right:i}},setZoomButtons:function(t,e,i){this._zoomButtons={left:t,middle:e,right:i}},get rotation(){return this._rotation},set rotation(t){this._rotation=t},get distance(){return this._distance},set distance(t){this._distance=t},get center(){return this._center},set center(t){this._center=t},get whellSpeed(){this._wheelSpeed},set wheelSpeed(t){this._wheelSpeed=t},get minCameraFocus(){return this._minFocus},set minCameraFocus(t){this._minFocus=t},get minPitch(){return this._minPitch},set minPitch(t){this._minPitch=t},get maxPitch(){return this._maxPitch},set maxPitch(t){this._maxPitch=t},get minDistance(){return this._minDistance},set minDistance(t){this._minDistance=t},get maxDistance(){return this._maxDistance},set maxDistance(t){this._maxDistance=t},get minX(){return this._minX},get maxX(){return this._maxX},get minY(){return this._minY},get maxY(){return this._maxY},get minZ(){return this._minZ},get maxZ(){return this._maxZ},set minX(t){this._minX=t},set maxX(t){this._maxX=t},set minY(t){this._minY=t},set maxY(t){this._maxY=t},set minZ(t){this._minZ=t},set maxZ(t){this._maxZ=t},get displacementSpeed(){return this._displacementSpeed},set displacementSpeed(t){this._displacementSpeed=t},get enabled(){return this._enabled},set enabled(t){this._enabled=t},get showLimitGizmo(){return this._showLimitGizmo},set showLimitGizmo(t){this._showLimitGizmo=t},get limitGizmoColor(){return this._limitGizmoColor},set limitGizmoColor(t){this._limitGizmoColor=t},displayGizmo:function(t,e){if(this._showLimitGizmo){var n=i.apply(this);e.modelMatrixStack.push(),e.modelMatrixStack.identity(),n&&t.draw(n),e.modelMatrixStack.pop()}},serialize:function(t,e,i){$traceurRuntime.superGet(this,r.prototype,"serialize").call(this,t,e,i),t.rotateButtons=this._rotateButtons,t.panButtons=this._panButtons,t.zoomButtons=this._zoomButtons,t.rotation=this._rotation.toArray(),t.distance=this._distance,t.center=this._center.toArray(),t.rotationSpeed=this._rotationSpeed,t.forward=this._forward,t.left=this._left,t.wheelSpeed=this._wheelSpeed,t.minFocus=this._minFocus,t.minPitch=this._minPitch,t.maxPitch=this._maxPitch,t.minDistance=this._minDistance,t.maxDistance=this._maxDistance,t.maxX=this._maxX,t.minX=this._minX,t.minY=this._minY,t.maxY=this._maxY,t.maxZ=this._maxZ,t.minZ=this._minZ,t.displacementSpeed=this._displacementSpeed,t.enabled=this._enabled},deserialize:function(t,e,i){this._rotateButtons=e.rotateButtons||this._rotateButtons,this._panButtons=e.panButtons||this._panButtons,this._zoomButtons=e.zoomButtons||this._zoomButtons,this._rotation=new bg.Vector2(e.rotation)||this._rotation,this._distance=void 0!==e.distance?e.distance:this._distance,this._center=new bg.Vector3(e.center)||this._center,this._rotationSpeed=void 0!==e.rotationSpeed?e.rotationSpeed:this._rotationSpeed,this._forward=void 0!==e.forward?e.forward:this._forward,this._left=void 0!==e.left?e.left:this._left,this._wheelSpeed=void 0!==e.wheelSpeed?e.wheelSpeed:this._wheelSpeed,this._minFocus=void 0!==e.minFocus?e.minFocus:this._minFocus,this._minPitch=void 0!==e.minPitch?e.minPitch:this._minPitch,this._maxPitch=void 0!==e.maxPitch?e.maxPitch:this._maxPitch,this._minDistance=void 0!==e.minDistance?e.minDistance:this._minDistance,this._maxDistance=void 0!==e.maxDistance?e.maxDistance:this._maxDistance,this._maxX=void 0!==e.maxX?e.maxX:this._maxX,this._minX=void 0!==e.minX?e.minX:this._minX,this._minY=void 0!==e.minY?e.minY:this._minY,this._maxY=void 0!==e.maxY?e.maxY:this._maxY,this._maxZ=void 0!==e.maxZ?e.maxZ:this._maxZ,this._minZ=void 0!==e.minZ?e.minZ:this._minZ,this._displacementSpeed=void 0!==e.displacementSpeed?e.displacementSpeed:this._displacementSpeed,this._enabled=void 0!==e.enabled?e.enabled:this._enabled},frame:function(t){if(this.transform&&this.enabled){var e=this.transform.matrix.forwardVector,i=this.transform.matrix.leftVector;e.scale(this._forward),i.scale(this._left),this._center.add(e).add(i);var n=this._rotation.x>this._minPitch?this._rotation.x:this._minPitch;if(n=n<this._maxPitch?n:this._maxPitch,this._rotation.x=n,this._distance=this._distance>this._minDistance?this._distance:this._minDistance,this._distance=this._distance<this._maxDistance?this._distance:this._maxDistance,this._mouseButtonPressed){var r=new bg.Vector3;this._keys[bg.app.SpecialKey.UP_ARROW]&&(r.add(this.transform.matrix.backwardVector),bg.app.MainLoop.singleton.windowController.postRedisplay()),this._keys[bg.app.SpecialKey.DOWN_ARROW]&&(r.add(this.transform.matrix.forwardVector),bg.app.MainLoop.singleton.windowController.postRedisplay()),this._keys[bg.app.SpecialKey.LEFT_ARROW]&&(r.add(this.transform.matrix.leftVector),bg.app.MainLoop.singleton.windowController.postRedisplay()),this._keys[bg.app.SpecialKey.RIGHT_ARROW]&&(r.add(this.transform.matrix.rightVector),bg.app.MainLoop.singleton.windowController.postRedisplay()),r.scale(this._displacementSpeed),this._center.add(r)}this._center.x<this._minX?this._center.x=this._minX:this._center.x>this._maxX&&(this._center.x=this._maxX),this._center.y<this._minY?this._center.y=this._minY:this._center.y>this._maxY&&(this._center.y=this._maxY),this._center.z<this._minZ?this._center.z=this._minZ:this._center.z>this._maxZ&&(this._center.z=this._maxZ),this.transform.matrix.identity().translate(this._center).rotate(bg.Math.degreesToRadians(this._rotation.y),0,1,0).rotate(bg.Math.degreesToRadians(n),-1,0,0).translate(0,0,this._distance)}this.camera&&(this.camera.focus=this._distance>this._minFocus?this._distance:this._minFocus)},mouseDown:function(t){this.enabled&&(this._mouseButtonPressed=!0,this._lastPos=new bg.Vector2(t.x,t.y))},mouseUp:function(t){this._mouseButtonPressed=!1},mouseDrag:function(e){if(this.transform&&this._lastPos&&this.enabled){var i=new bg.Vector2(this._lastPos.y-e.y,this._lastPos.x-e.x);switch(this._lastPos.set(e.x,e.y),t(this)){case n.ROTATE:i.x=-1*i.x,this._rotation.add(i.scale(.5));break;case n.PAN:var r=this.transform.matrix.upVector,s=this.transform.matrix.leftVector;r.scale(-.001*i.x*this._distance),s.scale(-.001*i.y*this._distance),this._center.add(r).add(s);break;case n.ZOOM:this._distance+=.01*i.x*this._distance}}},mouseWheel:function(t){if(this.enabled){var e=this._distance>.01?this._distance:.01;this._distance+=.001*t.delta*e*this._wheelSpeed}},touchStart:function(t){this.enabled&&(this._lastTouch=t.touches)},touchMove:function(t){if(this._lastTouch.length==t.touches.length&&this.transform&&this.enabled)if(1==this._lastTouch.length){var e=this._lastTouch[0],i=t.touches[0],n=new bg.Vector2(-1*(e.y-i.y),e.x-i.x);this._rotation.add(n.scale(.5))}else if(2==this._lastTouch.length){var r=this._lastTouch[0],s=this._lastTouch[1],a=null,o=null;t.touches.forEach(function(t){t.identifier==r.identifier?a=t:t.identifier==s.identifier&&(o=t)});var c=Math.round(new bg.Vector2(r.x,r.y).sub(new bg.Vector3(s.x,s.y)).magnitude()),u=Math.round(new bg.Vector2(a.x,a.y).sub(new bg.Vector3(o.x,o.y)).magnitude()),h=new bg.Vector2(r.y-a.y,s.x-o.x),l=this.transform.matrix.upVector,f=this.transform.matrix.leftVector;l.scale(-.001*h.x*this._distance),f.scale(-.001*h.y*this._distance),this._center.add(l).add(f),this._distance+=.005*(c-u)*this._distance}this._lastTouch=t.touches},keyDown:function(t){this.enabled&&(this._keys[t.key]=!0,bg.app.MainLoop.singleton.windowController.postRedisplay())},keyUp:function(t){this.enabled&&(this._keys[t.key]=!1)}},{DisableAll:function(t){var e=t.component("bg.manipulation.OrbitCameraController");e&&(e.enabled=!1),t.children.forEach(function(t){return r.DisableAll(t)})},SetUniqueEnabled:function(t,e){r.DisableAll(e),t.enabled=!0}},e)}(bg.scene.Component),s=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{},{},t)}(bg.scene.Component),a=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{},{},t)}(bg.scene.Component);bg.scene.registerComponent(bg.manipulation,r,"bg.manipulation.OrbitCameraController"),bg.scene.registerComponent(bg.manipulation,s,"bg.manipulation.FPSCameraController"),bg.scene.registerComponent(bg.manipulation,a,"bg.manipulation.TargetCameraController")}(),bg.tools={},function(){var t=function(){function t(t,e){this._min=new bg.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._max=new bg.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._center=null,this._size=null,this._halfSize=null,this._vertexArray=[],e=e||bg.Matrix4.Identity(),t instanceof bg.scene.Drawable?this.addDrawable(t,e):t instanceof bg.scene.PolyList&&this.addPolyList(t,e)}return $traceurRuntime.createClass(t,{clear:function(){this._min=bg.Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._max=bg.Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._center=this._size=this._halfSize=null},get min(){return this._min},get max(){return this._max},get center(){if(!this._center){this.halfSize;this._center=bg.Vector3.Add(this.halfSize,this._min)}return this._center},get size(){return this._size||(this._size=bg.Vector3.Sub(this.max,this.min)),this._size},get halfSize(){return this._halfSize||(this._halfSize=new bg.Vector3(this.size),this._halfSize.scale(.5)),this._halfSize},addPolyList:function(t,e){this._center=this._size=this._halfSize=null;for(var i=0;i<t.vertex.length;i+=3){var n=e.multVector(new bg.Vector3(t.vertex[i],t.vertex[i+1],t.vertex[i+2]));n.x<this._min.x&&(this._min.x=n.x),n.y<this._min.y&&(this._min.y=n.y),n.z<this._min.z&&(this._min.z=n.z),n.x>this._max.x&&(this._max.x=n.x),n.z>this._max.z&&(this._max.z=n.z),n.y>this._max.y&&(this._max.y=n.y)}},addDrawable:function(t,e){var i=this;t.forEach(function(t,n,r){if(t.visible){var s=new bg.Matrix4(e);r&&s.mult(r),i.addPolyList(t,s)}})}},{})}();bg.tools.BoundingBox=t}(),bg.render={},function(){var t=function(t){function e(t){var i=void 0!==arguments[1]?arguments[1]:bg.base.OpacityLayer.ALL;$traceurRuntime.superConstructor(e).call(this,t),this._pipeline=new bg.base.Pipeline(t),this._pipeline.opacityLayer=i,this._matrixState=bg.base.MatrixState.Current(),this._drawVisitor=new bg.scene.DrawVisitor(this._pipeline,this._matrixState),this._settings={}}return $traceurRuntime.createClass(e,{get pipeline(){return this._pipeline},get opacityLayer(){return this._pipeline.opacityLayer},get drawVisitor(){return this._drawVisitor},get matrixState(){return this._matrixState},set settings(t){this._settings=t},get settings(){return this._settings},draw:function(t,e){}},{},t)}(bg.app.ContextObject);bg.render.RenderLayer=t}(),function(){bg.render.RenderPath={FORWARD:1,DEFERRED:2},bg.render.RaytracerQuality={low:{maxSamples:20,rayIncrement:.05},mid:{maxSamples:50,rayIncrement:.025},high:{maxSamples:100,rayIncrement:.0125},extreme:{maxSamples:200,rayIncrement:.0062}},bg.render.ShadowType={HARD:bg.base.ShadowType.HARD,SOFT:bg.base.ShadowType.SOFT},bg.render.ShadowMapQuality={low:512,mid:1024,high:2048,extreme:4096};var t={debug:{enabled:!1},ambientOcclusion:{enabled:!0,sampleRadius:.4,kernelSize:16,blur:2,maxDistance:300},raytracer:{enabled:!0,quality:bg.render.RaytracerQuality.mid},antialiasing:{enabled:!1},shadows:{quality:bg.render.ShadowMapQuality.mid,type:bg.render.ShadowType.SOFT}},e=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e),this._frameVisitor=new bg.scene.FrameVisitor,this._settings=t,this._clearColor=bg.Color.Black()}return $traceurRuntime.createClass(i,{get isSupported(){return!1},create:function(){console.log("ERROR: Error creating renderer. The renderer class must implemente the create() method.")},get clearColor(){return this._clearColor},set clearColor(t){this._clearColor=t},frame:function(t,e){this._frameVisitor.delta=e,t.accept(this._frameVisitor)},display:function(t,e){this.draw(t,e)},get settings(){return this._settings}},{Create:function(t,e){var i=null;if(e==bg.render.RenderPath.DEFERRED&&(i=new bg.render.DeferredRenderer(t)),(e==bg.render.RenderPath.FORWARD||i&&!i.isSupported)&&(i=new bg.render.ForwardRenderer(t)),!i.isSupported)throw new Error("No suitable renderer found.");return i.create(),i}},e)}(bg.app.ContextObject);bg.render.Renderer=e}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter([{name:"inLighting",dataType:"sampler2D",role:"value"},{name:"inDiffuse",dataType:"sampler2D",role:"value"},{name:"inPositionMap",dataType:"sampler2D",role:"value"},{name:"inSSAO",dataType:"sampler2D",role:"value"},{name:"inReflection",dataType:"sampler2D",role:"value"},{name:"inSpecularMap",dataType:"sampler2D",role:"value"},{name:"inMaterial",dataType:"sampler2D",role:"value"},{name:"inOpaqueDepthMap",dataType:"sampler2D",role:"value"},{name:"inViewSize",dataType:"vec2",role:"value"},{name:"inSSAOBlur",dataType:"int",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&(this._fragmentShaderSource.addFunction(t().functions.blur.textureDownsample),this._fragmentShaderSource.addFunction(t().functions.blur.blur),this._fragmentShaderSource.addFunction(t().functions.blur.glowBlur),this._fragmentShaderSource.setMainBody("\n\t\t\t\t\tvec4 lighting = clamp(texture2D(inLighting,fsTexCoord),vec4(0.0),vec4(1.0));\n\t\t\t\t\tvec4 diffuse = texture2D(inDiffuse,fsTexCoord);\n\t\t\t\t\tvec4 pos = texture2D(inPositionMap,fsTexCoord);\n\t\t\t\t\tvec4 ssao = blur(inSSAO,fsTexCoord,inSSAOBlur * 20,inViewSize);\n\t\t\t\t\tvec4 material = texture2D(inMaterial,fsTexCoord);\n\n\t\t\t\t\tvec4 specular = texture2D(inSpecularMap,fsTexCoord);\t// The roughness parameter is stored on A component, inside specular map\n\n\t\t\t\t\tfloat roughness = specular.a;\n\t\t\t\t\troughness *= 400.0;\n\t\t\t\t\tvec4 reflect = blur(inReflection,fsTexCoord,int(roughness),inViewSize);\n\n\t\t\t\t\tvec4 opaqueDepth = texture2D(inOpaqueDepthMap,fsTexCoord);\n\t\t\t\t\tif (pos.z<opaqueDepth.z && opaqueDepth.w<1.0) {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tfloat reflectionAmount = material.b;\n\t\t\t\t\t\tvec3 finalColor = lighting.rgb * (1.0 - reflectionAmount);\n\t\t\t\t\t\tfinalColor += reflect.rgb * reflectionAmount;\n\t\t\t\t\t\tfinalColor *= ssao.rgb;\n\t\t\t\t\t\tgl_FragColor = vec4(finalColor,diffuse.a);\n\t\t\t\t\t}"))),this._fragmentShaderSource},setupVars:function(){this.shader.setVector2("inViewSize",new bg.Vector2(this.viewport.width,this.viewport.height)),this.shader.setTexture("inLighting",this._surface.lightingMap,bg.base.TextureUnit.TEXTURE_0),this.shader.setTexture("inDiffuse",this._surface.diffuseMap,bg.base.TextureUnit.TEXTURE_1),this.shader.setTexture("inPositionMap",this._surface.positionMap,bg.base.TextureUnit.TEXTURE_2),this.shader.setTexture("inSSAO",this._surface.ssaoMap,bg.base.TextureUnit.TEXTURE_3),this.shader.setTexture("inReflection",this._surface.reflectionMap,bg.base.TextureUnit.TEXTURE_4),this.shader.setTexture("inMaterial",this._surface.materialMap,bg.base.TextureUnit.TEXTURE_5),this.shader.setTexture("inSpecularMap",this._surface.specularMap,bg.base.TextureUnit.TEXTURE_6),this.shader.setTexture("inOpaqueDepthMap",this._surface.opaqueDepthMap,bg.base.TextureUnit.TEXTURE_7),this.shader.setValueInt("inSSAOBlur",this.ssaoBlur)},set viewport(t){this._viewport=t},get viewport(){return this._viewport},set clearColor(t){this._clearColor=t},get clearColor(){return this._clearColor},set ssaoBlur(t){this._ssaoBlur=t},get ssaoBlur(){return this._ssaoBlur},get colorCorrection(){return this._colorCorrection||(this._colorCorrection={hue:1,saturation:1,lightness:1,brightness:.5,contrast:.5}),this._colorCorrection}},{},e)}(bg.base.TextureEffect);bg.render.DeferredMixEffect=e}(),function(){function t(t,e,i,n){var r=new bg.base.Pipeline(t);return r.renderSurface=i,void 0!==n?(r.opacityLayer=n,r.effect=e):r.textureEffect=e,r}function e(e){var i=e.context,n=e._surfaces,r=e._opacityLayer;e._gbufferUbyte=t(i,new bg.render.GBufferEffect(i),n.gbufferUByteSurface,r),e._gbufferFloat=t(i,new bg.render.PositionGBufferEffect(i),n.gbufferFloatSurface,r),e._shadow=t(i,new bg.render.ShadowEffect(i),n.shadowSurface,bg.base.OpacityLayer.ALL),e._lighting=t(i,new bg.render.LightingEffect(i),n.lightingSurface),e._ssao=t(i,new bg.render.SSAOEffect(i),n.ssaoSurface),e._ssao.clearColor=bg.Color.White(),e._ssrt=t(i,new bg.render.SSRTEffect(i),n.ssrtSurface);var s=e.matrixState;e.ubyteVisitor=new bg.scene.DrawVisitor(e._gbufferUbyte,s),e.floatVisitor=new bg.scene.DrawVisitor(e._gbufferFloat,s),e.shadowVisitor=new bg.scene.DrawVisitor(e._shadow,s),e._mix=t(i,new bg.render.DeferredMixEffect(i),n.mixSurface)}bg.render.SurfaceType={UNDEFINED:0,OPAQUE:1,TRANSPARENT:2};var i=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._type=bg.render.SurfaceType.UNDEFINED,this._gbufferUByteSurface=null,this._gbufferFloatSurface=null,this._lightingSurface=null,this._shadowSurface=null,this._ssaoSurface=null,this._mixSurface=null,this._ssrtSurface=null,this._opaqueSurfaces=null}return $traceurRuntime.createClass(e,{createOpaqueSurfaces:function(){this._type=bg.render.SurfaceType.OPAQUE,this.createCommon()},createTransparentSurfaces:function(t){this._type=bg.render.SurfaceType.TRANSPARENT,this._opaqueSurfaces=t,this.createCommon()},resize:function(t){var e=new bg.Vector2(t.width,t.height);this._gbufferUByteSurface.size=e,this._gbufferFloatSurface.size=e,this._lightingSurface.size=e,this._shadowSurface.size=e,this._ssaoSurface.size=e,this._ssrtSurface.size=e,this._mixSurface.size=e},get type(){return this._type},get gbufferUByteSurface(){return this._gbufferUByteSurface},get gbufferFloatSurface(){return this._gbufferFloatSurface},get lightingSurface(){return this._lightingSurface},get shadowSurface(){return this._shadowSurface},get ssaoSurface(){return this._ssaoSurface},get ssrtSurface(){return this._ssrtSurface},get mixSurface(){return this._mixSurface},get diffuse(){return this._gbufferUByteSurface.getTexture(0)},get specular(){return this._gbufferUByteSurface.getTexture(1)},get normal(){return this._gbufferUByteSurface.getTexture(2)},get material(){return this._gbufferUByteSurface.getTexture(3)},get position(){return this._gbufferFloatSurface.getTexture(0)},get lighting(){return this._lightingSurface.getTexture()},get shadow(){return this._shadowSurface.getTexture()},get ambientOcclusion(){return this._ssaoSurface.getTexture()},get reflection(){return this._ssrtSurface.getTexture()},get mix(){return this._mixSurface.getTexture()},get reflectionColor(){return this._type==bg.render.SurfaceType.OPAQUE?this.lighting:this._opaqueSurfaces.lighting},get reflectionDepth(){return this._type==bg.render.SurfaceType.OPAQUE?this.position:this._opaqueSurfaces.position},get mixDepthMap(){return this._type==bg.render.SurfaceType.OPAQUE?this.position:this._opaqueSurfaces.position},createCommon:function(){var t=this.context;this._gbufferUByteSurface=new bg.base.TextureSurface(t),this._gbufferUByteSurface.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._gbufferUByteSurface.resizeOnViewportChanged=!1,this._gbufferFloatSurface=new bg.base.TextureSurface(t),this._gbufferFloatSurface.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.FLOAT},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._gbufferFloatSurface.resizeOnViewportChanged=!1,this._lightingSurface=new bg.base.TextureSurface(t),this._lightingSurface.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.FLOAT},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._lightingSurface.resizeOnViewportChanged=!1,this._shadowSurface=new bg.base.TextureSurface(t),this._shadowSurface.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._shadowSurface.resizeOnViewportChanged=!1,this._ssaoSurface=new bg.base.TextureSurface(t),this._ssaoSurface.create(),this._ssaoSurface.resizeOnViewportChanged=!1,this._ssrtSurface=new bg.base.TextureSurface(t),this._ssrtSurface.create(),this._ssrtSurface.resizeOnViewportChanged=!1,this._mixSurface=new bg.base.TextureSurface(t),this._mixSurface.create(),this._mixSurface.resizeOnViewportChanged=!1}},{},t)}(bg.app.ContextObject);bg.render.DeferredRenderSurfaces=i;var n=function(t){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{createOpaque:function(){this._opacityLayer=bg.base.OpacityLayer.OPAQUE,this._surfaces=new bg.render.DeferredRenderSurfaces(this.context),this._surfaces.createOpaqueSurfaces(),e(this)},createTransparent:function(t){this._opacityLayer=bg.base.OpacityLayer.TRANSPARENT,this._surfaces=new bg.render.DeferredRenderSurfaces(this.context),this._surfaces.createTransparentSurfaces(t),e(this),this._gbufferUbyte.blend=!0,this._gbufferUbyte.setBlendMode=bg.base.BlendMode.NORMAL,this._gbufferUbyte.clearColor=bg.Color.Transparent(),this._lighting.clearColor=bg.Color.Black(),this.pipeline.clearColor=bg.Color.Transparent()},set shadowMap(t){this._shadowMap=t},get shadowMap(){return this._shadowMap},get pipeline(){return this._mix},get texture(){return this.maps.mix},draw:function(t,e){this.matrixState.projectionMatrixStack.set(e.projection),this.matrixState.viewMatrixStack.set(e.viewMatrix),this.matrixState.modelMatrixStack.identity(),this.performDraw(t,e)},get maps(){return this._surfaces},resize:function(t){var e=t.viewport;this.maps.resize(new bg.Size2D(e.width,e.height))},performDraw:function(t,e){var i=this;bg.base.Pipeline.SetCurrent(this._gbufferUbyte),this._gbufferUbyte.viewport=e.viewport,this._gbufferUbyte.clearBuffers(),t.accept(this.ubyteVisitor),bg.base.Pipeline.SetCurrent(this._gbufferFloat),this._gbufferFloat.viewport=e.viewport,this._gbufferFloat.clearBuffers(),t.accept(this.floatVisitor),this._lighting.viewport=e.viewport,this._lighting.clearcolor=bg.Color.White(),bg.base.Pipeline.SetCurrent(this._lighting),this._lighting.clearBuffers(bg.base.ClearBuffers.COLOR_DEPTH),this._lighting.blendMode=bg.base.BlendMode.ADD,this._lighting.blend=!0,this._shadow.viewport=e.viewport;var n=0;bg.scene.Light.GetActiveLights().forEach(function(r){r.light&&r.light.enabled&&r.node&&r.node.enabled&&(r.light.type!=bg.base.LightType.DIRECTIONAL&&r.light.type!=bg.base.LightType.SPOT||(i._shadowMap.shadowType=i.settings.shadows.type,i._shadowMap.update(t,e,r.light,r.transform),bg.base.Pipeline.SetCurrent(i._shadow),i._shadow.viewport=e.viewport,i._shadow.clearBuffers(),i._shadow.effect.light=r.light,i._shadow.effect.shadowMap=i._shadowMap,t.accept(i.shadowVisitor)),bg.base.Pipeline.SetCurrent(i._lighting),i._lighting.textureEffect.lightEmissionFactor=0==n?10:0,i._lighting.textureEffect.light=r.light,i._lighting.textureEffect.lightTransform=r.transform,i._lighting.textureEffect.shadowMap=i.maps.shadow,i._lighting.drawTexture(i.maps),++n)});var r=this.settings.ambientOcclusion.enabled,s=this.settings.raytracer.enabled,a=new bg.Viewport(e.viewport);if(this._ssao.textureEffect.enabled=r,this._ssao.textureEffect.settings.kernelSize=this.settings.ambientOcclusion.kernelSize,this._ssao.textureEffect.settings.sampleRadius=this.settings.ambientOcclusion.sampleRadius,this._ssao.textureEffect.settings.maxDistance=this.settings.ambientOcclusion.maxDistance,r&&(bg.base.Pipeline.SetCurrent(this._ssao),this._ssao.viewport=e.viewport,this._ssao.clearBuffers(),this._ssao.textureEffect.viewport=e.viewport,this._ssao.textureEffect.projectionMatrix=e.projection,this._ssao.drawTexture(this.maps)),bg.base.Pipeline.SetCurrent(this._ssrt),s){this._ssrt.viewport=a,this._ssrt.clearBuffers(),this._ssrt.textureEffect.quality=this.settings.raytracer.quality;var o=e.node.component("bg.scene.Transform");if(o){var c=new bg.Matrix4(e.projection);c.mult(e.viewMatrix),this._ssrt.textureEffect.cameraPosition=c.multVector(o.matrix.position).xyz}this._ssrt.textureEffect.projectionMatrix=e.projection,this._ssrt.textureEffect.rayFailColor=this.settings.raytracer.clearColor||bg.Color.Black(),this._ssrt.textureEffect.basic=this.settings.raytracer.basicReflections||!1,this._ssrt.drawTexture(this.maps)}bg.base.Pipeline.SetCurrent(this.pipeline),this.pipeline.viewport=e.viewport,this.pipeline.clearBuffers(),this.pipeline.textureEffect.viewport=e.viewport,this.pipeline.textureEffect.ssaoBlur=r?this.settings.ambientOcclusion.blur:1,this.pipeline.drawTexture({lightingMap:this.maps.lighting,diffuseMap:this.maps.diffuse,positionMap:this.maps.position,ssaoMap:r?this.maps.ambientOcclusion:bg.base.TextureCache.WhiteTexture(this.context),reflectionMap:s?this.maps.reflection:this.maps.lighting,specularMap:this.maps.specular,materialMap:this.maps.material,opaqueDepthMap:this.maps.mixDepthMap})}
},{},t)}(bg.render.RenderLayer);bg.render.DeferredRenderLayer=n}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._size=new bg.Size2D(0)}return $traceurRuntime.createClass(e,{get isSupported(){return bg.base.RenderSurface.MaxColorAttachments()>5&&bg.base.RenderSurface.SupportFormat(bg.base.RenderSurfaceFormat.FLOAT)&&bg.base.RenderSurface.SupportType(bg.base.RenderSurfaceType.DEPTH)},get pipeline(){return this._pipeline},create:function(){var t=this.context;this._opaqueLayer=new bg.render.DeferredRenderLayer(t),this._opaqueLayer.settings=this.settings,this._opaqueLayer.createOpaque(),this._transparentLayer=new bg.render.DeferredRenderLayer(t),this._transparentLayer.settings=this.settings,this._transparentLayer.createTransparent(this._opaqueLayer.maps),this._shadowMap=new bg.base.ShadowMap(t),this._shadowMap.size=new bg.Vector2(2048),this._opaqueLayer.shadowMap=this._shadowMap,this._transparentLayer.shadowMap=this._shadowMap;var e=new bg.base.TextureSurface(t);e.create(),this._mixPipeline=new bg.base.Pipeline(t),this._mixPipeline.textureEffect=new bg.render.RendererMixEffect(t),this._mixPipeline.renderSurface=e,this._pipeline=new bg.base.Pipeline(t),this._pipeline.textureEffect=new bg.render.PostprocessEffect(t)},draw:function(t,e){this._shadowMap.size.x!=this.settings.shadows.quality&&(this._shadowMap.size=new bg.Vector2(this.settings.shadows.quality));var i=e.viewport,n=this.settings.antialiasing||{},r=i.width,s=i.height;if(n.enabled){var a=n.maxTextureSize||4096,o=i.aspectRatio;r=2*i.width,s=2*i.height,o>1&&r>a?(r=a,s=a/o):s>a&&(s=a,r=a*o)}var c=new bg.Viewport(0,0,r,s);e.viewport=c;this._opaqueLayer.clearColor=this.clearColor,this._size.width==e.viewport.width&&this._size.height==e.viewport.height||(this._opaqueLayer.resize(e),this._transparentLayer.resize(e)),this._opaqueLayer.draw(t,e),this._transparentLayer.draw(t,e),bg.base.Pipeline.SetCurrent(this._mixPipeline),this._mixPipeline.viewport=e.viewport,this._mixPipeline.clearColor=bg.Color.Black(),this._mixPipeline.clearBuffers(),this._mixPipeline.drawTexture({opaque:this._opaqueLayer.texture,transparent:this._transparentLayer.texture,transparentNormal:this._transparentLayer.maps.normal,opaqueDepth:this._opaqueLayer.maps.position,transparentDepth:this._transparentLayer.maps.position}),bg.base.Pipeline.SetCurrent(this.pipeline),this.pipeline.viewport=i,this.pipeline.clearColor=this.clearColor,this.pipeline.clearBuffers(),this.pipeline.drawTexture({texture:this._mixPipeline.renderSurface.getTexture(0)}),e.viewport=i},getImage:function(t,e,i,n){var r=e.viewport;e.viewport=new bg.Viewport(0,0,i,n),this.draw(t,e);var s=document.createElement("canvas");s.width=i,s.height=n;for(var a=s.getContext("2d"),o=this.pipeline.renderSurface.readBuffer(new bg.Viewport(0,0,i,n)),c=a.createImageData(i,n),u=4*i,h=0;h<n;++h)for(var l=0;l<u;l+=4){var f=h*i*4,b=(n-h)*i*4;c.data[b+l+0]=o[f+l+0],c.data[b+l+1]=o[f+l+1],c.data[b+l+2]=o[f+l+2],c.data[b+l+3]=o[f+l+3]}a.putImageData(c,0,0);var g=s.toDataURL("image/jpeg");return e.viewport=r,this.viewport=r,this.draw(t,e),g}},{},t)}(bg.render.Renderer);bg.render.DeferredRenderer=t}(),function(){var t=function(t){function e(t,i){$traceurRuntime.superConstructor(e).call(this,t,i),this._pipeline.effect=new bg.base.ForwardEffect(t),this._pipeline.opacityLayer=i,this._lightComponent=null,this._lightComponents=[],i==bg.base.OpacityLayer.TRANSPARENT&&(this._pipeline.buffersToClear=bg.base.ClearBuffers.NONE,this._pipeline.blend=!0,this._pipeline.blendMode=bg.base.BlendMode.NORMAL)}return $traceurRuntime.createClass(e,{set lightComponent(t){this._lightComponent=t},get lightComponent(){return this._lightComponent},setLightSources:function(t){this._lightComponents=t},set shadowMap(t){this._shadowMap=t},get shadowMap(){return this._shadowMap},draw:function(t,e){bg.base.Pipeline.SetCurrent(this._pipeline),this._pipeline.viewport=e.viewport,0!=e.clearBuffers&&this._pipeline.clearBuffers(),this.matrixState.projectionMatrixStack.set(e.projection),this.matrixState.viewMatrixStack.set(e.viewMatrix),bg.base.Pipeline.SetCurrent(this._pipeline),this._pipeline.viewport=e.viewport,this.willDraw(t,e),this.performDraw(t,e)},willDraw:function(t,e){var i=this;this._lightComponent?(this._pipeline.effect.light=this._lightComponent.light,this._pipeline.effect.lightTransform=this._lightComponent.transform,this._pipeline.effect.shadowMap=this._shadowMap):this._lightComponents&&(this._pipeline.effect.lightArray.reset(),this._lightComponents.forEach(function(t){i._pipeline.effect.lightArray.push(t.light,t.transform)}),this._pipeline.effect.shadowMap=this._shadowMap)},performDraw:function(t,e){this._pipeline.viewport=e.viewport,t.accept(this.drawVisitor)}},{},t)}(bg.render.RenderLayer);bg.render.ForwardRenderLayer=t}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t)}return $traceurRuntime.createClass(e,{get isSupported(){return!0},create:function(){var t=this.context;this._transparentLayer=new bg.render.ForwardRenderLayer(t,bg.base.OpacityLayer.TRANSPARENT),this._opaqueLayer=new bg.render.ForwardRenderLayer(t,bg.base.OpacityLayer.OPAQUE),this._shadowMap=new bg.base.ShadowMap(t),this._shadowMap.size=new bg.Vector2(2048)},draw:function(t,e){var i=null,n=[];bg.scene.Light.GetActiveLights().some(function(t,e){if(e>=bg.base.MAX_FORWARD_LIGHTS)return!0;t.light&&t.light.enabled&&(n.push(t),t.light.type!=bg.base.LightType.POINT&&t.light.castShadows&&(i=t))}),i&&this._shadowMap.update(t,e,i.light,i.transform),n.length&&(this._opaqueLayer.setLightSources(n),this._opaqueLayer.shadowMap=this._shadowMap,this._transparentLayer.setLightSources(n),this._transparentLayer.shadowMap=this._shadowMap),this._opaqueLayer.pipeline.clearColor=this.clearColor,this._opaqueLayer.draw(t,e),this._transparentLayer.draw(t,e)},getImage:function(t,e,i,n){var r=e.viewport;e.viewport=new bg.Viewport(0,0,i,n),this.draw(t,e),this.draw(t,e);var s=document.createElement("canvas");s.width=i,s.height=n;for(var a=s.getContext("2d"),o=this._opaqueLayer.pipeline.renderSurface.readBuffer(new bg.Viewport(0,0,i,n)),c=a.createImageData(i,n),u=4*i,h=0;h<n;++h)for(var l=0;l<u;l+=4){var f=h*i*4,b=(n-h)*i*4;c.data[b+l+0]=o[f+l+0],c.data[b+l+1]=o[f+l+1],c.data[b+l+2]=o[f+l+2],c.data[b+l+3]=o[f+l+3]}a.putImageData(c,0,0);var g=s.toDataURL("image/jpeg");return e.viewport=r,this._opaqueLayer.viewport=r,this._transparentLayer.viewport=r,g}},{},t)}(bg.render.Renderer);bg.render.ForwardRenderer=t}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=null,i=null,n=null,r=null,s={gbuffer_ubyte_vertex:function(){return e||(e=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),e.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.normal,t().inputs.buffers.tangent,t().inputs.buffers.tex0,t().inputs.buffers.tex1]),e.addParameter(t().inputs.matrix.all),e.addParameter([{name:"fsPosition",dataType:"vec3",role:"out"},{name:"fsTex0Coord",dataType:"vec2",role:"out"},{name:"fsTex1Coord",dataType:"vec2",role:"out"},{name:"fsNormal",dataType:"vec3",role:"out"},{name:"fsTangent",dataType:"vec3",role:"out"},{name:"fsBitangent",dataType:"vec3",role:"out"}]),"webgl1"==bg.Engine.Get().id&&e.setMainBody("\n\t\t\t\t\tvec4 viewPos = inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t\tgl_Position = inProjectionMatrix * viewPos;\n\t\t\t\t\t\n\t\t\t\t\tfsNormal = normalize((inNormalMatrix  * vec4(inNormal,1.0)).xyz);\n\t\t\t\t\tfsTangent = normalize((inNormalMatrix * vec4(inTangent,1.0)).xyz);\n\t\t\t\t\tfsBitangent = cross(fsNormal,fsTangent);\n\t\t\t\t\t\n\t\t\t\t\tfsTex0Coord = inTex0;\n\t\t\t\t\tfsTex1Coord = inTex1;\n\t\t\t\t\tfsPosition = viewPos.xyz;")),e},gbuffer_ubyte_fragment:function(){return i||(i=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),i.appendHeader("#extension GL_EXT_draw_buffers : require"),i.addParameter([{name:"fsPosition",dataType:"vec3",role:"in"},{name:"fsTex0Coord",dataType:"vec2",role:"in"},{name:"fsTex1Coord",dataType:"vec2",role:"in"},{name:"fsNormal",dataType:"vec3",role:"in"},{name:"fsTangent",dataType:"vec3",role:"in"},{name:"fsBitangent",dataType:"vec3",role:"int"}]),i.addParameter(t().inputs.material.all),i.addFunction(t().functions.materials.all),"webgl1"==bg.Engine.Get().id&&i.setMainBody("\n\t\t\t\t\t\tvec4 lightMap = samplerColor(inLightMap,fsTex1Coord,inLightMapOffset,inLightMapScale);\n\t\t\t\t\t\tvec4 diffuse = samplerColor(inTexture,fsTex0Coord,inTextureOffset,inTextureScale) * inDiffuseColor * lightMap;\n\t\t\t\t\t\tif (diffuse.a>=inAlphaCutoff) {\n\t\t\t\t\t\t\tvec3 normal = samplerNormal(inNormalMap,fsTex0Coord,inNormalMapOffset,inNormalMapScale);\n\t\t\t\t\t\t\tnormal = combineNormalWithMap(fsNormal,fsTangent,fsBitangent,normal);\n\t\t\t\t\t\t\tvec4 specular = specularColor(inSpecularColor,inShininessMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinShininessMaskChannel,inShininessMaskInvert);\n\t\t\t\t\t\t\tfloat lightEmission = applyTextureMask(inLightEmission,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinLightEmissionMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinLightEmissionMaskChannel,inLightEmissionMaskInvert);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfloat reflectionMask = applyTextureMask(inReflection,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinReflectionMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinReflectionMaskChannel,inReflectionMaskInvert);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\tfloat roughnessMask = applyTextureMask(inRoughness,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinRoughnessMask,fsTex0Coord,inTextureOffset,inTextureScale,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tinRoughnessMaskChannel,inRoughnessMaskInvert);\n\n\t\t\t\t\t\t\tgl_FragData[0] = diffuse;\n\t\t\t\t\t\t\tgl_FragData[1] = vec4(specular.rgb,roughnessMask); // Store roughness on A component of specular\n\t\t\t\t\t\t\tgl_FragData[2] = vec4(normal * 0.5 + 0.5, inUnlit ? 0.0 : 1.0);\t// Store !unlit parameter on A component of normal\n\t\t\t\t\t\t\tgl_FragData[3] = vec4(lightEmission,inShininess/255.0,reflectionMask,float(inCastShadows));\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tdiscard;\n\t\t\t\t\t\t}")),i},gbuffer_float_vertex:function(){return n||(n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,null,t().inputs.matrix.model,t().inputs.matrix.view,t().inputs.matrix.projection,null,{name:"fsPosition",dataType:"vec4",role:"out"},{name:"fsTex0Coord",dataType:"vec2",role:"out"}]),"webgl1"==bg.Engine.Get().id&&n.setMainBody("\n\t\t\t\t\tfsPosition = inViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t\tfsTex0Coord = inTex0;\n\t\t\t\t\t\n\t\t\t\t\tgl_Position = inProjectionMatrix * fsPosition;")),n},gbuffer_float_fragment:function(){return r||(r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),r.addParameter([t().inputs.material.texture,t().inputs.material.textureScale,t().inputs.material.textureOffset,null,{name:"fsPosition",dataType:"vec4",role:"in"},{name:"fsTex0Coord",dataType:"vec2",role:"in"}]),r.addFunction(t().functions.materials.samplerColor),"webgl1"==bg.Engine.Get().id&&r.setMainBody("\n\t\t\t\t\tfloat alpha = samplerColor(inTexture,fsTex0Coord,inTextureOffset,inTextureScale).a;\n\t\t\t\t\t// TODO: texture alpha\n\t\t\t\t\t// if (a<alphaCutoff....etc)\n\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = vec4(fsPosition.xyz,gl_FragCoord.z);")),r}},a=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t);var i=[s.gbuffer_ubyte_vertex(),s.gbuffer_ubyte_fragment()];this._material=null,this.setupShaderSource(i)}return $traceurRuntime.createClass(e,{get material(){return this._material},set material(t){this._material=t},setupVars:function(){if(this.material){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst),this.shader.setMatrix4("inNormalMatrix",t.normalMatrix),this.shader.setMatrix4("inViewMatrixInv",t.viewMatrixInvert);var i=this.material.texture||bg.base.TextureCache.WhiteTexture(this.context),n=this.material.lightmap||bg.base.TextureCache.WhiteTexture(this.context),r=this.material.normalMap||bg.base.TextureCache.NormalTexture(this.context);this.shader.setVector4("inDiffuseColor",this.material.diffuse),this.shader.setVector4("inSpecularColor",this.material.specular),this.shader.setValueFloat("inShininess",this.material.shininess),this.shader.setValueFloat("inLightEmission",this.material.lightEmission),this.shader.setValueFloat("inAlphaCutoff",this.material.alphaCutoff),this.shader.setTexture("inTexture",i,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTextureOffset",this.material.textureOffset),this.shader.setVector2("inTextureScale",this.material.textureScale),this.shader.setTexture("inLightMap",n,bg.base.TextureUnit.TEXTURE_1),this.shader.setVector2("inLightMapOffset",this.material.lightmapOffset),this.shader.setVector2("inLightMapScale",this.material.lightmapScale),this.shader.setTexture("inNormalMap",r,bg.base.TextureUnit.TEXTURE_2),this.shader.setVector2("inNormalMapScale",this.material.normalMapScale),this.shader.setVector2("inNormalMapOffset",this.material.normalMapOffset);var s=this.material.shininessMask||bg.base.TextureCache.WhiteTexture(this.context),a=this.material.lightEmissionMask||bg.base.TextureCache.WhiteTexture(this.context),o=this.material.reflectionMask||bg.base.TextureCache.WhiteTexture(this.context),c=this.material.roughnessMask||bg.base.TextureCache.WhiteTexture(this.context);this.shader.setTexture("inShininessMask",s,bg.base.TextureUnit.TEXTURE_3),this.shader.setVector4("inShininessMaskChannel",this.material.shininessMaskChannelVector),this.shader.setValueInt("inShininessMaskInvert",this.material.shininessMaskInvert),this.shader.setTexture("inLightEmissionMask",a,bg.base.TextureUnit.TEXTURE_4),this.shader.setVector4("inLightEmissionMaskChannel",this.material.lightEmissionMaskChannelVector),this.shader.setValueInt("inLightEmissionMaskInvert",this.material.lightEmissionMaskInvert),this.shader.setValueFloat("inReflection",this.material.reflectionAmount),this.shader.setTexture("inReflectionMask",o,bg.base.TextureUnit.TEXTURE_5),this.shader.setVector4("inReflectionMaskChannel",this.material.reflectionMaskChannelVector),this.shader.setValueInt("inReflectionMaskInvert",this.material.reflectionMaskInvert),this.shader.setValueFloat("inRoughness",this.material.roughness),this.shader.setTexture("inRoughnessMask",c,bg.base.TextureUnit.TEXTURE_6),this.shader.setVector4("inRoughnessMaskChannel",this.material.roughnessMaskChannelVector),this.shader.setValueInt("inRoughnessMaskInvert",this.material.roughnessMaskInvert),this.shader.setValueInt("inCastShadows",this.material.castShadows),this.shader.setValueInt("inUnlit",this.material.unlit)}}},{},t)}(bg.base.Effect),o=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t);var i=[s.gbuffer_float_vertex(),s.gbuffer_float_fragment()];this._material=null,this.setupShaderSource(i)}return $traceurRuntime.createClass(e,{get material(){return this._material},set material(t){this._material=t},setupVars:function(){if(this.material){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst);var i=this.material.texture||bg.base.TextureCache.WhiteTexture(this.context);this.shader.setTexture("inTexture",i,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTextureOffset",this.material.textureOffset),this.shader.setVector2("inTextureScale",this.material.textureScale)}}},{},t)}(bg.base.Effect);bg.render.PositionGBufferEffect=o,bg.render.GBufferEffect=a}(),function(){function t(t,e,i,n){bg.base.Pipeline.SetCurrent(t),t.viewport=n.viewport,t.clearBuffers(bg.base.ClearBuffers.COLOR|bg.base.ClearBuffers.DEPTH),i.accept(e)}var e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t),this._pipelines={ubyte:new bg.base.Pipeline(t),float:new bg.base.Pipeline(t)};var e=new bg.base.TextureSurface(t);e.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.UNSIGNED_BYTE},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._pipelines.ubyte.effect=new bg.render.GBufferEffect(t),this._pipelines.ubyte.renderSurface=e;var n=new bg.base.TextureSurface(t);n.create([{type:bg.base.RenderSurfaceType.RGBA,format:bg.base.RenderSurfaceFormat.FLOAT},{type:bg.base.RenderSurfaceType.DEPTH,format:bg.base.RenderSurfaceFormat.RENDERBUFFER}]),this._pipelines.float.effect=new bg.render.PositionGBufferEffect(t),this._pipelines.float.renderSurface=n,this._ubyteDrawVisitor=new bg.scene.DrawVisitor(this._pipelines.ubyte,this._matrixState),this._floatDrawVisitor=new bg.scene.DrawVisitor(this._pipelines.float,this._matrixState)}return $traceurRuntime.createClass(i,{get diffuse(){return this._pipelines.ubyte.renderSurface.getTexture(0)},get specular(){return this._pipelines.ubyte.renderSurface.getTexture(1)},get normal(){return this._pipelines.ubyte.renderSurface.getTexture(2)},get material(){return this._pipelines.ubyte.renderSurface.getTexture(3)},get position(){return this._pipelines.float.renderSurface.getTexture(0)},get shadow(){return this._pipelines.ubyte.renderSurface.getTexture(4)},update:function(e,i){t(this._pipelines.ubyte,this._ubyteDrawVisitor,e,i),t(this._pipelines.float,this._floatDrawVisitor,e,i)}},{},e)}(bg.app.ContextObject);bg.render.GBufferSet=e}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter([{name:"inDiffuse",dataType:"sampler2D",role:"value"},{name:"inSpecular",dataType:"sampler2D",role:"value"},{name:"inNormal",dataType:"sampler2D",role:"value"},{name:"inMaterial",dataType:"sampler2D",role:"value"},{name:"inPosition",dataType:"sampler2D",role:"value"},{name:"inShadowMap",dataType:"sampler2D",role:"value"},{name:"inLightEmissionFactor",dataType:"float",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),this._fragmentShaderSource.addParameter(t().inputs.lighting.all),this._fragmentShaderSource.addFunction(t().functions.utils.all),this._fragmentShaderSource.addFunction(t().functions.lighting.all),"webgl1"==bg.Engine.Get().id&&this._fragmentShaderSource.setMainBody("\n\t\t\t\t\tvec4 diffuse = texture2D(inDiffuse,fsTexCoord);\n\t\t\t\t\tvec4 specular = vec4(texture2D(inSpecular,fsTexCoord).rgb,1.0);\n\t\t\t\t\tvec4 normalTex = texture2D(inNormal,fsTexCoord);\n\t\t\t\t\tvec3 normal = normalTex.xyz * 2.0 - 1.0;\n\t\t\t\t\tvec4 material = texture2D(inMaterial,fsTexCoord);\n\t\t\t\t\tvec4 position = texture2D(inPosition,fsTexCoord);\n\t\t\t\t\t\n\t\t\t\t\tvec4 shadowColor = texture2D(inShadowMap,fsTexCoord);\n\t\t\t\t\tfloat shininess = material.g * 255.0;\n\t\t\t\t\tfloat lightEmission = material.r;\n\t\t\t\t\tbool unlit = normalTex.a == 0.0;\n\t\t\t\t\tif (unlit) {\n\t\t\t\t\t\tgl_FragColor = vec4(diffuse.rgb * min(inLightEmissionFactor,1.0),1.0);\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tvec4 light = getLight(\n\t\t\t\t\t\t\tinLightType,\n\t\t\t\t\t\t\tinLightAmbient, inLightDiffuse, inLightSpecular,shininess,\n\t\t\t\t\t\t\tinLightPosition,inLightDirection,\n\t\t\t\t\t\t\tinLightAttenuation.x,inLightAttenuation.y,inLightAttenuation.z,\n\t\t\t\t\t\t\tinSpotCutoff,inSpotExponent,inLightCutoffDistance,\n\t\t\t\t\t\t\tposition.rgb,normal,\n\t\t\t\t\t\t\tdiffuse,specular,shadowColor\n\t\t\t\t\t\t);\n\t\t\t\t\t\tlight.rgb = light.rgb + (lightEmission * diffuse.rgb * inLightEmissionFactor);\n\t\t\t\t\t\tgl_FragColor = light;\n\t\t\t\t\t}\n\t\t\t\t\t")),this._fragmentShaderSource},setupVars:function(){if(this.shader.setTexture("inDiffuse",this._surface.diffuse,bg.base.TextureUnit.TEXTURE_0),this.shader.setTexture("inSpecular",this._surface.specular,bg.base.TextureUnit.TEXTURE_1),this.shader.setTexture("inNormal",this._surface.normal,bg.base.TextureUnit.TEXTURE_2),this.shader.setTexture("inMaterial",this._surface.material,bg.base.TextureUnit.TEXTURE_3),this.shader.setTexture("inPosition",this._surface.position,bg.base.TextureUnit.TEXTURE_4),this.shader.setTexture("inShadowMap",this._shadowMap,bg.base.TextureUnit.TEXTURE_5),this.light){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setVector4("inLightAmbient",this._light.ambient),this.shader.setVector4("inLightDiffuse",this._light.diffuse),this.shader.setVector4("inLightSpecular",this._light.specular),this.shader.setValueInt("inLightType",this._light.type),this.shader.setVector3("inLightAttenuation",this._light.attenuationVector),this.shader.setValueFloat("inLightEmissionFactor",this.lightEmissionFactor),this.shader.setValueFloat("inLightCutoffDistance",this._light.cutoffDistance);var i=e.mult(this._lightTransform).rotation.multVector(this._light.direction).xyz,n=e.position;this.shader.setVector3("inLightDirection",i),this.shader.setVector3("inLightPosition",n),this.shader.setValueFloat("inSpotCutoff",this._light.spotCutoff),this.shader.setValueFloat("inSpotExponent",this._light.spotExponent)}},get lightEmissionFactor(){return this._lightEmissionFactor},set lightEmissionFactor(t){this._lightEmissionFactor=t},get light(){return this._light},set light(t){this._light=t},get lightTransform(){return this._lightTransform},set lightTransform(t){this._lightTransform=t},get shadowMap(){return this._shadowMap},set shadowMap(t){this._shadowMap=t}},{},e)}(bg.base.TextureEffect);bg.render.LightingEffect=e}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter([{name:"inTexture",dataType:"sampler2D",role:"value"},{name:"inFrameSize",dataType:"vec2",role:"value"},{name:"inBorderAntiAlias",dataType:"int",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&(this._fragmentShaderSource.addFunction(t().functions.utils.texOffset),this._fragmentShaderSource.addFunction(t().functions.utils.luminance),this._fragmentShaderSource.addFunction(t().functions.utils.borderDetection),this._fragmentShaderSource.addFunction(t().functions.blur.textureDownsample),this._fragmentShaderSource.addFunction(t().functions.blur.gaussianBlur),this._fragmentShaderSource.addFunction(t().functions.blur.antiAlias),this._fragmentShaderSource.setMainBody("\n\t\t\t\t\t\tvec4 result = vec4(0.0,0.0,0.0,1.0);\n\t\t\t\t\t\tif (inBorderAntiAlias==1) {\n\t\t\t\t\t\t\tresult = antiAlias(inTexture,fsTexCoord,inFrameSize,0.1,3);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tresult = texture2D(inTexture,fsTexCoord);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tgl_FragColor = result;\n\t\t\t\t\t\t"))),this._fragmentShaderSource},setupVars:function(){this.shader.setTexture("inTexture",this._surface.texture,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inFrameSize",this._surface.texture.size),this.shader.setValueInt("inBorderAntiAlias",0)},get settings(){return this._settings||(this._currentKernelSize=0,this._settings={refractionAmount:.01}),this._settings}},{},e)}(bg.base.TextureEffect);bg.render.PostprocessEffect=e}(),function(){var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t)}return $traceurRuntime.createClass(e,{get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter([{name:"inOpaque",dataType:"sampler2D",role:"value"},{name:"inTransparent",dataType:"sampler2D",role:"value"},{name:"inTransparentNormal",dataType:"sampler2D",role:"value"},{name:"inOpaqueDepth",dataType:"sampler2D",role:"value"},{name:"inTransparentDepth",dataType:"sampler2D",role:"value"},{name:"inRefractionAmount",dataType:"float",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&this._fragmentShaderSource.setMainBody("\n\t\t\t\t\t\tvec4 opaque = texture2D(inOpaque,fsTexCoord);\n\t\t\t\t\t\tvec4 transparent = texture2D(inTransparent,fsTexCoord);\n\t\t\t\t\t\tvec3 normal = texture2D(inTransparentNormal,fsTexCoord).rgb * 2.0 - 1.0;\n\t\t\t\t\t\tif (transparent.a>0.0) {\n\t\t\t\t\t\t\tfloat refractionFactor = inRefractionAmount / texture2D(inTransparentDepth,fsTexCoord).z;\n\t\t\t\t\t\t\tvec2 offset = fsTexCoord - normal.xy * refractionFactor;\n\t\t\t\t\t\t\tvec4 opaqueDepth = texture2D(inOpaqueDepth,offset);\n\t\t\t\t\t\t\tvec4 transparentDepth = texture2D(inTransparentDepth,offset);\n\t\t\t\t\t\t\t//if (opaqueDepth.w>transparentDepth.w) {\n\t\t\t\t\t\t\t\topaque = texture2D(inOpaque,offset);\n\t\t\t\t\t\t\t//}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tvec3 color = opaque.rgb * (1.0 - transparent.a) + transparent.rgb * transparent.a;\n\t\t\t\t\t\tgl_FragColor = vec4(color, 1.0);\n\t\t\t\t\t\t")),this._fragmentShaderSource},setupVars:function(){this.shader.setTexture("inOpaque",this._surface.opaque,bg.base.TextureUnit.TEXTURE_0),this.shader.setTexture("inTransparent",this._surface.transparent,bg.base.TextureUnit.TEXTURE_1),this.shader.setTexture("inTransparentNormal",this._surface.transparentNormal,bg.base.TextureUnit.TEXTURE_2),this.shader.setTexture("inOpaqueDepth",this._surface.opaqueDepth,bg.base.TextureUnit.TEXTURE_3),this.shader.setTexture("inTransparentDepth",this._surface.transparentDepth,bg.base.TextureUnit.TEXTURE_4),this.shader.setValueFloat("inRefractionAmount",this.settings.refractionAmount)},get settings(){return this._settings||(this._currentKernelSize=0,this._settings={refractionAmount:-.05}),this._settings}},{},t)}(bg.base.TextureEffect);bg.render.RendererMixEffect=t}(),function(){function t(){return bg.base.ShaderLibrary.Get()}var e=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e);var n=new bg.base.ShaderSource(bg.base.ShaderType.VERTEX),r=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT);n.addParameter([t().inputs.buffers.vertex,t().inputs.buffers.tex0,null,t().inputs.matrix.model,t().inputs.matrix.view,t().inputs.matrix.projection,{name:"inLightProjectionMatrix",dataType:"mat4",role:"value"},{name:"inLightViewMatrix",dataType:"mat4",role:"value"},null,{name:"fsTexCoord",dataType:"vec2",role:"out"},{name:"fsVertexPosFromLight",dataType:"vec4",role:"out"}]),r.addParameter(t().inputs.shadows.all),r.addFunction(t().functions.utils.unpack),r.addFunction(t().functions.lighting.getShadowColor),r.addParameter([t().inputs.material.receiveShadows,t().inputs.material.texture,t().inputs.material.textureOffset,t().inputs.material.textureScale,t().inputs.material.alphaCutoff,null,{name:"fsTexCoord",dataType:"vec2",role:"in"},{name:"fsVertexPosFromLight",dataType:"vec4",role:"in"}]),r.addFunction(t().functions.materials.samplerColor),"webgl1"==bg.Engine.Get().id&&(n.setMainBody("\n\t\t\t\t\tmat4 ScaleMatrix = mat4(0.5, 0.0, 0.0, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.0, 0.5, 0.0, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.0, 0.0, 0.5, 0.0,\n\t\t\t\t\t\t\t\t\t\t\t0.5, 0.5, 0.5, 1.0);\n\t\t\t\t\t\n\t\t\t\t\tfsVertexPosFromLight = ScaleMatrix * inLightProjectionMatrix * inLightViewMatrix * inModelMatrix * vec4(inVertex,1.0);\n\t\t\t\t\tfsTexCoord = inTex0;\n\t\t\t\t\t\n\t\t\t\t\tgl_Position = inProjectionMatrix * inViewMatrix * inModelMatrix * vec4(inVertex,1.0);"),r.setMainBody("\n\t\t\t\t\tfloat alpha = samplerColor(inTexture,fsTexCoord,inTextureOffset,inTextureScale).a;\n\t\t\t\t\tif (alpha>inAlphaCutoff) {\n\t\t\t\t\t\tvec4 shadowColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\t\t\t\t\tif (inReceiveShadows) {\n\t\t\t\t\t\t\tshadowColor = getShadowColor(fsVertexPosFromLight,inShadowMap,inShadowMapSize,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t inShadowType,inShadowStrength,inShadowBias,inShadowColor);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tgl_FragColor = shadowColor;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tdiscard;\n\t\t\t\t\t}")),this.setupShaderSource([n,r])}return $traceurRuntime.createClass(i,{beginDraw:function(){if(this.light&&this.shadowMap){var t=bg.base.MatrixState.Current(),e=(new bg.Matrix4(t.viewMatrixStack.matrixConst),this.shadowMap.viewMatrix);this.shader.setMatrix4("inLightProjectionMatrix",this.shadowMap.projection),this.shader.setMatrix4("inLightViewMatrix",e),this.shader.setValueInt("inShadowType",this.shadowMap.shadowType),this.shader.setTexture("inShadowMap",this.shadowMap.texture,bg.base.TextureUnit.TEXTURE_1),this.shader.setVector2("inShadowMapSize",this.shadowMap.size),this.shader.setValueFloat("inShadowStrength",this.light.shadowStrength),this.shader.setVector4("inShadowColor",this.shadowMap.shadowColor),this.shader.setValueFloat("inShadowBias",this.light.shadowBias)}},setupVars:function(){if(this.material&&this.light){var t=bg.base.MatrixState.Current(),e=new bg.Matrix4(t.viewMatrixStack.matrixConst);this.shader.setMatrix4("inModelMatrix",t.modelMatrixStack.matrixConst),this.shader.setMatrix4("inViewMatrix",e),this.shader.setMatrix4("inProjectionMatrix",t.projectionMatrixStack.matrixConst);var i=this.material.texture||bg.base.TextureCache.WhiteTexture(this.context);this.shader.setTexture("inTexture",i,bg.base.TextureUnit.TEXTURE_0),this.shader.setVector2("inTextureOffset",this.material.textureOffset),this.shader.setVector2("inTextureScale",this.material.textureScale),this.shader.setValueFloat("inAlphaCutoff",this.material.alphaCutoff),this.shader.setValueInt("inReceiveShadows",this.material.receiveShadows)}},get material(){return this._material},set material(t){this._material=t},get light(){return this._light},set light(t){this._light=t},get shadowMap(){return this._shadowMap},set shadowMap(t){this._shadowMap=t}},{},e)}(bg.base.Effect);bg.render.ShadowEffect=e}(),function(){var t=64,e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{get fragmentShaderSource(){return this._fragmentShaderSource||(this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT),this._fragmentShaderSource.addParameter([{name:"inViewportSize",dataType:"vec2",role:"value"},{name:"inPositionMap",dataType:"sampler2D",role:"value"},{name:"inNormalMap",dataType:"sampler2D",role:"value"},{name:"inProjectionMatrix",dataType:"mat4",role:"value"},{name:"inRandomMap",dataType:"sampler2D",role:"value"},{name:"inRandomMapSize",dataType:"vec2",role:"value"},{name:"inSampleRadius",dataType:"float",role:"value"},{name:"inKernelOffsets",dataType:"vec3",role:"value",vec:t},{name:"inKernelSize",dataType:"int",role:"value"},{name:"inSSAOColor",dataType:"vec4",role:"value"},{name:"inEnabled",dataType:"bool",role:"value"},{name:"inMaxDistance",dataType:"float",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),
"webgl1"==bg.Engine.Get().id&&this._fragmentShaderSource.setMainBody("\n\t\t\t\t\tif (!inEnabled) discard;\n\t\t\t\t\telse {\n\t\t\t\t\t\tvec4 normalTex = texture2D(inNormalMap,fsTexCoord);\n\t\t\t\t\t\tvec3 normal = normalTex.xyz * 2.0 - 1.0;\n\t\t\t\t\t\tvec4 vertexPos = texture2D(inPositionMap,fsTexCoord);\n\t\t\t\t\t\tif (distance(vertexPos.xyz,vec3(0))>inMaxDistance || vertexPos.w==1.0 || normalTex.a==0.0) {\n\t\t\t\t\t\t\tdiscard;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tvec2 noiseScale = vec2(inViewportSize.x/inRandomMapSize.x,inViewportSize.y/inRandomMapSize.y);\n\t\t\t\t\t\t\tvec3 randomVector = texture2D(inRandomMap, fsTexCoord * noiseScale).xyz * 2.0 - 1.0;\n\t\t\t\t\t\t\tvec3 tangent = normalize(randomVector - normal * dot(randomVector, normal));\n\t\t\t\t\t\t\tvec3 bitangent = cross(normal,tangent);\n\t\t\t\t\t\t\tmat3 tbn = mat3(tangent, bitangent, normal);\n\n\t\t\t\t\t\t\tfloat occlusion = 0.0;\n\t\t\t\t\t\t\tfor (int i=0; i<"+t+"; ++i) {\n\t\t\t\t\t\t\t\tif (inKernelSize==i) break;\n\t\t\t\t\t\t\t\tvec3 samplePos = tbn * inKernelOffsets[i];\n\t\t\t\t\t\t\t\tsamplePos = samplePos * inSampleRadius + vertexPos.xyz;\n\n\t\t\t\t\t\t\t\tvec4 offset = inProjectionMatrix * vec4(samplePos, 1.0);\t// -w, w\n\t\t\t\t\t\t\t\toffset.xyz /= offset.w;\t// -1, 1\n\t\t\t\t\t\t\t\toffset.xyz = offset.xyz * 0.5 + 0.5;\t// 0, 1\n\n\t\t\t\t\t\t\t\tvec4 sampleRealPos = texture2D(inPositionMap, offset.xy);\n\t\t\t\t\t\t\t\tif (samplePos.z<sampleRealPos.z) {\n\t\t\t\t\t\t\t\t\tfloat dist = distance(vertexPos.xyz, sampleRealPos.xyz);\n\t\t\t\t\t\t\t\t\tocclusion += dist<inSampleRadius ? 1.0:0.0;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tocclusion = 1.0 - (occlusion / float(inKernelSize));\n\t\t\t\t\t\t\tgl_FragColor = clamp(vec4(occlusion, occlusion, occlusion, 1.0) + inSSAOColor, 0.0, 1.0);\n\t\t\t\t\t\t\t//gl_FragColor = vec4(1.0, 0.0, 0.0 ,1.0);\n\t\t\t\t\t\t}\n\t\t\t\t\t}")),this._fragmentShaderSource},setupVars:function(){this.settings.kernelSize>t&&(this.settings.kernelSize=t),this.shader.setVector2("inViewportSize",new bg.Vector2(this.viewport.width,this.viewport.height)),this.shader.setTexture("inPositionMap",this._surface.position,bg.base.TextureUnit.TEXTURE_0),this.shader.setTexture("inNormalMap",this._surface.normal,bg.base.TextureUnit.TEXTURE_1),this.shader.setMatrix4("inProjectionMatrix",this.projectionMatrix),this.shader.setTexture("inRandomMap",this.randomMap,bg.base.TextureUnit.TEXTURE_2),this.shader.setVector2("inRandomMapSize",this.randomMap.size),this.shader.setValueFloat("inSampleRadius",this.settings.sampleRadius),this.shader.setVector3Ptr("inKernelOffsets",this.kernelOffsets),this.shader.setValueInt("inKernelSize",this.settings.kernelSize),this.shader.setVector4("inSSAOColor",this.settings.color),this.shader.setValueInt("inEnabled",this.settings.enabled),this.shader.setValueFloat("inMaxDistance",this.settings.maxDistance)},get viewport(){return this._viewport},set viewport(t){this._viewport=t},get projectionMatrix(){return this._projectionMatrix},set projectionMatrix(t){this._projectionMatrix=t},get randomMap(){return this._randomMap||(this._randomMap=bg.base.TextureCache.RandomTexture(this.context)),this._randomMap},set randomMap(t){this._randomMap=t},get settings(){return this._settings||(this._currentKernelSize=0,this._settings={kernelSize:32,sampleRadius:.3,color:bg.Color.Black(),blur:4,maxDistance:100,enabled:!0}),this._settings},get kernelOffsets(){if(this._currentKernelSize!=this.settings.kernelSize){this._kernelOffsets=[];for(var t=0;t<3*this.settings.kernelSize;t+=3){var e=new bg.Vector3(2*bg.Math.random()-1,2*bg.Math.random()-1,bg.Math.random());e.normalize();var i=t/3/this.settings.kernelSize;i=bg.Math.lerp(.1,1,i*i),e.scale(i),this._kernelOffsets.push(e.x),this._kernelOffsets.push(e.y),this._kernelOffsets.push(e.z)}this._currentKernelSize=this.settings.kernelSize}return this._kernelOffsets}},{},e)}(bg.base.TextureEffect);bg.render.SSAOEffect=e}(),function(){bg.render.RaytracerQuality={low:{maxSamples:20,rayIncrement:.05},mid:{maxSamples:50,rayIncrement:.025},high:{maxSamples:100,rayIncrement:.0125},extreme:{maxSamples:200,rayIncrement:.0062}};var t=function(t){function e(t){$traceurRuntime.superConstructor(e).call(this,t),this._basic=!1}return $traceurRuntime.createClass(e,{get fragmentShaderSource(){if(!this._fragmentShaderSource){this._fragmentShaderSource=new bg.base.ShaderSource(bg.base.ShaderType.FRAGMENT);var t=this.quality;this._fragmentShaderSource.addParameter([{name:"inPositionMap",dataType:"sampler2D",role:"value"},{name:"inNormalMap",dataType:"sampler2D",role:"value"},{name:"inLightingMap",dataType:"sampler2D",role:"value"},{name:"inMaterialMap",dataType:"sampler2D",role:"value"},{name:"inSamplePosMap",dataType:"sampler2D",role:"value"},{name:"inProjectionMatrix",dataType:"mat4",role:"value"},{name:"inCameraPos",dataType:"vec3",role:"value"},{name:"inRayFailColor",dataType:"vec4",role:"value"},{name:"inBasicMode",dataType:"bool",role:"value"},{name:"inCubeMap",dataType:"samplerCube",role:"value"},{name:"fsTexCoord",dataType:"vec2",role:"in"}]),"webgl1"==bg.Engine.Get().id&&this._fragmentShaderSource.setMainBody("\n\t\t\t\t\t\tvec3 normal = texture2D(inNormalMap,fsTexCoord).xyz * 2.0 - 1.0;\n\t\t\t\t\t\tvec4 vertexPos = texture2D(inPositionMap,fsTexCoord);\n\t\t\t\t\t\tvec3 cameraVector = vertexPos.xyz - inCameraPos;\n\t\t\t\t\t\tvec3 rayDirection = reflect(cameraVector,normal);\n\t\t\t\t\t\tvec4 lighting = texture2D(inLightingMap,fsTexCoord);\n\t\t\t\t\t\tvec4 material = texture2D(inMaterialMap,fsTexCoord);\n\t\t\t\t\t\tvec4 rayFailColor = inRayFailColor;\n\n\t\t\t\t\t\tvec3 lookup = reflect(cameraVector,normal);\n\t\t\t\t\t\trayFailColor = textureCube(inCubeMap, lookup);\n\t\t\t\t\t\t\n\t\t\t\t\t\tfloat increment = "+t.rayIncrement+";\n\t\t\t\t\t\tvec4 result = rayFailColor;\n\t\t\t\t\t\tif (!inBasicMode && material.b>0.0) {\t// material[2] is reflectionAmount\n\t\t\t\t\t\t\tresult = rayFailColor;\n\t\t\t\t\t\t\tfor (float i=0.0; i<"+t.maxSamples+".0; ++i) {\n\t\t\t\t\t\t\t\tif (i=="+t.maxSamples+".0) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tfloat radius = i * increment;\n\t\t\t\t\t\t\t\tincrement *= 1.01;\n\t\t\t\t\t\t\t\tvec3 ray = vertexPos.xyz + rayDirection * radius;\n\n\t\t\t\t\t\t\t\tvec4 offset = inProjectionMatrix * vec4(ray, 1.0);\t// -w, w\n\t\t\t\t\t\t\t\toffset.xyz /= offset.w;\t// -1, 1\n\t\t\t\t\t\t\t\toffset.xyz = offset.xyz * 0.5 + 0.5;\t// 0, 1\n\n\t\t\t\t\t\t\t\tvec4 rayActualPos = texture2D(inSamplePosMap, offset.xy);\n\t\t\t\t\t\t\t\tfloat hitDistance = rayActualPos.z - ray.z;\n\t\t\t\t\t\t\t\t//if (rayActualPos.w<0.6) {\n\t\t\t\t\t\t\t\t//\tresult = rayFailColor;\n\t\t\t\t\t\t\t\t//\tbreak;\n\t\t\t\t\t\t\t\t//}\n\t\t\t\t\t\t\t\tif (offset.x>1.0 || offset.y>1.0 || offset.x<0.0 || offset.y<0.0) {\n\t\t\t\t\t\t\t\t\tresult = rayFailColor;\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse if (hitDistance>0.02 && hitDistance<0.15) {\n\t\t\t\t\t\t\t\t\tresult = texture2D(inLightingMap,offset.xy);\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (result.a==0.0) {\n\t\t\t\t\t\t\tgl_FragColor = rayFailColor;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tgl_FragColor = result;\n\t\t\t\t\t\t}")}return this._fragmentShaderSource},setupVars:function(){this.shader.setTexture("inPositionMap",this._surface.position,bg.base.TextureUnit.TEXTURE_0),this.shader.setTexture("inNormalMap",this._surface.normal,bg.base.TextureUnit.TEXTURE_1),this.shader.setTexture("inLightingMap",this._surface.reflectionColor,bg.base.TextureUnit.TEXTURE_2),this.shader.setTexture("inMaterialMap",this._surface.material,bg.base.TextureUnit.TEXTURE_3),this.shader.setTexture("inSamplePosMap",this._surface.reflectionDepth,bg.base.TextureUnit.TEXTURE_4),this.shader.setMatrix4("inProjectionMatrix",this._projectionMatrix),this.shader.setVector3("inCameraPos",this._cameraPos),this.shader.setVector4("inRayFailColor",this.rayFailColor),this.shader.setValueInt("inBasicMode",this.basic),this.shader.setTexture("inCubeMap",bg.scene.Cubemap.Current(this.context),bg.base.TextureUnit.TEXTURE_5)},get projectionMatrix(){return this._projectionMatrix},set projectionMatrix(t){this._projectionMatrix=t},get cameraPosition(){return this._cameraPos},set cameraPosition(t){this._cameraPos=t},get rayFailColor(){return this._rayFailColor||bg.Color.Black()},set rayFailColor(t){this._rayFailColor=t},get quality(){return this._quality||bg.render.RaytracerQuality.low},set quality(t){this._quality&&this._quality.maxSamples==t.maxSamples&&this._quality.rayIncrement==t.rayIncrement||(this._quality=t,this._fragmentShaderSource=null,this.rebuildShaders())},get basic(){return this._basic},set basic(t){this._basic=t},get settings(){return this._settings,this._settings}},{},t)}(bg.base.TextureEffect);bg.render.SSRTEffect=t}(),bg.webgl1={},function(){var t="webgl1";bg.webgl1.EngineId=t;var e=function(e){function i(e){$traceurRuntime.superConstructor(i).call(this,e),bg.webgl1.Extensions.Get(e),this._engineId=t,this._texture=new bg.webgl1.TextureImpl(e),this._pipeline=new bg.webgl1.PipelineImpl(e),this._polyList=new bg.webgl1.PolyListImpl(e),this._shader=new bg.webgl1.ShaderImpl(e),this._colorBuffer=new bg.webgl1.ColorRenderSurfaceImpl(e),this._textureBuffer=new bg.webgl1.TextureRenderSurfaceImpl(e),this._shaderSource=new bg.webgl1.ShaderSourceImpl}return $traceurRuntime.createClass(i,{},{},e)}(bg.Engine);bg.webgl1.Engine=e}(),function(){bg.webgl1.shaderLibrary={inputs:{},functions:{}};var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{header:function(t){return"precision highp float;\nprecision highp int;"},parameter:function(t,e){if(!e)return"\n";var i="";switch(e.role){case"buffer":i="attribute";break;case"value":i="uniform";break;case"in":case"out":i="varying"}var n="";return e.vec&&(n="["+e.vec+"]"),i+" "+e.dataType+" "+e.name+n+";"},func:function(t,e){if(!e)return"\n";var i="";for(var n in e.params)i+=e.params[n]+" "+n+",";return(e.returnType+" "+e.name+"("+i+") {").replace(",)",")")+("\n"+bg.base.ShaderSource.FormatSource(e.body)).replace(/\n/g,"\n\t")+"\n}"}},{},t)}(bg.base.ShaderSourceImpl);bg.webgl1.ShaderSourceImpl=t}(),function(){var t=null,e=function(e){function i(t){$traceurRuntime.superConstructor(i).call(this,t)}return $traceurRuntime.createClass(i,{getExtension:function(t){return this.context.getExtension(t)},get textureFloat(){return void 0===this._textureFloat&&(this._textureFloat=this.getExtension("OES_texture_float")),this._textureFloat},get depthTexture(){return void 0===this._depthTexture&&(this._depthTexture=this.getExtension("WEBGL_depth_texture")),this._depthTexture},get drawBuffers(){return void 0===this._drawBuffers&&(this._drawBuffers=this.getExtension("WEBGL_draw_buffers")),this._drawBuffers}},{Get:function(e){return t||(t=new i(e)),t}},e)}(bg.app.ContextObject);bg.webgl1.Extensions=e}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{initFlags:function(t){bg.base.ClearBuffers.COLOR=t.COLOR_BUFFER_BIT,bg.base.ClearBuffers.DEPTH=t.DEPTH_BUFFER_BIT},setViewport:function(t,e){t.viewport(e.x,e.y,e.width,e.height)},clearBuffers:function(t,e,i){t.clearColor(e.r,e.g,e.b,e.a),t.clear(i)},setDepthTestEnabled:function(t,e){e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST)},setCullFace:function(t,e){e?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE)},setBlendEnabled:function(t,e){e?t.enable(t.BLEND):t.disable(t.BLEND)},setBlendMode:function(t,e){switch(e){case bg.base.BlendMode.NORMAL:t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),t.blendEquation(t.FUNC_ADD);break;case bg.base.BlendMode.MULTIPLY:t.blendFunc(t.ZERO,t.SRC_COLOR),t.blendEquation(t.FUNC_ADD);break;case bg.base.BlendMode.ADD:t.blendFunc(t.ONE,t.ONE),t.blendEquation(t.FUNC_ADD);break;case bg.base.BlendMode.SUBTRACT:t.blendFunc(t.ONE,t.ONE),t.blendEquation(t.FUNC_SUBTRACT);break;case bg.base.BlendMode.ALPHA_ADD:t.blendFunc(t.SRC_ALPHA,t.SRC_ALPHA),t.blendEquation(t.FUNC_ADD);break;case bg.base.BlendMode.ALPHA_SUBTRACT:t.blendFunc(t.SRC_ALPHA,t.SRC_ALPHA),t.blendEquation(t.FUNC_SUBTRACT)}}},{},t)}(bg.base.PipelineImpl);bg.webgl1.PipelineImpl=t}(),function(){function t(t,e,i,n){var r=null;return e.length&&(r=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),n),r.itemSize=i,r.numItems=e.length/i),r}function e(t,e){return e&&t.deleteBuffer(e),null}var i=!1,n=function(n){function r(){$traceurRuntime.superConstructor(r).apply(this,arguments)}return $traceurRuntime.createClass(r,{initFlags:function(t){bg.base.DrawMode.TRIANGLES=t.TRIANGLES,bg.base.DrawMode.TRIANGLE_FAN=t.TRIANGLE_FAN,bg.base.DrawMode.TRIANGLE_STRIP=t.TRIANGLE_STRIP,bg.base.DrawMode.LINES=t.LINES,bg.base.DrawMode.LINE_STRIP=t.LINE_STRIP,i=t.getExtension("OES_element_index_uint")},create:function(t){return{vertexBuffer:null,normalBuffer:null,tex0Buffer:null,tex1Buffer:null,tex2Buffer:null,colorBuffer:null,tangentBuffer:null,indexBuffer:null}},build:function(e,n,r,s,a,o,c,u,h,l){return n.vertexBuffer=t(e,r,3,e.STATIC_DRAW),n.normalBuffer=t(e,s,3,e.STATIC_DRAW),n.tex0Buffer=t(e,a,2,e.STATIC_DRAW),n.tex1Buffer=t(e,o,2,e.STATIC_DRAW),n.tex2Buffer=t(e,c,2,e.STATIC_DRAW),n.colorBuffer=t(e,u,4,e.STATIC_DRAW),n.tangentBuffer=t(e,h,3,e.STATIC_DRAW),l.length>0&&i?(n.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint32Array(l),e.STATIC_DRAW),n.indexBuffer.itemSize=3,n.indexBuffer.numItems=l.length):(n.indexBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.indexBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),e.STATIC_DRAW),n.indexBuffer.itemSize=3,n.indexBuffer.numItems=l.length),n.vertexBuffer&&n.indexBuffer},draw:function(t,e,n,r){t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.indexBuffer),i?t.drawElements(n,r,t.UNSIGNED_INT,0):t.drawElements(n,r,t.UNSIGNED_SHORT,0)},destroy:function(t,i){t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null),i.vertexBuffer=e(t,i.vertexBuffer),i.normalBuffer=e(t,i.normalBuffer),i.tex0Buffer=e(t,i.tex0Buffer),i.tex1Buffer=e(t,i.tex1Buffer),i.tex2Buffer=e(t,i.tex2Buffer),i.colorBuffer=e(t,i.colorBuffer),i.tangentBuffer=e(t,i.tangentBuffer),i.indexBuffer=e(t,i.indexBuffer)},update:function(t,e,n,r){if(n==bg.base.BufferType.INDEX)i?(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint32Array(index),t.STATIC_DRAW)):(t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(index),t.STATIC_DRAW)),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null);else{switch(n){case bg.base.BufferType.VERTEX:t.bindBuffer(t.ARRAY_BUFFER,e.vertexBuffer);break;case bg.base.BufferType.NORMAL:t.bindBuffer(t.ARRAY_BUFFER,e.normalBuffer);break;case bg.base.BufferType.TEX_COORD_0:t.bindBuffer(t.ARRAY_BUFFER,e.tex0Buffer);break;case bg.base.BufferType.TEX_COORD_1:t.bindBuffer(t.ARRAY_BUFFER,e.tex1Buffer);break;case bg.base.BufferType.TEX_COORD_2:t.bindBuffer(t.ARRAY_BUFFER,e.tex2Buffer);break;case bg.base.BufferType.COLOR:t.bindBuffer(t.ARRAY_BUFFER,e.colorBuffer);break;case bg.base.BufferType.TANGENT:t.bindBuffer(t.ARRAY_BUFFER,e.tangentBuffer)}t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null)}}},{},n)}(bg.base.PolyListImpl);bg.webgl1.PolyListImpl=n}(),function(){function t(){return o.drawBuffers?o.drawBuffers.MAX_COLOR_ATTACHMENTS||o.drawBuffers.MAX_COLOR_ATTACHMENTS_WEBGL:1}function e(t){switch(!0){case t.type==bg.base.RenderSurfaceType.RGBA&&t.format==bg.base.RenderSurfaceFormat.UNSIGNED_BYTE:case t.type==bg.base.RenderSurfaceType.RGBA&&t.format==bg.base.RenderSurfaceFormat.FLOAT:case t.type==bg.base.RenderSurfaceType.DEPTH&&t.format==bg.base.RenderSurfaceFormat.RENDERBUFFER:case t.type==bg.base.RenderSurfaceType.DEPTH&&t.format==bg.base.RenderSurfaceFormat.UNSIGNED_SHORT:return!0;default:return!1}}function i(t){switch(t){case bg.base.RenderSurfaceType.RGBA:return"RGBA";case bg.base.RenderSurfaceType.DEPTH:return"DEPTH";default:return"unknown"}}function n(t){switch(t){case bg.base.RenderSurfaceFormat.UNSIGNED_BYTE:return"UNSIGNED_BYTE";case bg.base.RenderSurfaceFormat.FLOAT:return"FLOAT";case bg.base.RenderSurfaceFormat.RENDERBUFFER:return"RENDERBUFFER";case bg.base.RenderSurfaceFormat.UNSIGNED_SHORT:return"UNSIGNED_SHORT";default:return"unknown"}}function r(r){var s=0,a=t(),c=null;return r.every(function(t,u){return e(t)?t.type==bg.base.RenderSurfaceType.DEPTH&&u!=r.length-1?(c="Error in attachment "+u+": Depth attachment must be specified as the last attachment. Specified at index "+u+" of "+(r.length-1),!1):(t.type==bg.base.RenderSurfaceType.RGBA&&++s,t.format!=bg.base.RenderSurfaceFormat.FLOAT||o.textureFloat?t.type!=bg.base.RenderSurfaceType.DEPTH||t.format==bg.base.RenderSurfaceFormat.RENDERBUFFER||o.depthTexture?!(s>a)||(c="Error in attachment "+u+": Maximum number of "+a+" color attachment exceeded.",!1):(c="Error in attachment "+u+": Depth texture attachment requested, but the requiered extension is not present: WEBGL_depth_texture.",!1):(c="Error in attachment "+u+": Floating point render surface requested, but the required extension is not present: OES_texture_float.",!1)):(c="Error in attachment "+u+": Invalid combination of type and format ("+i(t.type)+" is incompatible with "+n(t.format)+").",!1)}),c}function s(t,e,i,n){if(i.format==bg.base.RenderSurfaceFormat.RENDERBUFFER){var r=t.createRenderbuffer();return t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,r),t.bindRenderbuffer(t.RENDERBUFFER,null),{_renderbuffer:r}}var s=new bg.base.Texture(t),a=i.format,o=i.type;return s.create(),s.bind(),s.minFilter=bg.base.TextureFilter.LINEAR,s.magFilter=bg.base.TextureFilter.LINEAR,s.wrapX=bg.base.TextureWrap.CLAMP,s.wrapY=bg.base.TextureWrap.CLAMP,s.setImageRaw(e.width,e.height,null,o,a),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+n,t.TEXTURE_2D,s._texture,0),s.unbind(),s}function a(t,e,i,n){if(i.texture&&(i.texture.bind(),i.texture.setImageRaw(e.width,e.height,null,i.type,i.format),i.texture.unbind()),i.renderbuffer){var r=i.renderbuffer._renderbuffer;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e.width,e.height),t.bindRenderbuffer(t.RENDERBUFFER,null)}}var o=null,c=function(e){function i(){$traceurRuntime.superConstructor(i).apply(this,arguments)}return $traceurRuntime.createClass(i,{initFlags:function(t){bg.base.RenderSurfaceType.RGBA=t.RGBA,bg.base.RenderSurfaceType.DEPTH=t.DEPTH_COMPONENT,bg.base.RenderSurfaceFormat.UNSIGNED_BYTE=t.UNSIGNED_BYTE,bg.base.RenderSurfaceFormat.UNSIGNED_SHORT=t.UNSIGNED_SHORT,bg.base.RenderSurfaceFormat.FLOAT=t.FLOAT,bg.base.RenderSurfaceFormat.RENDERBUFFER=t.RENDERBUFFER,o=bg.webgl1.Extensions.Get()},supportType:function(t){switch(t){case bg.base.RenderSurfaceType.RGBA:return!0;case bg.base.RenderSurfaceType.DEPTH:return null!=o.depthTexture;default:return!1}},supportFormat:function(t){switch(t){case bg.base.RenderSurfaceFormat.UNSIGNED_BYTE:case bg.base.RenderSurfaceFormat.UNSIGNED_SHORT:return!0;case bg.base.RenderSurfaceFormat.FLOAT:return null!=o.textureFloat;default:return!1}},get maxColorAttachments(){return t()}},{},e)}(bg.base.RenderSurfaceBufferImpl),u=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{create:function(t){return{}},setActive:function(t,e,i){t.bindFramebuffer(t.FRAMEBUFFER,null)},resize:function(t,e,i){},destroy:function(t,e){},readBuffer:function(t,e,i,n){var r=new Uint8Array(i.width*i.height*4);return t.readPixels(i.x,i.y,i.width,i.height,t.RGBA,t.UNSIGNED_BYTE,r),r}},{},t)}(c);bg.webgl1.ColorRenderSurfaceImpl=u;var h=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{initFlags:function(t){},create:function(t,e){var i=r(e);if(i)throw new Error(i);var n=new bg.Vector2(256),a={fbo:t.createFramebuffer(),size:n,attachments:[]};t.bindFramebuffer(t.FRAMEBUFFER,a.fbo);var c=[];return e.forEach(function(e,i){var r=s(t,n,e,i);r instanceof bg.base.Texture&&c.push(o.drawBuffers?o.drawBuffers.COLOR_ATTACHMENT0_WEBGL+i:t.COLOR_ATTACHMENT0),a.attachments.push({texture:r instanceof bg.base.Texture?r:null,renderbuffer:r instanceof bg.base.Texture?null:r,format:e.format,type:e.type})}),c.length>1&&o.drawBuffers.drawBuffersWEBGL(c),t.bindFramebuffer(t.FRAMEBUFFER,null),a},setActive:function(t,e){t.bindFramebuffer(t.FRAMEBUFFER,e.fbo)},readBuffer:function(t,e,i,n){var r=new Uint8Array(i.width*i.height*4);return t.readPixels(i.x,n.height-i.y,i.width,i.height,t.RGBA,t.UNSIGNED_BYTE,r),r},resize:function(t,e,i){e.size.width=i.width,e.size.height=i.height,e.attachments.forEach(function(e,n){a(t,i,e,n)})},destroy:function(t,e){t.bindFramebuffer(t.FRAMEBUFFER,null);var i=e&&e.attachments;e.fbo&&t.deleteFramebuffer(e.fbo),i&&i.forEach(function(e){e.texture?e.texture.destroy():e.renderbuffer&&t.deleteRenderbuffer(e.renderbuffer._renderbuffer)}),e.fbo=null,e.size=null,e.attachments=null}},{},t)}(c);bg.webgl1.TextureRenderSurfaceImpl=h}(),function(){var t={textureInput:"sampler2D",texCoord:"vec2",size:"vec2",reduction:"vec2"},e={textureInput:"sampler2D",texCoord:"vec2",size:"int",samplerSize:"vec2"},i="\n\t\tint downsample = 30;\n\t\tvec2 texelSize = 1.0 / samplerSize;\n\t\tvec3 result = vec3(0.0);\n\t\tsize = int(max(float(size / downsample),1.0));\n\t\tvec2 hlim = vec2(float(-size) * 0.5 + 0.5);\n\t\tvec2 sign = vec2(1.0);\n\t\tfloat blurFactor = 10.0 - 0.2 * float(size) * log(float(size));\n\t\tfor (int x=0; x<40; ++x) {\n\t\t\tif (x==size) break;\n\t\t\tfor (int y=0; y<40; ++y) {\n\t\t\t\tif (y==size) break;\n\t\t\t\tvec2 offset = (hlim + vec2(float(x), float(y))) * texelSize * float(downsample) / blurFactor;\n\t\t\t\tresult += textureDownsample(textureInput, texCoord + offset,samplerSize,vec2(downsample)).rgb;\n\t\t\t}\n\t\t}\n\t\treturn vec4(result / float(size * size), 1.0);\n\t\t",n={textureInput:"sampler2D",texCoord:"vec2",size:"int",samplerSize:"vec2"},r={textureInput:"samplerCube",texCoord:"vec3",size:"int",samplerSize:"vec2",dist:"float"};bg.webgl1.shaderLibrary.functions.blur={textureDownsample:{returnType:"vec4",name:"textureDownsample",params:t,body:"\n\t\tfloat dx = reduction.x / size.x;\n\t\tfloat dy = reduction.y / size.y;\n\t\tvec2 coord = vec2(dx * texCoord.x / dx, dy * texCoord.y / dy);\n\t\treturn texture2D(textureInput,coord);\n\t"},gaussianBlur:{returnType:"vec4",name:"gaussianBlur",params:e,body:i},blur:{returnType:"vec4",name:"blur",params:e,body:i},glowBlur:{returnType:"vec4",name:"glowBlur",params:n,body:"\n\t\tint downsample = 30;\n\t\tvec2 texelSize = 1.0 / samplerSize;\n\t\tvec3 result = vec3(0.0);\n\t\tsize = int(max(float(size / downsample),1.0));\n\t\tvec2 hlim = vec2(float(-size) * 0.5 + 0.5);\n\t\tvec2 sign = vec2(1.0);\n\t\tfor (int x=0; x<40; ++x) {\n\t\t\tif (x==size) break;\n\t\t\tfor (int y=0; y<40; ++y) {\n\t\t\t\tif (y==size) break;\n\t\t\t\tvec2 offset = (hlim + vec2(float(x), float(y))) * texelSize;\n\t\t\t\tresult += textureDownsample(textureInput, texCoord + offset,samplerSize,vec2(downsample)).rgb;\n\t\t\t}\n\t\t}\n\t\treturn vec4(result / float(size * size), 1.0);\n\t"},blurCube:{returnType:"vec4",name:"blurCube",params:r,body:"\n\t\tint downsample = int(max(1.0,dist));\n\t\tvec2 texelSize = 1.0 / samplerSize;\n\t\tvec3 result = vec3(0.0);\n\t\tsize = int(max(float(size / downsample),1.0));\n\t\tvec2 hlim = vec2(float(-size) * 0.5 + 0.5);\n\t\tvec2 sign = vec2(1.0);\n\t\tfor (int x=0; x<40; ++x) {\n\t\t\tif (x==size) break;\n\t\t\tfor (int y=0; y<40; ++y) {\n\t\t\t\tif (y==size) break;\n\t\t\t\tvec3 offset = vec3((hlim + vec2(float(x*downsample), float(y*downsample))) * texelSize,0.0);\n\t\t\t\tresult += textureCube(textureInput, texCoord + offset,2.0).rgb;\n\t\t\t}\n\t\t}\n\t\treturn vec4(result / float(size * size), 1.0);\n\t\t"},antiAlias:{returnType:"vec4",name:"antiAlias",params:{sampler:"sampler2D",texCoord:"vec2",frameSize:"vec2",tresshold:"float",iterations:"int"},body:"\n\t\t\t\treturn (borderDetection(sampler,texCoord,frameSize)>tresshold) ?\n\t\t\t\t\tgaussianBlur(sampler,texCoord,iterations,frameSize) :\n\t\t\t\t\ttexture2D(sampler,texCoord);\n\t\t\t\t"}}}(),function(){bg.webgl1.shaderLibrary.functions.colorCorrection={rgb2hsv:{returnType:"vec3",name:"rgb2hsv",params:{c:"vec3"},body:"\n\t\t\t\tvec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\n\t\t\t\tvec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n\t\t\t\tvec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n\n\t\t\t\tfloat d = q.x - min(q.w, q.y);\n\t\t\t\tfloat e = 1.0e-10;\n\t\t\t\treturn vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);"},hsv2rgb:{returnType:"vec3",name:"hsv2rgb",params:{c:"vec3"},body:"\n\t\t\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\t\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\t\t\treturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);"},applyBrightness:{returnType:"vec4",name:"applyBrightness",params:{color:"vec4",brightness:"float"},body:"\n\t\t\t\t\treturn clamp(vec4(color.rgb + brightness - 0.5,1.0),0.0,1.0);\n\t\t\t\t"},applyContrast:{returnType:"vec4",name:"applyContrast",params:{color:"vec4",contrast:"float"},body:"\n\t\t\t\treturn clamp(vec4((color.rgb * max(contrast + 0.5,0.0)),1.0),0.0,1.0);"},applySaturation:{returnType:"vec4",name:"applySaturation",params:{color:"vec4",hue:"float",saturation:"float",lightness:"float"},body:"\n\t\t\t\tvec3 fragRGB = clamp(color.rgb + vec3(0.001),0.0,1.0);\n\t\t\t\tvec3 fragHSV = rgb2hsv(fragRGB);\n\t\t\t\tlightness -= 0.01;\n\t\t\t\tfloat h = hue;\n\t\t\t\tfragHSV.x *= h;\n\t\t\t\tfragHSV.yz *= vec2(saturation,lightness);\n\t\t\t\tfragHSV.x = mod(fragHSV.x, 1.0);\n\t\t\t\tfragHSV.y = mod(fragHSV.y, 1.0);\n\t\t\t\tfragHSV.z = mod(fragHSV.z, 1.0);\n\t\t\t\tfragRGB = hsv2rgb(fragHSV);\n\t\t\t\treturn clamp(vec4(hsv2rgb(fragHSV), color.w),0.0,1.0);"},colorCorrection:{returnType:"vec4",name:"colorCorrection",params:{fragColor:"vec4",hue:"float",saturation:"float",lightness:"float",brightness:"float",contrast:"float"},body:"\n\t\t\t\treturn applyContrast(applyBrightness(applySaturation(fragColor,hue,saturation,lightness),brightness),contrast);"}}}(),function(){bg.webgl1.shaderLibrary.inputs={buffers:{vertex:{name:"inVertex",dataType:"vec3",role:"buffer",target:"vertex"},normal:{name:"inNormal",dataType:"vec3",role:"buffer",target:"normal"},tangent:{name:"inTangent",dataType:"vec3",role:"buffer",target:"tangent"},tex0:{name:"inTex0",dataType:"vec2",role:"buffer",target:"tex0"},tex1:{name:"inTex1",dataType:"vec2",role:"buffer",target:"tex1"},tex2:{name:"inTex2",dataType:"vec2",role:"buffer",target:"tex2"},color:{name:"inColor",dataType:"vec4",role:"buffer",target:"color"}},matrix:{model:{name:"inModelMatrix",dataType:"mat4",role:"value"},view:{name:"inViewMatrix",dataType:"mat4",role:"value"},projection:{name:"inProjectionMatrix",dataType:"mat4",role:"value"},normal:{name:"inNormalMatrix",dataType:"mat4",role:"value"},viewInv:{name:"inViewMatrixInv",dataType:"mat4",role:"value"}},material:{diffuse:{name:"inDiffuseColor",dataType:"vec4",role:"value"},specular:{name:"inSpecularColor",dataType:"vec4",role:"value"},shininess:{name:"inShininess",dataType:"float",role:"value"},shininessMask:{name:"inShininessMask",dataType:"sampler2D",role:"value"},shininessMaskChannel:{name:"inShininessMaskChannel",dataType:"vec4",role:"value"},shininessMaskInvert:{name:"inShininessMaskInvert",dataType:"bool",role:"value"},lightEmission:{name:"inLightEmission",dataType:"float",role:"value"},lightEmissionMask:{name:"inLightEmissionMask",dataType:"sampler2D",role:"value"},lightEmissionMaskChannel:{name:"inLightEmissionMaskChannel",dataType:"vec4",role:"value"},lightEmissionMaskInvert:{name:"inLightEmissionMaskInvert",dataType:"bool",role:"value"},texture:{name:"inTexture",dataType:"sampler2D",role:"value"},textureOffset:{name:"inTextureOffset",dataType:"vec2",role:"value"},textureScale:{name:"inTextureScale",dataType:"vec2",role:"value"},alphaCutoff:{name:"inAlphaCutoff",dataType:"float",role:"value"},lightMap:{name:"inLightMap",dataType:"sampler2D",role:"value"},lightMapOffset:{name:"inLightMapOffset",dataType:"vec2",role:"value"},lightMapScale:{name:"inLightMapScale",dataType:"vec2",role:"value"},normalMap:{name:"inNormalMap",dataType:"sampler2D",role:"value"},normalMapOffset:{name:"inNormalMapOffset",dataType:"vec2",role:"value"},normalMapScale:{name:"inNormalMapScale",dataType:"vec2",role:"value"},reflection:{name:"inReflection",dataType:"float",role:"value"},reflectionMask:{name:"inReflectionMask",dataType:"sampler2D",role:"value"},reflectionMaskChannel:{name:"inReflectionMaskChannel",dataType:"vec4",role:"value"},reflectionMaskInvert:{name:"inReflectionMaskInvert",dataType:"bool",role:"value"},castShadows:{name:"inCastShadows",dataType:"bool",role:"value"},receiveShadows:{name:"inReceiveShadows",dataType:"bool",role:"value"},roughness:{name:"inRoughness",dataType:"float",role:"value"},roughnessMask:{name:"inRoughnessMask",dataType:"sampler2D",role:"value"},roughnessMaskChannel:{name:"inRoughnessMaskChannel",dataType:"vec4",role:"value"},roughnessMaskInvert:{name:"inRoughnessMaskInvert",dataType:"bool",role:"value"},unlit:{name:"inUnlit",dataType:"bool",role:"value"}},lighting:{type:{name:"inLightType",dataType:"int",role:"value"},position:{name:"inLightPosition",dataType:"vec3",role:"value"},direction:{name:"inLightDirection",dataType:"vec3",role:"value"},ambient:{name:"inLightAmbient",dataType:"vec4",role:"value"},diffuse:{name:"inLightDiffuse",dataType:"vec4",role:"value"},specular:{name:"inLightSpecular",dataType:"vec4",role:"value"},attenuation:{name:"inLightAttenuation",dataType:"vec3",role:"value"},spotExponent:{name:"inSpotExponent",dataType:"float",role:"value"},spotCutoff:{name:"inSpotCutoff",dataType:"float",role:"value"},cutoffDistance:{name:"inLightCutoffDistance",dataType:"float",role:"value"},exposure:{name:"inLightExposure",dataType:"float",role:"value"},castShadows:{name:"inLightCastShadows",dataType:"bool",role:"value"}},lightingForward:{type:{name:"inLightType",dataType:"int",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},position:{name:"inLightPosition",dataType:"vec3",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},direction:{name:"inLightDirection",dataType:"vec3",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},ambient:{name:"inLightAmbient",dataType:"vec4",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},diffuse:{name:"inLightDiffuse",dataType:"vec4",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},specular:{name:"inLightSpecular",dataType:"vec4",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},attenuation:{name:"inLightAttenuation",dataType:"vec3",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},spotExponent:{name:"inSpotExponent",dataType:"float",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},spotCutoff:{name:"inSpotCutoff",dataType:"float",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},cutoffDistance:{name:"inLightCutoffDistance",dataType:"float",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},exposure:{name:"inLightExposure",dataType:"float",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},castShadows:{name:"inLightCastShadows",dataType:"bool",role:"value",vec:bg.base.MAX_FORWARD_LIGHTS},numLights:{name:"inNumLights",dataType:"int",role:"value"}},shadows:{shadowMap:{name:"inShadowMap",dataType:"sampler2D",role:"value"},shadowMapSize:{name:"inShadowMapSize",dataType:"vec2",role:"value"},shadowStrength:{name:"inShadowStrength",dataType:"float",role:"value"},shadowColor:{name:"inShadowColor",dataType:"vec4",role:"value"},shadowBias:{name:"inShadowBias",dataType:"float",role:"value"},shadowType:{name:"inShadowType",
dataType:"int",role:"value"}},colorCorrection:{hue:{name:"inHue",dataType:"float",role:"value"},saturation:{name:"inSaturation",dataType:"float",role:"value"},lightness:{name:"inLightness",dataType:"float",role:"value"},brightness:{name:"inBrightness",dataType:"float",role:"value"},contrast:{name:"inContrast",dataType:"float",role:"value"}}}}(),function(){bg.webgl1.shaderLibrary.functions.lighting={beckmannDistribution:{returnType:"float",name:"beckmannDistribution",params:{x:"float",roughness:"float"},body:"\n\t\t\t\t\tfloat NdotH = max(x,0.0001);\n\t\t\t\t\tfloat cos2Alpha = NdotH * NdotH;\n\t\t\t\t\tfloat tan2Alpha = (cos2Alpha - 1.0) / cos2Alpha;\n\t\t\t\t\tfloat roughness2 = roughness * roughness;\n\t\t\t\t\tfloat denom = 3.141592653589793 * roughness2 * cos2Alpha * cos2Alpha;\n\t\t\t\t\treturn exp(tan2Alpha / roughness2) / denom;\n\t\t\t\t"},beckmannSpecular:{returnType:"float",name:"beckmannSpecular",params:{lightDirection:"vec3",viewDirection:"vec3",surfaceNormal:"vec3",roughness:"float"},body:"\n\t\t\t\t\treturn beckmannDistribution(dot(surfaceNormal, normalize(lightDirection + viewDirection)), roughness);\n\t\t\t\t"},getDirectionalLight:{returnType:"vec4",name:"getDirectionalLight",params:{ambient:"vec4",diffuse:"vec4",specular:"vec4",shininess:"float",direction:"vec3",vertexPos:"vec3",normal:"vec3",matDiffuse:"vec4",matSpecular:"vec4",shadowColor:"vec4"},body:"\n\t\t\t\tvec3 color = ambient.rgb * matDiffuse.rgb;\n\t\t\t\tvec3 diffuseWeight = max(0.0, dot(normal,direction)) * diffuse.rgb;\n\t\t\t\tcolor += min(diffuseWeight,shadowColor.rgb) * matDiffuse.rgb;\n\t\t\t\tif (shininess>0.0) {\n\t\t\t\t\tvec3 eyeDirection = normalize(-vertexPos);\n\t\t\t\t\tvec3 reflectionDirection = normalize(reflect(-direction,normal));\n\t\t\t\t\tfloat specularWeight = clamp(pow(max(dot(reflectionDirection, eyeDirection), 0.0), shininess), 0.0, 1.0);\n\t\t\t\t\t//sspecularWeight = beckmannSpecular(direction,eyeDirection,normal,0.01);\n\t\t\t\t\tvec3 specularColor = specularWeight * pow(shadowColor.rgb,vec3(10.0));\n\t\t\t\t\tcolor += specularColor * specular.rgb * matSpecular.rgb;\n\t\t\t\t}\n\t\t\t\treturn vec4(color,1.0);"},getPointLight:{returnType:"vec4",name:"getPointLight",params:{ambient:"vec4",diffuse:"vec4",specular:"vec4",shininess:"float",position:"vec3",constAtt:"float",linearAtt:"float",expAtt:"float",vertexPos:"vec3",normal:"vec3",matDiffuse:"vec4",matSpecular:"vec4"},body:"\n\t\t\t\tvec3 pointToLight = position - vertexPos;\n\t\t\t\tfloat distance = length(pointToLight);\n\t\t\t\tvec3 lightDir = normalize(pointToLight);\n\t\t\t\tfloat attenuation = 1.0 / (constAtt + linearAtt * distance + expAtt * distance * distance);\n\t\t\t\tvec3 color = ambient.rgb * matDiffuse.rgb;\n\t\t\t\tvec3 diffuseWeight = max(0.0,dot(normal,lightDir)) * diffuse.rgb * attenuation;\n\t\t\t\tcolor += diffuseWeight * matDiffuse.rgb;\n\t\t\t\tif (shininess>0.0) {\n\t\t\t\t\tvec3 eyeDirection = normalize(-vertexPos);\n\t\t\t\t\tvec3 reflectionDirection = normalize(reflect(-lightDir, normal));\n\t\t\t\t\tfloat specularWeight = clamp(pow(max(dot(reflectionDirection,eyeDirection),0.0), shininess), 0.0, 1.0);\n\t\t\t\t\tcolor += specularWeight * specular.rgb * matSpecular.rgb * attenuation;\n\t\t\t\t}\n\t\t\t\treturn vec4(color,1.0);"},getSpotLight:{returnType:"vec4",name:"getSpotLight",params:{ambient:"vec4",diffuse:"vec4",specular:"vec4",shininess:"float",position:"vec3",direction:"vec3",constAtt:"float",linearAtt:"float",expAtt:"float",spotCutoff:"float",spotExponent:"float",vertexPos:"vec3",normal:"vec3",matDiffuse:"vec4",matSpecular:"vec4",shadowColor:"vec4"},body:"\n\t\t\t\tvec4 matAmbient = vec4(1.0);\n\t\t\t\tvec3 s = normalize(position - vertexPos);\n\t\t\t\tfloat angle = acos(dot(-s, direction));\n\t\t\t\tfloat cutoff = radians(clamp(spotCutoff / 2.0,0.0,90.0));\n\t\t\t\tfloat distance = length(position - vertexPos);\n\t\t\t\tfloat attenuation = 1.0 / (constAtt );//+ linearAtt * distance + expAtt * distance * distance);\n\t\t\t\tif (angle<cutoff) {\n\t\t\t\t\tfloat spotFactor = pow(dot(-s, direction), spotExponent);\n\t\t\t\t\tvec3 v = normalize(vec3(-vertexPos));\n\t\t\t\t\tvec3 h = normalize(v + s);\n\t\t\t\t\tvec3 diffuseAmount = matDiffuse.rgb * diffuse.rgb * max(dot(s, normal), 0.0);\n\t\t\t\t\tif (shininess>0.0) {\n\t\t\t\t\t\tdiffuseAmount += matSpecular.rgb * specular.rgb * pow(max(dot(h,normal), 0.0),shininess);\n\t\t\t\t\t\tdiffuseAmount *= pow(shadowColor.rgb,vec3(10.0));\n\t\t\t\t\t}\n\t\t\t\t\tdiffuseAmount.r = min(diffuseAmount.r, shadowColor.r);\n\t\t\t\t\tdiffuseAmount.g = min(diffuseAmount.g, shadowColor.g);\n\t\t\t\t\tdiffuseAmount.b = min(diffuseAmount.b, shadowColor.b);\n\t\t\t\t\treturn vec4(ambient.rgb * matDiffuse.rgb + attenuation * spotFactor * diffuseAmount,1.0);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn vec4(ambient.rgb * matDiffuse.rgb,1.0);\n\t\t\t\t}"},getLight:{returnType:"vec4",name:"getLight",params:{lightType:"int",ambient:"vec4",diffuse:"vec4",specular:"vec4",shininess:"float",lightPosition:"vec3",lightDirection:"vec3",constAtt:"float",linearAtt:"float",expAtt:"float",spotCutoff:"float",spotExponent:"float",cutoffDistance:"float",vertexPosition:"vec3",vertexNormal:"vec3",matDiffuse:"vec4",matSpecular:"vec4",shadowColor:"vec4"},body:"\n\t\t\t\t\tvec4 light = vec4(0.0);\n\t\t\t\t\tif (lightType=="+bg.base.LightType.DIRECTIONAL+") {\n\t\t\t\t\t\tlight = getDirectionalLight(ambient,diffuse,specular,shininess,\n\t\t\t\t\t\t\t\t\t\t-lightDirection,vertexPosition,vertexNormal,matDiffuse,matSpecular,shadowColor);\n\t\t\t\t\t}\n\t\t\t\t\telse if (lightType=="+bg.base.LightType.SPOT+") {\n\t\t\t\t\t\tfloat d = distance(vertexPosition,lightPosition);\n\t\t\t\t\t\tif (d<=cutoffDistance || cutoffDistance==-1.0) {\n\t\t\t\t\t\t\tlight = getSpotLight(ambient,diffuse,specular,shininess,\n\t\t\t\t\t\t\t\t\t\t\tlightPosition,lightDirection,\n\t\t\t\t\t\t\t\t\t\t\tconstAtt,linearAtt,expAtt,\n\t\t\t\t\t\t\t\t\t\t\tspotCutoff,spotExponent,\n\t\t\t\t\t\t\t\t\t\t\tvertexPosition,vertexNormal,matDiffuse,matSpecular,shadowColor);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (lightType=="+bg.base.LightType.POINT+") {\n\t\t\t\t\t\tfloat d = distance(vertexPosition,lightPosition);\n\t\t\t\t\t\tif (d<=cutoffDistance || cutoffDistance==-1.0) {\n\t\t\t\t\t\t\tlight = getPointLight(ambient,diffuse,specular,shininess,\n\t\t\t\t\t\t\t\t\t\t\tlightPosition,\n\t\t\t\t\t\t\t\t\t\t\tconstAtt,linearAtt,expAtt,\n\t\t\t\t\t\t\t\t\t\t\tvertexPosition,vertexNormal,matDiffuse,matSpecular);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn light;\n\t\t\t\t"},getShadowColor:{returnType:"vec4",name:"getShadowColor",params:{vertexPosFromLight:"vec4",shadowMap:"sampler2D",shadowMapSize:"vec2",shadowType:"int",shadowStrength:"float",shadowBias:"float",shadowColor:"vec4"},body:"\n\t\t\t\tfloat visibility = 1.0;\n\t\t\t\tvec3 depth = vertexPosFromLight.xyz / vertexPosFromLight.w;\n\t\t\t\tconst float kShadowBorderOffset = 3.0;\n\t\t\t\tfloat shadowBorderOffset = kShadowBorderOffset / shadowMapSize.x;\n\t\t\t\tfloat bias = shadowBias;\n\t\t\t\tvec4 shadow = vec4(1.0);\n\t\t\t\tif (shadowType=="+bg.base.ShadowType.HARD+") {\t// hard\n\t\t\t\t\tfloat shadowDepth = unpack(texture2D(shadowMap,depth.xy));\n\t\t\t\t\tif (shadowDepth<depth.z - bias &&\n\t\t\t\t\t\t(depth.x>0.0 && depth.x<1.0 && depth.y>0.0 && depth.y<1.0))\n\t\t\t\t\t{\n\t\t\t\t\t\tvisibility = 1.0 - shadowStrength;\n\t\t\t\t\t}\n\t\t\t\t\tshadow = clamp(shadowColor + visibility,0.0,1.0);\n\t\t\t\t}\n\t\t\t\telse if (shadowType>="+bg.base.ShadowType.SOFT+") {\t// soft / soft stratified (not supported on webgl, fallback to soft)\n\t\t\t\t\tvec2 poissonDisk[4];\n\t\t\t\t\tpoissonDisk[0] = vec2( -0.94201624, -0.39906216 );\n\t\t\t\t\tpoissonDisk[1] = vec2( 0.94558609, -0.76890725 );\n\t\t\t\t\tpoissonDisk[2] = vec2( -0.094184101, -0.92938870 );\n\t\t\t\t\tpoissonDisk[3] = vec2( 0.34495938, 0.29387760 );\n\t\t\t\t\t\n\t\t\t\t\tfor (int i=0; i<4; ++i) {\n\t\t\t\t\t\tfloat shadowDepth = unpack(texture2D(shadowMap, depth.xy + poissonDisk[i]/1000.0));\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (shadowDepth<depth.z - bias\n\t\t\t\t\t\t\t&& (depth.x>0.0 && depth.x<1.0 && depth.y>0.0 && depth.y<1.0)) {\n\t\t\t\t\t\t\tvisibility -= (shadowStrength) * 0.25;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tshadow = clamp(shadowColor + visibility,0.0,1.0);\n\t\t\t\t}\n\t\t\t\treturn shadow;"}}}(),function(){bg.webgl1.shaderLibrary.functions.materials={samplerColor:{returnType:"vec4",name:"samplerColor",params:{sampler:"sampler2D",uv:"vec2",offset:"vec2",scale:"vec2"},body:"\n\t\t\t\treturn texture2D(sampler,uv * scale + offset);"},samplerNormal:{returnType:"vec3",name:"samplerNormal",params:{sampler:"sampler2D",uv:"vec2",offset:"vec2",scale:"vec2"},body:"\n\t\t\t\treturn normalize(samplerColor(sampler,uv,offset,scale).xyz * 2.0 - 1.0);\n\t\t\t\t"},combineNormalWithMap:{returnType:"vec3",name:"combineNormalWithMap",params:{normalCoord:"vec3",tangent:"vec3",bitangent:"vec3",normalMapValue:"vec3"},body:"\n\t\t\t\tmat3 tbnMat = mat3( tangent.x, bitangent.x, normalCoord.x,\n\t\t\t\t\t\t\ttangent.y, bitangent.y, normalCoord.y,\n\t\t\t\t\t\t\ttangent.z, bitangent.z, normalCoord.z\n\t\t\t\t\t\t);\n\t\t\t\treturn normalize(normalMapValue * tbnMat);"},applyTextureMask:{returnType:"float",name:"applyTextureMask",params:{value:"float",textureMask:"sampler2D",uv:"vec2",offset:"vec2",scale:"vec2",channelMask:"vec4",invert:"bool"},body:"\n\t\t\t\tfloat mask;\n\t\t\t\tvec4 color = samplerColor(textureMask,uv,offset,scale);\n\t\t\t\tmask = color.r * channelMask.r +\n\t\t\t\t\t\t color.g * channelMask.g +\n\t\t\t\t\t\t color.b * channelMask.b +\n\t\t\t\t\t\t color.a * channelMask.a;\n\t\t\t\tif (invert) {\n\t\t\t\t\tmask = 1.0 - mask;\n\t\t\t\t}\n\t\t\t\treturn value * mask;"},specularColor:{returnType:"vec4",name:"specularColor",params:{specular:"vec4",shininessMask:"sampler2D",uv:"vec2",offset:"vec2",scale:"vec2",channelMask:"vec4",invert:"bool"},body:"\n\t\t\t\tfloat maskValue = applyTextureMask(1.0, shininessMask,uv,offset,scale,channelMask,invert);\n\t\t\t\treturn vec4(specular.rgb * maskValue, 1.0);"}}}(),function(){bg.webgl1.shaderLibrary.functions.utils={pack:{returnType:"vec4",name:"pack",params:{depth:"float"},body:"\n\t\t\t\tconst vec4 bitSh = vec4(256 * 256 * 256,\n\t\t\t\t\t\t\t\t\t\t256 * 256,\n\t\t\t\t\t\t\t\t\t\t256,\n\t\t\t\t\t\t\t\t\t\t1.0);\n\t\t\t\tconst vec4 bitMsk = vec4(0,\n\t\t\t\t\t\t\t\t\t\t1.0 / 256.0,\n\t\t\t\t\t\t\t\t\t\t1.0 / 256.0,\n\t\t\t\t\t\t\t\t\t\t1.0 / 256.0);\n\t\t\t\tvec4 comp = fract(depth * bitSh);\n\t\t\t\tcomp -= comp.xxyz * bitMsk;\n\t\t\t\treturn comp;"},unpack:{returnType:"float",name:"unpack",params:{color:"vec4"},body:"\n\t\t\t\tconst vec4 bitShifts = vec4(1.0 / (256.0 * 256.0 * 256.0),\n\t\t\t\t\t\t\t\t\t\t\t1.0 / (256.0 * 256.0),\n\t\t\t\t\t\t\t\t\t\t\t1.0 / 256.0,\n\t\t\t\t\t\t\t\t\t\t\t1.0);\n\t\t\t\treturn dot(color, bitShifts);"},random:{returnType:"float",name:"random",params:{seed:"vec3",i:"int"},body:"\n\t\t\t\tvec4 seed4 = vec4(seed,i);\n\t\t\t\tfloat dot_product = dot(seed4, vec4(12.9898,78.233,45.164,94.673));\n\t\t\t\treturn fract(sin(dot_product) * 43758.5453);"},texOffset:{returnType:"vec4",name:"texOffset",params:{sampler:"sampler2D",texCoord:"vec2",offset:"vec2",frameSize:"vec2"},body:"\n\t\t\t\treturn texture2D(sampler,texCoord + vec2(offset.x * 1.0/frameSize.x,offset.y * 1.0 / frameSize.y));\n\t\t\t\t"},luminance:{returnType:"float",name:"luminance",params:{color:"vec3"},body:"\n\t\t\t\treturn dot(vec3(0.2126,0.7152,0.0722), color);\n\t\t\t\t"},borderDetection:{returnType:"float",name:"borderDetection",params:{sampler:"sampler2D",texCoord:"vec2",frameSize:"vec2"},body:"\n\t\t\t\tfloat s00 = luminance(texOffset(sampler,texCoord,vec2(-1.0, 1.0),frameSize).rgb);\n\t\t\t\tfloat s10 = luminance(texOffset(sampler,texCoord,vec2(-1.0, 0.0),frameSize).rgb);\n\t\t\t\tfloat s20 = luminance(texOffset(sampler,texCoord,vec2(-1.0,-1.0),frameSize).rgb);\n\t\t\t\tfloat s01 = luminance(texOffset(sampler,texCoord,vec2(-1.0, 1.0),frameSize).rgb);\n\t\t\t\tfloat s21 = luminance(texOffset(sampler,texCoord,vec2( 0.0,-1.0),frameSize).rgb);\n\t\t\t\tfloat s02 = luminance(texOffset(sampler,texCoord,vec2( 1.0, 1.0),frameSize).rgb);\n\t\t\t\tfloat s12 = luminance(texOffset(sampler,texCoord,vec2( 1.0, 0.0),frameSize).rgb);\n\t\t\t\tfloat s22 = luminance(texOffset(sampler,texCoord,vec2( 1.0,-1.0),frameSize).rgb);\n\n\t\t\t\tfloat sx = s00 + 2.0 * s10 + s20 - (s02 + 2.0 * s12 + s22);\n\t\t\t\tfloat sy = s00 + 2.0 * s01 + s02 - (s20 + 2.0 * s21 + s22);\n\n\t\t\t\treturn sx * sx + sy * sy;\n\t\t\t\t"},applyConvolution:{returnType:"vec4",name:"applyConvolution",params:{texture:"sampler2D",texCoord:"vec2",texSize:"vec2",convMatrix:"float[9]",radius:"float"},body:"\n\t\t\t\tvec2 onePixel = vec2(1.0,1.0) / texSize * radius;\n\t\t\t\tvec4 colorSum = \n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2(-1, -1)) * convMatrix[0] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 0, -1)) * convMatrix[1] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 1, -1)) * convMatrix[2] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2(-1,  0)) * convMatrix[3] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 0,  0)) * convMatrix[4] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 1,  0)) * convMatrix[5] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2(-1,  1)) * convMatrix[6] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 0,  1)) * convMatrix[7] +\n\t\t\t\t\ttexture2D(texture, texCoord + onePixel * vec2( 1,  1)) * convMatrix[8];\n\t\t\t\tfloat kernelWeight =\n\t\t\t\t\tconvMatrix[0] +\n\t\t\t\t\tconvMatrix[1] +\n\t\t\t\t\tconvMatrix[2] +\n\t\t\t\t\tconvMatrix[3] +\n\t\t\t\t\tconvMatrix[4] +\n\t\t\t\t\tconvMatrix[5] +\n\t\t\t\t\tconvMatrix[6] +\n\t\t\t\t\tconvMatrix[7] +\n\t\t\t\t\tconvMatrix[8];\n\t\t\t\tif (kernelWeight <= 0.0) {\n\t\t\t\t\tkernelWeight = 1.0;\n\t\t\t\t}\n\t\t\t\treturn vec4((colorSum / kernelWeight).rgb, 1.0);\n\t\t\t\t"}}}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{initFlags:function(t){bg.base.ShaderType.VERTEX=t.VERTEX_SHADER,bg.base.ShaderType.FRAGMENT=t.FRAGMENT_SHADER},setActive:function(t,e){t.useProgram(e&&e.program)},create:function(t){return{program:t.createProgram(),attribLocations:{},uniformLocations:{}}},addShaderSource:function(t,e,i,n){var r=null;if(e&&e.program){var s=t.createShader(i);t.shaderSource(s,n),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS)?t.attachShader(e.program,s):r=t.getShaderInfoLog(s),t.deleteShader(s)}else r="Could not attach shader. Invalid shader program";return r},link:function(t,e){var i=null;return e&&e.program?(t.linkProgram(e.program),t.getProgramParameter(e.program,t.LINK_STATUS)||(i=t.getProgramInfoLog(e.program))):i="Could not link shader. Invalid shader program",i},initVars:function(t,e,i,n){i.forEach(function(i){e.attribLocations[i]=t.getAttribLocation(e.program,i)}),n.forEach(function(i){e.uniformLocations[i]=t.getUniformLocation(e.program,i)})},setInputBuffer:function(t,e,i,n,r){if(n&&e&&e.program){var s=e.attribLocations[i];-1!=s&&(t.bindBuffer(t.ARRAY_BUFFER,n),t.enableVertexAttribArray(s),t.vertexAttribPointer(s,r,t.FLOAT,!1,0,0))}},disableInputBuffer:function(t,e,i){t.disableVertexAttribArray(e.attribLocations[i])},setValueInt:function(t,e,i,n){t.uniform1i(e.uniformLocations[i],n)},setValueIntPtr:function(t,e,i,n){t.uniform1iv(e.uniformLocations[i],n)},setValueFloat:function(t,e,i,n){t.uniform1f(e.uniformLocations[i],n)},setValueFloatPtr:function(t,e,i,n){t.uniform1fv(e.uniformLocations[i],n)},setValueVector2:function(t,e,i,n){t.uniform2fv(e.uniformLocations[i],n.v)},setValueVector3:function(t,e,i,n){t.uniform3fv(e.uniformLocations[i],n.v)},setValueVector4:function(t,e,i,n){t.uniform4fv(e.uniformLocations[i],n.v)},setValueVector2v:function(t,e,i,n){t.uniform2fv(e.uniformLocations[i],n)},setValueVector3v:function(t,e,i,n){t.uniform3fv(e.uniformLocations[i],n)},setValueVector4v:function(t,e,i,n){t.uniform4fv(e.uniformLocations[i],n)},setValueMatrix3:function(t,e,i,n,r){t.uniformMatrix3fv(e.uniformLocations[i],n,r.m)},setValueMatrix4:function(t,e,i,n,r){t.uniformMatrix4fv(e.uniformLocations[i],n,r.m)},setTexture:function(t,e,i,n,r){n.setActive(r),n.bind(),t.uniform1i(e.uniformLocations[i],r)}},{},t)}(bg.base.ShaderImpl);bg.webgl1.ShaderImpl=t}(),function(){var t=function(t){function e(){$traceurRuntime.superConstructor(e).apply(this,arguments)}return $traceurRuntime.createClass(e,{initFlags:function(t){bg.base.TextureWrap.REPEAT=t.REPEAT,bg.base.TextureWrap.CLAMP=t.CLAMP_TO_EDGE,bg.base.TextureWrap.MIRRORED_REPEAT=t.MIRRORED_REPEAT,bg.base.TextureFilter.NEAREST_MIPMAP_NEAREST=t.NEAREST_MIPMAP_NEAREST,bg.base.TextureFilter.LINEAR_MIPMAP_NEAREST=t.LINEAR_MIPMAP_NEAREST,bg.base.TextureFilter.NEAREST_MIPMAP_LINEAR=t.NEAREST_MIPMAP_LINEAR,bg.base.TextureFilter.LINEAR_MIPMAP_LINEAR=t.LINEAR_MIPMAP_LINEAR,bg.base.TextureFilter.NEAREST=t.NEAREST,bg.base.TextureFilter.LINEAR=t.LINEAR,bg.base.TextureTarget.TEXTURE_2D=t.TEXTURE_2D,bg.base.TextureTarget.CUBE_MAP=t.TEXTURE_CUBE_MAP,bg.base.TextureTarget.POSITIVE_X_FACE=t.TEXTURE_CUBE_MAP_POSITIVE_X,bg.base.TextureTarget.NEGATIVE_X_FACE=t.TEXTURE_CUBE_MAP_NEGATIVE_X,bg.base.TextureTarget.POSITIVE_Y_FACE=t.TEXTURE_CUBE_MAP_POSITIVE_Y,bg.base.TextureTarget.NEGATIVE_Y_FACE=t.TEXTURE_CUBE_MAP_NEGATIVE_Y,bg.base.TextureTarget.POSITIVE_Z_FACE=t.TEXTURE_CUBE_MAP_POSITIVE_Z,bg.base.TextureTarget.NEGATIVE_Z_FACE=t.TEXTURE_CUBE_MAP_NEGATIVE_Z},requireMipmaps:function(t,e){return t==bg.base.TextureFilter.NEAREST_MIPMAP_NEAREST||t==bg.base.TextureFilter.LINEAR_MIPMAP_NEAREST||t==bg.base.TextureFilter.NEAREST_MIPMAP_LINEAR||t==bg.base.TextureFilter.LINEAR_MIPMAP_LINEAR||e==bg.base.TextureFilter.NEAREST_MIPMAP_NEAREST||e==bg.base.TextureFilter.LINEAR_MIPMAP_NEAREST||e==bg.base.TextureFilter.NEAREST_MIPMAP_LINEAR||e==bg.base.TextureFilter.LINEAR_MIPMAP_LINEAR},create:function(t){return t.createTexture()},setActive:function(t,e){t.activeTexture(t.TEXTURE0+e)},bind:function(t,e,i){t.bindTexture(e,i)},unbind:function(t,e){this.bind(t,e,null)},setTextureWrapX:function(t,e,i,n){t.texParameteri(e,t.TEXTURE_WRAP_S,n)},setTextureWrapY:function(t,e,i,n){t.texParameteri(e,t.TEXTURE_WRAP_T,n)},setImage:function(t,e,i,n,r,s,a){a&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!0),t.texParameteri(e,t.TEXTURE_MIN_FILTER,i),t.texParameteri(e,t.TEXTURE_MAG_FILTER,n),t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,s),this.requireMipmaps(i,n)&&t.generateMipmap(e)},setImageRaw:function(t,e,i,n,r,s,a,o,c,u){c||(c=t.RGBA),u||(u=t.UNSIGNED_BYTE),u==bg.base.RenderSurfaceFormat.FLOAT&&(i=bg.base.TextureFilter.NEAREST,n=bg.base.TextureFilter.NEAREST),t.texParameteri(e,t.TEXTURE_MIN_FILTER,i),t.texParameteri(e,t.TEXTURE_MAG_FILTER,n),t.texImage2D(e,0,c,s,a,0,c,u,o),this.requireMipmaps(i,n)&&t.generateMipmap(e)},setTextureFilter:function(t,e,i,n){t.texParameteri(e,t.TEXTURE_MIN_FILTER,i),t.texParameteri(e,t.TEXTURE_MAG_FILTER,n)},setCubemapImage:function(t,e,i){t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.generateMipmap(e)},setCubemapRaw:function(t,e,i,n,r){var s=t.RGBA,a=t.UNSIGNED_BYTE;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texImage2D(e,0,s,n,r,0,s,a,i),t.generateMipmap(e)},setVideo:function(t,e,i,n,r){r&&t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(e,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(e,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n)},updateVideoData:function(t,e,i,n){t.bindTexture(e,i),t.texImage2D(e,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,n),t.bindTexture(e,null)},destroy:function(t,e){t.deleteTexture(this._texture)}},{},t)}(bg.base.TextureImpl);bg.webgl1.TextureImpl=t}();